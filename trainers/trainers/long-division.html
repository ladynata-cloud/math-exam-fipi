<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Деление уголком — российская запись (ОГЭ)</title>

  <link rel="stylesheet" href="../../style.css">

  <style>
    :root{
      --bg:#fbfbfa;
      --paper:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border: rgba(15,23,42,.12);
      --accent:#2f5f73;
      --soft: rgba(47,95,115,.10);
      --ok: rgba(22,163,74,.12);
      --bad: rgba(239,68,68,.10);
      --shadow: 0 10px 26px rgba(15,23,42,.06);
      --r:16px;

      --cell: 1.55em;
      --barw: 2px;
      --line: rgba(15,23,42,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background: var(--bg); color: var(--text); line-height: 1.35; }
    .wrap{ width:min(1180px, calc(100% - 32px)); margin: 18px auto 30px; }
    h1{ margin:0 0 6px; font-size:20px; }
    .sub{ margin:0 0 14px; color: var(--muted); }

    .nav{ display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0 14px; }
    .nav a{
      text-decoration:none;
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(15,23,42,.12);
      color: var(--accent);
      font-weight: 900;
    }
    .nav a:hover{ background: rgba(47,95,115,.08); border-color: rgba(47,95,115,.25); }

    .bar{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin: 10px 0 14px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .label{ font-size:12px; font-weight:900; color: var(--muted); }
    input[type="number"]{
      padding:10px 12px; border-radius: 12px; border:1px solid rgba(15,23,42,.14);
      background:#fff; outline:none; font-size:14px; width: 190px;
    }
    input[type="number"]:focus{ border-color: rgba(47,95,115,.45); box-shadow: 0 0 0 3px rgba(47,95,115,.12); }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding: 10px 14px; border-radius: 12px;
      border: 1px solid rgba(47,95,115,.25);
      background: var(--accent); color:#fff;
      font-weight: 900; cursor:pointer; user-select:none;
    }
    .btn:hover{ filter:brightness(.98); }
    .btn.soft{ background: rgba(255,255,255,.75); color: var(--text); border-color: rgba(15,23,42,.14); }
    .btn.soft:hover{ background: rgba(47,95,115,.08); border-color: rgba(47,95,115,.25); }

    .status{
      flex:1; min-width: 280px;
      padding: 10px 12px; border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.65); color: var(--muted);
    }
    .status.ok{ background: var(--ok); border-color: rgba(22,163,74,.25); color: rgba(21,128,61,.95); }
    .status.bad{ background: var(--bad); border-color: rgba(239,68,68,.25); color: rgba(185,28,28,.95); }

    .grid{ display:grid; grid-template-columns: 1.35fr .65fr; gap: 14px; align-items:start; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }
    .card{ background: var(--paper); border: 1px solid var(--border); border-radius: var(--r); box-shadow: var(--shadow); padding: 14px; }

    .paper{
      border-radius: var(--r);
      border: 1px solid var(--border);
      background:
        radial-gradient(circle at 1px 1px, rgba(15,23,42,.06) 1px, transparent 1px) 0 0/18px 18px,
        linear-gradient(#fff,#fff);
      padding: 14px;
      overflow:auto;
    }

    /* 3 колонки как на твоём макете: слева тетрадь, середина — “ученик считает”, справа — проверка */
    .paperInner{
      display:flex;
      gap: 14px;
      align-items:flex-start;
    }
    @media (max-width: 980px){
      .paperInner{ flex-direction: column; }
    }
    .paperLeft{ flex: 0 0 auto; }
    .paperMid{
      flex: 0 0 260px;
      min-height: 520px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.14);
      background: rgba(255,255,255,.88);
      padding: 12px;
    }
    .paperRight{
      flex: 1 1 auto;
      min-width: 320px;
      border-radius: 14px;
      border: 1px dashed rgba(15,23,42,.18);
      background: rgba(255,255,255,.70);
      padding: 12px;
      background-image: radial-gradient(circle at 1px 1px, rgba(15,23,42,.05) 1px, transparent 1px);
      background-size: 18px 18px;
    }
    @media (max-width: 980px){
      .paperMid{ flex: 1 1 auto; min-height: 0; width: 100%; }
      .paperRight{ min-width: 0; width: 100%; }
    }

    /* ====== Российская тетрадная сетка:
       [pad] [минус-ячейка] [делимое n цифр] [|] [правая зона n клеток]
    */
    .divGrid{
      font-family: var(--mono);
      --n: 6;
      display: grid;
      grid-template-columns:
        1.2em
        var(--cell)
        repeat(var(--n), var(--cell))
        var(--barw)
        repeat(var(--n), var(--cell));

      grid-auto-rows: 1.55em;
      align-items: center;
      justify-content: start;
      position: relative;
      min-width: calc(1.2em + var(--cell) + var(--n) * var(--cell) + var(--barw) + var(--n) * var(--cell));
    }

    .cell{
      display:flex;
      align-items:center;        /* ⬅ поднимает минус и цифры на одну линию */
      justify-content:center;
      text-align:center;
      font-size:26px;
      line-height:1;
      padding:0 .05em;
      user-select:none;
    }
    .cell.small{ font-size: 18px; color: var(--muted); }

    .rbar{
      background: var(--line);
      align-self: stretch;
      justify-self: stretch;
    }
    .hlineR{
      height:0;
      border-top: 2px solid var(--line);
      align-self: start;
      margin-top: .18em;
    }
    .divisorR{
      font-size: 26px;
      font-weight: 900;
      color: rgba(15,23,42,.92);
      text-align:left;
      justify-self: start;
      padding-left: .25em;
      white-space: nowrap;
    }
    .qCell{ font-size: 26px; font-weight: 900; color: rgba(15,23,42,.92); }

    .hlBring{ background: rgba(245,158,11,.18); border: 1px solid rgba(245,158,11,.30); border-radius: 8px; padding-top: .06em; padding-bottom: .06em; }
    .hlCurrent{ background: rgba(47,95,115,.14); border: 1px solid rgba(47,95,115,.22); border-radius: 8px; padding-top: .06em; padding-bottom: .06em; }

    .minusCell{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      color: rgba(15,23,42,.65);
      font-weight: 900;
      padding-right: .15em;
      line-height: 1;
    }

    .underline{ border-bottom: 2px solid rgba(15,23,42,.45); padding-bottom: .15em; }
    .remainder{ color: rgba(15,23,42,.90); font-weight: 800; }

    .miniOut{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.60);
      color: var(--muted);
      margin-bottom: 10px;
      font-size: 14px;
      font-weight: 800;
    }
    .miniOut.ok{ background: rgba(22,163,74,.12); border-color: rgba(22,163,74,.25); color: rgba(21,128,61,.95); }
    .miniOut.bad{ background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.25); color: rgba(185,28,28,.95); }

    .check{ display:flex; gap:8px; align-items:center; color: var(--muted); font-size: 14px; user-select:none; }

    .levelBox{
      margin-top: 10px;
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 12px;
      padding: 10px;
      background: rgba(15,23,42,.02);
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items:center;
    }
    .levelBox b{ margin-right: 6px; }
    .levelOpt{ display:flex; gap:8px; align-items:center; color: var(--muted); font-size: 14px; }

    .log{
      margin-top: 12px;
      font-family: var(--mono);
      font-size: 13px;
      white-space: pre-wrap;
      background: rgba(15,23,42,.02);
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 12px;
      padding: 10px;
      min-height: 130px;
      color: rgba(100,116,139,.95);
    }

    .workTitle{
      margin: 0 0 8px;
      font-size: 14px;
      font-weight: 900;
      color: rgba(15,23,42,.85);
    }
    .workRow{
      display:flex;
      gap: 10px;
      align-items:flex-end;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .workRow .field input[type="number"]{ width: 160px; }
    .workNote{
      color: var(--muted);
      font-size: 12px;
      margin-top: -4px;
    }
    .scratch textarea{
      width: 100%;
      min-height: 160px;
      resize: vertical;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(15,23,42,.14);
      background: rgba(255,255,255,.92);
      font-family: var(--mono);
      font-size: 13px;
      outline:none;
    }
    .scratch textarea:focus{
      border-color: rgba(47,95,115,.45);
      box-shadow: 0 0 0 3px rgba(47,95,115,.12);
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>Деление уголком — российская запись</h1>
  <p class="sub">Делимое слева, делитель справа сверху, частное справа под чертой. Минусы “впритык”, как в тетрадке.</p>

  <div class="nav">
    <a href="../../index.html">← Главная</a>
    <a href="./long-multiplication.html">Умножение столбиком →</a>
    <a href="../multiplication-table/index.html">Таблица умножения →</a>
  </div>

  <div class="bar">
    <div class="field">
      <div class="label">Делимое</div>
      <input id="dividendIn" type="number" min="0" step="1" value="41608"/>
    </div>
    <div class="field">
      <div class="label">Делитель</div>
      <input id="divisorIn" type="number" min="1" step="1" value="56"/>
    </div>

    <button class="btn" id="startBtn">Старт</button>
    <button class="btn soft" id="randomBtn">Случайный</button>
    <button class="btn soft" id="resetBtn">Сброс</button>

    <div class="status" id="status">Введи числа и нажми «Старт».</div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="paper">
        <div class="paperInner">
          <div class="paperLeft">
            <div id="divArea"></div>
          </div>

          <div class="paperMid">
            <div class="workTitle">Здесь считает ученик</div>

            <div class="workRow">
              <div class="field">
                <div class="label">Цифра частного q (0–9)</div>
                <input id="qDigitIn" type="number" min="0" max="9" step="1" placeholder="0–9" disabled>
                <div class="workNote" id="qNote">—</div>
              </div>
            </div>

            <div class="workRow" id="prodRow">
              <div class="field">
                <div class="label">Произведение d×q</div>
                <input id="prodIn" type="number" min="0" step="1" placeholder="например 56×7=392" disabled>
                <div class="workNote" id="prodNote">—</div>
              </div>
            </div>

            <div class="workRow" id="remRow">
              <div class="field">
                <div class="label">Остаток шага N−prod</div>
                <input id="remIn" type="number" min="0" step="1" placeholder="например 416−392=24" disabled>
                <div class="workNote" id="remNote">—</div>
              </div>
            </div>

            <div class="workRow" id="nextRow">
              <div class="field">
                <div class="label">Новый кусок после сноса</div>
                <input id="nextChunkIn" type="number" min="0" step="1" placeholder="например 24 и снесли 0 → 240" disabled>
                <div class="workNote" id="nextNote">—</div>
              </div>
            </div>

            <div class="scratch" style="margin-top:10px;">
              <div class="label">Черновик (любые вычисления)</div>
              <textarea id="scratch" placeholder="Например: 56×7=392, 416−392=24..."></textarea>
            </div>
          </div>

          <div class="paperRight">
            <div class="miniOut" id="miniOut">Поле проверки: вводи шаги слева и нажимай «Проверить».</div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
              <button class="btn" id="checkBtn" disabled>Проверить шаг</button>
              <button class="btn soft" id="hintBtn" disabled>Подсказка</button>
            </div>

            <label class="check">
              <input id="calmMode" type="checkbox" checked>
              <span><b>Режим спокойствия</b> (объяснять “мало/велико”)</span>
            </label>

            <label class="check" style="margin-top:6px;">
              <input id="autoZero" type="checkbox" checked>
              <span>Разрешать нули в частном (если кусок &lt; делителя)</span>
            </label>

            <div class="levelBox" aria-label="Уровень цепочки">
              <b>Уровень:</b>
              <label class="levelOpt"><input type="radio" name="lvl" value="1" checked> 1 — только q</label>
              <label class="levelOpt"><input type="radio" name="lvl" value="2"> 2 — q + prod + rem</label>
              <label class="levelOpt"><input type="radio" name="lvl" value="3"> 3 — полный ( + nextChunk )</label>
            </div>

            <div class="log" id="logOut">—</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:900; margin-bottom:8px;">Правило подбора цифры</div>
      <div style="color:#64748b; font-size:14px;">
        Для текущего куска <b>N</b> ищем <b>q</b>, чтобы:<br>
        <b>d×q ≤ N</b>, а <b>d×(q+1) &gt; N</b>.<br><br>
        Подсказка показывает q = ⌊N/d⌋ и мини-проверку.
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  const dividendIn = $("dividendIn");
  const divisorIn  = $("divisorIn");
  const startBtn = $("startBtn");
  const randomBtn = $("randomBtn");
  const resetBtn = $("resetBtn");

  const statusEl = $("status");
  const miniOut = $("miniOut");
  const divArea = $("divArea");
  const logOut = $("logOut");

  const qDigitIn = $("qDigitIn");
  const checkBtn = $("checkBtn");
  const hintBtn = $("hintBtn");

  const calmMode = $("calmMode");
  const autoZero = $("autoZero");

  const prodRow = $("prodRow");
  const remRow  = $("remRow");
  const nextRow = $("nextRow");

  const prodIn = $("prodIn");
  const remIn  = $("remIn");
  const nextChunkIn = $("nextChunkIn");

  const qNote = $("qNote");
  const prodNote = $("prodNote");
  const remNote  = $("remNote");
  const nextNote = $("nextNote");

  let st = null;
  let level = 1;

  function setStatus(text, kind=""){
    statusEl.className = "status" + (kind ? " " + kind : "");
    statusEl.textContent = text;
    miniOut.className = "miniOut" + (kind ? " " + kind : "");
    miniOut.textContent = text;
  }

  function sInt(v, fb=null){
    if (v === "" || v === null || v === undefined) return fb;
    const n = Number(v);
    if (!Number.isFinite(n)) return fb;
    return Math.trunc(n);
  }
  function randInt(a,b){ return a + Math.floor(Math.random()*(b-a+1)); }

  function getLevel(){
    const v = document.querySelector('input[name="lvl"]:checked')?.value ?? "1";
    return Number(v);
  }

  function applyLevelUI(){
    level = getLevel();
    prodRow.style.display = (level >= 2) ? "" : "none";
    remRow.style.display  = (level >= 2) ? "" : "none";
    nextRow.style.display = (level >= 3) ? "" : "none";

    const enabled = !!(st && st.phase === "ask");
    qDigitIn.disabled = !enabled;
    prodIn.disabled = !(enabled && level >= 2);
    remIn.disabled  = !(enabled && level >= 2);
    nextChunkIn.disabled = !(enabled && level >= 3);

    if (!enabled){
      qNote.textContent = "—";
      prodNote.textContent = "—";
      remNote.textContent = "—";
      nextNote.textContent = "—";
    } else {
      updateNotes();
    }
  }

  function updateNotes(){
    if (!st || st.phase !== "ask"){
      qNote.textContent = "—";
      prodNote.textContent = "—";
      remNote.textContent = "—";
      nextNote.textContent = "—";
      return;
    }
    const N = st.chunk, d = st.divisor;
    qNote.textContent = `Сейчас: N=${N}, d=${d}`;
    if (level >= 2){
      prodNote.textContent = `prod = ${d}×q`;
      remNote.textContent  = `rem = ${N} − prod`;
    } else {
      prodNote.textContent = "—";
      remNote.textContent  = "—";
    }
    if (level >= 3){
      if (st.nextDigitIndex < st.n){
        const b = st.digits[st.nextDigitIndex];
        nextNote.textContent = `Сносим цифру ${b}: next = rem×10 + ${b}`;
      } else {
        nextNote.textContent = `Цифр больше нет — next не нужен.`;
      }
    } else {
      nextNote.textContent = "—";
    }
  }

  function expectedDigit(){
    let q = Math.floor(st.chunk / st.divisor);
    if (q > 9) q = 9;
    if (q < 0) q = 0;
    return q;
  }

  function explainTooSmall(q){
    const d = st.divisor, N = st.chunk;
    const next = d * (q + 1);
    return `${d}×(${q}+1) = ${next} > ${N} — значит можно увеличивать. Твоя цифра ${q} мала.`;
  }
  function explainTooBig(q){
    const d = st.divisor, N = st.chunk;
    const cur = d * q;
    return `${d}×${q} = ${cur} > ${N} — цифра ${q} велика.`;
  }
  function explainCorrect(q){
    const d = st.divisor, N = st.chunk;
    const cur = d*q;
    const nxt = d*(q+1);
    return `Проверка: ${d}×${q}=${cur} ≤ ${N}, а ${d}×(${q}+1)=${nxt} > ${N}.`;
  }

  function hint(){
    if (!st || st.phase !== "ask") return;
    const q = expectedDigit();
    setStatus(`Подсказка: q=${q}. ${explainCorrect(q)}`, "ok");
    st.log.push(`Подсказка: q=${q}. ${explainCorrect(q)}`);
    logOut.textContent = st.log.join("\n");
    updateNotes();
  }

  function start(){
    const dividend = sInt(dividendIn.value, null);
    const divisor  = sInt(divisorIn.value, null);

    if (dividend === null || divisor === null || dividend < 0 || divisor <= 0){
      setStatus("Проверь числа: делимое ≥ 0, делитель > 0.", "bad");
      return;
    }

    const digits = String(dividend).split("").map(Number);
    const n = digits.length;

    let chunk = 0;
    let end = -1;
    while (end + 1 < n){
      end++;
      chunk = chunk * 10 + digits[end];
      if (chunk >= divisor) break;
    }

    if (chunk < divisor && end === n-1){
      st = { dividend, divisor, digits, n, quotient: Array(n).fill(""), steps: [], curEnd: n-1, chunk: dividend, nextDigitIndex: n, remainder: dividend, phase:"done", bringIndex:null, log:[] };
      st.quotient[n-1] = "0";
      setStatus(`Готово: ${dividend} < ${divisor}. Частное 0, остаток ${dividend}.`, "ok");
      st.log = [statusEl.textContent];
      logOut.textContent = st.log.join("\n");
      render();
      checkBtn.disabled = true;
      hintBtn.disabled = true;
      applyLevelUI();
      return;
    }

    st = {
      dividend, divisor, digits, n,
      quotient: Array(n).fill(""),
      steps: [],
      curEnd: end,
      chunk,
      nextDigitIndex: end+1,
      remainder: null,
      phase:"ask",
      bringIndex: end,
      log:[`Старт: первый кусок N=${chunk}.`]
    };

    qDigitIn.value = "";
    prodIn.value = "";
    remIn.value = "";
    nextChunkIn.value = "";

    checkBtn.disabled = false;
    hintBtn.disabled = false;

    setStatus("Подбираем цифру частного.", "");
    logOut.textContent = st.log.join("\n");

    render();
    applyLevelUI();
    qDigitIn.focus();
  }

  function check(){
    if (!st || st.phase !== "ask") return;

    const q = sInt(qDigitIn.value, null);
    if (q === null || q < 0 || q > 9){
      setStatus("Введи цифру q от 0 до 9.", "bad");
      return;
    }

    const d = st.divisor;
    const N = st.chunk;

    if (N < d && !autoZero.checked){
      setStatus("Сейчас N < d. Обычно пишем 0 и сносим следующую цифру (включи галочку).", "bad");
      st.log.push(`Ситуация: ${N} < ${d}. Включи “нули в частном”.`);
      logOut.textContent = st.log.join("\n");
      return;
    }

    const prod = d * q;

    if (prod > N){
      setStatus("Слишком большая цифра.", "bad");
      st.log.push(calmMode.checked ? explainTooBig(q) : `Велико: ${d}×${q} > ${N}.`);
      logOut.textContent = st.log.join("\n");
      return;
    }

    const corr = expectedDigit();
    if (N >= d && q < corr){
      setStatus("Цифра слишком маленькая.", "bad");
      st.log.push(calmMode.checked ? explainTooSmall(q) : "Мало: можно увеличить цифру.");
      logOut.textContent = st.log.join("\n");
      return;
    }

    if (level >= 2){
      const prodUser = sInt(prodIn.value, null);
      const remUser  = sInt(remIn.value, null);
      const prodExp  = d * q;
      const remExp   = N - prodExp;

      if (prodUser === null){
        setStatus("Уровень 2/3: введи произведение d×q.", "bad");
        return;
      }
      if (prodUser !== prodExp){
        setStatus(`Произведение неверно. Нужно: ${d}×${q}=${prodExp}`, "bad");
        st.log.push(`Произведение: ожидали ${prodExp}, получили ${prodUser}.`);
        logOut.textContent = st.log.join("\n");
        return;
      }

      if (remUser === null){
        setStatus("Уровень 2/3: введи остаток N−prod.", "bad");
        return;
      }
      if (remUser !== remExp){
        setStatus(`Вычитание неверно. Нужно: ${N}-${prodExp}=${remExp}`, "bad");
        st.log.push(`Остаток: ожидали ${remExp}, получили ${remUser}.`);
        logOut.textContent = st.log.join("\n");
        return;
      }

      if (level >= 3 && st.nextDigitIndex < st.n){
        const bringDigit = st.digits[st.nextDigitIndex];
        const nextExp = remExp * 10 + bringDigit;
        const nextUser = sInt(nextChunkIn.value, null);
        if (nextUser === null){
          setStatus("Уровень 3: введи новый кусок после сноса.", "bad");
          return;
        }
        if (nextUser !== nextExp){
          setStatus(`Снос неверно. Нужно: ${remExp} и снесли ${bringDigit} → ${nextExp}`, "bad");
          st.log.push(`Снос: ожидали ${nextExp}, получили ${nextUser}.`);
          logOut.textContent = st.log.join("\n");
          return;
        }
      }

      if (calmMode.checked){
        st.log.push(explainCorrect(q));
        logOut.textContent = st.log.join("\n");
      }
    }

    applyStep(q);
  }

  function applyStep(q){
    const d = st.divisor;
    const N = st.chunk;

    const prod = d * q;
    const rem = N - prod;

    st.quotient[st.curEnd] = String(q);

    // продукт
    st.steps.push({ kind: "product", end: st.curEnd, text: String(prod), minus: true });
    // линия
    st.steps.push({ kind: "line", end: st.curEnd, len: Math.max(String(prod).length, String(N).length) + 1 });
    // остаток
    st.steps.push({ kind: "remainder", end: st.curEnd, text: String(rem) });

    st.log.push(`Шаг: N=${N}, q=${q}, prod=${prod}, остаток=${rem}.`);

    if (st.nextDigitIndex < st.n){
      const bringIdx = st.nextDigitIndex;
      const bringDigit = st.digits[bringIdx];
      const nextChunk = rem * 10 + bringDigit;

      st.steps.push({ kind: "nextchunk", end: bringIdx, text: String(nextChunk), highlightLast: true });

      st.curEnd = bringIdx;
      st.chunk = nextChunk;
      st.nextDigitIndex = bringIdx + 1;
      st.bringIndex = bringIdx;

      st.log.push(`Снесли цифру ${bringDigit} → новый кусок ${nextChunk}.`);
      logOut.textContent = st.log.join("\n");

      qDigitIn.value = "";
      prodIn.value = ""; remIn.value = ""; nextChunkIn.value = "";
      setStatus("Верно. Следующий шаг.", "ok");

      render();
      applyLevelUI();
      qDigitIn.focus();
      return;
    }

    st.phase = "done";
    st.remainder = rem;

    qDigitIn.disabled = true;
    checkBtn.disabled = true;
    hintBtn.disabled = true;

    applyLevelUI();

    const qStr = (st.quotient.join("").replace(/^0+(?=\d)/,"") || "0");
    setStatus(`Готово! Ответ: ${st.dividend} : ${st.divisor} = ${qStr}${rem ? ` (ост. ${rem})` : ""}`, "ok");
    st.log.push(`Финиш. Остаток = ${rem}.`);
    logOut.textContent = st.log.join("\n");
    render();
  }

  function render(){
    if (!st){ divArea.innerHTML = "<div style='color:#64748b'>—</div>"; return; }

    const n = st.n;

    // Новая раскладка колонок:
    // 1: pad, 2: минус, 3..(3+n-1): цифры делимого, затем "|" и правая зона
    const padCol = 1;
    const minusCol = 2;
    const digitStart = 3;

    const barCol = digitStart + n;
    const rightStart = barCol + 1;
    const lastColEnd = rightStart + n;

    const grid = document.createElement("div");
    grid.className = "divGrid";
    grid.style.setProperty("--n", String(n));

    // вертикальная черта
    const bar = document.createElement("div");
    bar.className = "rbar";
    bar.style.gridColumn = String(barCol);
    bar.style.gridRow = `1 / ${Math.max(14, st.steps.length + 12)}`;
    grid.appendChild(bar);

    // делимое
    for (let i=0; i<n; i++){
      let cls = "";
      if (st.phase === "ask" && i === st.bringIndex) cls = "hlBring";
      if (st.phase === "ask" && i === st.curEnd) cls = cls ? (cls + " hlCurrent") : "hlCurrent";

      const d = document.createElement("div");
      d.className = "cell" + (cls ? " " + cls : "");
      d.style.gridColumn = String(digitStart + i);
      d.style.gridRow = "1";
      d.textContent = String(st.digits[i]);
      grid.appendChild(d);
    }

    // делитель справа сверху
    const divisorText = String(st.divisor);
    const divEl = document.createElement("div");
    divEl.className = "divisorR";
    divEl.style.gridRow = "1";
    divEl.style.gridColumn = `${rightStart} / ${rightStart + Math.max(2, divisorText.length)}`;
    divEl.textContent = divisorText;
    grid.appendChild(divEl);

    // горизонтальная черта справа
    const hline = document.createElement("div");
    hline.className = "hlineR";
    hline.style.gridRow = "2";
    hline.style.gridColumn = `${barCol} / ${lastColEnd}`;
    grid.appendChild(hline);

    // частное справа (под чертой)
    const firstQ = st.quotient.findIndex(x => x !== "");
    const qStrPartial = (firstQ === -1) ? "" : st.quotient.slice(firstQ).join("");
    if (qStrPartial){
      for (let k=0; k<qStrPartial.length && k<n; k++){
        const c = document.createElement("div");
        c.className = "cell qCell";
        c.style.gridRow = "2";
        c.style.gridColumn = String(rightStart + k);
        c.textContent = qStrPartial[k];
        grid.appendChild(c);
      }
    }

    let row = 2;

    function placeNumber(r, endIdx, text, opts={}){
      const s = String(text);
      const L = s.length;
      const startIdx = endIdx - L + 1;

      if (opts.minus){
        const minus = document.createElement("div");
        minus.className = "cell minusCell";
        minus.style.gridRow = String(r);
        // Минус ставим “впритык”: ровно слева от первой цифры числа
        minus.style.gridColumn = String(digitStart + startIdx - 1);
        minus.textContent = "−";
        grid.appendChild(minus);
      }

      for (let k=0; k<L; k++){
        const idx = startIdx + k;
        if (idx < 0 || idx >= n) continue;

        const cell = document.createElement("div");
        cell.className = "cell" + (opts.remainder ? " remainder" : "");
        cell.style.gridColumn = String(digitStart + idx);
        cell.style.gridRow = String(r);
        cell.textContent = s[k];

        if (opts.highlightLast && k === L-1){
          cell.classList.add("hlBring");
        }
        grid.appendChild(cell);
      }

      if (opts.underline){
        const uLen = opts.underlineLen ?? L;
        const uStart = Math.max(0, endIdx - (uLen - 1));
        const uEnd = Math.min(n-1, endIdx);
        for (let idx=uStart; idx<=uEnd; idx++){
          const u = document.createElement("div");
          u.className = "cell underline";
          u.style.gridColumn = String(digitStart + idx);
          u.style.gridRow = String(r);
          u.textContent = "";
          grid.appendChild(u);
        }
      }
    }

    for (const it of st.steps){
      if (it.kind === "product"){ placeNumber(row, it.end, it.text, {minus:true}); row++; }
      else if (it.kind === "line"){ placeNumber(row, it.end, "", {underline:true, underlineLen: it.len}); row++; }
      else if (it.kind === "remainder"){ placeNumber(row, it.end, it.text, {remainder:true}); row++; }
      else if (it.kind === "nextchunk"){ placeNumber(row, it.end, it.text, {highlightLast: !!it.highlightLast}); row++; }
    }

    if (st.phase === "done"){
      row++;
      const qStr = (st.quotient.join("").replace(/^0+(?=\d)/,"") || "0");
      const res = document.createElement("div");
      res.className = "cell small";
      res.style.gridColumn = `1 / ${digitStart + n}`;
      res.style.gridRow = String(row);
      res.style.justifySelf = "start";
      res.style.textAlign = "left";
      res.textContent = `Ответ: ${st.dividend} : ${st.divisor} = ${qStr}${st.remainder ? ` (ост. ${st.remainder})` : ""}`;
      grid.appendChild(res);
    }

    divArea.innerHTML = "";
    divArea.appendChild(grid);

    updateNotes();
  }

  function random(){
    const divisor = randInt(12, 98);
    const len = randInt(4, 6);
    const min = Math.pow(10, len-1);
    const max = Math.pow(10, len) - 1;
    let dividend = randInt(min, max);

    if (Math.random() < 0.35){
      const s = String(dividend).split("");
      const pos = randInt(1, s.length-2);
      s[pos] = "0";
      dividend = Number(s.join(""));
    }

    if (dividend < divisor) dividend += divisor;
    dividendIn.value = dividend;
    divisorIn.value = divisor;
    start();
  }

  function resetAll(){
    st = null;
    divArea.innerHTML = "<div style='color:#64748b'>—</div>";
    logOut.textContent = "—";
    qDigitIn.value = "";
    prodIn.value = "";
    remIn.value = "";
    nextChunkIn.value = "";
    checkBtn.disabled = true;
    hintBtn.disabled = true;
    setStatus("Введи числа и нажми «Старт».", "");
    applyLevelUI();
  }

  startBtn.addEventListener("click", start);
  randomBtn.addEventListener("click", random);
  resetBtn.addEventListener("click", resetAll);
  checkBtn.addEventListener("click", check);
  hintBtn.addEventListener("click", hint);

  qDigitIn.addEventListener("keydown", (e) => { if (e.key === "Enter") check(); });
  prodIn.addEventListener("keydown", (e) => { if (e.key === "Enter") check(); });
  remIn.addEventListener("keydown", (e) => { if (e.key === "Enter") check(); });
  nextChunkIn.addEventListener("keydown", (e) => { if (e.key === "Enter") check(); });

  $$('input[name="lvl"]').forEach(r => r.addEventListener("change", () => {
    applyLevelUI();
    if (st && st.phase === "ask") qDigitIn.focus();
  }));

  resetAll();
})();
</script>
</body>
</html>

