<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Тренажёр: округление</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <main class="container">
    <h1>Тренажёр: округление</h1>

    <section class="panel">
      <div class="row">
        <label for="placeSelect"><strong>Округлять до:</strong></label>
        <select id="placeSelect">
          <option value="6">миллионов</option>
          <option value="5">сотен тысяч</option>
          <option value="4">десятков тысяч</option>
          <option value="3">тысяч</option>
          <option value="2">сотен</option>
          <option value="1">десятков</option>
          <option value="0" selected>единиц</option>
          <option value="-1">десятых</option>
          <option value="-2">сотых</option>
          <option value="-3">тысячных</option>
        </select>
      </div>

      <div class="row meta">
        <div id="progress">Задание: <span id="current">1</span> / <span id="total">10</span></div>
        <div id="score">Счёт: <span id="scoreNum">0</span></div>
      </div>
    </section>

    <section class="task">
      <div class="task-text" id="taskText">Загрузка…</div>

      <div class="answer-row">
        <input
          id="answerInput"
          inputmode="decimal"
          autocomplete="off"
          placeholder="Введите ответ (можно 12,3)"
          aria-label="Поле ввода ответа"
        />
        <button class="btn" id="checkBtn" type="button">Проверить</button>
        <button class="btn secondary" id="nextBtn" type="button" style="display:none;">Следующий</button>
      </div>

      <div class="row">
        <button class="btn ghost" id="toggleRuleBtn" type="button" aria-expanded="false" aria-controls="ruleBlock">
          Напомнить правило
        </button>
      </div>

      <div id="ruleBlock" class="rule is-hidden" aria-hidden="true">
        <ol>
          <li>Определи разряд (или число знаков после запятой), до которого округляешь.</li>
          <li>Посмотри на цифру <strong>справа</strong> от этого разряда:
            <ul>
              <li>0–4 → разряд не меняем;</li>
              <li>5–9 → увеличиваем разряд на 1.</li>
            </ul>
          </li>
          <li>Все цифры справа заменяем нулями (или отбрасываем, если округляем дробь).</li>
        </ol>
      </div>

      <div id="feedback" class="feedback" aria-live="polite"></div>
    </section>
  </main>

  <script>
    // ---------- helpers ----------
    const TOTAL = 10;

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // Показываем число по-русски (запятая)
    function formatForDisplay(numStr) {
      return numStr.replace('.', ',');
    }

    // Принимаем ввод: "12,3" / "12.3" / " 12 345,6 "
    function normalizeInput(s) {
      return s
        .trim()
        .replace(/\s+/g, '')
        .replace(',', '.');
    }

    // BigInt 10^n
    function pow10(n) {
      let x = 1n;
      for (let i = 0; i < n; i++) x *= 10n;
      return x;
    }

    // Парсим в (BigInt, scale): value = int / 10^scale
    function parseScaledBigInt(str) {
      // str already normalized: digits + optional "."
      const m = str.match(/^(\d+)(?:\.(\d+))?$/);
      if (!m) return null;
      const intPart = m[1];
      const fracPart = m[2] || '';
      const scale = fracPart.length;
      const digits = intPart + fracPart;
      return { int: BigInt(digits), scale };
    }

    // Округление half-up до 10^p (p может быть отрицательным)
    function roundScaledHalfUp(value, p) {
      // value: {int, scale}
      // хотим, чтобы p + targetScale >= 0
      const targetScale = Math.max(value.scale, -p);

      // приводим к targetScale (домножаем нулями)
      let int = value.int;
      if (targetScale > value.scale) {
        int = int * pow10(targetScale - value.scale);
      }

      const stepPow = p + targetScale; // >= 0
      const step = pow10(stepPow);

      let q = int / step;
      const r = int % step;

      if (r * 2n >= step) q = q + 1n;

      const roundedInt = q * step;

      // форматируем в строку
      if (p >= 0) {
        // округляем до целого разряда => без дробной части
        // (даже если targetScale > 0 — дробь по сути занулена)
        const whole = roundedInt / pow10(targetScale);
        return whole.toString();
      } else {
        // нужно показать ровно (-p) знаков после запятой
        const needScale = -p;

        // roundedInt сейчас в масштабе targetScale
        // если targetScale > needScale — отбрасываем лишние нули справа
        let adj = roundedInt;
        if (targetScale > needScale) {
          adj = adj / pow10(targetScale - needScale);
        } else if (targetScale < needScale) {
          adj = adj * pow10(needScale - targetScale);
        }

        const s = adj.toString().padStart(needScale + 1, '0');
        const cut = s.length - needScale;
        const a = s.slice(0, cut);
        const b = s.slice(cut);
        return a + '.' + b;
      }
    }

    function placeLabel(p) {
      const map = {
        6: 'миллионов',
        5: 'сотен тысяч',
        4: 'десятков тысяч',
        3: 'тысяч',
        2: 'сотен',
        1: 'десятков',
        0: 'единиц',
        '-1': 'десятых',
        '-2': 'сотых',
        '-3': 'тысячных'
      };
      return map[p] ?? 'единиц';
    }

    function generateNumberForPlace(p) {
      // простая логика генерации:
      // p >= 0 -> целые числа
      // p < 0  -> дробные с 3 знаками, чтобы было что округлять
      if (p >= 0) {
        // делаем диапазон “чувствительным” к разряду
        const max = Math.min(9_999_999, Math.max(200, Math.pow(10, p + 2) * 9));
        const n = randInt(10, max);
        return n.toString();
      } else {
        // дробь: целая часть 0..9999, дробная 3 знака
        const whole = randInt(0, 9999);
        const frac = randInt(0, 999).toString().padStart(3, '0');
        return whole.toString() + '.' + frac;
      }
    }

    // ---------- app state ----------
    let state = {
      p: 0,
      taskIndex: 1,
      score: 0,
      attempts: 0,
      numberStr: '0',
      correctStr: '0'
    };

    const el = {
      placeSelect: document.getElementById('placeSelect'),
      taskText: document.getElementById('taskText'),
      answer: document.getElementById('answerInput'),
      checkBtn: document.getElementById('checkBtn'),
      nextBtn: document.getElementById('nextBtn'),
      feedback: document.getElementById('feedback'),
      current: document.getElementById('current'),
      total: document.getElementById('total'),
      scoreNum: document.getElementById('scoreNum'),
      toggleRuleBtn: document.getElementById('toggleRuleBtn'),
      ruleBlock: document.getElementById('ruleBlock'),
    };

    el.total.textContent = TOTAL;

    function setFeedback(type, html) {
      el.feedback.classList.remove('correct', 'incorrect');
      if (type) el.feedback.classList.add(type);
      el.feedback.innerHTML = html;
    }

    function loadTask(resetAttempts = true) {
      state.p = parseInt(el.placeSelect.value, 10);

      if (resetAttempts) state.attempts = 0;

      state.numberStr = generateNumberForPlace(state.p);
      const parsed = parseScaledBigInt(state.numberStr);
      state.correctStr = roundScaledHalfUp(parsed, state.p);

      el.taskText.innerHTML =
        `Округлите число <strong>${formatForDisplay(state.numberStr)}</strong> до <strong>${placeLabel(state.p)}</strong>.`;

      el.answer.value = '';
      el.answer.focus();

      el.current.textContent = state.taskIndex;
      el.scoreNum.textContent = state.score;

      setFeedback('', '');
      el.nextBtn.style.display = 'none';
      el.checkBtn.disabled = false;
    }

    function showHint() {
      // короткая подсказка по текущему разряду
      const p = state.p;
      let hint = '';
      if (p >= 0) {
        hint = `Подсказка: смотрим цифру справа от разряда “${placeLabel(p)}”. Если она 5–9 — увеличиваем, иначе оставляем.`;
      } else {
        hint = `Подсказка: округляем до “${placeLabel(p)}”. Посмотрите на следующую цифру после нужного знака.`;
      }
      return `<div class="hint">${hint}</div>`;
    }

    function checkAnswer() {
      const raw = normalizeInput(el.answer.value);
      const parsed = parseScaledBigInt(raw);

      if (!parsed) {
        setFeedback('incorrect', 'Введите число (например: 1250 или 12,35).');
        el.answer.classList.add('input-error');
        return;
      }
      el.answer.classList.remove('input-error');

      // приводим ожидаемый и введённый к одному формату сравнения
      const userStr = (state.p >= 0)
        ? (parsed.int / pow10(parsed.scale)).toString()
        : roundScaledHalfUp(parsed, state.p); // если ввёл "12,3", нормализуем до нужной точности

      const ok = (userStr === state.correctStr);

      state.attempts += 1;

      if (ok) {
        state.score += 1;
        setFeedback('correct', `Верно ✅`);
        el.scoreNum.textContent = state.score;
        el.checkBtn.disabled = true;
        el.nextBtn.style.display = 'inline-block';
      } else {
        let html = `Неверно ❌ Правильный ответ: <strong>${formatForDisplay(state.correctStr)}</strong>.`;
        if (state.attempts >= 2) html += showHint();
        setFeedback('incorrect', html);
      }
    }

    function nextTask() {
      if (state.taskIndex >= TOTAL) {
        setFeedback('correct', `Готово ✅ Ваш результат: <strong>${state.score}</strong> / <strong>${TOTAL}</strong>.`);
        el.taskText.innerHTML = 'Серия завершена. Можно поменять разряд и начать заново.';
        el.nextBtn.style.display = 'none';
        el.checkBtn.disabled = true;
        return;
      }
      state.taskIndex += 1;
      loadTask(true);
    }

    // ---------- events ----------
    el.checkBtn.addEventListener('click', checkAnswer);
    el.nextBtn.addEventListener('click', nextTask);

    el.answer.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        if (!el.checkBtn.disabled) checkAnswer();
        else if (el.nextBtn.style.display !== 'none') nextTask();
      }
    });

    el.placeSelect.addEventListener('change', () => {
      state.taskIndex = 1;
      state.score = 0;
      loadTask(true);
    });

    el.toggleRuleBtn.addEventListener('click', () => {
      const hidden = el.ruleBlock.classList.toggle('is-hidden');
      el.ruleBlock.setAttribute('aria-hidden', hidden ? 'true' : 'false');
      el.toggleRuleBtn.setAttribute('aria-expanded', hidden ? 'false' : 'true');
    });

    // start
    loadTask(true);
  </script>
</body>
</html>
