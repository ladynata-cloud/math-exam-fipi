<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Тренажёр округления — mathexam.space</title>
  <style>
    :root{
      color-scheme: dark;
      --bg0:#0b1220;
      --bg1:#0f1b2f;
      --card:#121f36;
      --line:rgba(255,255,255,.12);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.55);
      --good:#39d98a;
      --bad:#ff5c5c;
      --accent:#7aa7ff;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --r:16px;
      --pad:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% 0%, #13254a 0%, var(--bg0) 55%),
                  radial-gradient(900px 600px at 80% 20%, #1d2f57 0%, var(--bg0) 60%);
      color:var(--txt);
      min-height:100svh;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 22px 14px 40px;
    }
    .topline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
      color:var(--muted2);
      font-size:14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: calc(var(--r) + 6px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    header{
      padding: 20px var(--pad) 14px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(122,167,255,.10), rgba(0,0,0,0));
    }
    h1{
      margin:0 0 6px;
      font-size: 28px;
      letter-spacing:.2px;
    }
    .sub{
      margin:0;
      color:var(--muted);
      line-height:1.4;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 14px;
      padding: 14px var(--pad);
    }
    @media (max-width: 820px){
      .grid{grid-template-columns:1fr}
    }

    .panel{
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: rgba(0,0,0,.18);
      padding: 14px;
    }
    .panel h2{
      margin:0 0 10px;
      font-size: 16px;
      color: var(--muted);
      font-weight: 600;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }

    label.lbl{
      display:block;
      font-size: 13px;
      color: var(--muted2);
      margin-bottom: 6px;
    }

    .field{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--txt);
      outline:none;
      font-size: 15px;
    }
    .field:focus{
      border-color: rgba(122,167,255,.55);
      box-shadow: 0 0 0 3px rgba(122,167,255,.12);
    }

    .checkline{
      display:flex;
      gap:10px;
      align-items:flex-start;
      user-select:none;
    }
    .checkline input{ transform: translateY(3px) scale(1.05); }

    .btn{
      border:1px solid var(--line);
      background: rgba(122,167,255,.12);
      color: var(--txt);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 650;
      transition: transform .05s ease, background .15s ease;
    }
    .btn:hover{ background: rgba(122,167,255,.18); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{ background: rgba(255,255,255,.06); }
    .btn.secondary:hover{ background: rgba(255,255,255,.10); }
    .btn.danger{ background: rgba(255,92,92,.12); }
    .btn.danger:hover{ background: rgba(255,92,92,.18); }

    .rulebox{
      margin-top: 10px;
      padding: 12px;
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: 14px;
      color: var(--muted);
      line-height: 1.45;
      display:none;
    }
    .rulebox ol{ margin: 0 0 0 18px; padding:0; }
    .rulebox ul{ margin: 6px 0 0 18px; padding:0; }

    .status{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .statusline{
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
      color: var(--muted);
      font-size: 14px;
    }
    .bar{
      width:100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid var(--line);
      overflow:hidden;
    }
    #barFill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(122,167,255,.8), rgba(57,217,138,.85));
    }
    .saved{
      color: var(--muted2);
      font-size: 13px;
    }

    .task{
      padding: 14px;
      border-radius: var(--r);
      border: 1px solid var(--line);
      background: rgba(0,0,0,.20);
    }
    .prompt{
      margin: 0 0 12px;
      font-size: 18px;
      line-height: 1.4;
    }
    .prompt .num{
      font-variant-numeric: tabular-nums;
      font-weight: 800;
      color: #ffffff;
    }
    .prompt .place{
      font-weight: 700;
      color: rgba(255,255,255,.9);
    }
    .inputrow{
      display:flex;
      gap:10px;
      align-items:stretch;
      flex-wrap:wrap;
    }
    #answer{
      flex: 1 1 240px;
      min-width: 200px;
    }
    .feedback{
      margin-top: 10px;
      font-size: 15px;
      line-height: 1.35;
    }
    .feedback.ok{ color: var(--good); font-weight: 700; }
    .feedback.bad{ color: var(--bad); font-weight: 700; }
    .hint{
      margin-top: 8px;
      color: var(--muted);
      font-size: 14px;
      line-height:1.35;
    }

    footer{
      padding: 14px var(--pad) 18px;
      border-top: 1px solid var(--line);
      color: var(--muted);
      font-size: 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    @media (max-width: 520px){
      h1{ font-size:24px; }
      .prompt{ font-size:16px; }
      .btn{ width:100%; }
      #answer{ min-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topline">
      <a href="./index.html">← На главную</a>
      <div>mathexam.space</div>
    </div>

    <div class="card">
      <header>
        <h1>Тренажёр округления</h1>
        <p class="sub">ОГЭ-режим по умолчанию • строгая проверка • подсказки • сохранение прогресса</p>
      </header>

      <div class="grid">
        <div class="panel">
          <h2>Настройки</h2>
          <div class="row">
            <div>
              <label class="lbl">Режим</label>
              <div class="checkline">
                <input id="ogeMode" type="checkbox" checked />
                <div>
                  <div style="font-weight:700;">ОГЭ-режим</div>
                  <div style="color:var(--muted2); font-size:13px; line-height:1.35;">
                    Только целые числа. Разряды: десятки → миллионы.
                  </div>
                </div>
              </div>
            </div>

            <div>
              <label class="lbl" for="countSel">Сколько заданий</label>
              <select id="countSel" class="field">
                <option value="5">5</option>
                <option value="10" selected>10</option>
              </select>
            </div>

            <div>
              <button id="ruleBtn" class="btn secondary" type="button">Напомнить правило</button>
              <div id="ruleBox" class="rulebox"></div>
            </div>

            <div>
              <button id="resetBtn" class="btn danger" type="button">Сбросить прогресс</button>
            </div>
          </div>
        </div>

        <div class="panel">
          <h2>Задание</h2>

          <div class="row" style="margin-bottom:12px;">
            <div>
              <label class="lbl" for="placeSel">Округлять до</label>
              <select id="placeSel" class="field" aria-label="Округлять до">
                <!-- options заполняются скриптом -->
              </select>
            </div>

            <div class="status">
              <div class="statusline">
                <div id="progress">Задание <span id="current">1</span> из <span id="total">10</span></div>
                <div>Верных: <span id="done">0</span>/<span id="tot2">10</span> • Попытки: <span id="attempts">0</span></div>
              </div>
              <div class="bar" aria-hidden="true"><div id="barFill"></div></div>
              <div id="savedLine" class="saved"></div>
            </div>
          </div>

          <div class="task">
            <p class="prompt">Округли <span id="num" class="num">…</span> до <span id="placeSpan" class="place">…</span>.</p>

            <div class="inputrow">
              <input id="answer" class="field" type="text" inputmode="decimal" autocomplete="off" placeholder="Введи ответ" />
              <button id="checkBtn" class="btn" type="button">Проверить</button>
              <button id="nextBtn" class="btn secondary" type="button" style="display:none;">Далее</button>
            </div>

            <div id="feedback" class="feedback" aria-live="polite"></div>
            <div id="hint" class="hint"></div>
          </div>
        </div>
      </div>

      <footer>
        <div><strong>Как это пригодится в делении уголком:</strong> при делении <span style="font-variant-numeric:tabular-nums;">473 : 8</span> можно округлить 473 до 480 → 480 : 8 = 60. Это помогает быстро прикинуть первую цифру частного.</div>
        <div style="color:var(--muted2);">Если после обновления на GitHub Pages что-то «не меняется» — сделайте жёсткое обновление: <strong>Ctrl+F5</strong>.</div>
      </footer>
    </div>
  </div>

  <script>
  (function(){
    "use strict";

    const LS_KEY = "roundingProgress_v3";

    const OGE_PLACES  = [1,2,3,4,5,6];
    const FULL_PLACES = [-3,-2,-1,0,1,2,3,4,5,6];

    const PLACE_LABEL = new Map([
      [-3, "тысячных"],
      [-2, "сотых"],
      [-1, "десятых"],
      [ 0, "единиц"],
      [ 1, "десятков"],
      [ 2, "сотен"],
      [ 3, "тысяч"],
      [ 4, "десятков тысяч"],
      [ 5, "сотен тысяч"],
      [ 6, "миллионов"],
    ]);

    const RULE_TEXT_HTML = `
      <ol>
        <li>Определи разряд, <strong>до которого</strong> округляешь.</li>
        <li>Посмотри на цифру <strong>справа</strong> от этого разряда:
          <ul>
            <li>если она <strong>0–4</strong> → разряд не меняем;</li>
            <li>если она <strong>5–9</strong> → увеличиваем разряд на 1.</li>
          </ul>
        </li>
        <li>Все цифры справа заменяем на нули (или на 0 в десятичной части — до нужного знака).</li>
      </ol>
    `;

    const ogeModeEl = document.getElementById("ogeMode");
    const placeSel  = document.getElementById("placeSel");
    const countSel  = document.getElementById("countSel");

    const currentEl = document.getElementById("current");
    const totalEl   = document.getElementById("total");
    const doneEl    = document.getElementById("done");
    const tot2El    = document.getElementById("tot2");

    const attemptsEl = document.getElementById("attempts");
    const progressEl = document.getElementById("progress");
    const barFillEl  = document.getElementById("barFill");
    const savedLine  = document.getElementById("savedLine");

    const numEl      = document.getElementById("num");
    const placeSpan  = document.getElementById("placeSpan");
    const answerEl   = document.getElementById("answer");

    const checkBtn   = document.getElementById("checkBtn");
    const nextBtn    = document.getElementById("nextBtn");

    const feedbackEl = document.getElementById("feedback");
    const hintEl     = document.getElementById("hint");

    const ruleBtn    = document.getElementById("ruleBtn");
    const ruleBox    = document.getElementById("ruleBox");

    const resetBtn   = document.getElementById("resetBtn");

    let totalTasks = Number(countSel.value) || 10;
    let currentTask = 0;
    let score = 0;
    let attempts = 0;
    let locked = false;
    let task = null;

    function clamp(n, a, b){ return Math.min(b, Math.max(a, n)); }

    function fmtNumberRU(x, exp){
      if (exp < 0){
        const dec = clamp((-exp) + 1, 1, 6);
        const s = Number(x).toFixed(dec).replace(".", ",");
        return s.replace(/,?0+$/, (m)=> m.startsWith(",") ? "" : m);
      }
      return Number(x).toLocaleString("ru-RU");
    }

    function rndInt(min, max){
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function roundToPlace(value, exp){
      if (exp >= 0){
        const unit = Math.pow(10, exp);
        return Math.round(value / unit) * unit;
      } else {
        const scale = Math.pow(10, -exp);
        return Math.round(value * scale) / scale;
      }
    }

    function buildStepHint(original, exp){
      if (exp >= 0){
        const unit = Math.pow(10, exp);
        const rightDigitPlace = exp - 1;
        const rightUnit = Math.pow(10, rightDigitPlace);
        const rightDigit = Math.floor((original % unit) / rightUnit);

        const roundName = PLACE_LABEL.get(exp) || `10^${exp}`;
        const rightName = PLACE_LABEL.get(rightDigitPlace) || `10^${rightDigitPlace}`;

        return `Подсказка: округляем до ${roundName}. Смотрим на разряд ${rightName}: цифра ${rightDigit} ${rightDigit >= 5 ? "≥" : "<"} 5 → ${rightDigit >= 5 ? "увеличиваем" : "оставляем"} округляемый разряд.`;
      }
      const roundName = PLACE_LABEL.get(exp) || `10^${exp}`;
      return `Подсказка: округляем до ${roundName}. Смотрим на следующий знак справа.`;
    }

    function validateAndParseInput(raw, exp){
      const s = String(raw || "").trim();
      if (!s) return { ok:false, msg:"Введите ответ." };

      const oge = ogeModeEl.checked;
      if (oge){
        if (!/^\d+$/.test(s)) return { ok:false, msg:"Введите целое число (без запятых и точек)." };
        return { ok:true, value: Number.parseInt(s, 10) };
      }

      if (exp >= 0){
        if (!/^\d+$/.test(s)) return { ok:false, msg:"Введите целое число." };
        return { ok:true, value: Number.parseInt(s, 10) };
      }

      if (!/^\d+(?:[.,]\d+)?$/.test(s)) return { ok:false, msg:"Введите число (можно с запятой)." };
      const v = Number.parseFloat(s.replace(",", "."));
      if (!Number.isFinite(v)) return { ok:false, msg:"Введите число (можно с запятой)." };
      return { ok:true, value: v };
    }

    function isCorrect(userValue, correctValue, exp){
      if (exp >= 0) return Number(userValue) === Number(correctValue);
      const scale = Math.pow(10, -exp);
      return Math.round(Number(userValue) * scale) === Math.round(Number(correctValue) * scale);
    }

    function updateUI(){
      totalTasks = Number(countSel.value) || 10;

      currentEl.textContent = String(clamp(currentTask + 1, 1, Math.max(1, totalTasks)));
      totalEl.textContent   = String(totalTasks);
      doneEl.textContent    = String(score);
      tot2El.textContent    = String(totalTasks);

      const done = clamp(currentTask, 0, totalTasks);
      const pct = totalTasks ? Math.round((done / totalTasks) * 100) : 0;
      barFillEl.style.width = pct + "%";

      attemptsEl.textContent = String(attempts);
    }

    function saveProgress(){
      const data = {
        oge: ogeModeEl.checked,
        place: placeSel.value,
        count: countSel.value,
        score,
        currentTask,
        savedAt: Date.now()
      };
      try{ localStorage.setItem(LS_KEY, JSON.stringify(data)); }catch(e){}
    }

    function loadProgress(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return null;
        const data = JSON.parse(raw);

        if (typeof data.oge === "boolean") ogeModeEl.checked = data.oge;
        if (data.count) countSel.value = String(data.count);

        const savedPlace = data.place;

        score = Number(data.score) || 0;
        currentTask = Number(data.currentTask) || 0;
        currentTask = clamp(currentTask, 0, (Number(countSel.value) || 10) - 1);

        if (data.savedAt){
          const dt = new Date(data.savedAt);
          savedLine.textContent = `Восстановлен прогресс (последний раз: ${dt.toLocaleString("ru-RU")}).`;
        } else {
          savedLine.textContent = "Восстановлен прогресс.";
        }
        return savedPlace ?? null;
      }catch(e){
        return null;
      }
    }

    function rebuildPlaceOptions(){
      const oge = ogeModeEl.checked;
      const places = oge ? OGE_PLACES : FULL_PLACES;

      const prev = placeSel.value;
      placeSel.innerHTML = "";

      for (const exp of places){
        const opt = document.createElement("option");
        opt.value = String(exp);
        opt.textContent = PLACE_LABEL.get(exp) || `10^${exp}`;
        placeSel.appendChild(opt);
      }

      if (prev && Array.from(placeSel.options).some(o => o.value === prev)){
        placeSel.value = prev;
      } else {
        placeSel.value = oge ? "1" : "0";
      }
    }

    function makeTask(){
      const exp = Number(placeSel.value);
      let value;

      if (exp >= 0){
        const minDigits = Math.max(2, exp + 1);
        const maxDigits = Math.min(8, exp + 5);
        const digits = rndInt(minDigits, maxDigits);

        const min = Math.pow(10, digits - 1);
        const max = Math.pow(10, digits) - 1;
        value = rndInt(min, max);

        if (value % Math.pow(10, exp) === 0){
          value += rndInt(1, 9) * Math.pow(10, Math.max(0, exp-1));
        }
      } else {
        const intPart = rndInt(0, 999);
        const decPlaces = clamp((-exp) + 2, 2, 6);
        const frac = rndInt(0, Math.pow(10, decPlaces) - 1) / Math.pow(10, decPlaces);
        value = intPart + frac;
      }

      const correct = roundToPlace(value, exp);
      return { value, exp, correct };
    }

    function renderTask(){
      attempts = 0;
      locked = false;
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";
      hintEl.textContent = "";
      nextBtn.style.display = "none";
      checkBtn.disabled = false;
      answerEl.value = "";
      answerEl.disabled = false;
      answerEl.focus();

      task = makeTask();
      numEl.textContent = fmtNumberRU(task.value, task.exp);
      placeSpan.textContent = PLACE_LABEL.get(task.exp) || `10^${task.exp}`;

      updateUI();
      saveProgress();
    }

    function finish(){
      locked = true;
      checkBtn.disabled = true;
      nextBtn.style.display = "none";
      answerEl.disabled = true;

      feedbackEl.className = "feedback ok";
      feedbackEl.textContent = `Готово! Верных ответов: ${score} из ${totalTasks}.`;
      hintEl.textContent = "Можно сменить разряд/режим и потренироваться ещё.";
      saveProgress();
    }

    function checkAnswer(){
      if (locked) return;

      const exp = Number(placeSel.value);
      const parsed = validateAndParseInput(answerEl.value, exp);

      if (!parsed.ok){
        feedbackEl.className = "feedback bad";
        feedbackEl.textContent = parsed.msg;
        return;
      }

      attempts += 1;
      attemptsEl.textContent = String(attempts);

      const ok = isCorrect(parsed.value, task.correct, exp);

      if (ok){
        feedbackEl.className = "feedback ok";
        feedbackEl.textContent = `Верно! ${fmtNumberRU(task.value, task.exp)} → ${fmtNumberRU(task.correct, task.exp)}.`;
        hintEl.textContent = "";
        locked = true;

        score += 1;
        doneEl.textContent = String(score);

        nextBtn.style.display = "inline-block";
        checkBtn.disabled = true;

        saveProgress();
        return;
      }

      feedbackEl.className = "feedback bad";
      feedbackEl.textContent = "Неверно. Попробуй ещё.";

      if (attempts >= 2){
        hintEl.textContent = buildStepHint(task.value, exp);
      }

      if (attempts >= 3){
        hintEl.textContent = `${buildStepHint(task.value, exp)} Ответ: ${fmtNumberRU(task.correct, task.exp)}.`;
        locked = true;
        nextBtn.style.display = "inline-block";
        checkBtn.disabled = true;
      }

      saveProgress();
    }

    function next(){
      if (!locked) return;

      currentTask += 1;
      if (currentTask >= totalTasks){
        finish();
        return;
      }
      renderTask();
    }

    function resetAll(){
      try{ localStorage.removeItem(LS_KEY); }catch(e){}
      score = 0;
      currentTask = 0;
      savedLine.textContent = "Прогресс сброшен. Начнём заново.";
      renderTask();
    }

    ruleBtn.addEventListener("click", ()=>{
      const isOpen = ruleBox.style.display === "block";
      ruleBox.innerHTML = RULE_TEXT_HTML;
      ruleBox.style.display = isOpen ? "none" : "block";
      ruleBtn.textContent = isOpen ? "Напомнить правило" : "Скрыть правило";
    });

    resetBtn.addEventListener("click", resetAll);
    checkBtn.addEventListener("click", checkAnswer);
    nextBtn.addEventListener("click", next);

    answerEl.addEventListener("keydown", (e)=>{
      if (e.key === "Enter"){
        e.preventDefault();
        if (locked) next();
        else checkAnswer();
      }
    });

    ogeModeEl.addEventListener("change", ()=>{
      const savedPlace = placeSel.value;
      rebuildPlaceOptions();
      if (savedPlace && Array.from(placeSel.options).some(o => o.value === savedPlace)){
        placeSel.value = savedPlace;
      }
      score = 0;
      currentTask = 0;
      savedLine.textContent = "Режим изменён. Начинаем заново (статистика обнулена).";
      renderTask();
    });

    placeSel.addEventListener("change", ()=>{
      score = 0;
      currentTask = 0;
      savedLine.textContent = "Разряд изменён. Начинаем заново (статистика обнулена).";
      renderTask();
    });

    countSel.addEventListener("change", ()=>{
      score = 0;
      currentTask = 0;
      savedLine.textContent = "Количество заданий изменено. Начинаем заново (статистика обнулена).";
      renderTask();
    });

    const savedPlace = loadProgress();
    rebuildPlaceOptions();

    if (savedPlace != null){
      const exists = Array.from(placeSel.options).some(o => o.value === String(savedPlace));
      if (exists) placeSel.value = String(savedPlace);
    }

    totalTasks = Number(countSel.value) || 10;
    updateUI();
    renderTask();
  })();
  </script>
</body>
</html>

