<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–¢—Ä–µ–Ω–∞–∂—ë—Ä –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è (fresh)</title>

  <!-- –æ–±—â–∏–π —Å—Ç–∏–ª—å —Å–∞–π—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
  <link rel="stylesheet" href="style.css" />
  <!-- —Å—Ç–∏–ª—å —Ç—Ä–µ–Ω–∞–∂—ë—Ä–∞ -->
  <link rel="stylesheet" href="rounding-fresh.css" />
</head>
<body>
  <main class="rf">
    <header class="rf__header">
      <h1 class="rf__title">–¢—Ä–µ–Ω–∞–∂—ë—Ä –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è</h1>
      <p class="rf__subtitle">–°–≤–µ–∂–∞—è –≤–µ—Ä—Å–∏—è ‚Äú—Å –Ω—É–ª—è‚Äù ‚Äî –ø—Ä–æ—Å—Ç–∞—è, —É—Å—Ç–æ–π—á–∏–≤–∞—è, —à–∫–æ–ª—å–Ω–∞—è.</p>
      <p class="rf__back"><a href="index.html">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a></p>
    </header>

    <section class="rf__panel">
      <div class="rf__row">
        <label class="rf__label" for="targetSelect">–û–∫—Ä—É–≥–ª—è–µ–º:</label>
        <select id="targetSelect" class="rf__select" aria-label="–í—ã–±–æ—Ä —Ä–∞–∑—Ä—è–¥–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è"></select>

        <label class="rf__label" for="levelSelect">–£—Ä–æ–≤–µ–Ω—å:</label>
        <select id="levelSelect" class="rf__select rf__select--small" aria-label="–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>

        <label class="rf__toggle" title="–ò–Ω–æ–≥–¥–∞ –±—É–¥—É—Ç –∑–∞–¥–∞—á–∏ ‚Äú–∏–∑ –∂–∏–∑–Ω–∏‚Äù">
          <input type="checkbox" id="appliedToggle" checked />
          <span>–ü—Ä–∏–∫–ª–∞–¥–Ω—ã–µ</span>
        </label>

        <button id="newBtn" class="rf__btn" type="button">–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä</button>
      </div>

      <div class="rf__row rf__row--series">
        <div class="rf__seriesLeft">
          <span class="rf__label">–°–µ—Ä–∏—è:</span>
          <input id="seriesSize" class="rf__input rf__input--tiny" type="number" min="5" max="30" value="10" aria-label="–†–∞–∑–º–µ—Ä —Å–µ—Ä–∏–∏" />
          <button id="startSeriesBtn" class="rf__btn rf__btn--primary" type="button">–°—Ç–∞—Ä—Ç</button>
          <button id="stopSeriesBtn" class="rf__btn rf__btn--ghost" type="button" style="display:none;">–°–±—Ä–æ—Å</button>
        </div>

        <div class="rf__seriesRight">
          <div id="seriesText" class="rf__seriesText">–°–µ—Ä–∏—è –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞</div>
          <div class="rf__bar" aria-hidden="true">
            <div id="seriesBarFill" class="rf__barFill" style="width:0%"></div>
          </div>
        </div>
      </div>

      <div class="rf__stats" aria-label="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞">
        <div class="rf__stat">
          <div class="rf__statValue" id="statSolved">0</div>
          <div class="rf__statLabel">–ü—Ä–æ–≤–µ—Ä–æ–∫</div>
        </div>
        <div class="rf__stat">
          <div class="rf__statValue" id="statCorrect">0</div>
          <div class="rf__statLabel">–í–µ—Ä–Ω–æ</div>
        </div>
        <div class="rf__stat">
          <div class="rf__statValue" id="statAccuracy">0%</div>
          <div class="rf__statLabel">–¢–æ—á–Ω–æ—Å—Ç—å</div>
        </div>
        <div class="rf__stat">
          <div class="rf__statValue" id="statStreak">0</div>
          <div class="rf__statLabel">–°–µ—Ä–∏—è –≤–µ—Ä–Ω—ã—Ö</div>
        </div>
      </div>
    </section>

    <section class="rf__card" aria-label="–ó–∞–¥–∞–Ω–∏–µ">
      <div class="rf__taskLabel">–ó–∞–¥–∞–Ω–∏–µ</div>
      <div id="taskText" class="rf__taskText">–ù–∞–∂–º–∏ ¬´–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä¬ª (–∏–ª–∏ ¬´–°—Ç–∞—Ä—Ç¬ª, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —Å–µ—Ä–∏—é).</div>

      <div class="rf__answerRow">
        <label class="rf__label" for="answerInput">–û—Ç–≤–µ—Ç:</label>
        <input id="answerInput" class="rf__input" inputmode="decimal" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 350 –∏–ª–∏ 3,14" aria-label="–ü–æ–ª–µ –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞" />
        <button id="checkBtn" class="rf__btn rf__btn--check" type="button" aria-label="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <button id="nextBtn" class="rf__btn rf__btn--next" type="button" aria-label="–°–ª–µ–¥—É—é—â–∏–π –ø—Ä–∏–º–µ—Ä">–î–∞–ª—å—à–µ</button>
      </div>

      <div class="rf__actions">
        <button id="hintBtn" class="rf__btn rf__btn--ghost" type="button">–ü–æ–¥—Å–∫–∞–∑–∫–∞</button>
        <button id="solutionBtn" class="rf__btn rf__btn--ghost" type="button">–†–µ—à–µ–Ω–∏–µ</button>
        <button id="resetProgressBtn" class="rf__btn rf__btn--ghost" type="button">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
      </div>

      <div id="message" class="rf__message" aria-live="polite" style="display:none;"></div>
      <div id="solutionBox" class="rf__solution" style="display:none;"></div>

      <div id="storageNote" class="rf__storageNote" style="display:none;">
        –ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è (–±—Ä–∞—É–∑–µ—Ä –∑–∞–ø—Ä–µ—Ç–∏–ª —Ö—Ä–∞–Ω–∏–ª–∏—â–µ). –ù–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.
      </div>
    </section>

    <details class="rf__rules">
      <summary>–ü—Ä–∞–≤–∏–ª–æ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è (–∫–æ—Ä–æ—Ç–∫–æ)</summary>
      <div class="rf__rulesBody">
        <ol>
          <li>–û–ø—Ä–µ–¥–µ–ª–∏ —Ä–∞–∑—Ä—è–¥, <b>–¥–æ –∫–æ—Ç–æ—Ä–æ–≥–æ –æ–∫—Ä—É–≥–ª—è–µ—à—å</b>.</li>
          <li>–ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —Ü–∏—Ñ—Ä—É <b>—Å–ø—Ä–∞–≤–∞</b> –æ—Ç —ç—Ç–æ–≥–æ —Ä–∞–∑—Ä—è–¥–∞.</li>
          <li>–ï—Å–ª–∏ —Å–ø—Ä–∞–≤–∞ <b>0‚Äì4</b> ‚Äî —Ä–∞–∑—Ä—è–¥ –Ω–µ –º–µ–Ω—è–µ–º.</li>
          <li>–ï—Å–ª–∏ —Å–ø—Ä–∞–≤–∞ <b>5‚Äì9</b> ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑—Ä—è–¥ –Ω–∞ 1.</li>
          <li>–¶–∏—Ñ—Ä—ã —Å–ø—Ä–∞–≤–∞ –∑–∞–º–µ–Ω—è–µ–º –Ω—É–ª—è–º–∏ (–¥–ª—è —Ü–µ–ª—ã—Ö) –∏–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –Ω—É–∂–Ω–æ–µ —á–∏—Å–ª–æ –∑–Ω–∞–∫–æ–≤ (–¥–ª—è –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö).</li>
        </ol>
      </div>
    </details>
  </main>

<script>
(() => {
  "use strict";

  // ====== –ö–æ–Ω—Ñ–∏–≥ ======
  const BASE_SCALE = 10000;         // 4 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π "–≤–Ω—É—Ç—Ä–∏" (—Ö–≤–∞—Ç–∞–µ—Ç –¥–æ —Ç—ã—Å—è—á–Ω—ã—Ö)
  const BASE_DECIMALS = 4;
  const EPS = 0;                    // —Ä–∞–±–æ—Ç–∞–µ–º –≤ —Ü–µ–ª—ã—Ö scaled, —Ç–∞–∫ —á—Ç–æ EPS –Ω–µ –Ω—É–∂–µ–Ω
  const STORAGE_KEY = "rounding_fresh_state_v1";
  const CHECK_LOCK_MS = 1200;
  const APPLIED_PROB = 0.22;

  const $ = (id) => document.getElementById(id);

  const el = {
    targetSelect: $("targetSelect"),
    levelSelect: $("levelSelect"),
    appliedToggle: $("appliedToggle"),
    newBtn: $("newBtn"),

    seriesSize: $("seriesSize"),
    startSeriesBtn: $("startSeriesBtn"),
    stopSeriesBtn: $("stopSeriesBtn"),
    seriesText: $("seriesText"),
    seriesBarFill: $("seriesBarFill"),

    statSolved: $("statSolved"),
    statCorrect: $("statCorrect"),
    statAccuracy: $("statAccuracy"),
    statStreak: $("statStreak"),

    taskText: $("taskText"),
    answerInput: $("answerInput"),
    checkBtn: $("checkBtn"),
    nextBtn: $("nextBtn"),

    hintBtn: $("hintBtn"),
    solutionBtn: $("solutionBtn"),
    resetProgressBtn: $("resetProgressBtn"),

    message: $("message"),
    solutionBox: $("solutionBox"),
    storageNote: $("storageNote"),
  };

  // ====== –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ localStorage ======
  const storage = (() => {
    try {
      const t = "__t";
      localStorage.setItem(t, "1");
      localStorage.removeItem(t);
      return localStorage;
    } catch {
      return null;
    }
  })();

  if (!storage) el.storageNote.style.display = "block";

  const safeLoad = () => {
    if (!storage) return null;
    try {
      const raw = storage.getItem(STORAGE_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch {
      return null;
    }
  };

  const safeSave = (obj) => {
    if (!storage) return;
    try {
      storage.setItem(STORAGE_KEY, JSON.stringify(obj));
    } catch {
      // ignore
    }
  };

  // ====== –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ü–µ–ª–µ–π ======
  // step: —à–∞–≥ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è (–≤ "–æ–±—ã—á–Ω—ã—Ö" –µ–¥–∏–Ω–∏—Ü–∞—Ö)
  // decimalsAnswer: —Å–∫–æ–ª—å–∫–æ –∑–Ω–∞–∫–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –æ—Ç–≤–µ—Ç–µ
  const TARGETS = [
    { id: "tens",        label: "–¥–æ –¥–µ—Å—è—Ç–∫–æ–≤",        step: 10,    decimalsAnswer: 0 },
    { id: "hundreds",    label: "–¥–æ —Å–æ—Ç–µ–Ω",          step: 100,   decimalsAnswer: 0 },
    { id: "thousands",   label: "–¥–æ —Ç—ã—Å—è—á",          step: 1000,  decimalsAnswer: 0 },

    { id: "units",       label: "–¥–æ —Ü–µ–ª—ã—Ö",          step: 1,     decimalsAnswer: 0 },

    { id: "tenths",      label: "–¥–æ –¥–µ—Å—è—Ç—ã—Ö",        step: 0.1,   decimalsAnswer: 1 },
    { id: "hundredths",  label: "–¥–æ —Å–æ—Ç—ã—Ö",          step: 0.01,  decimalsAnswer: 2 },
    { id: "thousandths", label: "–¥–æ —Ç—ã—Å—è—á–Ω—ã—Ö",       step: 0.001, decimalsAnswer: 3 },
  ];

  // –ù–∞–ø–æ–ª–Ω—è–µ–º select
  const fillTargetSelect = () => {
    el.targetSelect.innerHTML = "";
    for (const t of TARGETS) {
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = t.label;
      el.targetSelect.appendChild(opt);
    }
  };

  const getTarget = (id) => TARGETS.find(t => t.id === id) || TARGETS[0];

  // ====== –°–æ—Å—Ç–æ—è–Ω–∏–µ ======
  let stats = { solved: 0, correct: 0, streak: 0, bestStreak: 0 };
  let series = { active: false, size: 10, index: 0, correct: 0 }; // index = —Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á –∑–∞–≤–µ—Ä—à–µ–Ω–æ
  let current = null; // —Ç–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞
  let checkLocked = false;

  // ====== –£—Ç–∏–ª–∏—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/–ø–∞—Ä—Å–∏–Ω–≥–∞ ======
  const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

  const toRu = (s) => String(s).replace(".", ",");

  const scaledToStringRu = (scaled, decimals) => {
    // scaled ‚Äî —Ü–µ–ª–æ–µ –≤ BASE_SCALE
    const sign = scaled < 0 ? "-" : "";
    const abs = Math.abs(scaled);

    const intPart = Math.floor(abs / BASE_SCALE);
    const frac = abs % BASE_SCALE;

    if (decimals <= 0) return sign + String(intPart);

    const fracStrFull = String(frac).padStart(BASE_DECIMALS, "0");
    const fracStr = fracStrFull.slice(0, decimals);
    return sign + `${intPart},${fracStr}`;
  };

  const normalizeInput = (s) => {
    let t = (s || "").trim().replace(/\s+/g, "").replace(",", ".");
    if (!t) return "";

    // —Ä–∞–∑—Ä–µ—à–∏–º +
    if (t[0] === "+") t = t.slice(1);

    // —Ç–æ–ª—å–∫–æ –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ (5 –∫–ª–∞—Å—Å)
    if (t[0] === "-") return "NEGATIVE_NOT_ALLOWED";

    // –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
    if (!/^\d+(\.\d+)?$/.test(t)) return "BAD_FORMAT";

    const parts = t.split(".");
    let intPart = parts[0] || "0";
    let fracPart = parts[1] ?? null;

    // –≤–µ–¥—É—â–∏–µ –Ω—É–ª–∏ —É —Ü–µ–ª–æ–π —á–∞—Å—Ç–∏: 0005 -> 5 (–Ω–æ 0 –æ—Å—Ç–∞—ë—Ç—Å—è)
    intPart = intPart.replace(/^0+(?=\d)/, "");
    if (intPart === "") intPart = "0";

    if (fracPart === null) return intPart;
    return intPart + "." + fracPart;
  };

  // –ü–∞—Ä—Å–∏–º –≤ scaled int (BASE_SCALE) + —Ñ–ª–∞–≥ –ª–∏—à–Ω–∏—Ö –ù–ï–Ω—É–ª–µ–≤—ã—Ö —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
  const parseToScaled = (inputNorm, allowedDecimals) => {
    const parts = inputNorm.split(".");
    const intStr = parts[0];
    const fracStrRaw = parts[1] || "";

    const intVal = parseInt(intStr, 10);
    if (!Number.isFinite(intVal)) return { ok: false, reason: "format" };

    // –ª–∏—à–Ω–∏–µ —Ü–∏—Ñ—Ä—ã –ø–æ—Å–ª–µ allowedDecimals (–µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –Ω—É–ª–∏ ‚Äî –æ—Ç–≤–µ—Ç "–Ω–µ –æ–∫—Ä—É–≥–ª—ë–Ω")
    let extraNonZero = false;
    if (fracStrRaw.length > allowedDecimals) {
      extraNonZero = [...fracStrRaw.slice(allowedDecimals)].some(ch => ch !== "0");
    }

    // –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–µ BASE_DECIMALS –∑–Ω–∞–∫–æ–≤, –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–µ ‚Äî –Ω—É–ª–∏
    const fracPadded = (fracStrRaw + "0".repeat(BASE_DECIMALS)).slice(0, BASE_DECIMALS);
    const fracVal = parseInt(fracPadded || "0", 10);

    const scaled = intVal * BASE_SCALE + (Number.isFinite(fracVal) ? fracVal : 0);
    return { ok: true, scaled, extraNonZero };
  };

  // ====== –õ–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á ======
  const stepToScaled = (step) => Math.round(step * BASE_SCALE);

  const rightPlaceScaled = (stepScaled) => Math.floor(stepScaled / 10);

  const digitAt = (nScaled, placeScaled) => {
    if (placeScaled <= 0) return 0;
    return Math.floor(nScaled / placeScaled) % 10;
  };

  const getRange = (target, level) => {
    const lvl = Number(level) || 1;
    const step = target.step;

    if (step === 10) {
      if (lvl === 1) return [10, 99];
      if (lvl === 2) return [100, 999];
      return [1000, 9999];
    }

    if (step === 100) {
      if (lvl === 1) return [100, 999];
      if (lvl === 2) return [1000, 9999];
      return [10000, 99999];
    }

    if (step === 1000) {
      if (lvl === 1) return [1000, 9999];
      if (lvl === 2) return [10000, 99999];
      return [100000, 999999];
    }

    // –¥–æ —Ü–µ–ª—ã—Ö –∏ –¥–µ—Å—è—Ç–∏—á–Ω—ã–µ: –º–µ–Ω—è–µ–º —Ü–µ–ª—É—é —á–∞—Å—Ç—å
    if (step <= 1) {
      if (lvl === 1) return [0, 99];
      if (lvl === 2) return [0, 999];
      return [0, 9999];
    }

    // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
    return [1, 999];
  };

  const makeAppliedText = (displayN, targetLabel, target) => {
    const isIntLike = target.step >= 1;

    const intTemplates = [
      (x) => `–¶–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞ ${x} —Ä—É–±. –û–∫—Ä—É–≥–ª–∏—Ç–µ –¥–æ ${targetLabel} –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ—Ü–µ–Ω–∫–∏.`,
      (x) => `–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ ${x} –∫–º. –û–∫—Ä—É–≥–ª–∏—Ç–µ –¥–æ ${targetLabel}.`,
      (x) => `–í –∑–∞–ª–µ ${x} –∑—Ä–∏—Ç–µ–ª–µ–π. –û–∫—Ä—É–≥–ª–∏—Ç–µ –¥–æ ${targetLabel}.`,
      (x) => `–ù–∞ —Å–∫–ª–∞–¥–µ ${x} –∫–æ—Ä–æ–±–æ–∫. –û–∫—Ä—É–≥–ª–∏—Ç–µ –¥–æ ${targetLabel}.`,
    ];

    const decTemplates = [
      (x) => `–î–ª–∏–Ω–∞ –¥–æ—Å–∫–∏ ${x} –º. –û–∫—Ä—É–≥–ª–∏—Ç–µ –¥–æ ${targetLabel}.`,
      (x) => `–ú–∞—Å—Å–∞ —Ç–æ–≤–∞—Ä–∞ ${x} –∫–≥. –û–∫—Ä—É–≥–ª–∏—Ç–µ –¥–æ ${targetLabel}.`,
      (x) => `–®–∏—Ä–∏–Ω–∞ –ª–µ–Ω—Ç—ã ${x} –º. –û–∫—Ä—É–≥–ª–∏—Ç–µ –¥–æ ${targetLabel}.`,
    ];

    const pool = isIntLike ? intTemplates : decTemplates;
    return pool[randInt(0, pool.length - 1)](displayN);
  };

  const generateTask = () => {
    const target = getTarget(el.targetSelect.value);
    const level = el.levelSelect.value;

    const stepScaled = stepToScaled(target.step);
    const allowedDecimals = target.decimalsAnswer; // —Å–∫–æ–ª—å–∫–æ –∑–Ω–∞–∫–æ–≤ –¥–æ–ø—É—Å—Ç–∏–º–æ –≤ –æ—Ç–≤–µ—Ç–µ

    // —Å–∫–æ–ª—å–∫–æ –∑–Ω–∞–∫–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ —Å–∞–º–æ–º —á–∏—Å–ª–µ, —á—Ç–æ–±—ã –±—ã–ª–∞ "—Ü–∏—Ñ—Ä–∞ —Å–ø—Ä–∞–≤–∞"
    let decimalsInTask = allowedDecimals;
    if (target.id === "units") {
      // –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ —Ü–µ–ª—ã—Ö ‚Äî –ø—É—Å—Ç—å –±—É–¥—É—Ç –¥–µ—Å—è—Ç—ã–µ/—Å–æ—Ç—ã–µ, —á—Ç–æ–±—ã –±—ã–ª–æ —Å–º—ã—Å–ª –æ–∫—Ä—É–≥–ª—è—Ç—å
      decimalsInTask = Math.random() < 0.5 ? 1 : 2;
    } else if (target.step < 1) {
      // –¥–æ –¥–µ—Å—è—Ç—ã—Ö –Ω—É–∂–µ–Ω –∫–∞–∫ –º–∏–Ω–∏–º—É–º 2 –∑–Ω–∞–∫–∞, –¥–æ —Å–æ—Ç—ã—Ö ‚Äî 3, –¥–æ —Ç—ã—Å—è—á–Ω—ã—Ö ‚Äî 4
      decimalsInTask = Math.min(BASE_DECIMALS, allowedDecimals + 1);
    } else {
      decimalsInTask = 0; // –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ —á–∏—Å–ª–∞
    }

    const [minInt, maxInt] = getRange(target, level);

    let nScaled = 0;

    if (decimalsInTask === 0) {
      // —Ü–µ–ª–æ–µ
      let n = randInt(minInt, maxInt);

      // –∏–∑–±–µ–≥–∞–µ–º —Å–∫—É—á–Ω—ã—Ö –∫—Ä–∞—Ç–Ω—ã—Ö —à–∞–≥—É (—á—É—Ç—å-—á—É—Ç—å)
      if (target.step >= 10) {
        const step = target.step;
        if (n % step === 0) {
          const add = randInt(1, Math.min(9, step - 1));
          if (n + add <= maxInt) n += add;
        }
      }

      nScaled = n * BASE_SCALE;
    } else {
      // –¥–µ—Å—è—Ç–∏—á–Ω–æ–µ: –±–µ—Ä—ë–º –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞–∫–æ–≤
      const intPart = randInt(minInt, maxInt);
      const digits = decimalsInTask;

      const denom = Math.pow(10, digits);
      const frac = randInt(0, denom - 1);

      // –ø–µ—Ä–µ–≤–æ–¥–∏–º frac –≤ BASE_SCALE
      const shift = Math.pow(10, BASE_DECIMALS - digits);
      nScaled = intPart * BASE_SCALE + frac * shift;
    }

    const answerScaled = Math.round(nScaled / stepScaled) * stepScaled;

    const displayN = scaledToStringRu(nScaled, decimalsInTask);
    const displayAnswer = scaledToStringRu(answerScaled, allowedDecimals);

    const useApplied = el.appliedToggle.checked && Math.random() < APPLIED_PROB;
    const prompt = useApplied
      ? makeAppliedText(displayN, target.label, target)
      : `–û–∫—Ä—É–≥–ª–∏—Ç–µ —á–∏—Å–ª–æ ${displayN} ${target.label}.`;

    // —Ü–∏—Ñ—Ä–∞ —Å–ø—Ä–∞–≤–∞ (–¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è)
    const rightScaled = rightPlaceScaled(stepScaled);
    const lookDigit = digitAt(nScaled, rightScaled);

    // –Ω–∞–∑–≤–∞–Ω–∏—è —Ä–∞–∑—Ä—è–¥–æ–≤ —Å–ø—Ä–∞–≤–∞ (–¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏/—Ä–µ—à–µ–Ω–∏—è)
    const rightName = (() => {
      const map = {
        "tens": "–µ–¥–∏–Ω–∏—Ü—ã",
        "hundreds": "–¥–µ—Å—è—Ç–∫–∏",
        "thousands": "—Å–æ—Ç–Ω–∏",
        "units": "–¥–µ—Å—è—Ç—ã–µ",
        "tenths": "—Å–æ—Ç—ã–µ",
        "hundredths": "—Ç—ã—Å—è—á–Ω—ã–µ",
        "thousandths": "–¥–µ—Å—è—Ç–∏—Ç—ã—Å—è—á–Ω—ã–µ",
      };
      return map[target.id] || "—Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑—Ä—è–¥";
    })();

    return {
      targetId: target.id,
      targetLabel: target.label,
      step: target.step,
      stepScaled,
      allowedDecimals,
      decimalsInTask,
      nScaled,
      displayN,
      answerScaled,
      displayAnswer,
      prompt,
      rightName,
      lookDigit,

      // –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∑–∞–¥–∞—á–µ
      attempts: 0,
      solved: false,
    };
  };

  // ====== UI / —Å–æ–æ–±—â–µ–Ω–∏—è ======
  const setMessage = (text, kind) => {
    if (!text) {
      el.message.style.display = "none";
      el.message.textContent = "";
      el.message.className = "rf__message";
      return;
    }
    el.message.style.display = "block";
    el.message.textContent = text;
    el.message.className = "rf__message " + (kind ? `rf__message--${kind}` : "");
  };

  const showSolution = (html) => {
    el.solutionBox.style.display = "block";
    el.solutionBox.innerHTML = html;
  };

  const hideSolution = () => {
    el.solutionBox.style.display = "none";
    el.solutionBox.innerHTML = "";
  };

  const updateStatsUI = () => {
    el.statSolved.textContent = String(stats.solved);
    el.statCorrect.textContent = String(stats.correct);
    const acc = stats.solved ? Math.round((stats.correct / stats.solved) * 100) : 0;
    el.statAccuracy.textContent = `${acc}%`;
    el.statStreak.textContent = String(stats.streak);
  };

  const updateSeriesUI = () => {
    if (!series.active) {
      el.seriesText.textContent = "–°–µ—Ä–∏—è –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞";
      el.seriesBarFill.style.width = "0%";
      el.stopSeriesBtn.style.display = "none";
      return;
    }

    const done = series.index;
    const total = series.size;
    const left = Math.max(0, total - done);
    const pct = Math.round((done / total) * 100);

    el.seriesText.textContent = `–ó–∞–¥–∞–Ω–∏–µ ${Math.min(done + 1, total)} –∏–∑ ${total} ‚Ä¢ –í–µ—Ä–Ω–æ: ${series.correct} ‚Ä¢ –û—Å—Ç–∞–ª–æ—Å—å: ${left}`;
    el.seriesBarFill.style.width = `${pct}%`;
    el.stopSeriesBtn.style.display = "inline-flex";
  };

  const persist = () => {
    safeSave({
      targetId: el.targetSelect.value,
      level: el.levelSelect.value,
      applied: !!el.appliedToggle.checked,

      stats,
      series,

      current,
      checkLocked: false, // —á—Ç–æ–±—ã –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –∑–∞—Å—Ç—Ä—è—Ç—å
    });
  };

  const restore = () => {
    const saved = safeLoad();
    if (!saved) return;

    // –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    if (typeof saved.targetId === "string") el.targetSelect.value = saved.targetId;
    if (typeof saved.level === "string") el.levelSelect.value = saved.level;
    if (typeof saved.applied === "boolean") el.appliedToggle.checked = saved.applied;

    // —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    if (saved.stats) stats = { ...stats, ...saved.stats };
    if (saved.series) series = { ...series, ...saved.series };

    // —Ç–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞
    if (saved.current) current = saved.current;

    updateStatsUI();
    updateSeriesUI();

    if (current) {
      el.taskText.textContent = current.prompt || `–û–∫—Ä—É–≥–ª–∏—Ç–µ —á–∏—Å–ª–æ ${current.displayN} ${current.targetLabel}.`;
      el.answerInput.focus();
    }
  };

  // ====== –ü–æ–≤–µ–¥–µ–Ω–∏–µ ======
  const setCheckLocked = (locked) => {
    checkLocked = locked;
    el.checkBtn.disabled = locked;
    el.checkBtn.textContent = locked ? "–ü—Ä–æ–≤–µ—Ä—è—é‚Ä¶" : "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å";
  };

  const newTask = () => {
    current = generateTask();

    // –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
    el.taskText.textContent = current.prompt;
    el.answerInput.value = "";
    el.answerInput.focus();

    setMessage("", "");
    hideSolution();

    persist();
  };

  const startSeries = () => {
    const size = Math.max(5, Math.min(30, Number(el.seriesSize.value) || 10));
    series = { active: true, size, index: 0, correct: 0 };
    updateSeriesUI();

    setMessage("–°–µ—Ä–∏—è –∑–∞–ø—É—â–µ–Ω–∞ ‚úÖ –†–µ—à–∞–π –∏ –∂–º–∏ ¬´–î–∞–ª—å—à–µ¬ª.", "ok");
    newTask();
    persist();
  };

  const stopSeries = () => {
    series = { active: false, size: 10, index: 0, correct: 0 };
    updateSeriesUI();
    setMessage("–°–µ—Ä–∏—è —Å–±—Ä–æ—à–µ–Ω–∞.", "info");
    persist();
  };

  const finishSeriesIfNeeded = () => {
    if (!series.active) return;
    if (series.index >= series.size) {
      series.active = false;
      updateSeriesUI();
      setMessage(`–°–µ—Ä–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: ${series.correct}/${series.size}`, "ok");
      persist();
    }
  };

  const hintText = () => {
    if (!current) return "";
    return `–ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø—Ä–∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–∏ ${current.targetLabel} —Å–º–æ—Ç—Ä–∏–º –Ω–∞ ${current.rightName}. –ï—Å–ª–∏ —Ü–∏—Ñ—Ä–∞ 0‚Äì4 ‚Äî —Ä–∞–∑—Ä—è–¥ –Ω–µ –º–µ–Ω—è–µ–º; –µ—Å–ª–∏ 5‚Äì9 ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º.`;
  };

  const solutionHTML = () => {
    if (!current) return "";
    const d = current.lookDigit;
    const rule = d >= 5
      ? `–¶–∏—Ñ—Ä–∞ ${d} ‚â• 5 ‚Üí —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑—Ä—è–¥ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è.`
      : `–¶–∏—Ñ—Ä–∞ ${d} < 5 ‚Üí —Ä–∞–∑—Ä—è–¥ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –Ω–µ –º–µ–Ω—è–µ–º.`;

    return `
      <div class="rf__solutionTitle">–†–∞–∑–±–æ—Ä</div>
      <div>–û–∫—Ä—É–≥–ª—è–µ–º <b>${current.targetLabel}</b>.</div>
      <div>–°–º–æ—Ç—Ä–∏–º –Ω–∞ <b>${current.rightName}</b>: —Ç–∞–º —Ü–∏—Ñ—Ä–∞ <b>${d}</b>.</div>
      <div>${rule}</div>
      <div class="rf__solutionAnswer">–û—Ç–≤–µ—Ç: <b>${current.displayAnswer}</b></div>
    `;
  };

  const checkAnswer = () => {
    if (checkLocked) return;

    if (!current) {
      setMessage("–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ ¬´–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä¬ª.", "info");
      return;
    }

    setCheckLocked(true);
    setTimeout(() => setCheckLocked(false), CHECK_LOCK_MS);

    const norm = normalizeInput(el.answerInput.value);

    if (norm === "NEGATIVE_NOT_ALLOWED") {
      setMessage("–ó–¥–µ—Å—å —Ç—Ä–µ–Ω–∏—Ä—É–µ–º —à–∫–æ–ª—å–Ω–æ–µ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö —á–∏—Å–µ–ª üôÇ", "bad");
      return;
    }
    if (norm === "BAD_FORMAT" || !norm) {
      setMessage("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ. –ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å —Å –∑–∞–ø—è—Ç–æ–π –∏–ª–∏ —Ç–æ—á–∫–æ–π.", "info");
      return;
    }

    const parsed = parseToScaled(norm, current.allowedDecimals);
    if (!parsed.ok) {
      setMessage("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.", "bad");
      return;
    }

    if (parsed.extraNonZero) {
      setMessage("–ü–æ—Ö–æ–∂–µ, –æ—Ç–≤–µ—Ç –µ—â—ë –Ω–µ –æ–∫—Ä—É–≥–ª—ë–Ω –¥–æ –Ω—É–∂–Ω–æ–≥–æ —Ä–∞–∑—Ä—è–¥–∞ (–ª–∏—à–Ω–∏–µ —Ü–∏—Ñ—Ä—ã –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π).", "bad");
      return;
    }

    current.attempts += 1;

    const ok = (parsed.scaled === current.answerScaled);

    // —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: —Å—á–∏—Ç–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ–≥–¥–∞ (—ç—Ç–æ —á–µ—Å—Ç–Ω–µ–µ –∫–∞–∫ —Ç—Ä–µ–Ω–∞–∂—ë—Ä)
    stats.solved += 1;

    if (ok) {
      if (!current.solved) {
        current.solved = true;
        stats.correct += 1;
      }
      stats.streak += 1;
      stats.bestStreak = Math.max(stats.bestStreak, stats.streak);

      setMessage("–í–µ—Ä–Ω–æ ‚úÖ", "ok");
    } else {
      stats.streak = 0;

      if (current.attempts >= 3) {
        setMessage(`–ù–µ–≤–µ—Ä–Ω–æ ‚ùå –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${current.displayAnswer}`, "bad");
        showSolution(solutionHTML());
      } else if (current.attempts >= 2) {
        setMessage("–ù–µ–≤–µ—Ä–Ω–æ ‚ùå " + hintText(), "bad");
      } else {
        setMessage("–ù–µ–≤–µ—Ä–Ω–æ ‚ùå –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.", "bad");
      }
    }

    updateStatsUI();
    persist();
  };

  const nextTask = () => {
    if (!current) {
      newTask();
      return;
    }

    // –µ—Å–ª–∏ —Å–µ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–∞ ‚Äî —Å—á–∏—Ç–∞–µ–º –∑–∞–¥–∞—á—É –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π –ø–æ –∫–Ω–æ–ø–∫–µ "–î–∞–ª—å—à–µ"
    if (series.active) {
      series.index += 1;
      if (current.solved) series.correct += 1;

      updateSeriesUI();
      persist();
      finishSeriesIfNeeded();

      if (!series.active) {
        // —Å–µ—Ä–∏—è –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å ‚Äî –Ω–µ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        current = null;
        el.taskText.textContent = "–°–µ—Ä–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª –∏–ª–∏ ¬´–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä¬ª.";
        el.answerInput.value = "";
        el.answerInput.blur();
        hideSolution();
        return;
      }
    }

    newTask();
  };

  const resetProgress = () => {
    const ok = confirm("–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å —ç—Ç–æ–≥–æ —Ç—Ä–µ–Ω–∞–∂—ë—Ä–∞?");
    if (!ok) return;

    stats = { solved: 0, correct: 0, streak: 0, bestStreak: 0 };
    series = { active: false, size: 10, index: 0, correct: 0 };
    current = null;

    updateStatsUI();
    updateSeriesUI();
    setMessage("–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω.", "info");
    hideSolution();

    if (storage) {
      try { storage.removeItem(STORAGE_KEY); } catch {}
    }
  };

  // ====== –°–æ–±—ã—Ç–∏—è ======
  window.addEventListener("error", (e) => {
    console.error(e);
    setMessage("–£–ø—Å, –æ—à–∏–±–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ. –ü–æ–ø—Ä–æ–±—É–π ¬´–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å¬ª –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.", "bad");
  });

  el.newBtn.addEventListener("click", () => {
    // –≤ —Å–µ—Ä–∏–∏ "–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä" –Ω–µ –∑–∞–ø—Ä–µ—â–∞–µ–º, –Ω–æ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å "–î–∞–ª—å—à–µ"
    newTask();
  });

  el.startSeriesBtn.addEventListener("click", startSeries);
  el.stopSeriesBtn.addEventListener("click", stopSeries);

  el.checkBtn.addEventListener("click", checkAnswer);
  el.nextBtn.addEventListener("click", nextTask);

  el.answerInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") checkAnswer();
  });

  el.hintBtn.addEventListener("click", () => {
    if (!current) return;
    setMessage(hintText(), "info");
  });

  el.solutionBtn.addEventListener("click", () => {
    if (!current) return;
    if (el.solutionBox.style.display === "none") showSolution(solutionHTML());
    else hideSolution();
  });

  el.resetProgressBtn.addEventListener("click", resetProgress);

  // –ø—Ä–∏ —Å–º–µ–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º, —Ç–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É –Ω–µ –ª–æ–º–∞–µ–º
  el.targetSelect.addEventListener("change", () => { persist(); });
  el.levelSelect.addEventListener("change", () => { persist(); });
  el.appliedToggle.addEventListener("change", () => { persist(); });

  // ====== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ======
  fillTargetSelect();

  // –¥–µ—Ñ–æ–ª—Ç: 5 –∫–ª–∞—Å—Å ‚Äî –¥–µ—Å—è—Ç–∫–∏
  el.targetSelect.value = "tens";

  restore();
  updateStatsUI();
  updateSeriesUI();
})();
</script>
</body>
</html>
