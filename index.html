<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MathExam — ОГЭ (ФИПИ) • тренажёры и задачи</title>
  <meta name="description" content="Тренажёры и задачи по математике (ОГЭ/ФИПИ). Удобная навигация, спокойный дизайн." />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header class="header">
    <div class="container header__inner">
      <div class="brand">
        <div class="brand__logo" aria-hidden="true">∑</div>
        <div class="brand__text">
          <div class="brand__title">MathExam</div>
          <div class="brand__subtitle">ОГЭ (ФИПИ) • тренажёры • задачи</div>
        </div>
      </div>

      <nav class="nav">
        <a class="nav__link" href="#trainers">Тренажёры</a>
        <a class="nav__link" href="#materials">Задачи</a>
        <a class="nav__link" href="#all">Все страницы</a>
        <a class="nav__link nav__link--ghost" href="https://github.com/ladynata-cloud/math-exam-fipi" target="_blank" rel="noopener">GitHub</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div class="hero__left">
        <h1 class="hero__title">Домашний “ФИПИ-удобно”</h1>
        <p class="hero__text">
          Тренажёры и странички с задачами. Главная страница сама подхватывает всё, что ты уже добавила в репозиторий —
          не нужно вручную править меню каждый раз.
        </p>

        <div class="hero__actions">
          <a class="btn" href="#trainers">Открыть тренажёры</a>
          <a class="btn btn--soft" href="#materials">Открыть задачи</a>
        </div>

        <div class="hero__note">
          <span class="pill">Совет</span>
          Ссылки ниже обновятся автоматически после коммита новых HTML-страниц в репозиторий.
        </div>
      </div>

      <div class="hero__right">
        <div class="panel">
          <div class="panel__title">Быстрый доступ</div>
          <div class="panel__grid">
            <a class="mini" href="trainers/trainers/long-division.html">
              <div class="mini__title">Деление уголком</div>
              <div class="mini__text">Пошагово, как в тетради</div>
            </a>
            <a class="mini" href="trainers/trainers/long-multiplication-oge.html">
              <div class="mini__title">Умножение столбиком</div>
              <div class="mini__text">ОГЭ-режим: переносы</div>
            </a>
          </div>

          <div class="panel__footer">
            <span class="muted">Если ссылка не открылась — проверь, что файл лежит по указанному пути.</span>
          </div>
        </div>
      </div>
    </section>

    <!-- TRAINERS -->
    <section id="trainers" class="section">
      <div class="section__head">
        <h2 class="section__title">Тренажёры</h2>
        <p class="section__desc">Все тренажёры из папки <span class="mono">trainers/</span> (и вложенных).</p>
      </div>

      <div class="cards" id="trainersList">
        <!-- Fallback (если GitHub API недоступен) -->
        <a class="card" href="trainers/trainers/long-division.html">
          <div class="card__title">Деление уголком</div>
          <div class="card__meta">trainers/trainers/long-division.html</div>
          <div class="card__text">Алгоритм деления “как в школе”, по шагам.</div>
        </a>

        <a class="card" href="trainers/trainers/long-multiplication-oge.html">
          <div class="card__title">Умножение столбиком (ОГЭ)</div>
          <div class="card__meta">trainers/trainers/long-multiplication-oge.html</div>
          <div class="card__text">Поразрядно + переносы: для тех, кто забывает алгоритм.</div>
        </a>
      </div>
    </section>

    <!-- MATERIALS / TASKS -->
    <section id="materials" class="section">
      <div class="section__head">
        <h2 class="section__title">Задачи и материалы</h2>
        <p class="section__desc">
          Автосбор: странички из репозитория (кроме <span class="mono">index.html</span> и тренажёров).
          ЕГЭ/ВПР скрыты по умолчанию.
        </p>
      </div>

      <div class="toolbar">
        <label class="field">
          <span class="field__label">Поиск</span>
          <input id="q" class="input" type="search" placeholder="например: 1-20, проценты, дроби, ФИПИ..." />
        </label>

        <label class="check">
          <input id="showAll" type="checkbox" />
          <span>Показывать всё (включая ЕГЭ/ВПР/черновики)</span>
        </label>

        <button id="reload" class="btn btn--soft" type="button">Обновить список</button>
      </div>

      <div class="notice" id="statusBox">
        Загружаю список файлов из GitHub…
      </div>

      <div class="cards" id="materialsList"></div>
    </section>

    <!-- ALL PAGES -->
    <section id="all" class="section">
      <div class="section__head">
        <h2 class="section__title">Все HTML-страницы (списком)</h2>
        <p class="section__desc">Если нужно просто быстро открыть всё, что уже есть на сайте.</p>
      </div>

      <div class="list" id="allList"></div>
    </section>

    <footer class="footer">
      <div class="footer__row">
        <div class="muted">© <span id="year"></span> mathexam.space</div>
        <div class="muted">Сделано спокойно и читабельно ✦</div>
      </div>
    </footer>
  </main>

<script>
(() => {
  // ==== НАСТРОЙКА (если когда-то сменишь репозиторий/ветку) ====
  const CONFIG = {
    owner: "ladynata-cloud",
    repo: "math-exam-fipi",
    branch: "main",
  };

  // По умолчанию скрываем “не то”
  const HIDE_DIRS_DEFAULT = new Set([
    ".github", "assets", "img", "images", "css", "js",
    "ege", "vpr", "drafts", "archive", "tmp"
  ]);

  // Допускаем html/htm/pdf (если вдруг есть pdf-разборы)
  const ALLOW_EXT = new Set([".html", ".htm", ".pdf"]);

  const el = (id) => document.getElementById(id);

  const trainersList = el("trainersList");
  const materialsList = el("materialsList");
  const allList = el("allList");
  const statusBox = el("statusBox");

  const qInput = el("q");
  const showAll = el("showAll");
  const reloadBtn = el("reload");

  document.getElementById("year").textContent = new Date().getFullYear();

  const API_BASE = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents`;

  function ext(name) {
    const i = name.lastIndexOf(".");
    return i >= 0 ? name.slice(i).toLowerCase() : "";
  }

  function isAllowedFile(item) {
    if (item.type !== "file") return false;
    const e = ext(item.name);
    return ALLOW_EXT.has(e);
  }

  function isHtmlFile(item) {
    const e = ext(item.name);
    return item.type === "file" && (e === ".html" || e === ".htm");
  }

  function niceTitleFromPath(path) {
    // trainers/trainers/long-division.html -> long-division
    const base = path.split("/").pop().replace(/\.(html|htm|pdf)$/i, "");
    return base
      .replace(/[-_]+/g, " ")
      .replace(/\b(oge|ege|vpr|fipi)\b/gi, (m) => m.toUpperCase())
      .trim()
      .replace(/^./, c => c.toUpperCase());
  }

  function hrefFromPath(path) {
    // index.html в корне -> "index.html" (но мы его не показываем)
    return path;
  }

  function cardHTML(item, badge) {
    const title = item.title || niceTitleFromPath(item.path);
    const meta = item.path;
    const desc = item.desc || "";
    return `
      <a class="card" href="${hrefFromPath(item.path)}">
        <div class="card__row">
          <div class="card__title">${title}</div>
          ${badge ? `<div class="badge">${badge}</div>` : ``}
        </div>
        <div class="card__meta">${meta}</div>
        ${desc ? `<div class="card__text">${desc}</div>` : ``}
      </a>
    `;
  }

  function listItemHTML(item) {
    const title = item.title || niceTitleFromPath(item.path);
    return `<a class="list__item" href="${hrefFromPath(item.path)}">${title}<span class="list__meta">${item.path}</span></a>`;
  }

  async function fetchJSON(url) {
    const res = await fetch(url, { headers: { "Accept": "application/vnd.github+json" } });
    if (!res.ok) throw new Error(`GitHub API ${res.status}`);
    return res.json();
  }

  async function listDir(path = "") {
    const url = `${API_BASE}/${path ? encodeURI(path) : ""}?ref=${encodeURIComponent(CONFIG.branch)}`;
    return fetchJSON(url);
  }

  async function scanSelectedDirs(root) {
    // Берём “понятные” директории, чтобы не делать сотни запросов
    // + trainers (отдельно)
    const dirs = root
      .filter(x => x.type === "dir")
      .map(x => x.name);

    const candidates = new Set();

    for (const d of dirs) {
      // В задачи обычно кладут так:
      if (/oge|fipi|tasks|task|materials|variants|variant|problems|problem|lessons|topics/i.test(d)) {
        candidates.add(d);
      }
      if (d.toLowerCase() === "trainers") candidates.add(d);
    }

    // На всякий случай: если задач пока мало, всё равно покажем html из корня
    return Array.from(candidates);
  }

  function shouldHidePath(path, showAllChecked) {
    if (showAllChecked) return false;
    const parts = path.split("/").map(p => p.toLowerCase());
    return parts.some(p => HIDE_DIRS_DEFAULT.has(p));
  }

  function applyQuery(items, query) {
    const q = (query || "").trim().toLowerCase();
    if (!q) return items;
    return items.filter(it =>
      it.path.toLowerCase().includes(q) ||
      (it.title && it.title.toLowerCase().includes(q))
    );
  }

  async function build() {
    statusBox.textContent = "Загружаю список файлов из GitHub…";
    statusBox.className = "notice";

    let root;
    try {
      root = await listDir("");
    } catch (e) {
      statusBox.textContent =
        "Не получилось загрузить список с GitHub (возможны ограничения сети). " +
        "Ниже остаются рабочие “ручные” ссылки на тренажёры.";
      statusBox.className = "notice notice--warn";
      return;
    }

    // 1) Собираем тренажёры: trainers/… (глубина 2)
    const trainers = [];
    const materials = [];
    const allPages = [];

    // html/pdf в корне (кроме index.html)
    for (const it of root) {
      if (isAllowedFile(it) && it.name.toLowerCase() !== "index.html") {
        const obj = { path: it.path, title: niceTitleFromPath(it.path) };
        allPages.push(obj);

        // в материалы — только не trainers
        if (!it.path.toLowerCase().includes("trainers/")) {
          materials.push(obj);
        }
      }
    }

    const dirsToScan = await scanSelectedDirs(root);

    // ограничим число запросов: сканируем только выбранные директории, максимум 10
    const limited = dirsToScan.slice(0, 10);

    for (const d of limited) {
      // trainers — особый случай: там часто trainers/trainers/…
      try {
        const level1 = await listDir(d);
        for (const it of level1) {
          if (it.type === "dir") {
            // один уровень внутрь
            const level2 = await listDir(it.path);
            for (const f of level2) {
              if (isAllowedFile(f) && f.name.toLowerCase() !== "index.html") {
                const obj = { path: f.path, title: niceTitleFromPath(f.path) };
                allPages.push(obj);

                if (obj.path.toLowerCase().includes("trainers/")) trainers.push(obj);
                else materials.push(obj);
              }
            }
          } else if (isAllowedFile(it) && it.name.toLowerCase() !== "index.html") {
            const obj = { path: it.path, title: niceTitleFromPath(it.path) };
            allPages.push(obj);

            if (obj.path.toLowerCase().includes("trainers/")) trainers.push(obj);
            else materials.push(obj);
          }
        }
      } catch (e) {
        // если директория не читается — просто пропускаем
      }
    }

    // дедуп
    const uniqByPath = (arr) => {
      const m = new Map();
      for (const x of arr) m.set(x.path, x);
      return Array.from(m.values()).sort((a,b) => a.path.localeCompare(b.path, "ru"));
    };

    const trainersU = uniqByPath(trainers);
    const materialsU = uniqByPath(materials);
    const allU = uniqByPath(allPages).filter(x => isHtmlFile({type:"file", name:x.path, path:x.path}));

    // Фильтрация (по умолчанию скрываем ege/vpr и т.п.)
    const showAllChecked = showAll.checked;
    const q = qInput.value;

    const trainersV = applyQuery(trainersU, q).filter(x => !shouldHidePath(x.path, showAllChecked));
    const materialsV = applyQuery(materialsU, q).filter(x => !shouldHidePath(x.path, showAllChecked));

    // trainers section
    if (trainersV.length) {
      trainersList.innerHTML = trainersV.map(x => cardHTML(x, "Тренажёр")).join("");
    }

    // materials section
    materialsList.innerHTML = materialsV.length
      ? materialsV.map(x => cardHTML(x, "Страница")).join("")
      : `<div class="empty">Пока не нашла подходящих страниц. Проверь, что они лежат в репозитории и имеют расширение .html</div>`;

    // all pages list (только html)
    const allFiltered = applyQuery(allU, q).filter(x => !shouldHidePath(x.path, showAllChecked));
    allList.innerHTML = allFiltered.length
      ? allFiltered.map(x => listItemHTML(x)).join("")
      : `<div class="empty">Список пуст (возможно, всё скрыто фильтрами).</div>`;

    statusBox.textContent = `Готово: тренажёров — ${trainersV.length}, страниц — ${materialsV.length}.`;
    statusBox.className = "notice notice--ok";
  }

  // events
  reloadBtn.addEventListener("click", build);
  qInput.addEventListener("input", () => {
    // лёгкий дебаунс
    clearTimeout(window.__t);
    window.__t = setTimeout(build, 200);
  });
  showAll.addEventListener("change", build);

  // start
  build();
})();
</script>
</body>
</html>

