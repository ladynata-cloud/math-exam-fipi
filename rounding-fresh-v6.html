<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–¢—Ä–µ–Ω–∞–∂—ë—Ä –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è ‚Äî v6</title>

  <!-- –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–µ —Å—Ç–∏–ª–∏, –±–µ–∑ style.css -->
  <link rel="stylesheet" href="rounding-fresh-v6.css?v=1" />
</head>
<body>
  <main class="rf6">
    <header class="rf6__header">
      <h1 class="rf6__title">–¢—Ä–µ–Ω–∞–∂—ë—Ä –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è <span class="rf6__badge">v6</span></h1>
      <p class="rf6__subtitle">
        –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ä–∞–∑—Ä—è–¥–æ–≤ + –Ω—É–ª–∏ —Å–Ω–∏–∑—É + —É–º–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ + –∏—Ç–æ–≥ —Å–µ—Ä–∏–∏.
      </p>
      <p class="rf6__back"><a href="index.html">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a></p>
    </header>

    <section class="rf6__panel">
      <div class="rf6__row">
        <label class="rf6__label" for="targetSelect">–û–∫—Ä—É–≥–ª—è–µ–º:</label>
        <select id="targetSelect" class="rf6__select"></select>

        <label class="rf6__label" for="levelSelect">–£—Ä–æ–≤–µ–Ω—å:</label>
        <select id="levelSelect" class="rf6__select rf6__select--small">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>

        <label class="rf6__toggle" title="–ò–Ω–æ–≥–¥–∞ –±—É–¥—É—Ç –∑–∞–¥–∞—á–∏ ‚Äú–∏–∑ –∂–∏–∑–Ω–∏‚Äù">
          <input type="checkbox" id="appliedToggle" checked />
          <span>–ü—Ä–∏–∫–ª–∞–¥–Ω—ã–µ</span>
        </label>

        <button id="newBtn" class="rf6__btn" type="button">–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä</button>
      </div>

      <div class="rf6__row rf6__row--series">
        <div class="rf6__seriesLeft">
          <span class="rf6__label">–°–µ—Ä–∏—è:</span>
          <input id="seriesSize" class="rf6__input rf6__input--tiny" type="number" min="5" max="30" value="10" />
          <button id="startSeriesBtn" class="rf6__btn rf6__btn--primary" type="button">–°—Ç–∞—Ä—Ç</button>
          <button id="stopSeriesBtn" class="rf6__btn rf6__btn--ghost" type="button" style="display:none;">–°–±—Ä–æ—Å</button>
        </div>

        <div class="rf6__seriesRight">
          <div id="seriesText" class="rf6__seriesText">–°–µ—Ä–∏—è –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞</div>
          <div class="rf6__bar" aria-hidden="true">
            <div id="seriesBarFill" class="rf6__barFill" style="width:0%"></div>
          </div>
        </div>
      </div>

      <div class="rf6__stats">
        <div class="rf6__stat">
          <div class="rf6__statValue" id="statSolved">0</div>
          <div class="rf6__statLabel">–ü—Ä–æ–≤–µ—Ä–æ–∫</div>
        </div>
        <div class="rf6__stat">
          <div class="rf6__statValue" id="statCorrect">0</div>
          <div class="rf6__statLabel">–í–µ—Ä–Ω–æ</div>
        </div>
        <div class="rf6__stat">
          <div class="rf6__statValue" id="statAccuracy">0%</div>
          <div class="rf6__statLabel">–¢–æ—á–Ω–æ—Å—Ç—å</div>
        </div>
        <div class="rf6__stat">
          <div class="rf6__statValue" id="statStreak">0</div>
          <div class="rf6__statLabel">–°–µ—Ä–∏—è –≤–µ—Ä–Ω—ã—Ö</div>
        </div>
      </div>

      <div class="rf6__meta" id="metaLine">
        –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞ –∑–∞–¥–∞–Ω–∏–µ: <b id="avgTime">‚Äî</b> ‚Ä¢ –ß–∞—â–µ –≤—Å–µ–≥–æ –æ—à–∏–±–∫–∏: <b id="mostMistakes">‚Äî</b>
      </div>
    </section>

    <section class="rf6__card">
      <div class="rf6__taskLabel">–ó–∞–¥–∞–Ω–∏–µ</div>
      <div id="taskText" class="rf6__taskText">–ù–∞–∂–º–∏ ¬´–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä¬ª (–∏–ª–∏ ¬´–°—Ç–∞—Ä—Ç¬ª –¥–ª—è —Å–µ—Ä–∏–∏).</div>

      <div id="guide" class="rf6__guide" hidden>
        <div class="rf6__guideLabel">–ù–∞ —á—Ç–æ —Å–º–æ—Ç—Ä–∏–º</div>
        <div id="guideDigits" class="rf6__guideDigits"></div>
        <div id="guideText" class="rf6__guideText"></div>
      </div>

      <div class="rf6__answerRow">
        <label class="rf6__label" for="answerInput">–û—Ç–≤–µ—Ç:</label>
        <input id="answerInput" class="rf6__input" inputmode="decimal" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 350 –∏–ª–∏ 3,14" />
        <button id="checkBtn" class="rf6__btn rf6__btn--check" type="button">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <button id="nextBtn" class="rf6__btn rf6__btn--next" type="button">–î–∞–ª—å—à–µ</button>
      </div>

      <div class="rf6__actions">
        <button id="hintBtn" class="rf6__btn rf6__btn--ghost" type="button">–ü–æ–¥—Å–∫–∞–∑–∫–∞</button>
        <button id="solutionBtn" class="rf6__btn rf6__btn--ghost" type="button">–†–µ—à–µ–Ω–∏–µ</button>
        <button id="resetProgressBtn" class="rf6__btn rf6__btn--ghost" type="button">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
      </div>

      <div id="message" class="rf6__message" aria-live="polite" style="display:none;"></div>
      <div id="solutionBox" class="rf6__solution" style="display:none;"></div>

      <div id="storageNote" class="rf6__storageNote" style="display:none;">
        –ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è (–±—Ä–∞—É–∑–µ—Ä –∑–∞–ø—Ä–µ—Ç–∏–ª —Ö—Ä–∞–Ω–∏–ª–∏—â–µ). –ù–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.
      </div>
    </section>

    <details class="rf6__rules">
      <summary>–ü—Ä–∞–≤–∏–ª–æ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è</summary>
      <div class="rf6__rulesBody">
        <div class="rf6__step"><b>–®–∞–≥ 1.</b> –û–ø—Ä–µ–¥–µ–ª–∏ —Ä–∞–∑—Ä—è–¥, –¥–æ –∫–æ—Ç–æ—Ä–æ–≥–æ –æ–∫—Ä—É–≥–ª—è–µ—à—å.</div>
        <div class="rf6__step"><b>–®–∞–≥ 2.</b> –ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —Ü–∏—Ñ—Ä—É —Å–ø—Ä–∞–≤–∞ –æ—Ç —ç—Ç–æ–≥–æ —Ä–∞–∑—Ä—è–¥–∞.</div>
        <div class="rf6__step"><b>–®–∞–≥ 3.</b> 0‚Äì4 ‚Üí —Ä–∞–∑—Ä—è–¥ –Ω–µ –º–µ–Ω—è–µ–º; 5‚Äì9 ‚Üí —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–∞ 1.</div>
        <div class="rf6__step"><b>–®–∞–≥ 4.</b> –î–ª—è —Ü–µ–ª—ã—Ö —Å–ø—Ä–∞–≤–∞ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –Ω—É–ª–∏, –¥–ª—è –¥—Ä–æ–±–µ–π –ª–∏—à–Ω–∏–µ –∑–Ω–∞–∫–∏ —Å–ø—Ä–∞–≤–∞ –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º.</div>
      </div>
    </details>
  </main>

  <div id="toast" class="rf6__toast" aria-live="polite"></div>

<script>
(() => {
  "use strict";

  const BASE_SCALE = 10000;
  const BASE_DECIMALS = 4;
  const STORAGE_KEY = "rounding_fresh_v6_state";
  const CHECK_LOCK_MS = 1100;
  const APPLIED_PROB = 0.22;

  const $ = (id) => document.getElementById(id);

  const el = {
    targetSelect: $("targetSelect"),
    levelSelect: $("levelSelect"),
    appliedToggle: $("appliedToggle"),
    newBtn: $("newBtn"),

    seriesSize: $("seriesSize"),
    startSeriesBtn: $("startSeriesBtn"),
    stopSeriesBtn: $("stopSeriesBtn"),
    seriesText: $("seriesText"),
    seriesBarFill: $("seriesBarFill"),

    statSolved: $("statSolved"),
    statCorrect: $("statCorrect"),
    statAccuracy: $("statAccuracy"),
    statStreak: $("statStreak"),

    avgTime: $("avgTime"),
    mostMistakes: $("mostMistakes"),

    taskText: $("taskText"),
    guide: $("guide"),
    guideDigits: $("guideDigits"),
    guideText: $("guideText"),

    answerInput: $("answerInput"),
    checkBtn: $("checkBtn"),
    nextBtn: $("nextBtn"),

    hintBtn: $("hintBtn"),
    solutionBtn: $("solutionBtn"),
    resetProgressBtn: $("resetProgressBtn"),

    message: $("message"),
    solutionBox: $("solutionBox"),
    storageNote: $("storageNote"),
    toast: $("toast"),
  };

  // localStorage safe
  const storage = (() => {
    try {
      const t = "__t";
      localStorage.setItem(t, "1");
      localStorage.removeItem(t);
      return localStorage;
    } catch { return null; }
  })();
  if (!storage) el.storageNote.style.display = "block";

  const safeLoad = () => {
    if (!storage) return null;
    try {
      const raw = storage.getItem(STORAGE_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch { return null; }
  };
  const safeSave = (obj) => {
    if (!storage) return;
    try { storage.setItem(STORAGE_KEY, JSON.stringify(obj)); } catch {}
  };

  const TARGETS = [
    { id: "tens",        label: "–¥–æ –¥–µ—Å—è—Ç–∫–æ–≤",        step: 10,    decimalsAnswer: 0 },
    { id: "hundreds",    label: "–¥–æ —Å–æ—Ç–µ–Ω",          step: 100,   decimalsAnswer: 0 },
    { id: "thousands",   label: "–¥–æ —Ç—ã—Å—è—á",          step: 1000,  decimalsAnswer: 0 },
    { id: "units",       label: "–¥–æ —Ü–µ–ª—ã—Ö",          step: 1,     decimalsAnswer: 0 },
    { id: "tenths",      label: "–¥–æ –¥–µ—Å—è—Ç—ã—Ö",        step: 0.1,   decimalsAnswer: 1 },
    { id: "hundredths",  label: "–¥–æ —Å–æ—Ç—ã—Ö",          step: 0.01,  decimalsAnswer: 2 },
    { id: "thousandths", label: "–¥–æ —Ç—ã—Å—è—á–Ω—ã—Ö",       step: 0.001, decimalsAnswer: 3 },
  ];

  const fillTargetSelect = () => {
    el.targetSelect.innerHTML = "";
    for (const t of TARGETS) {
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = t.label;
      el.targetSelect.appendChild(opt);
    }
  };
  const getTarget = (id) => TARGETS.find(t => t.id === id) || TARGETS[0];

  // State
  let stats = { solved: 0, correct: 0, streak: 0 };
  let series = { active: false, size: 10, index: 0, correct: 0 };
  let current = null;
  let locked = false;

  // ‚Äú—É—á–µ–Ω–∏—á–µ—Å–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞‚Äù
  let timeSumMs = 0;
  let timeCount = 0;
  let taskStartMs = null;

  // –æ—à–∏–±–∫–∏ –ø–æ —Ç–∏–ø–∞–º –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è (–∑–∞ –≤—Å—ë –≤—Ä–µ–º—è –∏ –∑–∞ —Å–µ—Ä–∏—é)
  let mistakesByTarget = {};
  let mistakesByTargetSeries = {};

  const nowMs = () => (typeof performance !== "undefined" ? performance.now() : Date.now());

  const toast = (text) => {
    if (!text) return;
    el.toast.textContent = text;
    el.toast.classList.add("is-show");
    window.setTimeout(() => el.toast.classList.remove("is-show"), 1600);
  };

  const persist = (withToast=false) => {
    safeSave({
      targetId: el.targetSelect.value,
      level: el.levelSelect.value,
      applied: !!el.appliedToggle.checked,
      stats, series, current,
      timeSumMs, timeCount, taskStartMs,
      mistakesByTarget, mistakesByTargetSeries
    });
    if (withToast) toast("–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
  };

  const restore = () => {
    const s = safeLoad();
    if (!s) return;

    if (typeof s.targetId === "string") el.targetSelect.value = s.targetId;
    if (typeof s.level === "string") el.levelSelect.value = s.level;
    if (typeof s.applied === "boolean") el.appliedToggle.checked = s.applied;

    if (s.stats) stats = { ...stats, ...s.stats };
    if (s.series) series = { ...series, ...s.series };

    if (Number.isFinite(s.timeSumMs)) timeSumMs = s.timeSumMs;
    if (Number.isFinite(s.timeCount)) timeCount = s.timeCount;
    if (Number.isFinite(s.taskStartMs)) taskStartMs = s.taskStartMs;

    if (s.mistakesByTarget && typeof s.mistakesByTarget === "object") mistakesByTarget = s.mistakesByTarget;
    if (s.mistakesByTargetSeries && typeof s.mistakesByTargetSeries === "object") mistakesByTargetSeries = s.mistakesByTargetSeries;

    if (s.current && Number.isFinite(s.current.nScaled)) {
      current = s.current;
      el.taskText.textContent = current.prompt;
      renderGuide();
    }
  };

  const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

  const scaledToStringRu = (scaled, decimals) => {
    const abs = Math.abs(scaled);
    const intPart = Math.floor(abs / BASE_SCALE);
    const frac = abs % BASE_SCALE;
    if (decimals <= 0) return String(intPart);
    const fracStrFull = String(frac).padStart(BASE_DECIMALS, "0");
    return `${intPart},${fracStrFull.slice(0, decimals)}`;
  };

  // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è + –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –æ–ø—Ä–µ–¥–µ–ª–∏–º ‚Äú–ª–∏—à–Ω–∏–µ –Ω—É–ª–∏‚Äù
  const normalizeInputDetailed = (raw, allowedDecimals) => {
    const original = String(raw || "").trim();
    let t = original.replace(/\s+/g, "").replace(",", ".");
    if (!t) return { kind: "empty" };

    if (t[0] === "+") t = t.slice(1);
    if (t[0] === "-") return { kind: "negative" };
    if (!/^\d+(\.\d+)?$/.test(t)) return { kind: "bad" };

    const parts = t.split(".");
    let intPart = (parts[0] || "0").replace(/^0+(?=\d)/, "");
    if (intPart === "") intPart = "0";

    const frac = parts[1] ?? null;
    const norm = frac === null ? intPart : (intPart + "." + frac);

    // –õ–∏—à–Ω–∏–µ –Ω—É–ª–∏ –≤ –∫–æ–Ω—Ü–µ –¥—Ä–æ–±–∏ (–Ω–µ –æ—à–∏–±–∫–∞, –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Å–∫–∞–∑–∫–∞ –æ –∑–∞–ø–∏—Å–∏)
    let hasExtraZeros = false;
    if (frac !== null && frac.length > allowedDecimals) {
      const extra = frac.slice(allowedDecimals);
      hasExtraZeros = extra.length > 0 && [...extra].every(ch => ch === "0");
    }

    return { kind: "ok", norm, hasExtraZeros };
  };

  const parseToScaled = (inputNorm, allowedDecimals) => {
    const parts = inputNorm.split(".");
    const intVal = parseInt(parts[0], 10);
    if (!Number.isFinite(intVal)) return { ok: false };

    const fracRaw = parts[1] || "";

    // –ª–∏—à–Ω–∏–µ —Ü–∏—Ñ—Ä—ã –ø–æ—Å–ª–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
    let extraNonZero = false;
    if (fracRaw.length > allowedDecimals) {
      extraNonZero = [...fracRaw.slice(allowedDecimals)].some(ch => ch !== "0");
    }

    const fracPadded = (fracRaw + "0".repeat(BASE_DECIMALS)).slice(0, BASE_DECIMALS);
    const fracVal = parseInt(fracPadded || "0", 10);

    const scaled = intVal * BASE_SCALE + (Number.isFinite(fracVal) ? fracVal : 0);
    return { ok: true, scaled, extraNonZero };
  };

  const stepToScaled = (step) => Math.round(step * BASE_SCALE);
  const rightPlaceScaled = (stepScaled) => Math.floor(stepScaled / 10);
  const digitAt = (nScaled, placeScaled) => Math.floor(nScaled / placeScaled) % 10;

  const roundName = (id) => ({
    tens: "–¥–µ—Å—è—Ç–∫–∏", hundreds: "—Å–æ—Ç–Ω–∏", thousands: "—Ç—ã—Å—è—á–∏",
    units: "—Ü–µ–ª—ã–µ", tenths: "–¥–µ—Å—è—Ç—ã–µ", hundredths: "—Å–æ—Ç—ã–µ", thousandths: "—Ç—ã—Å—è—á–Ω—ã–µ"
  }[id] || "—Ä–∞–∑—Ä—è–¥");

  const rightName = (id) => ({
    tens: "–µ–¥–∏–Ω–∏—Ü—ã", hundreds: "–¥–µ—Å—è—Ç–∫–∏", thousands: "—Å–æ—Ç–Ω–∏",
    units: "–¥–µ—Å—è—Ç—ã–µ", tenths: "—Å–æ—Ç—ã–µ", hundredths: "—Ç—ã—Å—è—á–Ω—ã–µ", thousandths: "–¥–µ—Å—è—Ç–∏—Ç—ã—Å—è—á–Ω—ã–µ"
  }[id] || "—Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑—Ä—è–¥");

  const getRange = (target, level) => {
    const lvl = Number(level) || 1;
    const step = target.step;
    if (step === 10)   return lvl === 1 ? [10,99] : (lvl === 2 ? [100,999] : [1000,9999]);
    if (step === 100)  return lvl === 1 ? [100,999] : (lvl === 2 ? [1000,9999] : [10000,99999]);
    if (step === 1000) return lvl === 1 ? [1000,9999] : (lvl === 2 ? [10000,99999] : [100000,999999]);
    if (step <= 1)     return lvl === 1 ? [0,99] : (lvl === 2 ? [0,999] : [0,9999]);
    return [1,999];
  };

  const appliedText = (displayN, targetLabel, isInt) => {
    const ints = [
      (x) => `–¶–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞ ${x} —Ä—É–±. –û–∫—Ä—É–≥–ª–∏—Ç–µ ${targetLabel} –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ—Ü–µ–Ω–∫–∏.`,
      (x) => `–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ ${x} –∫–º. –û–∫—Ä—É–≥–ª–∏—Ç–µ ${targetLabel}.`,
      (x) => `–°–∫–æ—Ä–æ—Å—Ç—å ${x} –∫–º/—á. –û–∫—Ä—É–≥–ª–∏—Ç–µ ${targetLabel}.`,
      (x) => `–í –∑–∞–ª–µ ${x} –∑—Ä–∏—Ç–µ–ª–µ–π. –û–∫—Ä—É–≥–ª–∏—Ç–µ ${targetLabel}.`,
    ];
    const decs = [
      (x) => `–î–ª–∏–Ω–∞ –¥–æ—Å–∫–∏ ${x} –º. –û–∫—Ä—É–≥–ª–∏—Ç–µ ${targetLabel}.`,
      (x) => `–ú–∞—Å—Å–∞ —Ç–æ–≤–∞—Ä–∞ ${x} –∫–≥. –û–∫—Ä—É–≥–ª–∏—Ç–µ ${targetLabel}.`,
      (x) => `–®–∏—Ä–∏–Ω–∞ –ª–µ–Ω—Ç—ã ${x} –º. –û–∫—Ä—É–≥–ª–∏—Ç–µ ${targetLabel}.`,
    ];
    const pool = isInt ? ints : decs;
    return pool[randInt(0, pool.length - 1)](displayN);
  };

  // ===== Guide =====
  const digitIndexFromPlace = (placeScaled, intLen) => {
    if (placeScaled >= BASE_SCALE) {
      const k = Math.round(Math.log10(placeScaled / BASE_SCALE)); // 1->0, 10->1...
      return intLen - 1 - k;
    } else {
      const d = Math.round(Math.log10(BASE_SCALE / placeScaled)); // tenths:1...
      return intLen + 1 + (d - 1);
    }
  };

  const renderGuide = () => {
    if (!current) { el.guide.hidden = true; return; }

    const intPart = Math.floor(current.nScaled / BASE_SCALE);
    const frac = current.nScaled % BASE_SCALE;

    const intStr = String(intPart);
    const fracStrFull = String(frac).padStart(BASE_DECIMALS, "0");
    const fracStr = current.decimalsInTask > 0 ? fracStrFull.slice(0, current.decimalsInTask) : "";
    const full = fracStr ? `${intStr},${fracStr}` : intStr;

    const roundIdx = digitIndexFromPlace(current.roundPlaceScaled, intStr.length);
    const lookIdx  = digitIndexFromPlace(current.lookPlaceScaled,  intStr.length);

    let html = "";
    for (let i = 0; i < full.length; i++) {
      const ch = full[i];
      let cls = "rf6__d";
      if (ch === ",") cls += " rf6__d--comma";
      else {
        if (i === roundIdx) cls += " rf6__d--round";
        if (i === lookIdx)  cls += " rf6__d--look";
        if (i > roundIdx)   cls += (current.turnToZero ? " rf6__d--tozero" : " rf6__d--drop");
      }
      html += `<span class="${cls}">${ch}</span>`;
    }

    el.guide.hidden = false;
    el.guideDigits.innerHTML = html;

    const rule = current.lookDigit >= 5 ? "–¶–∏—Ñ—Ä–∞ ‚â• 5 ‚Üí —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑—Ä—è–¥." : "–¶–∏—Ñ—Ä–∞ < 5 ‚Üí —Ä–∞–∑—Ä—è–¥ –Ω–µ –º–µ–Ω—è–µ–º.";
    const tail = current.turnToZero ? "–°–ø—Ä–∞–≤–∞ —Å—Ç–∞–Ω—É—Ç –Ω—É–ª–∏ (0 –ø–æ–∫–∞–∑–∞–Ω—ã —Å–Ω–∏–∑—É)." : "–õ–∏—à–Ω–∏–µ –∑–Ω–∞–∫–∏ —Å–ø—Ä–∞–≤–∞ –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º.";
    el.guideText.textContent = `–°–∏–Ω–∏–π ‚Äî —Ä–∞–∑—Ä—è–¥ (${current.roundName}). –û—Ä–∞–Ω–∂–µ–≤—ã–π ‚Äî —Å–º–æ—Ç—Ä–∏–º –Ω–∞ ${current.rightName}: —Ü–∏—Ñ—Ä–∞ ${current.lookDigit}. ${rule} ${tail}`;
  };

  // ===== Task generation =====
  const generateTask = () => {
    const target = getTarget(el.targetSelect.value);
    const level = el.levelSelect.value;

    const stepScaled = stepToScaled(target.step);
    const allowedDecimals = target.decimalsAnswer;

    let decimalsInTask;
    if (target.id === "units") decimalsInTask = Math.random() < 0.5 ? 1 : 2;
    else if (target.step < 1)  decimalsInTask = Math.min(BASE_DECIMALS, allowedDecimals + 1);
    else                       decimalsInTask = 0;

    const [minInt, maxInt] = getRange(target, level);

    let nScaled;
    if (decimalsInTask === 0) {
      let n = randInt(minInt, maxInt);
      if (target.step >= 10 && n % target.step === 0) n += 1;
      nScaled = n * BASE_SCALE;
    } else {
      const intPart = randInt(minInt, maxInt);
      const denom = Math.pow(10, decimalsInTask);
      const frac = randInt(0, denom - 1);
      const shift = Math.pow(10, BASE_DECIMALS - decimalsInTask);
      nScaled = intPart * BASE_SCALE + frac * shift;
    }

    const answerScaled = Math.round(nScaled / stepScaled) * stepScaled;

    const displayN = scaledToStringRu(nScaled, decimalsInTask);
    const displayAnswer = scaledToStringRu(answerScaled, allowedDecimals);

    const useApplied = el.appliedToggle.checked && Math.random() < APPLIED_PROB;
    const prompt = useApplied
      ? appliedText(displayN, target.label, target.step >= 1)
      : `–û–∫—Ä—É–≥–ª–∏—Ç–µ —á–∏—Å–ª–æ ${displayN} ${target.label}.`;

    const lookPlace = rightPlaceScaled(stepScaled);
    const lookDigit = digitAt(nScaled, lookPlace);

    return {
      targetId: target.id,
      targetLabel: target.label,
      stepScaled,
      allowedDecimals,
      decimalsInTask,
      nScaled,
      answerScaled,
      displayAnswer,
      prompt,

      roundPlaceScaled: stepScaled,
      lookPlaceScaled: lookPlace,
      roundName: roundName(target.id),
      rightName: rightName(target.id),
      lookDigit,

      turnToZero: target.step >= 10,
      attempts: 0,
      solved: false,
    };
  };

  // ===== UI helpers =====
  const setMessage = (text, kind) => {
    if (!text) { el.message.style.display = "none"; return; }
    el.message.style.display = "block";
    el.message.textContent = text;
    el.message.className = "rf6__message " + (kind ? `rf6__message--${kind}` : "");
  };

  const updateStatsUI = () => {
    el.statSolved.textContent = String(stats.solved);
    el.statCorrect.textContent = String(stats.correct);
    el.statAccuracy.textContent = stats.solved ? `${Math.round((stats.correct / stats.solved) * 100)}%` : "0%";
    el.statStreak.textContent = String(stats.streak);
  };

  const updateSeriesUI = () => {
    if (!series.active) {
      el.seriesText.textContent = "–°–µ—Ä–∏—è –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞";
      el.seriesBarFill.style.width = "0%";
      el.stopSeriesBtn.style.display = "none";
      return;
    }
    const done = series.index, total = series.size, left = Math.max(0, total - done);
    el.seriesText.textContent = `–ó–∞–¥–∞–Ω–∏–µ ${Math.min(done + 1, total)} –∏–∑ ${total} ‚Ä¢ –í–µ—Ä–Ω–æ: ${series.correct} ‚Ä¢ –û—Å—Ç–∞–ª–æ—Å—å: ${left}`;
    el.seriesBarFill.style.width = `${Math.round((done / total) * 100)}%`;
    el.stopSeriesBtn.style.display = "inline-flex";
  };

  const formatTime = (ms) => {
    if (!Number.isFinite(ms) || ms <= 0) return "‚Äî";
    const s = Math.round(ms / 1000);
    const m = Math.floor(s / 60);
    const r = s % 60;
    return m > 0 ? `${m}:${String(r).padStart(2, "0")}` : `${r}—Å`;
  };

  const computeMostMistakes = (obj) => {
    const entries = Object.entries(obj || {});
    if (entries.length === 0) return "‚Äî";
    entries.sort((a,b) => b[1] - a[1]);
    const top = entries[0];
    const id = top[0];
    const t = getTarget(id);
    return t ? t.label : "‚Äî";
  };

  const updateMeta = () => {
    const avg = timeCount > 0 ? (timeSumMs / timeCount) : null;
    el.avgTime.textContent = avg ? formatTime(avg) : "‚Äî";
    el.mostMistakes.textContent = computeMostMistakes(mistakesByTarget);
  };

  const addMistake = (targetId, isSeries) => {
    mistakesByTarget[targetId] = (mistakesByTarget[targetId] || 0) + 1;
    if (isSeries) mistakesByTargetSeries[targetId] = (mistakesByTargetSeries[targetId] || 0) + 1;
  };

  // ===== Behavior =====
  const setLocked = (v) => {
    locked = v;
    el.checkBtn.disabled = v;
    el.checkBtn.textContent = v ? "–ü—Ä–æ–≤–µ—Ä—è—é‚Ä¶" : "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å";
  };

  const startTaskTimer = () => { taskStartMs = nowMs(); };
  const finishTaskTimer = () => {
    if (!Number.isFinite(taskStartMs)) return;
    const dt = nowMs() - taskStartMs;
    timeSumMs += dt;
    timeCount += 1;
    taskStartMs = null;
  };

  const newTask = () => {
    current = generateTask();
    el.taskText.textContent = current.prompt;
    el.answerInput.value = "";
    el.answerInput.focus();
    el.solutionBox.style.display = "none";
    el.solutionBox.innerHTML = "";
    el.message.style.display = "none";
    renderGuide();

    startTaskTimer();
    persist(false);
  };

  const startSeries = () => {
    const size = Math.max(5, Math.min(30, Number(el.seriesSize.value) || 10));
    series = { active: true, size, index: 0, correct: 0 };
    mistakesByTargetSeries = {};
    updateSeriesUI();
    setMessage("–°–µ—Ä–∏—è –∑–∞–ø—É—â–µ–Ω–∞ ‚úÖ –†–µ—à–∞–π –∏ –∂–º–∏ ¬´–î–∞–ª—å—à–µ¬ª.", "ok");
    newTask();
    persist(true);
  };

  const stopSeries = () => {
    series = { active: false, size: 10, index: 0, correct: 0 };
    mistakesByTargetSeries = {};
    updateSeriesUI();
    setMessage("–°–µ—Ä–∏—è —Å–±—Ä–æ—à–µ–Ω–∞.", "info");
    persist(true);
  };

  const hintText = () => {
    if (!current) return "";
    return `–ü–æ–¥—Å–∫–∞–∑–∫–∞: –æ–∫—Ä—É–≥–ª—è–µ–º ${current.targetLabel} ‚Üí —Å–º–æ—Ç—Ä–∏–º –Ω–∞ ${current.rightName}. 0‚Äì4 ‚Üí –Ω–µ –º–µ–Ω—è–µ–º; 5‚Äì9 ‚Üí —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º.`;
  };

  const solutionHTML = () => {
    if (!current) return "";
    const d = current.lookDigit;
    const rule = d >= 5 ? `–¶–∏—Ñ—Ä–∞ ${d} ‚â• 5 ‚Üí —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑—Ä—è–¥.` : `–¶–∏—Ñ—Ä–∞ ${d} < 5 ‚Üí —Ä–∞–∑—Ä—è–¥ –Ω–µ –º–µ–Ω—è–µ–º.`;
    return `<div class="rf6__solutionTitle">–†–∞–∑–±–æ—Ä</div>
      <div>–û–∫—Ä—É–≥–ª—è–µ–º <b>${current.targetLabel}</b>.</div>
      <div>–°–º–æ—Ç—Ä–∏–º –Ω–∞ <b>${current.rightName}</b>: —Ü–∏—Ñ—Ä–∞ <b>${d}</b>.</div>
      <div>${rule}</div>
      <div class="rf6__solutionAnswer">–û—Ç–≤–µ—Ç: <b>${current.displayAnswer}</b></div>`;
  };

  const diagnoseMistake = (userScaled) => {
    // 1) –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ –∫—Ä–∞—Ç–µ–Ω —à–∞–≥—É –¥–ª—è –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –¥–æ –¥–µ—Å—è—Ç–∫–æ–≤/—Å–æ—Ç–µ–Ω/—Ç—ã—Å—è—á
    if (current.turnToZero && (userScaled % current.stepScaled !== 0)) {
      return `–ü—Ä–∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–∏ ${current.targetLabel} –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫—Ä–∞—Ç–µ–Ω —à–∞–≥—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ –¥–µ—Å—è—Ç–∫–æ–≤ ‚Äî –æ–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 0).`;
    }

    // 2) –Ω–∞ –æ–¥–∏–Ω ‚Äú—à–∞–≥ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è‚Äù –≤—ã—à–µ/–Ω–∏–∂–µ
    const diff = userScaled - current.answerScaled;
    if (Math.abs(diff) === current.stepScaled) {
      return `–í—ã —É—à–ª–∏ –Ω–∞ 1 —à–∞–≥ ${diff > 0 ? "–≤—ã—à–µ" : "–Ω–∏–∂–µ"} –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å —Ü–∏—Ñ—Ä—É —Å–ø—Ä–∞–≤–∞: 5‚Äì9 ‚Üí —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º, 0‚Äì4 ‚Üí –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º.`;
    }

    // 3) –≤–æ–∑–º–æ–∂–Ω–æ –æ–∫—Ä—É–≥–ª–∏–ª –Ω–µ –¥–æ —Ç–æ–≥–æ —Ä–∞–∑—Ä—è–¥–∞
    return `–ü—Ä–æ–≤–µ—Ä—å —Ä–∞–∑—Ä—è–¥: –º—ã –æ–∫—Ä—É–≥–ª—è–µ–º ${current.targetLabel} –∏ —Å–º–æ—Ç—Ä–∏–º –Ω–∞ ${current.rightName}.`;
  };

  const checkAnswer = () => {
    if (locked) return;
    if (!current) { setMessage("–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ ¬´–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä¬ª.", "info"); return; }

    setLocked(true);
    setTimeout(() => setLocked(false), CHECK_LOCK_MS);

    const det = normalizeInputDetailed(el.answerInput.value, current.allowedDecimals);
    if (det.kind === "negative") { setMessage("–¢—Ä–µ–Ω–∏—Ä—É–µ–º –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö —á–∏—Å–µ–ª üôÇ", "bad"); return; }
    if (det.kind === "bad" || det.kind === "empty") { setMessage("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ (–º–æ–∂–Ω–æ —Å –∑–∞–ø—è—Ç–æ–π –∏–ª–∏ —Ç–æ—á–∫–æ–π).", "info"); return; }

    const parsed = parseToScaled(det.norm, current.allowedDecimals);
    if (!parsed.ok) { setMessage("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç.", "bad"); return; }

    if (parsed.extraNonZero) {
      // —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–∏–ø –æ—à–∏–±–∫–∏ ‚Äî ‚Äú–ª–∏—à–Ω–∏–µ —Ü–∏—Ñ—Ä—ã –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π‚Äù
      setMessage("–õ–∏—à–Ω–∏–µ —Ü–∏—Ñ—Ä—ã –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π: –æ–∫—Ä—É–≥–ª–∏ –¥–æ –Ω—É–∂–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–Ω–∞–∫–æ–≤.", "bad");
      return;
    }

    current.attempts += 1;
    const ok = (parsed.scaled === current.answerScaled);

    stats.solved += 1;

    if (ok) {
      if (!current.solved) { current.solved = true; stats.correct += 1; }
      stats.streak += 1;

      if (det.hasExtraZeros && current.allowedDecimals > 0) {
        setMessage(`–í–µ—Ä–Ω–æ ‚úÖ (–º–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å –∫–æ—Ä–æ—á–µ: ${current.displayAnswer})`, "ok");
      } else {
        setMessage("–í–µ—Ä–Ω–æ ‚úÖ", "ok");
      }
    } else {
      stats.streak = 0;

      // –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –æ—Ç —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏
      const diag = diagnoseMistake(parsed.scaled);

      if (current.attempts >= 3) {
        setMessage(`–ù–µ–≤–µ—Ä–Ω–æ ‚ùå ${diag} –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${current.displayAnswer}`, "bad");
        el.solutionBox.style.display = "block";
        el.solutionBox.innerHTML = solutionHTML();
      } else if (current.attempts >= 2) {
        setMessage(`–ù–µ–≤–µ—Ä–Ω–æ ‚ùå ${diag}`, "bad");
      } else {
        setMessage("–ù–µ–≤–µ—Ä–Ω–æ ‚ùå –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.", "bad");
      }
    }

    updateStatsUI();
    updateMeta();
    persist(false);
  };

  const finishSeriesIfNeeded = () => {
    if (!series.active) return;
    if (series.index >= series.size) {
      series.active = false;
      updateSeriesUI();

      const most = computeMostMistakes(mistakesByTargetSeries);
      const text = most !== "‚Äî"
        ? `–°–µ—Ä–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: ${series.correct}/${series.size}. –ß–∞—â–µ –≤—Å–µ–≥–æ –æ—à–∏–±–∫–∏ –±—ã–ª–∏: ${most}.`
        : `–°–µ—Ä–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: ${series.correct}/${series.size}.`;

      setMessage(text, "ok");
      persist(true);
    }
  };

  const nextTask = () => {
    if (!current) { newTask(); return; }

    // —Å—á–∏—Ç–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–¥–∞–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –¥–∞–ª—å—à–µ
    finishTaskTimer();
    updateMeta();

    if (series.active) {
      series.index += 1;
      if (current.solved) series.correct += 1;
      else addMistake(current.targetId, true);

      updateSeriesUI();
      finishSeriesIfNeeded();

      if (!series.active) {
        // –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Ä–∏–∏ ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏–º—Å—è
        current = null;
        el.taskText.textContent = "–°–µ—Ä–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª –∏–ª–∏ ¬´–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä¬ª.";
        el.answerInput.value = "";
        el.answerInput.blur();
        el.guide.hidden = true;
        persist(false);
        return;
      }
    }

    newTask();
  };

  const resetProgress = () => {
    const ok = confirm("–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —ç—Ç–æ–≥–æ —Ç—Ä–µ–Ω–∞–∂—ë—Ä–∞?");
    if (!ok) return;

    stats = { solved: 0, correct: 0, streak: 0 };
    series = { active: false, size: 10, index: 0, correct: 0 };
    current = null;

    timeSumMs = 0; timeCount = 0; taskStartMs = null;
    mistakesByTarget = {}; mistakesByTargetSeries = {};

    updateStatsUI();
    updateSeriesUI();
    updateMeta();

    el.taskText.textContent = "–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω. –ù–∞–∂–º–∏ ¬´–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä¬ª.";
    el.answerInput.value = "";
    el.guide.hidden = true;
    el.message.style.display = "none";
    el.solutionBox.style.display = "none";
    el.solutionBox.innerHTML = "";

    if (storage) { try { storage.removeItem(STORAGE_KEY); } catch {} }
  };

  // Events
  el.newBtn.addEventListener("click", () => { newTask(); persist(true); });
  el.startSeriesBtn.addEventListener("click", startSeries);
  el.stopSeriesBtn.addEventListener("click", stopSeries);

  el.checkBtn.addEventListener("click", checkAnswer);
  el.nextBtn.addEventListener("click", nextTask);

  el.answerInput.addEventListener("keydown", (e) => { if (e.key === "Enter") checkAnswer(); });

  el.hintBtn.addEventListener("click", () => { if (current) setMessage(hintText(), "info"); });

  el.solutionBtn.addEventListener("click", () => {
    if (!current) return;
    if (el.solutionBox.style.display === "none") {
      el.solutionBox.style.display = "block";
      el.solutionBox.innerHTML = solutionHTML();
    } else {
      el.solutionBox.style.display = "none";
      el.solutionBox.innerHTML = "";
    }
  });

  el.resetProgressBtn.addEventListener("click", resetProgress);

  el.targetSelect.addEventListener("change", () => { persist(true); if (current) renderGuide(); });
  el.levelSelect.addEventListener("change", () => { persist(true); });
  el.appliedToggle.addEventListener("change", () => { persist(true); });

  // Init
  fillTargetSelect();
  el.targetSelect.value = "tens";
  restore();
  updateStatsUI();
  updateSeriesUI();
  updateMeta();
})();
</script>
</body>
</html>

