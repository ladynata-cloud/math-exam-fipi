<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–¢—Ä–µ–Ω–∞–∂—ë—Ä: —Ç–æ—Ä–º–æ–∂–µ–Ω–∏–µ –∏ –ø—Ä—ã–∂–∫–∏ (–ª–µ—Å–µ–Ω–∫–∞ –∏ –¥–µ–ª–µ–Ω–∏–µ)</title>

  <!-- –ï—Å–ª–∏ —Ñ–∞–π–ª –≤ –ø–∞–ø–∫–µ trainers/, –∞ style.css –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: -->
  <link rel="stylesheet" href="../style.css">

  <style>
    :root { --bg:#f7f7fb; --card:#fff; --text:#111; --muted:#666; --accent:#2b6cb0; --bad:#b00020; --good:#0a7a28; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    .container { max-width: 980px; margin: 0 auto; padding: 16px; }
    .card { background:var(--card); border-radius: 14px; padding: 16px; box-shadow: 0 4px 14px rgba(0,0,0,.06); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    h1 { font-size: 22px; margin: 0 0 10px; }
    .small { color:var(--muted); font-size: 14px; }
    .task { font-size: 18px; line-height: 1.45; }
    input[type="text"] { font-size: 18px; padding: 10px 12px; border-radius: 10px; border: 1px solid #d0d4dc; min-width: 160px; }
    select { font-size:16px; padding:10px 12px; border-radius:10px; border:1px solid #d0d4dc; }
    button { font-size: 16px; padding: 10px 12px; border-radius: 10px; border: 1px solid #d0d4dc; background: #fff; cursor:pointer; }
    button.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .badge { padding: 2px 8px; border-radius: 999px; background: #eef2ff; font-size: 13px; }
    .feedback { margin-top: 10px; padding: 10px 12px; border-radius: 10px; background: #f0f7ff; border: 1px solid #d6e9ff; }
    .feedback.good { background: #f2fff5; border-color: #ccefd4; color: var(--good); }
    .feedback.bad { background: #fff3f3; border-color: #ffd2d2; color: var(--bad); }
    details { margin-top: 10px; }
    pre { white-space: pre-wrap; background:#0b1020; color:#eef; padding: 12px; border-radius: 12px; overflow:auto; }
    table { border-collapse: collapse; width: 100%; }
    td, th { border-bottom: 1px solid #eceff4; padding: 8px; text-align:left; vertical-align: middle; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: .95em; background:#eef1f6; padding: 2px 6px; border-radius: 6px; }
    hr { border:none;border-top:1px solid #eceff4;margin:14px 0; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .stepbox { margin-top: 12px; padding: 12px; border-radius: 12px; border: 1px dashed #cbd5e1; background: #fbfdff; }
    .pill { display:inline-block; padding:2px 10px; border-radius:999px; background:#eef1f6; font-size:13px; }
    .okcell { color: var(--good); font-weight: 700; }
    .lock { opacity:.85; }
    .tight { line-height: 1.45; }

    /* ===== AI helper ===== */
    .aiTextarea { width:100%; font-size:16px; padding:10px 12px; border-radius:10px; border:1px solid #d0d4dc; background:#fff; resize: vertical; }
    #aiAnswerBox { white-space: pre-wrap; }
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h1>–¢—Ä–µ–Ω–∞–∂—ë—Ä –û–ì–≠: —Ç–æ—Ä–º–æ–∂–µ–Ω–∏–µ –∏ –ø—Ä—ã–∂–∫–∏ ‚Äî ‚Äú–ª–µ—Å–µ–Ω–∫–∞‚Äù –∏ ‚Äú–¥–µ–ª–µ–Ω–∏–µ‚Äù</h1>
          <div class="small">–ë–µ–∑ ‚Äú—Ç–µ–º‚Äù. –ü—Ä–æ—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä—è–µ–º –æ–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å—á–∏—Ç–∞–µ–º.</div>
        </div>
        <a href="../index.html" class="small">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
      </div>

      <hr>

      <div class="row">
        <label class="small">–†–µ–∂–∏–º:</label>
        <select id="mode">
          <option value="fixed">–í–∞—à–∏ 4 –∑–∞–¥–∞—á–∏ (1‚Äì4)</option>
          <option value="mix">–°–º–µ—à–∞–Ω–Ω—ã–π (—Ä–∞–Ω–¥–æ–º)</option>
          <option value="brake">–¢–æ–ª—å–∫–æ —Ç–æ—Ä–º–æ–∂–µ–Ω–∏–µ</option>
          <option value="bounce">–¢–æ–ª—å–∫–æ –ø—Ä—ã–∂–∫–∏</option>
        </select>

        <label class="small" style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="stepMode" checked>
          –ü–æ—à–∞–≥–æ–≤–æ (—Å —Ç–∞–±–ª–∏—Ü–µ–π)
        </label>

        <button id="btnNew" class="primary">–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä</button>
        <button id="btnHow">–ö–∞–∫ —Ä–µ—à–∞—Ç—å</button>
        <span class="badge" id="stat">0 —Ä–µ—à–µ–Ω–æ ¬∑ 0% ¬∑ —Å—Ä. 0.0 —Å</span>
      </div>

      <div id="how" class="feedback" style="display:none;">
        <b>–ö–∞–∫ —Ä–µ—à–∞—Ç—å (–ø–æ-–ø—Ä–æ—Å—Ç–æ–º—É)</b>
        <ul style="margin:8px 0 0 18px;">
          <li><b>–¢–æ—Ä–º–æ–∂–µ–Ω–∏–µ</b>: –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É <b>–º–∏–Ω—É—Å –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ</b>. –ü–∏—à–µ–º —á–∏—Å–ª–∞ ‚Äú–ª–µ—Å–µ–Ω–∫–æ–π‚Äù, –ø–æ—Ç–æ–º <b>—Å–∫–ª–∞–¥—ã–≤–∞–µ–º</b>.</li>
          <li><b>–î–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏</b>: —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞ —á–∏—Å–ª–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ (–ø–æ—Å–ª–µ–¥–Ω—è—è —Å–µ–∫—É–Ω–¥–∞ ‚Äî –µ—â—ë –µ–¥–µ—Ç).</li>
          <li><b>–ü—Ä—ã–∂–∫–∏</b>: –∫–∞–∂–¥—ã–π —Ä–∞–∑ –≤—ã—Å–æ—Ç–∞ <b>–¥–µ–ª–∏—Ç—Å—è</b> –Ω–∞ 2 –∏–ª–∏ –Ω–∞ 3. –ò—â–µ–º –ø–µ—Ä–≤—ã–π –ø—Ä—ã–∂–æ–∫, –≥–¥–µ —Å—Ç–∞–ª–æ <b>–º–µ–Ω—å—à–µ 15 —Å–º</b>.</li>
          <li>–î–ª—è –ø—Ä—ã–∂–∫–æ–≤ —É–¥–æ–±–Ω–µ–µ —Å—á–∏—Ç–∞—Ç—å <b>–≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö</b> (–ø–æ—Ä–æ–≥ –≤–µ–¥—å –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö).</li>
        </ul>
      </div>

      <div style="margin-top:14px;">
        <div class="task" id="taskText">–ù–∞–∂–º–∏—Ç–µ <span class="kbd">¬´–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä¬ª</span>.</div>

        <div id="stepPanel" class="stepbox" style="display:none;">
          <div class="row" style="justify-content:space-between;">
            <div class="small" id="stepHint">–°—á–∏—Ç–∞–µ–º –ø–æ —à–∞–≥–∞–º.</div>
            <span class="pill" id="stepUnit">–µ–¥.</span>
          </div>

          <div style="margin-top:10px; overflow:auto;">
            <table id="stepTable"></table>
          </div>

          <div class="row" style="margin-top:10px;">
            <button id="btnStepCheck">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —à–∞–≥</button>
            <button id="btnStepSkip" title="–ï—Å–ª–∏ —Å–µ–π—á–∞—Å –Ω–µ –≥–æ—Ç–æ–≤—ã –∫ —Ç–∞–±–ª–∏—Ü–µ ‚Äî –º–æ–∂–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å —Å—Ä–∞–∑—É">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø–æ—à–∞–≥–æ–≤–æ</button>
            <span class="small" id="stepStatus" style="margin-left:auto;"></span>
          </div>

          <div id="stepFeedback" class="feedback" style="display:none;"></div>

          <!-- –ë–ª–æ–∫ ‚Äú—Å–ª–æ–∂–µ–Ω–∏–µ –ø–∞—Ä–∞–º–∏‚Äù + –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è -->
          <div id="pairPanel" class="stepbox" style="display:none; margin-top:10px;">
            <div class="row" style="justify-content:space-between;">
              <div><b>–ë—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–± —Å–ª–æ–∂–∏—Ç—å –ª–µ—Å–µ–Ω–∫—É</b></div>
              <span class="pill" id="pairInfo">‚Äî</span>
            </div>

            <div class="small tight" id="pairLines" style="margin-top:8px;"></div>

            <div class="row" style="margin-top:10px;">
              <div class="small" style="min-width: 210px;">
                <b id="mulLabel">–ü–æ—Å—á–∏—Ç–∞–π—Ç–µ:</b> <span id="mulExpr"></span>
              </div>
              <input id="mulInput" type="text" inputmode="decimal" placeholder="–≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ">
              <button id="btnMulCheck">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
              <button id="btnMulSkip" title="–ï—Å–ª–∏ –ø–æ–∫–∞ —Ç—Ä—É–¥–Ω–æ ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —É–º–Ω–æ–∂–µ–Ω–∏–µ</button>
            </div>

            <div id="mulFeedback" class="feedback" style="display:none;"></div>

            <!-- –ù–æ–≤–æ–µ: –∫–Ω–æ–ø–∫–∞ ‚Äú–ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –≤ –æ—Ç–≤–µ—Ç‚Äù -->
            <div class="row" style="margin-top:10px;">
              <button id="btnFillAnswer" disabled>–ü–æ–¥—Å—Ç–∞–≤–∏—Ç—å —Å—É–º–º—É –≤ –æ—Ç–≤–µ—Ç</button>
              <span class="small" id="fillNote"></span>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <label for="answer"><b>–û—Ç–≤–µ—Ç:</b></label>
          <input id="answer" type="text" inputmode="decimal" placeholder="–≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ">
          <button id="btnCheck">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
          <button id="btnShow" style="margin-left:auto;">–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–±–æ—Ä</button>
        </div>

        <div id="feedback" class="feedback" style="display:none;"></div>

        <!-- ===== –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ ===== -->
        <div id="aiBox" class="stepbox" style="margin-top:12px;">
          <div class="row" style="justify-content:space-between;">
            <div><b>ü§ñ –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫</b> <span class="small">–ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è</span></div>
            <span class="pill" id="aiPill">–≥–æ—Ç–æ–≤</span>
          </div>

          <div class="row" style="margin-top:10px;">
            <button id="aiHintBtn">ü§ñ –ü–æ–¥—Å–∫–∞–∑–∫–∞</button>
            <button id="aiExplainBtn" disabled>ü§ñ –û–±—ä—è—Å–Ω–∏ –æ—à–∏–±–∫—É</button>
            <button id="aiSolutionBtn">ü§ñ –†–µ—à–µ–Ω–∏–µ</button>
          </div>

          <div style="margin-top:10px;">
            <textarea id="aiQuestion" class="aiTextarea" rows="2" placeholder="–ú–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –≤–æ–ø—Ä–æ—Å (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
          </div>

          <div id="aiAnswerBox" class="feedback" style="display:none; margin-top:10px;"></div>

          <div class="small" style="margin-top:8px;">
            –í ¬´–ü–æ–¥—Å–∫–∞–∑–∫–µ¬ª –ò–ò –Ω–µ –¥–æ–ª–∂–µ–Ω –≤—ã–¥–∞–≤–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç. –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞ –Ω–∞–∂–º–∏—Ç–µ ¬´–†–µ—à–µ–Ω–∏–µ¬ª.
          </div>
        </div>

        <details id="solutionBox" style="display:none;">
          <summary><b>–†–∞–∑–±–æ—Ä</b></summary>
          <div class="small" style="margin:8px 0 6px;">–ë–µ–∑ —Ñ–æ—Ä–º—É–ª: ‚Äú–ª–µ—Å–µ–Ω–∫–∞‚Äù + ‚Äú—Å–∫–ª–∞–¥—ã–≤–∞–µ–º‚Äù + ‚Äú—Å—Ä–∞–≤–Ω–∏–ª–∏ —Å 15 —Å–º‚Äù.</div>
          <pre id="solutionText"></pre>
        </details>

        <div class="row" style="margin-top:12px;">
          <button id="btnExport">–°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã CSV</button>
          <button id="btnReset" style="margin-left:auto;">–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const modeEl = $("mode");
  const stepModeEl = $("stepMode");

  const taskTextEl = $("taskText");
  const ansEl = $("answer");

  const feedbackEl = $("feedback");
  const solutionBoxEl = $("solutionBox");
  const solutionTextEl = $("solutionText");

  const statEl = $("stat");
  const howEl = $("how");

  const stepPanelEl = $("stepPanel");
  const stepTableEl = $("stepTable");
  const stepHintEl = $("stepHint");
  const stepUnitEl = $("stepUnit");
  const stepStatusEl = $("stepStatus");
  const stepFeedbackEl = $("stepFeedback");

  const pairPanelEl = $("pairPanel");
  const pairInfoEl = $("pairInfo");
  const pairLinesEl = $("pairLines");
  const mulLabelEl = $("mulLabel");
  const mulExprEl = $("mulExpr");
  const mulInputEl = $("mulInput");
  const mulFeedbackEl = $("mulFeedback");
  const btnMulCheck = $("btnMulCheck");
  const btnMulSkip = $("btnMulSkip");

  const btnFillAnswer = $("btnFillAnswer");
  const fillNoteEl = $("fillNote");

  const btnNew = $("btnNew");
  const btnCheck = $("btnCheck");
  const btnShow = $("btnShow");
  const btnHow = $("btnHow");
  const btnExport = $("btnExport");
  const btnReset = $("btnReset");

  const btnStepCheck = $("btnStepCheck");
  const btnStepSkip = $("btnStepSkip");

  // ===== AI elements =====
  const aiPillEl = $("aiPill");
  const aiHintBtn = $("aiHintBtn");
  const aiExplainBtn = $("aiExplainBtn");
  const aiSolutionBtn = $("aiSolutionBtn");
  const aiQuestionEl = $("aiQuestion");
  const aiAnswerBoxEl = $("aiAnswerBox");

  let current = null;
  let startTs = null;
  let lastSignature = null;

  // –ü–æ—à–∞–≥–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  let stepExpected = [];
  let stepIndex = 2;            // –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–æ 2-–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
  let stepDone = false;
  let stepTol = 0.05;           // –¥–æ–ø—É—Å–∫ –¥–ª—è –æ–∫—Ä—É–≥–ª–µ–Ω–∏–π (–æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –¥–µ–ª–µ–Ω–∏–∏ –Ω–∞ 3)
  let stepLabelLeft = "‚Ññ";
  let stepLabelRight = "–∑–Ω–∞—á–µ–Ω–∏–µ";

  // –ú–∏–Ω–∏-—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ‚Äú—Å–ª–æ–∂–µ–Ω–∏–µ –ø–∞—Ä–∞–º–∏‚Äù
  let pairRequired = false;
  let pairDone = false;
  let pairStage = 0;        // 1: –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ, 2: +—Å–µ—Ä–µ–¥–∏–Ω–∞
  let pairSum = 0;
  let pairPairs = 0;
  let pairMiddle = null;
  let pairProduct = 0;
  let pairTotal = 0;
  let pairUnit = "";

  const state = {
    solved: 0,
    correct: 0,
    times: [],
    attemptsLog: []
  };

  // ===== AI state =====
  const AI_ENDPOINT = "https://mathexam-ai.ladynata3000.workers.dev/api/tutor";
  let aiBusy = false;
  let aiExplainAvailable = false;
  let aiAttemptsThisTask = 0;
  let aiLastStage = "final";      // "step" | "mul" | "final"
  let aiLastUserValue = "";

  function aiSetPill(text, busy=false) {
    if (!aiPillEl) return;
    aiPillEl.textContent = text;
    aiPillEl.style.background = busy ? "#fff7ed" : "#eef1f6";
  }

  function aiShowAnswer(kind, text) {
    if (!aiAnswerBoxEl) return;
    aiAnswerBoxEl.className = "feedback " + (kind || "");
    aiAnswerBoxEl.textContent = text;
    aiAnswerBoxEl.style.display = "block";
  }

  function aiHideAnswer() {
    if (!aiAnswerBoxEl) return;
    aiAnswerBoxEl.style.display = "none";
    aiAnswerBoxEl.textContent = "";
  }

  function aiUpdateExplainButton() {
    if (!aiExplainBtn) return;
    aiExplainBtn.disabled = aiBusy || !aiExplainAvailable || !current;
  }

  function aiSetButtonsDisabled(disabled) {
    const dis = disabled || !current;
    if (aiHintBtn) aiHintBtn.disabled = dis;
    if (aiSolutionBtn) aiSolutionBtn.disabled = dis;
    aiUpdateExplainButton();
  }

  function aiResetForNewTask(clearQuestion=true) {
    aiBusy = false;
    aiExplainAvailable = false;
    aiAttemptsThisTask = 0;
    aiLastStage = "final";
    aiLastUserValue = "";

    if (aiQuestionEl && clearQuestion) aiQuestionEl.value = "";
    aiHideAnswer();
    aiSetPill("–≥–æ—Ç–æ–≤", false);
    aiSetButtonsDisabled(false);
  }

  function inferStageNow() {
    if (stepModeEl.checked && !stepDone) return "step";
    if (stepModeEl.checked && current && current.kind === "brake" && pairRequired && !pairDone) return "mul";
    return "final";
  }

  function termsPreview(arr) {
    if (!Array.isArray(arr)) return { total: 0, all: [] };
    if (arr.length <= 24) return { total: arr.length, all: arr };
    return { total: arr.length, first: arr.slice(0, 12), last: arr.slice(-12) };
  }

  function buildAITask(mode, reveal) {
    if (!current) return null;

    const stageNow = inferStageNow();

    // –ø—Ä–æ—Å—Ç—ã–µ –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    let delta = null;
    let factor = null;
    if (current.kind === "brake" && Array.isArray(current.terms) && current.terms.length >= 2) {
      delta = current.terms[0] - current.terms[1];
    }
    if (current.kind === "bounce" && Array.isArray(current.terms) && current.terms.length >= 2) {
      // h2 = h1 / factor => factor = h1 / h2
      const raw = current.terms[1] !== 0 ? (current.terms[0] / current.terms[1]) : null;
      if (raw) factor = Math.round(raw * 1000) / 1000;
    }

    const teacherNotesBrake =
      "–¢–æ—Ä–º–æ–∂–µ–Ω–∏–µ: –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –º–∏–Ω—É—Å –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ (–ª–µ—Å–µ–Ω–∫–∞). " +
      "–î–ª—è '–¥–æ –ø–æ–ª–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏' —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (0 –Ω–µ –≤–∫–ª—é—á–∞–µ–º). " +
      "–î–ª—è '–∑–∞ –ø–µ—Ä–≤—ã–µ n —Å–µ–∫—É–Ω–¥' –±–µ—Ä–µ–º —Ä–æ–≤–Ω–æ n —á–ª–µ–Ω–æ–≤. " +
      "–°—É–º–º—É –º–æ–∂–Ω–æ —Å–ª–æ–∂–∏—Ç—å –ø–∞—Ä–∞–º–∏ (–ø–µ—Ä–≤—ã–π+–ø–æ—Å–ª–µ–¥–Ω–∏–π –∏ —Ç.–¥.). " +
      "–ï—Å–ª–∏ reveal=false (hint/explain) ‚Äî –ù–ï –Ω–∞–∑—ã–≤–∞–π –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É.";

    const teacherNotesBounce =
      "–ü—Ä—ã–∂–∫–∏: —É–¥–æ–±–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä—ã (–ø–æ—Ä–æ–≥ 15 —Å–º). " +
      "–î–∞–ª—å—à–µ –∫–∞–∂–¥—ã–π –ø—Ä—ã–∂–æ–∫ –¥–µ–ª–∏–º –Ω–∞ 2 –∏–ª–∏ –Ω–∞ 3. " +
      "–ù—É–∂–µ–Ω –Ω–æ–º–µ—Ä –ø–µ—Ä–≤–æ–≥–æ –ø—Ä—ã–∂–∫–∞, –≥–¥–µ —Å—Ç–∞–ª–æ < 15 —Å–º. " +
      "–ï—Å–ª–∏ reveal=false (hint/explain) ‚Äî –ù–ï –Ω–∞–∑—ã–≤–∞–π –Ω–æ–º–µ—Ä –ø—Ä—ã–∂–∫–∞-–æ—Ç–≤–µ—Ç.";

    const task = {
      topic: "braking-bounces",
      kind: current.kind,                // "brake" | "bounce"
      stage: stageNow,
      lastErrorStage: aiLastStage,
      question: current.question,
      unit: current.unit,
      stepMode: !!stepModeEl.checked,
      stepDone: !!stepDone,
      stepIndex: stepModeEl.checked ? stepIndex : null,
      stepTotal: stepModeEl.checked ? stepExpected.length : null,
      stepTolerance: stepTol,
      terms: termsPreview(current.terms || []),
      delta,
      factor,
      thresholdCm: (current.kind === "bounce") ? 15 : null,

      pair: (current.kind === "brake") ? {
        required: pairRequired,
        done: pairDone,
        stage: pairStage,
        pairs: pairPairs,
        pairSum: pairSum,
        middle: pairMiddle,
      } : null,

      userAnswer: aiLastUserValue,
      attempts: aiAttemptsThisTask,
      reveal: !!reveal,
      correctAnswer: String(current.answer),
      teacherNotes: (current.kind === "brake") ? teacherNotesBrake : teacherNotesBounce
    };

    // –ï—Å–ª–∏ —É—á–µ–Ω–∏–∫ –æ—à–∏–±—Å—è –∏–º–µ–Ω–Ω–æ –≤ —à–∞–≥–µ, –ø–æ–ª–µ–∑–Ω–æ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å "–∫–∞–∫–æ–π —à–∞–≥ —Å–µ–π—á–∞—Å"
    if (aiLastStage === "step" && stepModeEl.checked && !stepDone) {
      const need = stepExpected[stepIndex - 1];
      task.stepNeedNow = Number.isFinite(need) ? need : null;
      const prev = stepIndex > 2 ? stepExpected[stepIndex - 2] : stepExpected[0];
      task.stepPrev = Number.isFinite(prev) ? prev : null;
    }

    // –ï—Å–ª–∏ –æ—à–∏–±—Å—è –≤ —É–º–Ω–æ–∂–µ–Ω–∏–∏ ‚Äî –¥–æ–±–∞–≤–∏–º –æ–∂–∏–¥–∞–µ–º–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
    if (aiLastStage === "mul" && pairRequired && !pairDone) {
      task.mulExpected =
        (pairStage === 1) ? `${pairSum} √ó ${pairPairs}` :
        (pairMiddle !== null) ? `${pairProduct} + ${pairMiddle}` :
        `${pairProduct}`;
    }

    return task;
  }

  async function callAI(mode) {
    if (!current) {
      aiShowAnswer("bad", "–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä¬ª.");
      return;
    }
    if (aiBusy) return;

    const reveal = (mode === "solution");
    const task = buildAITask(mode, reveal);
    if (!task) return;

    const userText = aiQuestionEl ? aiQuestionEl.value.trim() : "";

    aiBusy = true;
    aiSetPill("–¥—É–º–∞—é‚Ä¶", true);
    aiSetButtonsDisabled(true);
    aiShowAnswer("", "‚Ä¶–¥—É–º–∞—é");

    try {
      const resp = await fetch(AI_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mode, task, userText })
      });
      const data = await resp.json();
      if (!data.ok) throw new Error(data.error || "AI error");
      aiShowAnswer("", data.text);
      aiSetPill("–≥–æ—Ç–æ–≤", false);
    } catch (e) {
      aiShowAnswer("bad", "–ò–ò –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
      aiSetPill("–æ—à–∏–±–∫–∞", false);
    } finally {
      aiBusy = false;
      aiSetButtonsDisabled(false);
    }
  }

  function fmtSmart(x, digits=4) {
    if (Number.isInteger(x)) return String(x);
    const v = Math.round(x * Math.pow(10, digits)) / Math.pow(10, digits);
    let s = String(v);
    if (s.includes(".")) s = s.replace(".", ",");
    return s;
  }

  function fmtMeters(m) {
    const v = Math.round(m * 100) / 100;
    let s = String(v);
    if (s.includes(".")) s = s.replace(".", ",");
    return s;
  }

  function parseUserNumber(s) {
    if (typeof s !== "string") return NaN;
    const t = s.trim().replace(",", ".").replace(/\s+/g, "");
    if (t === "") return NaN;

    // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π: "1/3"
    if (t.includes("/")) {
      const parts = t.split("/");
      if (parts.length === 2) {
        const a = Number(parts[0]);
        const b = Number(parts[1]);
        if (Number.isFinite(a) && Number.isFinite(b) && b !== 0) return a / b;
      }
    }

    const n = Number(t);
    return Number.isFinite(n) ? n : NaN;
  }

  function closeEnough(a, b, tol) {
    return Math.abs(a - b) <= tol;
  }

  function showFeedback(kind, html) {
    feedbackEl.className = "feedback " + (kind || "");
    feedbackEl.innerHTML = html;
    feedbackEl.style.display = "block";
  }
  function hideFeedback() { feedbackEl.style.display = "none"; }

  function showStepFeedback(kind, html) {
    stepFeedbackEl.className = "feedback " + (kind || "");
    stepFeedbackEl.innerHTML = html;
    stepFeedbackEl.style.display = "block";
  }
  function hideStepFeedback() { stepFeedbackEl.style.display = "none"; }

  function showMulFeedback(kind, html) {
    mulFeedbackEl.className = "feedback " + (kind || "");
    mulFeedbackEl.innerHTML = html;
    mulFeedbackEl.style.display = "block";
  }
  function hideMulFeedback() { mulFeedbackEl.style.display = "none"; }

  function setStat() {
    const acc = state.solved ? (state.correct / state.solved) : 0;
    const avg = state.times.length ? (state.times.reduce((a,b)=>a+b,0) / state.times.length) : 0;
    statEl.textContent = `${state.solved} —Ä–µ—à–µ–Ω–æ ¬∑ ${(acc*100).toFixed(0)}% ¬∑ —Å—Ä. ${avg.toFixed(1)} —Å`;
  }

  function resetPairExerciseUI() {
    pairRequired = false;
    pairDone = false;
    pairStage = 0;
    pairSum = 0;
    pairPairs = 0;
    pairMiddle = null;
    pairProduct = 0;
    pairTotal = 0;
    pairUnit = "";

    pairPanelEl.style.display = "none";
    pairInfoEl.textContent = "‚Äî";
    pairLinesEl.innerHTML = "";
    mulLabelEl.textContent = "–ü–æ—Å—á–∏—Ç–∞–π—Ç–µ:";
    mulExprEl.textContent = "";
    mulInputEl.value = "";
    mulInputEl.disabled = false;
    btnMulCheck.disabled = false;
    hideMulFeedback();

    btnFillAnswer.disabled = true;
    fillNoteEl.textContent = "";
  }

  function resetUIForNewTask() {
    ansEl.value = "";
    hideFeedback();

    solutionBoxEl.style.display = "none";
    solutionBoxEl.open = false;
    btnShow.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–±–æ—Ä";

    btnCheck.disabled = false;

    // —Å–±—Ä–æ—Å –º–∏–Ω–∏-—É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
    resetPairExerciseUI();

    stepDone = !stepModeEl.checked;
    ansEl.disabled = !stepDone;
    btnCheck.disabled = !stepDone;

    stepPanelEl.style.display = stepModeEl.checked ? "block" : "none";
    hideStepFeedback();

    // AI reset
    aiResetForNewTask(true);
  }

  // ======= –í–∞—à–∏ 4 –∑–∞–¥–∞—á–∏ (1‚Äì4) =======
  function task1_fixed() {
    const a1 = 36, dec = 6;
    const terms = [];
    for (let x=a1; x>0; x-=dec) terms.push(x);
    const sum = terms.reduce((p,c)=>p+c,0);

    return {
      id: "fixed_1",
      signature: "fixed_1",
      kind: "brake",
      question: `1) –í–æ–¥–∏—Ç–µ–ª—å –Ω–∞—á–∞–ª —Ç–æ—Ä–º–æ–∂–µ–Ω–∏–µ. –ó–∞ –ø–µ—Ä–≤—É—é —Å–µ–∫—É–Ω–¥—É –æ–Ω –ø—Ä–æ–µ—Ö–∞–ª 36 –º, –∞ –∑–∞ –∫–∞–∂–¥—É—é —Å–ª–µ–¥—É—é—â—É—é ‚Äî –Ω–∞ 6 –º –º–µ–Ω—å—à–µ. –°–∫–æ–ª—å–∫–æ –º–µ—Ç—Ä–æ–≤ –æ–Ω –ø—Ä–æ–µ—Ö–∞–ª –¥–æ –ø–æ–ª–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏?`,
      answer: sum,
      terms,
      unit: "–º",
      stepUnit: "–º",
      stepTol: 0,
      stepLeft: "—Å–µ–∫—É–Ω–¥–∞ ‚Ññ",
      stepRight: "–º–µ—Ç—Ä–æ–≤ –∑–∞ —Å–µ–∫—É–Ω–¥—É",
      stepHint: `–°–æ—Å—Ç–∞–≤—å—Ç–µ –ª–µ—Å–µ–Ω–∫—É: –∫–∞–∂–¥—ã–π —Ä–∞–∑ –º–∏–Ω—É—Å 6. –û—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å —Ç–∞–º, –≥–¥–µ –¥–∞–ª—å—à–µ –±—ã–ª–æ –±—ã 0.`,
      solution: (() => {
        const lines = [];
        lines.push(`–õ–µ—Å–µ–Ω–∫–∞ (–º–µ—Ç—Ä–æ–≤ –∑–∞ —Å–µ–∫—É–Ω–¥—É): ${terms.join(", ")}.`);
        lines.push(`–ú–æ–∂–Ω–æ —Å–ª–æ–∂–∏—Ç—å ‚Äú–≤ –ª–æ–±‚Äù, –∞ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ ‚Äî –ø–∞—Ä–∞–º–∏ (–ø–µ—Ä–≤–æ–µ+–ø–æ—Å–ª–µ–¥–Ω–µ–µ –∏ —Ç.–¥.).`);
        lines.push(`–û—Ç–≤–µ—Ç: ${sum}.`);
        return lines.join("\n");
      })()
    };
  }

  function task2_fixed() {
    const a1 = 21, dec = 3, n = 5;
    const terms = [];
    for (let i=0;i<n;i++) terms.push(a1 - dec*i);
    const sum = terms.reduce((p,c)=>p+c,0);

    return {
      id: "fixed_2",
      signature: "fixed_2",
      kind: "brake",
      question: `2) –í–æ–¥–∏—Ç–µ–ª—å –Ω–∞—á–∞–ª —Ç–æ—Ä–º–æ–∂–µ–Ω–∏–µ. –ó–∞ –ø–µ—Ä–≤—É—é —Å–µ–∫—É–Ω–¥—É –æ–Ω –ø—Ä–æ–µ—Ö–∞–ª 21 –º, –∞ –∑–∞ –∫–∞–∂–¥—É—é —Å–ª–µ–¥—É—é—â—É—é ‚Äî –Ω–∞ 3 –º –º–µ–Ω—å—à–µ. –°–∫–æ–ª—å–∫–æ –º–µ—Ç—Ä–æ–≤ –æ–Ω –ø—Ä–æ—à—ë–ª –∑–∞ –ø–µ—Ä–≤—ã–µ 5 —Å–µ–∫—É–Ω–¥ —Ç–æ—Ä–º–æ–∂–µ–Ω–∏—è?`,
      answer: sum,
      terms,
      unit: "–º",
      stepUnit: "–º",
      stepTol: 0,
      stepLeft: "—Å–µ–∫—É–Ω–¥–∞ ‚Ññ",
      stepRight: "–º–µ—Ç—Ä–æ–≤ –∑–∞ —Å–µ–∫—É–Ω–¥—É",
      stepHint: `–°–¥–µ–ª–∞–π—Ç–µ 5 —à–∞–≥–æ–≤ –ª–µ—Å–µ–Ω–∫–∏: –∫–∞–∂–¥—ã–π —Ä–∞–∑ –º–∏–Ω—É—Å 3. –ü–æ—Ç–æ–º —Å–ª–æ–∂–∏—Ç–µ 5 —á–∏—Å–µ–ª.`,
      solution: (() => {
        const lines = [];
        lines.push(`–õ–µ—Å–µ–Ω–∫–∞ (5 —Å–µ–∫—É–Ω–¥): ${terms.join(", ")}.`);
        lines.push(`–£–¥–æ–±–Ω–æ —Å–ª–æ–∂–∏—Ç—å –ø–∞—Ä–∞–º–∏: (–ø–µ—Ä–≤–æ–µ+–ø–æ—Å–ª–µ–¥–Ω–µ–µ), (–≤—Ç–æ—Ä–æ–µ+–ø—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω–µ–µ), –∏ –µ—Å–ª–∏ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Å–µ—Ä–µ–¥–∏–Ω–∞ ‚Äî –ø—Ä–∏–±–∞–≤–∏—Ç—å –µ—ë.`);
        lines.push(`–û—Ç–≤–µ—Ç: ${sum}.`);
        return lines.join("\n");
      })()
    };
  }

  function task3_fixed() {
    const h1m = 3.6, factor = 2, thresholdCm = 15;
    const h1cm = h1m * 100;

    const heights = [h1cm];
    while (heights[heights.length-1] >= thresholdCm && heights.length < 60) {
      heights.push(heights[heights.length-1] / factor);
    }
    const answer = heights.length;

    return {
      id: "fixed_3",
      signature: "fixed_3",
      kind: "bounce",
      question: `3) –ú—è—á–∏–∫ –æ—Ç—Å–∫–æ—á–∏–ª –Ω–∞ 3,6 –º, –∞ –¥–∞–ª—å—à–µ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø–æ–¥–ø—Ä—ã–≥–∏–≤–∞–ª –≤ 2 —Ä–∞–∑–∞ –Ω–∏–∂–µ. –ù–∞ –∫–∞–∫–æ–º –ø—Ä—ã–∂–∫–µ –æ–Ω –≤–ø–µ—Ä–≤—ã–µ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç 15 —Å–º?`,
      answer,
      terms: heights,
      unit: "—Å–º",
      stepUnit: "—Å–º",
      stepTol: 0.05,
      stepLeft: "–ø—Ä—ã–∂–æ–∫ ‚Ññ",
      stepRight: "–≤—ã—Å–æ—Ç–∞",
      stepHint: `–°—á–∏—Ç–∞–µ–º –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö: 3,6 –º = 360 —Å–º. –ö–∞–∂–¥—ã–π —Ä–∞–∑ –¥–µ–ª–∏–º –Ω–∞ 2, –ø–æ–∫–∞ –Ω–µ —Å—Ç–∞–Ω–µ—Ç < 15.`,
      solution: (() => {
        const show = heights.slice(0, Math.min(10, heights.length)).map((v,i)=>`${i+1}) ${fmtSmart(v)} —Å–º`).join("\n");
        const lines = [];
        lines.push(`3,6 –º = 360 —Å–º.`);
        lines.push(`–î–µ–ª–∏–º –Ω–∞ 2 –∫–∞–∂–¥—ã–π —Ä–∞–∑:`);
        lines.push(show);
        lines.push(`–ü–µ—Ä–≤—ã–π —Ä–∞–∑ –Ω–∏–∂–µ 15 —Å–º ‚Äî –Ω–∞ ${answer}-–º –ø—Ä—ã–∂–∫–µ.`);
        lines.push(`–û—Ç–≤–µ—Ç: ${answer}.`);
        return lines.join("\n");
      })()
    };
  }

  function task4_fixed() {
    const h1m = 4.8, factor = 3, thresholdCm = 15;
    const h1cm = h1m * 100;

    const heights = [h1cm];
    while (heights[heights.length-1] >= thresholdCm && heights.length < 60) {
      heights.push(heights[heights.length-1] / factor);
    }
    const answer = heights.length;

    return {
      id: "fixed_4",
      signature: "fixed_4",
      kind: "bounce",
      question: `4) –ú—è—á–∏–∫ –æ—Ç—Å–∫–æ—á–∏–ª –Ω–∞ 4,8 –º, –∞ –¥–∞–ª—å—à–µ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø–æ–¥–ø—Ä—ã–≥–∏–≤–∞–ª –≤ 3 —Ä–∞–∑–∞ –Ω–∏–∂–µ. –ù–∞ –∫–∞–∫–æ–º –ø—Ä—ã–∂–∫–µ –æ–Ω –≤–ø–µ—Ä–≤—ã–µ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç 15 —Å–º?`,
      answer,
      terms: heights,
      unit: "—Å–º",
      stepUnit: "—Å–º",
      stepTol: 0.05,
      stepLeft: "–ø—Ä—ã–∂–æ–∫ ‚Ññ",
      stepRight: "–≤—ã—Å–æ—Ç–∞",
      stepHint: `–°—á–∏—Ç–∞–µ–º –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö: 4,8 –º = 480 —Å–º. –ö–∞–∂–¥—ã–π —Ä–∞–∑ –¥–µ–ª–∏–º –Ω–∞ 3 (–º–æ–∂–Ω–æ –æ–∫—Ä—É–≥–ª—è—Ç—å –¥–æ —Å–æ—Ç—ã—Ö).`,
      solution: (() => {
        const show = heights.slice(0, Math.min(12, heights.length)).map((v,i)=>`${i+1}) ${fmtSmart(v)} —Å–º`).join("\n");
        const lines = [];
        lines.push(`4,8 –º = 480 —Å–º.`);
        lines.push(`–î–µ–ª–∏–º –Ω–∞ 3 –∫–∞–∂–¥—ã–π —Ä–∞–∑:`);
        lines.push(show);
        lines.push(`–ü–µ—Ä–≤—ã–π —Ä–∞–∑ –Ω–∏–∂–µ 15 —Å–º ‚Äî –Ω–∞ ${answer}-–º –ø—Ä—ã–∂–∫–µ.`);
        lines.push(`–û—Ç–≤–µ—Ç: ${answer}.`);
        return lines.join("\n");
      })()
    };
  }

  const fixedSet = [task1_fixed, task2_fixed, task3_fixed, task4_fixed];

  // ======= –†–∞–Ω–¥–æ–º =======
  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

  function genBrakeStop() {
    const dec = [2,3,4,5,6,7,8,9][randInt(0,7)];
    const k = randInt(4, 12);
    const a1 = dec * k;

    const terms = [];
    for (let x=a1; x>0; x-=dec) terms.push(x);
    const sum = terms.reduce((p,c)=>p+c,0);

    return {
      id: "brake_stop",
      signature: `brake_stop|${a1}|${dec}`,
      kind: "brake",
      question: `–í–æ–¥–∏—Ç–µ–ª—å –Ω–∞—á–∞–ª —Ç–æ—Ä–º–æ–∂–µ–Ω–∏–µ. –ó–∞ –ø–µ—Ä–≤—É—é —Å–µ–∫—É–Ω–¥—É –æ–Ω –ø—Ä–æ–µ—Ö–∞–ª ${a1} –º, –∞ –∑–∞ –∫–∞–∂–¥—É—é —Å–ª–µ–¥—É—é—â—É—é ‚Äî –Ω–∞ ${dec} –º –º–µ–Ω—å—à–µ. –°–∫–æ–ª—å–∫–æ –º–µ—Ç—Ä–æ–≤ –æ–Ω –ø—Ä–æ–µ—Ö–∞–ª –¥–æ –ø–æ–ª–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏?`,
      answer: sum,
      terms,
      unit: "–º",
      stepUnit: "–º",
      stepTol: 0,
      stepLeft: "—Å–µ–∫—É–Ω–¥–∞ ‚Ññ",
      stepRight: "–º–µ—Ç—Ä–æ–≤ –∑–∞ —Å–µ–∫—É–Ω–¥—É",
      stepHint: `–°–æ—Å—Ç–∞–≤—å—Ç–µ –ª–µ—Å–µ–Ω–∫—É: –∫–∞–∂–¥—ã–π —Ä–∞–∑ –º–∏–Ω—É—Å ${dec}. –û—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å —Ç–∞–º, –≥–¥–µ –¥–∞–ª—å—à–µ –±—ã–ª–æ –±—ã 0.`,
      solution: `–õ–µ—Å–µ–Ω–∫–∞: ${terms.join(", ")}.\n–°—É–º–º—É —É–¥–æ–±–Ω–æ —Å–ª–æ–∂–∏—Ç—å –ø–∞—Ä–∞–º–∏ (–ø–µ—Ä–≤–æ–µ+–ø–æ—Å–ª–µ–¥–Ω–µ–µ –∏ —Ç.–¥.).\n–û—Ç–≤–µ—Ç: ${sum}.`
    };
  }

  function genBrakeFirstN() {
    const dec = [2,3,4,5,6][randInt(0,4)];
    const n = randInt(4, 8);
    const a1 = dec * randInt(n+2, n+10);

    const terms = [];
    for (let i=0;i<n;i++) terms.push(a1 - dec*i);
    const sum = terms.reduce((p,c)=>p+c,0);

    return {
      id: "brake_first_n",
      signature: `brake_first_n|${a1}|${dec}|${n}`,
      kind: "brake",
      question: `–í–æ–¥–∏—Ç–µ–ª—å –Ω–∞—á–∞–ª —Ç–æ—Ä–º–æ–∂–µ–Ω–∏–µ. –ó–∞ –ø–µ—Ä–≤—É—é —Å–µ–∫—É–Ω–¥—É –æ–Ω –ø—Ä–æ–µ—Ö–∞–ª ${a1} –º, –∞ –∑–∞ –∫–∞–∂–¥—É—é —Å–ª–µ–¥—É—é—â—É—é ‚Äî –Ω–∞ ${dec} –º –º–µ–Ω—å—à–µ. –°–∫–æ–ª—å–∫–æ –º–µ—Ç—Ä–æ–≤ –æ–Ω –ø—Ä–æ—à—ë–ª –∑–∞ –ø–µ—Ä–≤—ã–µ ${n} —Å–µ–∫—É–Ω–¥ —Ç–æ—Ä–º–æ–∂–µ–Ω–∏—è?`,
      answer: sum,
      terms,
      unit: "–º",
      stepUnit: "–º",
      stepTol: 0,
      stepLeft: "—Å–µ–∫—É–Ω–¥–∞ ‚Ññ",
      stepRight: "–º–µ—Ç—Ä–æ–≤ –∑–∞ —Å–µ–∫—É–Ω–¥—É",
      stepHint: `–°–¥–µ–ª–∞–π—Ç–µ ${n} —à–∞–≥–æ–≤ –ª–µ—Å–µ–Ω–∫–∏: –∫–∞–∂–¥—ã–π —Ä–∞–∑ –º–∏–Ω—É—Å ${dec}. –ü–æ—Ç–æ–º —Å–ª–æ–∂–∏—Ç–µ ${n} —á–∏—Å–µ–ª.`,
      solution: `–õ–µ—Å–µ–Ω–∫–∞: ${terms.join(", ")}.\n–°—É–º–º—É —É–¥–æ–±–Ω–æ —Å–ª–æ–∂–∏—Ç—å –ø–∞—Ä–∞–º–∏ (–ø–µ—Ä–≤–æ–µ+–ø–æ—Å–ª–µ–¥–Ω–µ–µ –∏ —Ç.–¥.).\n–û—Ç–≤–µ—Ç: ${sum}.`
    };
  }

  function genBounceThreshold() {
    const factor = (Math.random() < 0.5) ? 2 : 3;
    const answerWanted = randInt(4, 8);
    const thresholdCm = 15;

    const m = (factor === 3) ? [1,2][randInt(0,1)] : 1;
    const h1cm = thresholdCm * m * Math.pow(factor, answerWanted-2);
    const h1m = h1cm / 100;

    const heights = [h1cm];
    while (heights[heights.length-1] >= thresholdCm && heights.length < 60) {
      heights.push(heights[heights.length-1] / factor);
    }

    return {
      id: "bounce_threshold",
      signature: `bounce|${factor}|${h1cm}`,
      kind: "bounce",
      question: `–ú—è—á–∏–∫ –æ—Ç—Å–∫–æ—á–∏–ª –Ω–∞ ${fmtMeters(h1m)} –º, –∞ –¥–∞–ª—å—à–µ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø–æ–¥–ø—Ä—ã–≥–∏–≤–∞–ª –≤ ${factor} —Ä–∞–∑–∞ –Ω–∏–∂–µ. –ù–∞ –∫–∞–∫–æ–º –ø—Ä—ã–∂–∫–µ –æ–Ω –≤–ø–µ—Ä–≤—ã–µ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç 15 —Å–º?`,
      answer: heights.length,
      terms: heights,
      unit: "—Å–º",
      stepUnit: "—Å–º",
      stepTol: 0.05,
      stepLeft: "–ø—Ä—ã–∂–æ–∫ ‚Ññ",
      stepRight: "–≤—ã—Å–æ—Ç–∞",
      stepHint: `–°—á–∏—Ç–∞–µ–º –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö: ${fmtMeters(h1m)} –º = ${fmtSmart(h1cm)} —Å–º. –ö–∞–∂–¥—ã–π —Ä–∞–∑ –¥–µ–ª–∏–º –Ω–∞ ${factor}.`,
      solution: (() => {
        const show = heights.map((v,i)=>`${i+1}) ${fmtSmart(v)} —Å–º`).join("\n");
        return `–ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ —Å–º: ${fmtMeters(h1m)} –º = ${fmtSmart(h1cm)} —Å–º.\n–î–µ–ª–∏–º –Ω–∞ ${factor}:\n${show}\n–û—Ç–≤–µ—Ç: ${heights.length}.`;
      })()
    };
  }

  function chooseTask() {
    const mode = modeEl.value;

    if (mode === "fixed") {
      let idx = 0;
      if (current && current.id.startsWith("fixed_")) {
        const curIdx = ["fixed_1","fixed_2","fixed_3","fixed_4"].indexOf(current.id);
        idx = (curIdx + 1) % 4;
      }
      return fixedSet[idx]();
    }

    const gens = [];
    if (mode === "mix" || mode === "brake") gens.push(genBrakeStop, genBrakeFirstN);
    if (mode === "mix" || mode === "bounce") gens.push(genBounceThreshold);

    for (let tries=0; tries<20; tries++){
      const t = gens[randInt(0, gens.length-1)]();
      if (t.signature !== lastSignature) return t;
    }
    return gens[0]();
  }

  function buildStepPanel(task) {
    stepExpected = task.terms.slice();
    stepIndex = 2;
    stepDone = !stepModeEl.checked;

    stepTol = task.stepTol ?? 0.05;
    stepLabelLeft = task.stepLeft ?? "‚Ññ";
    stepLabelRight = task.stepRight ?? "–∑–Ω–∞—á–µ–Ω–∏–µ";

    stepUnitEl.textContent = task.stepUnit ? `–µ–¥.: ${task.stepUnit}` : "–µ–¥.";
    stepHintEl.textContent = task.stepHint || "–°—á–∏—Ç–∞–µ–º –ø–æ —à–∞–≥–∞–º.";
    stepStatusEl.textContent = stepModeEl.checked ? `–®–∞–≥: 2 –∏–∑ ${stepExpected.length}` : "";

    // —Å–±—Ä–æ—Å ‚Äú—Å–ª–æ–∂–µ–Ω–∏—è –ø–∞—Ä–∞–º–∏‚Äù
    resetPairExerciseUI();

    stepTableEl.innerHTML = "";

    const thead = document.createElement("thead");
    const trh = document.createElement("tr");
    ["", stepLabelLeft, stepLabelRight].forEach(h => {
      const th = document.createElement("th");
      th.textContent = h;
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    stepTableEl.appendChild(thead);

    const tbody = document.createElement("tbody");

    for (let i=1; i<=stepExpected.length; i++) {
      const tr = document.createElement("tr");

      const tdMark = document.createElement("td");
      tdMark.id = `mark_${i}`;
      tdMark.textContent = (i===1) ? "–¥–∞–Ω–æ" : "";
      tr.appendChild(tdMark);

      const tdIdx = document.createElement("td");
      tdIdx.textContent = i;
      tr.appendChild(tdIdx);

      const tdVal = document.createElement("td");

      if (i === 1) {
        tdVal.textContent = `${fmtSmart(stepExpected[0])} ${task.stepUnit || ""}`.trim();
        tdVal.classList.add("lock");
      } else {
        const input = document.createElement("input");
        input.type = "text";
        input.inputMode = "decimal";
        input.placeholder = "–≤–≤–µ–¥–∏—Ç–µ";
        input.style.minWidth = "140px";
        input.id = `step_in_${i}`;
        input.disabled = (i !== 2);
        if (i !== 2) input.style.display = "none";
        tdVal.appendChild(input);

        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") checkStep();
        });
      }

      tr.appendChild(tdVal);
      tbody.appendChild(tr);
    }

    stepTableEl.appendChild(tbody);
    hideStepFeedback();

    const firstInput = document.getElementById("step_in_2");
    if (firstInput) firstInput.focus();
  }

  function renderTask(t) {
    current = t;
    lastSignature = t.signature;
    startTs = Date.now();

    taskTextEl.textContent = t.question;
    solutionTextEl.textContent = t.solution || "";

    resetUIForNewTask();

    if (stepModeEl.checked) {
      stepPanelEl.style.display = "block";
      buildStepPanel(t);
      ansEl.disabled = true;
      btnCheck.disabled = true;
    } else {
      stepPanelEl.style.display = "none";
      stepDone = true;
      ansEl.disabled = false;
      btnCheck.disabled = false;
      ansEl.focus();
    }
  }

  function setupPairExercise(terms, unit) {
    const n = terms.length;
    if (n < 2) return;

    pairUnit = unit || "";
    pairPairs = Math.floor(n / 2);
    pairSum = terms[0] + terms[n - 1];
    pairMiddle = (n % 2 === 1) ? terms[pairPairs] : null;
    pairProduct = pairSum * pairPairs;
    pairTotal = pairProduct + (pairMiddle ?? 0);

    pairRequired = true;
    pairDone = false;
    pairStage = 1;

    btnFillAnswer.disabled = true;
    fillNoteEl.textContent = "–°—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å—á—ë—Ç–∞.";

    const lines = [];
    for (let i = 0; i < pairPairs; i++) {
      const a = terms[i];
      const b = terms[n - 1 - i];
      lines.push(`${a} + ${b} = ${a + b}`);
    }

    const unitTail = pairUnit ? ` ${pairUnit}` : "";
    let html = `–°–∫–ª–∞–¥—ã–≤–∞–µ–º –ø–∞—Ä–∞–º–∏: <b>–ø–µ—Ä–≤–æ–µ + –ø–æ—Å–ª–µ–¥–Ω–µ–µ</b>, <b>–≤—Ç–æ—Ä–æ–µ + –ø—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω–µ–µ</b> –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ.<br>`;
    html += lines.map(s => `‚Ä¢ ${s}${unitTail}`).join("<br>");
    html += `<br><br>`;
    html += `–ü–æ–ª—É—á–∏–ª–æ—Å—å <b>${pairPairs}</b> –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å—É–º–º –ø–æ <b>${pairSum}${unitTail}</b>.`;

    if (pairMiddle !== null) {
      html += `<br>–ò –µ—Å—Ç—å ‚Äú—Å–µ—Ä–µ–¥–∏–Ω–∞‚Äù: <b>${pairMiddle}${unitTail}</b> (–µ—ë –ø—Ä–∏–±–∞–≤–∏–º –≤ –∫–æ–Ω—Ü–µ).`;
    }

    pairLinesEl.innerHTML = html;
    pairInfoEl.textContent = `${pairPairs} –ø–∞—Ä`;

    pairPanelEl.style.display = "block";
    hideMulFeedback();

    setMulStageUI();
  }

  function setMulStageUI() {
    mulInputEl.value = "";
    mulInputEl.disabled = false;
    btnMulCheck.disabled = false;

    const unitTail = pairUnit ? ` ${pairUnit}` : "";

    if (pairStage === 1) {
      mulLabelEl.textContent = "–ü–æ—Å—á–∏—Ç–∞–π—Ç–µ:";
      mulExprEl.textContent = `${pairSum} √ó ${pairPairs}${unitTail}`;
    } else {
      mulLabelEl.textContent = "–ê —Ç–µ–ø–µ—Ä—å:";
      mulExprEl.textContent = `${pairProduct} + ${pairMiddle}${unitTail}`;
    }

    setTimeout(() => mulInputEl.focus(), 0);
  }

  function enableFillAnswerButton() {
    btnFillAnswer.disabled = false;
    fillNoteEl.textContent = "–ú–æ–∂–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å —Å—É–º–º—É –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å.";
  }

  function fillAnswerFromPair() {
    if (!current || !pairRequired || !pairDone) return;
    ansEl.value = String(current.answer);
    ansEl.disabled = false;
    btnCheck.disabled = false;
    ansEl.focus();
    ansEl.select();
    showFeedback("good", "–°—É–º–º–∞ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ –ø–æ–ª–µ ¬´–û—Ç–≤–µ—Ç¬ª. –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å¬ª.");
  }

  function completePairExercise() {
    pairDone = true;
    mulInputEl.disabled = true;
    btnMulCheck.disabled = true;

    enableFillAnswerButton();

    ansEl.disabled = false;
    btnCheck.disabled = false;
    ansEl.focus();
  }

  function checkMul() {
    if (!pairRequired || pairDone) return;

    // AI: —Ñ–∏–∫—Å–∏—Ä—É–µ–º –ø–æ–ø—ã—Ç–∫—É –≤ –±–ª–æ–∫–µ —É–º–Ω–æ–∂–µ–Ω–∏—è
    aiAttemptsThisTask += 1;
    aiLastStage = "mul";
    aiLastUserValue = (mulInputEl.value || "").trim();

    const user = parseUserNumber(mulInputEl.value);
    if (!Number.isFinite(user)) {
      aiExplainAvailable = true;
      aiUpdateExplainButton();
      showMulFeedback("bad", "–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ.");
      return;
    }

    const expected = (pairStage === 1) ? pairProduct : pairTotal;
    const ok = closeEnough(user, expected, 0.0001);

    if (!ok) {
      aiExplainAvailable = true;
      aiUpdateExplainButton();
      showMulFeedback("bad", "–ü–æ–∫–∞ –Ω–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
      return;
    }

    // –≤—Å—ë –≤–µ—Ä–Ω–æ ‚Äî –æ–±—ä—è—Å–Ω—è—Ç—å –æ—à–∏–±–∫—É –Ω–µ –Ω—É–∂–Ω–æ
    aiExplainAvailable = false;
    aiUpdateExplainButton();

    if (pairStage === 1 && pairMiddle !== null) {
      showMulFeedback("good", `‚úÖ –í–µ—Ä–Ω–æ: <b>${pairSum} √ó ${pairPairs} = ${pairProduct}</b>. –¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤—å—Ç–µ —Å–µ—Ä–µ–¥–∏–Ω—É.`);
      pairStage = 2;
      setMulStageUI();
      return;
    }

    showMulFeedback("good", `‚úÖ –û—Ç–ª–∏—á–Ω–æ. –°—É–º–º–∞ –ø–æ–ª—É—á–∏–ª–∞—Å—å <b>${pairTotal}</b>${pairUnit ? " " + pairUnit : ""}. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –µ—ë –≤ –æ—Ç–≤–µ—Ç –Ω–∏–∂–µ.`);
    completePairExercise();
  }

  function skipMul() {
    pairDone = true;
    showMulFeedback("good", "–û–∫, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É–º–Ω–æ–∂–µ–Ω–∏–µ. –ù–æ –ø–æ–º–Ω–∏—Ç–µ: –ª–µ—Å–µ–Ω–∫—É —É–¥–æ–±–Ω–æ —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å –ø–∞—Ä–∞–º–∏.");

    enableFillAnswerButton();

    ansEl.disabled = false;
    btnCheck.disabled = false;
    ansEl.focus();
  }

  function checkStep() {
    if (!current || !stepModeEl.checked) return;
    if (stepIndex > stepExpected.length) return;

    const input = document.getElementById(`step_in_${stepIndex}`);
    if (!input) return;

    // AI: —Ñ–∏–∫—Å–∏—Ä—É–µ–º –ø–æ–ø—ã—Ç–∫—É –≤ —à–∞–≥–µ
    aiAttemptsThisTask += 1;
    aiLastStage = "step";
    aiLastUserValue = (input.value || "").trim();

    const user = parseUserNumber(input.value);
    const need = stepExpected[stepIndex-1];

    if (!Number.isFinite(user)) {
      aiExplainAvailable = true;
      aiUpdateExplainButton();
      showStepFeedback("bad", `–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ. –ú–æ–∂–Ω–æ —Å –∑–∞–ø—è—Ç–æ–π. –ü—Ä–∏ –¥–µ–ª–µ–Ω–∏–∏ –Ω–∞ 3 –¥–æ–ø—É—Å—Ç–∏–º–æ –æ–∫—Ä—É–≥–ª—è—Ç—å (—Ö–æ—Ç—è –±—ã –¥–æ —Å–æ—Ç—ã—Ö).`);
      return;
    }

    const ok = closeEnough(user, need, stepTol);

    if (!ok) {
      aiExplainAvailable = true;
      aiUpdateExplainButton();
      showStepFeedback("bad", `–ü–æ–∫–∞ –Ω–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ —à–∞–≥–∞ (–º–∏–Ω—É—Å –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ / –¥–µ–ª–∏–º –Ω–∞ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ) –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.`);
      return;
    }

    // —à–∞–≥ –≤–µ—Ä–Ω—ã–π ‚Äî –æ–±—ä—è—Å–Ω—è—Ç—å –æ—à–∏–±–∫—É –Ω–µ –Ω—É–∂–Ω–æ
    aiExplainAvailable = false;
    aiUpdateExplainButton();

    const mark = document.getElementById(`mark_${stepIndex}`);
    if (mark) { mark.textContent = "‚úì"; mark.classList.add("okcell"); }

    input.disabled = true;
    input.style.display = "inline-block";
    input.classList.add("lock");

    stepIndex++;

    if (stepIndex <= stepExpected.length) {
      const next = document.getElementById(`step_in_${stepIndex}`);
      if (next) {
        next.style.display = "inline-block";
        next.disabled = false;
        next.focus();
      }
      stepStatusEl.textContent = `–®–∞–≥: ${stepIndex} –∏–∑ ${stepExpected.length}`;
      hideStepFeedback();
    } else {
      stepDone = true;
      stepStatusEl.textContent = `–ì–æ—Ç–æ–≤–æ: —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞`;

      if (current.kind === "brake") {
        showStepFeedback("good", `–û—Ç–ª–∏—á–Ω–æ. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Å–ª–æ–∂–∏—Ç—å –±—ã—Å—Ç—Ä–µ–µ: –ø–µ—Ä–≤–æ–µ + –ø–æ—Å–ª–µ–¥–Ω–µ–µ, –≤—Ç–æ—Ä–æ–µ + –ø—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω–µ–µ ‚Äî –ø–æ–ª—É—á–∞—é—Ç—Å—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Å—É–º–º—ã.`);
        setupPairExercise(stepExpected, current.stepUnit || "");
        ansEl.disabled = true;
        btnCheck.disabled = true;
      } else {
        showStepFeedback("good", `–û—Ç–ª–∏—á–Ω–æ. –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç –Ω–∏–∂–µ (—Å—É–º–º–∞ –∏–ª–∏ –Ω–æ–º–µ—Ä –ø—Ä—ã–∂–∫–∞).`);
        ansEl.disabled = false;
        btnCheck.disabled = false;
        ansEl.focus();
      }
    }
  }

  function checkAnswer() {
    if (!current) return;

    if (stepModeEl.checked) {
      if (!stepDone) {
        showFeedback("bad", `–°–Ω–∞—á–∞–ª–∞ –¥–æ–≤–µ–¥–∏—Ç–µ –ø–æ—à–∞–≥–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É –¥–æ –∫–æ–Ω—Ü–∞ (–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ‚Äú–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø–æ—à–∞–≥–æ–≤–æ‚Äù).`);
        return;
      }
      if (current.kind === "brake" && pairRequired && !pairDone) {
        showFeedback("bad", `–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–Ω–∏-—à–∞–≥ ‚Äú—É–º–Ω–æ–∂–µ–Ω–∏–µ‚Äù (–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ‚Äú–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —É–º–Ω–æ–∂–µ–Ω–∏–µ‚Äù).`);
        return;
      }
    }

    const userRaw = ansEl.value;

    // AI: —Ñ–∏–∫—Å–∏—Ä—É–µ–º –ø–æ–ø—ã—Ç–∫—É –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ
    aiAttemptsThisTask += 1;
    aiLastStage = "final";
    aiLastUserValue = (userRaw || "").trim();

    const elapsed = startTs ? ((Date.now()-startTs)/1000) : 0;

    state.solved++;
    state.times.push(elapsed);

    const n = parseUserNumber(userRaw);
    const ok = Number.isFinite(n) && Math.round(n) === n && n === current.answer;

    if (ok) state.correct++;

    // AI: –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ–≤–µ—Ä–Ω–æ
    aiExplainAvailable = !ok;
    aiUpdateExplainButton();

    state.attemptsLog.push({
      ts: new Date().toISOString(),
      taskId: current.id,
      signature: current.signature,
      correctAnswer: current.answer,
      userAnswer: userRaw.trim(),
      isCorrect: ok ? 1 : 0,
      timeSec: elapsed.toFixed(1)
    });

    setStat();

    if (ok) {
      showFeedback("good", `‚úÖ –í–µ—Ä–Ω–æ. <b>–û—Ç–≤–µ—Ç: ${current.answer}</b>. –í—Ä–µ–º—è: ${elapsed.toFixed(1)} —Å.`);
      btnCheck.disabled = true;
    } else {
      const hint = (current.kind === "bounce")
        ? `–ü–æ–¥—Å–∫–∞–∑–∫–∞: —Å—á–∏—Ç–∞–π—Ç–µ –≤—ã—Å–æ—Ç—ã —à–∞–≥–∞–º–∏ (—É–¥–æ–±–Ω–æ –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö) –∏ –Ω–∞–π–¥–∏—Ç–µ –ø–µ—Ä–≤—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ —Å—Ç–∞–ª–æ < 15.`
        : `–ü–æ–¥—Å–∫–∞–∑–∫–∞: —Å–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–π—Ç–µ ‚Äú–ª–µ—Å–µ–Ω–∫—É‚Äù —á–∏—Å–µ–ª, –ø–æ—Ç–æ–º —Å–ª–æ–∂–∏—Ç–µ (–º–æ–∂–Ω–æ –ø–∞—Ä–∞–º–∏).`;
      showFeedback("bad", `‚ùå –ü–æ–∫–∞ –Ω–µ—Ç. ${hint} –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ ‚Äú–†–∞–∑–±–æ—Ä‚Äù –∏–ª–∏ —Å–ø—Ä–æ—Å–∏—Ç–µ –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫–∞.`);
    }
  }

  function toggleSolution() {
    if (!current) return;
    const shown = solutionBoxEl.style.display !== "none";
    if (shown) {
      solutionBoxEl.style.display = "none";
      solutionBoxEl.open = false;
      btnShow.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–±–æ—Ä";
    } else {
      solutionBoxEl.style.display = "block";
      solutionBoxEl.open = true;
      btnShow.textContent = "–°–∫—Ä—ã—Ç—å —Ä–∞–∑–±–æ—Ä";
    }
  }

  function exportCSV() {
    const headers = ["timestamp_iso","task_id","signature","correct_answer","user_answer","is_correct","time_sec"];
    const lines = [headers.join(",")];

    state.attemptsLog.forEach(r => {
      const row = [
        r.ts,
        r.taskId,
        `"${String(r.signature).replace(/"/g,'""')}"`,
        r.correctAnswer,
        `"${String(r.userAnswer).replace(/"/g,'""')}"`,
        r.isCorrect,
        r.timeSec
      ];
      lines.push(row.join(","));
    });

    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "trainer_braking_bounces_results.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 2000);
  }

  function resetStats() {
    state.solved = 0;
    state.correct = 0;
    state.times = [];
    state.attemptsLog = [];
    setStat();
    hideFeedback();
  }

  function toggleHow() {
    howEl.style.display = (howEl.style.display === "none") ? "block" : "none";
  }

  function skipStep() {
    stepDone = true;
    stepStatusEl.textContent = `–ü–æ—à–∞–≥–æ–≤–æ –ø—Ä–æ–ø—É—â–µ–Ω–æ`;
    hideStepFeedback();

    resetPairExerciseUI();

    ansEl.disabled = false;
    btnCheck.disabled = false;
    ansEl.focus();
  }

  // handlers
  btnNew.addEventListener("click", () => renderTask(chooseTask()));
  btnCheck.addEventListener("click", checkAnswer);
  btnShow.addEventListener("click", toggleSolution);
  btnHow.addEventListener("click", toggleHow);
  btnExport.addEventListener("click", exportCSV);
  btnReset.addEventListener("click", resetStats);

  btnStepCheck.addEventListener("click", checkStep);
  btnStepSkip.addEventListener("click", skipStep);

  btnMulCheck.addEventListener("click", checkMul);
  btnMulSkip.addEventListener("click", skipMul);

  btnFillAnswer.addEventListener("click", fillAnswerFromPair);

  if (aiHintBtn) aiHintBtn.addEventListener("click", () => callAI("hint"));
  if (aiExplainBtn) aiExplainBtn.addEventListener("click", () => callAI("explain"));
  if (aiSolutionBtn) aiSolutionBtn.addEventListener("click", () => callAI("solution"));

  mulInputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") checkMul();
  });

  ansEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") checkAnswer();
  });

  stepModeEl.addEventListener("change", () => {
    if (!current) return;
    renderTask(current);
  });

  setStat();
  aiSetButtonsDisabled(true);
})();
</script>
</body>
</html>


