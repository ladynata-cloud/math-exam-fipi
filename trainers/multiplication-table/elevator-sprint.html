<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–¢–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è ‚Äî ¬´–õ–∏—Ñ—Ç¬ª (—Å–ø—Ä–∏–Ω—Ç)</title>
  <style>
    :root{
      --bg:#fbfbfa;
      --surface:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border: rgba(15, 23, 42, .12);
      --accent:#2f5f73;
      --soft: rgba(47,95,115,.10);
      --ok: rgba(22,163,74,.12);
      --bad: rgba(239,68,68,.10);
      --shadow: 0 10px 26px rgba(15, 23, 42, .06);
      --r: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.35;
    }
    .wrap{
      width:min(1100px, calc(100% - 32px));
      margin: 18px auto 30px;
    }
    h1{ margin:0 0 6px; font-size: 20px; }
    .sub{ margin:0 0 14px; color:var(--muted); }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .topbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 12px;
    }

    .status{
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.65);
      color: var(--muted);
    }
    .status.ok{ background: var(--ok); border-color: rgba(22,163,74,.25); color: rgba(21,128,61,.95); }
    .status.bad{ background: var(--bad); border-color: rgba(239,68,68,.25); color: rgba(185,28,28,.95); }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 12px;
      align-items:end;
      margin-top: 10px;
    }
    @media (max-width: 520px){
      .controls{ grid-template-columns: 1fr; }
    }

    .field{ display:flex; flex-direction:column; gap:6px; }
    .label{ font-size: 12px; font-weight: 700; color:var(--muted); }
    .input, select{
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(15,23,42,.14);
      background: var(--surface);
      outline:none;
      font-size: 14px;
    }
    .input:focus, select:focus{
      border-color: rgba(47,95,115,.45);
      box-shadow: 0 0 0 3px rgba(47,95,115,.12);
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 10px 14px;
      border-radius: 12px;
      border:1px solid rgba(47,95,115,.25);
      background: var(--accent);
      color:#fff;
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{ filter: brightness(.98); }
    .btn.soft{
      background: rgba(255,255,255,.75);
      color: var(--text);
      border-color: rgba(15,23,42,.14);
      font-weight: 800;
    }
    .btn.soft:hover{ background: rgba(47,95,115,.08); border-color: rgba(47,95,115,.25); }

    .check{
      display:flex; gap:8px; align-items:center;
      font-size: 14px; color: var(--muted);
      user-select:none;
    }

    /* Game area */
    .game{
      display:grid;
      grid-template-columns: 1fr 260px;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 900px){
      .game{ grid-template-columns: 1fr; }
    }

    .question{
      border:1px solid var(--border);
      border-radius: var(--r);
      padding: 14px;
      background: rgba(15,23,42,.02);
    }
    .qline{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .qtext{
      font-family: var(--mono);
      font-size: 30px;
      letter-spacing: .3px;
    }
    .timer{
      font-family: var(--mono);
      font-size: 16px;
      color: var(--muted);
      padding: 6px 10px;
      border:1px solid rgba(15,23,42,.10);
      border-radius: 999px;
      background: rgba(255,255,255,.65);
    }

    .answers{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .ans{
      padding: 12px 10px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.12);
      background: #fff;
      cursor:pointer;
      font-size: 18px;
      font-weight: 900;
      text-align:center;
      user-select:none;
    }
    .ans:hover{ background: rgba(47,95,115,.06); border-color: rgba(47,95,115,.25); }
    .ans.ok{ background: var(--ok); border-color: rgba(22,163,74,.30); }
    .ans.bad{ background: var(--bad); border-color: rgba(239,68,68,.30); }

    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 14px;
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--soft);
      border: 1px solid rgba(47,95,115,.18);
      color: var(--accent);
      font-size: 12px;
      font-weight: 800;
      white-space:nowrap;
    }

    /* Elevator */
    .elevator{
      border:1px solid var(--border);
      border-radius: var(--r);
      background: rgba(255,255,255,.75);
      box-shadow: var(--shadow);
      padding: 12px;
      position: sticky;
      top: 76px;
    }
    @media (max-width: 900px){
      .elevator{ position: static; }
    }
    .eTitle{ font-weight: 900; margin-bottom: 8px; }
    .shaft{
      height: 360px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.10);
      background:
        linear-gradient(to bottom, rgba(15,23,42,.03), rgba(15,23,42,.00)),
        repeating-linear-gradient(to bottom, rgba(15,23,42,.10) 0 1px, transparent 1px 36px);
      position: relative;
      overflow: hidden;
    }
    .cab{
      width: calc(100% - 26px);
      height: 44px;
      border-radius: 12px;
      background: rgba(47,95,115,.14);
      border: 1px solid rgba(47,95,115,.28);
      position: absolute;
      left: 13px;
      bottom: 6px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 0 10px;
      transition: transform .18s ease;
    }
    .cab .icon{ font-size: 18px; }
    .cab .floor{ font-family: var(--mono); font-weight: 800; color: var(--accent); }
    .progress{
      margin-top: 10px;
      display:grid;
      gap: 8px;
      color: var(--muted);
      font-size: 14px;
    }
    .bar{
      height: 10px;
      border-radius: 999px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.04);
      overflow:hidden;
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: rgba(47,95,115,.55);
      transition: width .18s ease;
    }
    .stats{
      margin-top: 12px;
      display:grid;
      gap: 6px;
      font-size: 14px;
      color: var(--muted);
    }
    .stats b{ color: var(--text); }

    /* Weak list */
    .weak{
      margin-top: 12px;
      border-top: 1px solid rgba(15,23,42,.10);
      padding-top: 10px;
    }
    .weak h3{
      margin: 0 0 8px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 900;
    }
    .weakList{
      font-family: var(--mono);
      font-size: 13px;
      color: rgba(100,116,139,.95);
      white-space: pre-wrap;
      background: rgba(15,23,42,.02);
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 12px;
      padding: 10px;
      min-height: 70px;
    }

    .footerNote{
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <h1>–¢–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è ‚Äî ¬´–õ–∏—Ñ—Ç¬ª</h1>
      <p class="sub">–ë—ã—Å—Ç—Ä–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞. –ú–æ–∂–Ω–æ ‚Äú–ø–æ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ‚Äù –∏–ª–∏ ‚Äú—Å–º–µ—à–∞–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã‚Äù. –û—à–∏–±–∫–∏ –∏ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –ø–∞—Ä—ã –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è —á–∞—â–µ.</p>
    </div>
    <div id="status" class="status">–ù–∞—Å—Ç—Ä–æ–π —Ä–µ–∂–∏–º –∏ –Ω–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª.</div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row" style="justify-content:space-between; gap:12px;">
        <div class="row" style="gap:10px;">
          <button class="btn" id="startBtn">–°—Ç–∞—Ä—Ç</button>
          <button class="btn soft" id="pauseBtn" disabled>–ü–∞—É–∑–∞</button>
          <button class="btn soft" id="resetBtn">–°–±—Ä–æ—Å</button>
        </div>
        <div class="row">
          <span class="pill" id="modePill">–†–µ–∂–∏–º: 6‚Äì9</span>
          <span class="pill" id="levelPill">–≠—Ç–∞–∂–∏: 0/10</span>
        </div>
      </div>

      <div class="controls">
        <div class="field">
          <span class="label">–†–µ–∂–∏–º</span>
          <select id="mode">
            <option value="mixed">–°–º–µ—à–∞–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã</option>
            <option value="single">–û–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ 8)</option>
          </select>
        </div>

        <div class="field" id="singleWrap" style="display:none;">
          <span class="label">–¢–∞–±–ª–∏—Ü–∞ –Ω–∞‚Ä¶</span>
          <select id="singleBase">
            <option>2</option><option>3</option><option>4</option><option>5</option>
            <option selected>6</option><option>7</option><option>8</option><option>9</option>
          </select>
        </div>

        <div class="field" id="rangeWrap">
          <span class="label">–î–∏–∞–ø–∞–∑–æ–Ω –º–Ω–æ–∂–∏—Ç–µ–ª–µ–π</span>
          <select id="rangePreset">
            <option value="2-9">2‚Äì9 (–≤—Å—ë)</option>
            <option value="2-5">2‚Äì5 (–ª—ë–≥–∫–∏–π —Ä–∞–∑–æ–≥—Ä–µ–≤)</option>
            <option value="6-9" selected>6‚Äì9 (—á–∞—Å—Ç–æ ‚Äú–ø—Ä–æ–≤–∞–ª‚Äù)</option>
          </select>
        </div>

        <div class="field">
          <span class="label">–í—Ç–æ—Ä–æ–π –º–Ω–æ–∂–∏—Ç–µ–ª—å (–æ–±—ã—á–Ω–æ 1‚Äì10)</span>
          <select id="bRange">
            <option value="1-10" selected>1‚Äì10</option>
            <option value="2-9">2‚Äì9</option>
            <option value="1-9">1‚Äì9</option>
          </select>
        </div>

        <div class="field">
          <span class="label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–ø—Ä–∏–Ω—Ç–∞</span>
          <select id="timeLimit">
            <option value="60" selected>60 —Å–µ–∫—É–Ω–¥</option>
            <option value="90">90 —Å–µ–∫—É–Ω–¥</option>
            <option value="120">120 —Å–µ–∫—É–Ω–¥</option>
            <option value="180">180 —Å–µ–∫—É–Ω–¥</option>
          </select>
        </div>

        <div class="field">
          <span class="label">–ü–æ—Ä—è–¥–æ–∫ (–¥–ª—è ‚Äú–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã‚Äù)</span>
          <select id="orderMode">
            <option value="random" selected>–í—Ä–∞–∑–±—Ä–æ—Å</option>
            <option value="ordered">–ü–æ –ø–æ—Ä—è–¥–∫—É (1..10)</option>
          </select>
        </div>

        <label class="check">
          <input id="repeatWeak" type="checkbox" checked>
          <span>–ü–æ–≤—Ç–æ—Ä—è—Ç—å —Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞ —á–∞—â–µ</span>
        </label>

        <label class="check">
          <input id="sound" type="checkbox">
          <span>–ó–≤—É–∫ (—Ç–∏—Ö–∏–π ‚Äú–∫–ª–∏–∫‚Äù)</span>
        </label>
      </div>

      <div class="game" style="margin-top:14px;">
        <div class="question">
          <div class="qline">
            <div class="qtext" id="qText">‚Äî</div>
            <div class="timer" id="timer">‚è± 60</div>
          </div>

          <div class="answers" id="answers">
            <div class="ans">‚Äî</div><div class="ans">‚Äî</div><div class="ans">‚Äî</div><div class="ans">‚Äî</div>
          </div>

          <div class="hint">
            <span class="pill">–ü–æ–¥—Å–∫–∞–∑–∫–∞</span>
            <span id="hintText">–ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è ‚Äî –º–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å —à–∞–≥–∞–º–∏. –ü–æ—Ç–æ–º –±—É–¥–µ—Ç –±—ã—Å—Ç—Ä–µ–µ.</span>
          </div>

          <div class="footerNote">
            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –∫–ª–∏–∫–∞–π –ø–æ –æ—Ç–≤–µ—Ç—É. –í –∫–æ–Ω—Ü–µ –ø–æ–∫–∞–∂–µ–º —Å–ª–∞–±—ã–µ –ø–∞—Ä—ã (–æ—à–∏–±–∫–∏ –∏ ‚Äú—Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ‚Äù).
          </div>
        </div>

        <div class="elevator">
          <div class="eTitle">–õ–∏—Ñ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</div>
          <div class="shaft" aria-label="–õ–∏—Ñ—Ç">
            <div class="cab" id="cab">
              <span class="icon">üõó</span>
              <span class="floor" id="floorText">0 —ç—Ç–∞–∂</span>
            </div>
          </div>
          <div class="progress">
            <div class="bar"><div id="barFill"></div></div>
            <div class="stats" id="stats">
              <div>–ü—Ä–∞–≤–∏–ª—å–Ω–æ: <b>0</b></div>
              <div>–û—à–∏–±–æ–∫: <b>0</b></div>
              <div>–°–µ—Ä–∏—è: <b>0</b></div>
              <div>–¢–æ—á–Ω–æ—Å—Ç—å: <b>‚Äî</b></div>
              <div>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: <b>‚Äî</b></div>
            </div>
          </div>

          <div class="weak">
            <h3>–°–ª–∞–±—ã–µ –ø–∞—Ä—ã (—Ç–æ–ø)</h3>
            <div class="weakList" id="weakList">‚Äî</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px; font-size:16px;">–ö–∞–∫ —ç—Ç–æ ‚Äú—É—á–∏—Ç‚Äù, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç</h2>
      <div style="color:var(--muted); font-size:14px; display:grid; gap:10px;">
        <div><b>1) –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å.</b> –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å ‚Äî –º–æ–∂–Ω–æ –¥–æ–π—Ç–∏ —Å—á—ë—Ç–æ–º. –≠—Ç–æ —Å–Ω–∏–º–∞–µ—Ç —Å—Ç—Ä–∞—Ö.</div>
        <div><b>2) –ü–æ–≤—Ç–æ—Ä—ã —Å–ª–∞–±–æ–≥–æ.</b> –û—à–∏–±–∫–∏ –∏ ‚Äú—Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω—ã–µ‚Äù –ø–∞—Ä—ã –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è —á–∞—â–µ.</div>
        <div><b>3) –ê–≤—Ç–æ–º–∞—Ç–∏–∑–º.</b> –°–ø—Ä–∏–Ω—Ç—ã –∫–æ—Ä–æ—Ç–∫–∏–µ ‚Äî –º–æ–∑–≥ –∑–∞–∫—Ä–µ–ø–ª—è–µ—Ç –±—ã—Å—Ç—Ä–æ.</div>
        <div class="pill">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: 1‚Äì2 —Å–ø—Ä–∏–Ω—Ç–∞ –≤ –¥–µ–Ω—å –ø–æ 60 —Å–µ–∫</div>
      </div>

      <hr style="border:none; border-top:1px solid rgba(15,23,42,.10); margin: 14px 0;">

      <button class="btn soft" id="clearStatsBtn">–°—Ç–µ—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–ª–∞–±—ã—Ö –º–µ—Å—Ç</button>
      <div style="margin-top:10px; color:var(--muted); font-size:13px;">
        –ò—Å—Ç–æ—Ä–∏—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage). –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ/–∫–æ–º–ø—å—é—Ç–µ—Ä–µ –±—É–¥–µ—Ç —Å–≤–æ—è.
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const statusEl = $("status");
  const startBtn = $("startBtn");
  const pauseBtn = $("pauseBtn");
  const resetBtn = $("resetBtn");

  const modeSel = $("mode");
  const singleWrap = $("singleWrap");
  const singleBaseSel = $("singleBase");
  const rangeWrap = $("rangeWrap");
  const rangePresetSel = $("rangePreset");
  const bRangeSel = $("bRange");
  const timeLimitSel = $("timeLimit");
  const orderModeSel = $("orderMode");
  const repeatWeakChk = $("repeatWeak");
  const soundChk = $("sound");

  const modePill = $("modePill");
  const levelPill = $("levelPill");

  const qText = $("qText");
  const timerEl = $("timer");
  const answersBox = $("answers");
  const hintText = $("hintText");

  const cab = $("cab");
  const floorText = $("floorText");
  const barFill = $("barFill");
  const statsEl = $("stats");
  const weakList = $("weakList");
  const clearStatsBtn = $("clearStatsBtn");

  const STORE_KEY = "mathexam_mul_weak_v1";

  // === state ===
  let running = false;
  let paused = false;
  let tLeft = 60;
  let timerId = null;

  let correct = 0;
  let wrong = 0;
  let streak = 0;
  let bestStreak = 0;
  let sumTime = 0;
  let answered = 0;

  let levelCorrect = 0;     // –¥–ª—è –ª–∏—Ñ—Ç–∞ (0..10)
  let buildingLevel = 1;

  let orderedNextB = 1;     // –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ø–æ –ø–æ—Ä—è–¥–∫—É"
  let current = null;       // {a,b,ans,choices,startTs}

  // weak store: key "a√ób" -> {wrong: n, slow: n}
  let weak = loadWeak();

  function loadWeak(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if (!raw) return {};
      const obj = JSON.parse(raw);
      return (obj && typeof obj === "object") ? obj : {};
    } catch { return {}; }
  }
  function saveWeak(){
    try{ localStorage.setItem(STORE_KEY, JSON.stringify(weak)); } catch {}
  }

  function setStatus(text, kind=""){
    statusEl.className = "status" + (kind ? " " + kind : "");
    statusEl.textContent = text;
  }

  function beep(ok=true){
    if (!soundChk.checked) return;
    // —Ç–∏—Ö–∏–π –∫–ª–∏–∫ —á–µ—Ä–µ–∑ WebAudio
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.value = ok ? 740 : 220;
      g.gain.value = 0.04;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(() => { o.stop(); ctx.close(); }, 60);
    } catch {}
  }

  function parseRange(val){
    const [a,b] = val.split("-").map(Number);
    return {min: a, max: b};
  }

  function pickWeightedWeakPair(aMin, aMax, bMin, bMax){
    // –≤—ã–±–∏—Ä–∞–µ–º –∏–∑ weak —Å –≤–µ—Å–æ–º (wrong*3 + slow)
    const items = [];
    for (const k in weak){
      const m = k.match(/^(\d+)\√ó(\d+)$/);
      if (!m) continue;
      const a = Number(m[1]), b = Number(m[2]);
      if (a < aMin || a > aMax || b < bMin || b > bMax) continue;
      const w = (weak[k].wrong || 0) * 3 + (weak[k].slow || 0);
      if (w > 0) items.push({a,b,w});
    }
    if (!items.length) return null;

    const total = items.reduce((s,x)=>s+x.w,0);
    let r = Math.random() * total;
    for (const it of items){
      r -= it.w;
      if (r <= 0) return {a: it.a, b: it.b};
    }
    return {a: items[0].a, b: items[0].b};
  }

  function makeChoices(ans, a, b){
    const set = new Set([ans]);

    // ‚Äú–ø–æ—Ö–æ–∂–∏–µ‚Äù –æ—Ç–≤–ª–µ–∫–∞—é—â–∏–µ
    const candidates = [
      ans + a, ans - a, ans + b, ans - b,
      ans + 1, ans - 1, ans + 2, ans - 2
    ].filter(x => Number.isFinite(x) && x > 0);

    // –¥–æ–±–∞–≤–∏–º —Ç–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ (—Å–æ—Å–µ–¥–Ω–∏–π –º–Ω–æ–∂–∏—Ç–µ–ª—å)
    candidates.push(a * Math.max(1, b-1));
    candidates.push(a * (b+1));
    candidates.push(Math.max(1, a-1) * b);
    candidates.push((a+1) * b);

    // –¥–æ–±–∏–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–º–∏
    while (set.size < 4){
      let v = candidates.length ? candidates[Math.floor(Math.random()*candidates.length)] : null;
      if (!v || v === ans || v <= 0) v = ans + (Math.floor(Math.random()*7)-3);
      if (v > 0) set.add(v);
      if (set.size < 4 && Math.random() < .25) set.add(Math.max(1, ans + (Math.floor(Math.random()*20)-10)));
    }

    const arr = Array.from(set).slice(0,4);

    // –ø–µ—Ä–µ–º–µ—à–∞–µ–º
    for (let i = arr.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }

  function getSettings(){
    const mode = modeSel.value; // mixed | single
    const bR = parseRange(bRangeSel.value);
    let aR;

    if (mode === "single"){
      const base = Number(singleBaseSel.value);
      aR = {min: base, max: base};
    } else {
      aR = parseRange(rangePresetSel.value);
    }

    return {
      mode,
      aMin: aR.min, aMax: aR.max,
      bMin: bR.min, bMax: bR.max,
      timeLimit: Number(timeLimitSel.value),
      orderMode: orderModeSel.value, // random|ordered
      repeatWeak: repeatWeakChk.checked,
    };
  }

  function updateBadges(){
    const s = getSettings();
    if (s.mode === "single"){
      modePill.textContent = `–†–µ–∂–∏–º: —Ç–∞–±–ª–∏—Ü–∞ –Ω–∞ ${s.aMin}`;
    } else {
      modePill.textContent = `–†–µ–∂–∏–º: ${s.aMin}‚Äì${s.aMax}`;
    }
    levelPill.textContent = `–≠—Ç–∞–∂–∏: ${levelCorrect}/10 ‚Ä¢ –£—Ä–æ–≤–µ–Ω—å ${buildingLevel}`;
  }

  function updateStats(){
    const acc = answered ? Math.round((correct / answered) * 100) : null;
    const avg = answered ? (sumTime / answered) : null;

    statsEl.innerHTML = `
      <div>–ü—Ä–∞–≤–∏–ª—å–Ω–æ: <b>${correct}</b></div>
      <div>–û—à–∏–±–æ–∫: <b>${wrong}</b></div>
      <div>–°–µ—Ä–∏—è: <b>${streak}</b> (–ª—É—á—à–µ–µ: ${bestStreak})</div>
      <div>–¢–æ—á–Ω–æ—Å—Ç—å: <b>${acc === null ? "‚Äî" : acc + "%"}</b></div>
      <div>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: <b>${avg === null ? "‚Äî" : avg.toFixed(2) + "—Å"}</b></div>
    `;

    // –ª–∏—Ñ—Ç: 10 —ç—Ç–∞–∂–µ–π = 10 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤ —Ç–µ–∫—É—â–µ–º —É—Ä–æ–≤–Ω–µ
    const pct = Math.min(100, Math.round((levelCorrect / 10) * 100));
    barFill.style.width = pct + "%";

    const shaftH = 360;
    const cabH = 44;
    const bottomPad = 6;
    const topPad = 6;

    // —ç—Ç–∞–∂ 0 –≤–Ω–∏–∑—É, —ç—Ç–∞–∂ 10 –Ω–∞–≤–µ—Ä—Ö—É
    const yMax = shaftH - cabH - bottomPad - topPad;
    const y = (levelCorrect / 10) * yMax;
    cab.style.transform = `translateY(${-y}px)`;
    floorText.textContent = `${levelCorrect} —ç—Ç–∞–∂`;
    updateBadges();
  }

  function weakTopText(){
    // –ø–æ–∫–∞–∂–µ–º —Ç–æ–ø-8 –ø–æ –≤–µ—Å—É
    const arr = Object.entries(weak).map(([k,v]) => {
      const w = (v.wrong||0)*3 + (v.slow||0);
      return {k, wrong: v.wrong||0, slow: v.slow||0, w};
    }).filter(x => x.w > 0).sort((a,b)=>b.w-a.w).slice(0,8);

    if (!arr.length) return "–ü–æ–∫–∞ –ø—É—Å—Ç–æ üôÇ\n–û—à–∏–±–∫–∏/–º–µ–¥–ª–µ–Ω–Ω—ã–µ –ø–∞—Ä—ã –ø–æ—è–≤—è—Ç—Å—è —Ç—É—Ç.";
    return arr.map(x => `${x.k}  |  –æ—à–∏–±–∫–∏:${x.wrong}  –º–µ–¥–ª–µ–Ω–Ω–æ:${x.slow}`).join("\n");
  }

  function renderWeak(){
    weakList.textContent = weakTopText();
  }

  function newQuestion(){
    const s = getSettings();
    updateBadges();

    let a, b;

    // –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤–∑—è—Ç—å —Å–ª–∞–±–æ–µ –º–µ—Å—Ç–æ
    if (s.repeatWeak && Math.random() < 0.55){
      const w = pickWeightedWeakPair(s.aMin, s.aMax, s.bMin, s.bMax);
      if (w){ a = w.a; b = w.b; }
    }

    if (a == null || b == null){
      if (s.mode === "single"){
        a = s.aMin;
        if (s.orderMode === "ordered"){
          b = orderedNextB;
          orderedNextB++;
          if (orderedNextB > s.bMax) orderedNextB = s.bMin; // —Ü–∏–∫–ª–æ–º
        } else {
          b = randInt(s.bMin, s.bMax);
        }
      } else {
        a = randInt(s.aMin, s.aMax);
        b = randInt(s.bMin, s.bMax);
      }
    }

    const ans = a * b;
    const choices = makeChoices(ans, a, b);

    current = {a, b, ans, choices, startTs: performance.now()};

    qText.textContent = `${a} √ó ${b} = ?`;
    hintText.textContent = (a === 9 || b === 9)
      ? "–ü–æ–¥—Å–∫–∞–∑–∫–∞: 9√ón = 10√ón ‚àí n."
      : "–ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è ‚Äî –º–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å —à–∞–≥–∞–º–∏. –ü–æ—Ç–æ–º –±—É–¥–µ—Ç –±—ã—Å—Ç—Ä–µ–µ.";

    answersBox.innerHTML = "";
    choices.forEach(val => {
      const div = document.createElement("div");
      div.className = "ans";
      div.textContent = String(val);
      div.addEventListener("click", () => answer(val, div));
      answersBox.appendChild(div);
    });
  }

  function markWeak(a,b, kind){
    const key = `${a}√ó${b}`;
    if (!weak[key]) weak[key] = {wrong:0, slow:0};
    if (kind === "wrong") weak[key].wrong += 1;
    if (kind === "slow") weak[key].slow += 1;
    saveWeak();
  }

  function answer(val, elDiv){
    if (!running || paused || !current) return;

    const dt = (performance.now() - current.startTs) / 1000;
    answered++;
    sumTime += dt;

    // —Å—á–∏—Ç–∞–µ–º "—Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ" –∫–∞–∫ —Å–ª–∞–±–æ–µ –º–µ—Å—Ç–æ
    if (dt > 3.2) markWeak(current.a, current.b, "slow");

    const ok = (val === current.ans);

    // –ø–æ–¥—Å–≤–µ—Ç–∏–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞ –º–≥–Ω–æ–≤–µ–Ω–∏–µ
    const all = Array.from(answersBox.querySelectorAll(".ans"));
    all.forEach(x => {
      const n = Number(x.textContent);
      if (n === current.ans) x.classList.add("ok");
    });

    if (ok){
      correct++;
      streak++;
      bestStreak = Math.max(bestStreak, streak);
      levelCorrect++;

      beep(true);
      setStatus(`–í–µ—Ä–Ω–æ! (${current.a}√ó${current.b}=${current.ans})`, "ok");

      if (levelCorrect >= 10){
        buildingLevel++;
        levelCorrect = 0;
        setStatus(`–û—Ç–ª–∏—á–Ω–æ! –ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å: ${buildingLevel}. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º üôÇ`, "ok");
      }
    } else {
      wrong++;
      streak = 0;
      markWeak(current.a, current.b, "wrong");

      beep(false);
      elDiv.classList.add("bad");
      setStatus(`–û—à–∏–±–∫–∞. –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${current.a}√ó${current.b}=${current.ans}`, "bad");
    }

    updateStats();
    renderWeak();

    // –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å —á–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫—É—é –ø–∞—É–∑—É
    setTimeout(() => {
      if (running && !paused) newQuestion();
    }, ok ? 260 : 520);
  }

  function randInt(a,b){
    return a + Math.floor(Math.random() * (b - a + 1));
  }

  function tick(){
    if (!running || paused) return;
    tLeft--;
    timerEl.textContent = `‚è± ${tLeft}`;
    if (tLeft <= 0){
      endSprint();
    }
  }

  function start(){
    const s = getSettings();

    running = true;
    paused = false;

    tLeft = s.timeLimit;
    timerEl.textContent = `‚è± ${tLeft}`;

    correct = 0; wrong = 0; streak = 0; bestStreak = 0;
    sumTime = 0; answered = 0;
    levelCorrect = 0; buildingLevel = 1;

    orderedNextB = parseRange(bRangeSel.value).min;

    updateBadges();
    updateStats();
    renderWeak();

    startBtn.disabled = true;
    pauseBtn.disabled = false;
    pauseBtn.textContent = "–ü–∞—É–∑–∞";
    setStatus("–ü–æ–µ—Ö–∞–ª–∏! –í—ã–±–∏—Ä–∞–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç.", "");

    clearInterval(timerId);
    timerId = setInterval(tick, 1000);

    newQuestion();
  }

  function pause(){
    if (!running) return;
    paused = !paused;
    pauseBtn.textContent = paused ? "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" : "–ü–∞—É–∑–∞";
    setStatus(paused ? "–ü–∞—É–∑–∞. –ù–∞–∂–º–∏ ¬´–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å¬ª." : "–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º!", "");
  }

  function endSprint(){
    running = false;
    paused = false;
    clearInterval(timerId);
    timerId = null;

    startBtn.disabled = false;
    pauseBtn.disabled = true;

    const acc = answered ? Math.round((correct / answered) * 100) : 0;
    const avg = answered ? (sumTime / answered).toFixed(2) : "‚Äî";

    qText.textContent = "–°–ø—Ä–∏–Ω—Ç –∑–∞–≤–µ—Ä—à—ë–Ω ‚úÖ";
    timerEl.textContent = "‚è± 0";
    answersBox.innerHTML = `
      <div class="ans" style="grid-column:1/-1; cursor:default;">
        –ò—Ç–æ–≥: –ø—Ä–∞–≤–∏–ª—å–Ω–æ ${correct}, –æ—à–∏–±–æ–∫ ${wrong}, —Ç–æ—á–Ω–æ—Å—Ç—å ${acc}%, —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è ${avg}—Å
      </div>
    `;

    setStatus("–ì–æ—Ç–æ–≤–æ. –ú–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å ¬´–°—Ç–∞—Ä—Ç¬ª –µ—â—ë —Ä–∞–∑ –∏–ª–∏ —Å–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º.", "ok");
  }

  function reset(){
    running = false;
    paused = false;
    clearInterval(timerId);
    timerId = null;

    startBtn.disabled = false;
    pauseBtn.disabled = true;

    tLeft = Number(timeLimitSel.value);
    timerEl.textContent = `‚è± ${tLeft}`;

    qText.textContent = "‚Äî";
    answersBox.innerHTML = `<div class="ans">‚Äî</div><div class="ans">‚Äî</div><div class="ans">‚Äî</div><div class="ans">‚Äî</div>`;
    setStatus("–ù–∞—Å—Ç—Ä–æ–π —Ä–µ–∂–∏–º –∏ –Ω–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª.", "");

    correct = 0; wrong = 0; streak = 0; bestStreak = 0;
    sumTime = 0; answered = 0;
    levelCorrect = 0; buildingLevel = 1;

    updateStats();
    renderWeak();
    updateBadges();
  }

  function onModeChange(){
    const m = modeSel.value;
    singleWrap.style.display = (m === "single") ? "block" : "none";
    rangeWrap.style.display = (m === "mixed") ? "block" : "none";
    updateBadges();
  }

  // events
  startBtn.addEventListener("click", start);
  pauseBtn.addEventListener("click", pause);
  resetBtn.addEventListener("click", reset);

  modeSel.addEventListener("change", () => { onModeChange(); reset(); });
  singleBaseSel.addEventListener("change", reset);
  rangePresetSel.addEventListener("change", reset);
  bRangeSel.addEventListener("change", reset);
  timeLimitSel.addEventListener("change", reset);
  orderModeSel.addEventListener("change", reset);
  repeatWeakChk.addEventListener("change", () => { renderWeak(); });
  soundChk.addEventListener("change", () => { /* nothing */ });

  clearStatsBtn.addEventListener("click", () => {
    if (!confirm("–°—Ç–µ—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–ª–∞–±—ã—Ö –º–µ—Å—Ç –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ?")) return;
    weak = {};
    saveWeak();
    renderWeak();
    setStatus("–ò—Å—Ç–æ—Ä–∏—è —Å–ª–∞–±—ã—Ö –º–µ—Å—Ç –æ—á–∏—â–µ–Ω–∞.", "ok");
  });

  // init
  onModeChange();
  renderWeak();
  updateBadges();
  reset();
})();
</script>
</body>
</html>

