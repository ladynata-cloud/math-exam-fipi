<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Тренажёр округления — ОГЭ</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#121824;
      --muted:#9fb0c3;
      --text:#e9f0f7;
      --line:rgba(255,255,255,.10);
      --accent:#5aa7ff;
      --good:#39d98a;
      --bad:#ff5a6b;
      --warn:#ffd166;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 900px at 10% -10%, rgba(90,167,255,.20), transparent 60%),
                  radial-gradient(900px 700px at 110% 0%, rgba(255,90,107,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.5;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 16px 40px;
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 12px;
    }
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .subtitle{margin-top:6px;color:var(--muted);font-size:14px}
    .toplink{margin-top:2px;white-space:nowrap;font-size:14px;opacity:.95}

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
      margin-top: 12px;
    }
    @media (max-width: 880px){
      .grid{grid-template-columns: 1fr}
    }

    .card{
      background: rgba(18,24,36,.92);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(6px);
    }
    .card h2{
      margin: 0 0 10px;
      font-size: 16px;
      color: #dbe7f3;
      font-weight: 650;
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 560px){
      .controls{grid-template-columns:1fr}
    }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    select, input{
      width:100%;
      background: rgba(7,10,16,.7);
      color: var(--text);
      border:1px solid rgba(255,255,255,.16);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
      font-size: 14px;
    }
    select:focus, input:focus{
      border-color: rgba(90,167,255,.55);
      box-shadow: 0 0 0 3px rgba(90,167,255,.15);
    }

    .task{
      margin-top: 12px;
      padding: 14px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(7,10,16,.35);
    }
    .task-title{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .task-text{
      font-size: 18px;
      margin: 0;
    }
    .task-text .num{
      font-variant-numeric: tabular-nums;
      padding: 1px 8px;
      border-radius: 10px;
      background: rgba(90,167,255,.12);
      border: 1px solid rgba(90,167,255,.28);
      display:inline-block;
    }
    .task-text .place{color:#dbe7f3;font-weight:650}

    .answer-row{
      display:flex;
      gap:10px;
      align-items:stretch;
      margin-top: 10px;
    }
    .answer-row input{flex: 1 1 auto;font-size:16px}
    @media (max-width: 560px){
      .answer-row{flex-direction:column}
    }

    .btns{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top: 10px;
    }
    button{
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 14px;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    button:hover{
      background: rgba(255,255,255,.09);
      border-color: rgba(255,255,255,.24);
    }
    button:active{transform: translateY(1px)}
    button.primary{
      background: rgba(90,167,255,.18);
      border-color: rgba(90,167,255,.38);
    }
    button.primary:hover{
      background: rgba(90,167,255,.24);
      border-color: rgba(90,167,255,.55);
    }
    button.danger{
      background: rgba(255,90,107,.14);
      border-color: rgba(255,90,107,.38);
    }
    button.danger:hover{
      background: rgba(255,90,107,.18);
      border-color: rgba(255,90,107,.55);
    }
    button[disabled]{opacity:.55;cursor:not-allowed}

    .feedback{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(7,10,16,.35);
      font-size: 14px;
      min-height: 44px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .dot{width:10px;height:10px;border-radius:999px;background: rgba(255,255,255,.30);flex:0 0 auto}
    .feedback.good{border-color: rgba(57,217,138,.35)}
    .feedback.good .dot{background: var(--good)}
    .feedback.bad{border-color: rgba(255,90,107,.40)}
    .feedback.bad .dot{background: var(--bad)}
    .feedback.warn{border-color: rgba(255,209,102,.35)}
    .feedback.warn .dot{background: var(--warn)}

    details{
      margin-top: 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(7,10,16,.35);
      border-radius: 12px;
      padding: 8px 10px;
    }
    summary{cursor:pointer;font-weight:650;color:#dbe7f3}
    .rule{margin: 8px 0 0;color: var(--muted);font-size: 13px}
    .rule ol{margin: 8px 0 0 18px}
    .rule li{margin:6px 0}

    .stepbox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(7,10,16,.35);
      font-size: 14px;
      color: #dbe7f3;
    }
    .stepbox .small{font-size: 13px; color: var(--muted); margin-top:6px}
    .mono{font-variant-numeric: tabular-nums}

    .stats{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .stat{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(7,10,16,.35);
    }
    .stat .k{font-size: 12px; color: var(--muted)}
    .stat .v{font-size: 20px; font-weight: 750; margin-top: 3px}
    .stat .v.small{font-size:16px; font-weight:650}

    .progressbar{
      margin-top: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
    }
    .progressbar > div{
      height:100%;
      width:0%;
      background: rgba(90,167,255,.55);
      transition: width .18s ease;
    }

    .footer-note{margin-top: 12px;color: var(--muted);font-size: 13px}

    /* мобильный комфорт */
    @media (max-width: 768px) {
      .answer-row input { font-size: 18px; padding: 14px 12px; }
      button { padding: 14px 14px; font-size: 16px; }
      .btns { gap: 8px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Тренажёр округления (ОГЭ-скоропомощь)</h1>
        <div class="subtitle">Проверка + подсказки + разбор шага. Прогресс сохраняется в браузере.</div>
      </div>
      <div class="toplink"><a href="./index.html">← На главную</a></div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>Задание</h2>

        <div class="controls">
          <div>
            <label for="placeSel">Округлять до</label>
            <select id="placeSel">
              <option value="auto">Авто (под разряд)</option>
              <option value="6">миллионов</option>
              <option value="5">сотен тысяч</option>
              <option value="4">десятков тысяч</option>
              <option value="3">тысяч</option>
              <option value="2">сотен</option>
              <option value="1">десятков</option>
              <option value="0">единиц</option>
              <option value="-1">десятых</option>
              <option value="-2">сотых</option>
              <option value="-3">тысячных</option>
            </select>
          </div>

          <div>
            <label for="modeSel">Какие числа</label>
            <select id="modeSel">
              <option value="auto">Авто</option>
              <option value="ints">Только целые</option>
              <option value="dec">Только десятичные</option>
            </select>
          </div>

          <div>
            <label for="negSel">Отрицательные</label>
            <select id="negSel">
              <option value="no">Нет</option>
              <option value="sometimes">Иногда</option>
              <option value="yes">Да</option>
            </select>
          </div>

          <div>
            <label for="sessionSel">Сессия</label>
            <select id="sessionSel">
              <option value="10">10 заданий</option>
              <option value="20">20 заданий</option>
              <option value="inf">Бесконечно</option>
            </select>
          </div>
        </div>

        <div class="task" aria-live="polite">
          <div class="task-title">
            <div>Задание <span class="mono" id="taskN">1</span> из <span class="mono" id="taskTotal">10</span></div>
            <div>Ошибок в этом задании: <span class="mono" id="tries">0</span></div>
          </div>

          <p class="task-text" id="taskText">
            Округли число <span class="num mono" id="numSpan">—</span> до <span class="place" id="placeSpan">—</span>.
          </p>

          <div class="answer-row">
            <input id="answer" type="text" inputmode="decimal" autocomplete="off"
                   placeholder="Твой ответ" aria-label="Твой ответ" />
          </div>

          <div class="btns">
            <button class="primary" id="checkBtn" type="button">Проверить (Enter)</button>
            <button id="nextBtn" type="button" style="display:none;">Далее</button>
            <button id="newBtn" type="button">Новый пример</button>
            <button id="solBtn" type="button">Показать решение</button>
            <button class="danger" id="resetBtn" type="button">Сбросить статистику</button>
          </div>

          <div class="feedback" id="feedback">
            <span class="dot" aria-hidden="true"></span>
            <span class="msg" id="feedbackMsg" style="color: var(--muted);">
              Вводи число как удобно: <span class="mono">12 345,6</span> или <span class="mono">12345.6</span>.
            </span>
          </div>

          <div class="stepbox" id="stepBox">
            <strong>Разбор</strong>
            <div class="small" id="stepText">
              Нажми «Проверить», и здесь появится подсказка/разбор.
            </div>
          </div>

          <div class="progressbar" title="Прогресс сессии">
            <div id="barFill"></div>
          </div>

          <details>
            <summary>Правило округления (напомнить)</summary>
            <div class="rule">
              <ol>
                <li>Определи разряд, до которого округляешь.</li>
                <li>Посмотри на цифру справа:
                  <ul>
                    <li><b>0–4</b> → разряд не меняем;</li>
                    <li><b>5–9</b> → увеличиваем разряд на 1.</li>
                  </ul>
                </li>
                <li>Цифры справа заменяем на нули (или оставляем нужное число знаков после запятой).</li>
              </ol>
            </div>
          </details>

          <div class="footer-note">
            Связь с делением уголком: <span class="mono">473 : 8</span> ≈ <span class="mono">480 : 8 = 60</span> — помогает подобрать первую цифру частного.
          </div>
        </div>
      </section>

      <aside class="card">
        <h2>Статистика</h2>

        <div class="stats">
          <div class="stat">
            <div class="k">Правильно</div>
            <div class="v" id="sCorrect">0</div>
          </div>
          <div class="stat">
            <div class="k">Всего попыток</div>
            <div class="v" id="sTotal">0</div>
          </div>
          <div class="stat">
            <div class="k">Серия</div>
            <div class="v" id="sStreak">0</div>
          </div>
          <div class="stat">
            <div class="k">Лучшая серия</div>
            <div class="v" id="sBest">0</div>
          </div>
          <div class="stat" style="grid-column: 1 / -1;">
            <div class="k">Примечание</div>
            <div class="v small">
              Прогресс и настройки сохраняются в браузере (localStorage).
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
(() => {
  const STORAGE_KEY = "mathexam_rounding_v3";

  const POS_LABEL = {0:"единиц",1:"десятков",2:"сотен",3:"тысяч",4:"десятков тысяч",5:"сотен тысяч",6:"миллионов"};
  const NEG_LABEL = {"-1":"десятых","-2":"сотых","-3":"тысячных"};
  const NEXT_LABEL = {
    "-4":"десятитысячных","-3":"тысячных","-2":"сотых","-1":"десятых",
     0:"десятых",1:"единиц",2:"десятков",3:"сотен",4:"тысяч",5:"десятков тысяч",6:"сотен тысяч"
  };

  const placeSel = document.getElementById("placeSel");
  const modeSel = document.getElementById("modeSel");
  const negSel = document.getElementById("negSel");
  const sessionSel = document.getElementById("sessionSel");

  const numSpan = document.getElementById("numSpan");
  const placeSpan = document.getElementById("placeSpan");
  const taskNEl = document.getElementById("taskN");
  const taskTotalEl = document.getElementById("taskTotal");
  const triesEl = document.getElementById("tries");

  const answerEl = document.getElementById("answer");
  const checkBtn = document.getElementById("checkBtn");
  const nextBtn = document.getElementById("nextBtn");
  const newBtn = document.getElementById("newBtn");
  const solBtn = document.getElementById("solBtn");
  const resetBtn = document.getElementById("resetBtn");

  const feedbackEl = document.getElementById("feedback");
  const feedbackMsgEl = document.getElementById("feedbackMsg");
  const stepTextEl = document.getElementById("stepText");
  const barFill = document.getElementById("barFill");

  const sCorrect = document.getElementById("sCorrect");
  const sTotal = document.getElementById("sTotal");
  const sStreak = document.getElementById("sStreak");
  const sBest = document.getElementById("sBest");

  const state = {
    settings: { place:"auto", mode:"auto", negatives:"no", sessionSize:"10" },
    stats: { correct:0, total:0, streak:0, best:0 },
    session: { done:0 },
    task: null
  };

  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      settings: state.settings,
      stats: state.stats,
      session: state.session
    }));
  }
  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const data = JSON.parse(raw);
      if(data.settings) Object.assign(state.settings, data.settings);
      if(data.stats) Object.assign(state.stats, data.stats);
      if(data.session) Object.assign(state.session, data.session);
    }catch(e){}
  }

  function fmtDisplay(value, fixedDigits=null){
    const opts = { useGrouping:true };
    if(fixedDigits !== null){
      opts.minimumFractionDigits = fixedDigits;
      opts.maximumFractionDigits = fixedDigits;
    }else{
      opts.maximumFractionDigits = 12;
    }
    return new Intl.NumberFormat("ru-RU", opts).format(value);
  }

  function setFeedback(kind, html){
    feedbackEl.classList.remove("good","bad","warn");
    if(kind) feedbackEl.classList.add(kind);
    feedbackMsgEl.innerHTML = html;
  }

  function updateStatsUI(){
    sCorrect.textContent = state.stats.correct;
    sTotal.textContent = state.stats.total;
    sStreak.textContent = state.stats.streak;
    sBest.textContent = state.stats.best;
  }

  function sessionSizeNumber(){
    if(state.settings.sessionSize === "inf") return Infinity;
    return Number(state.settings.sessionSize) || 10;
  }
  function updateSessionUI(){
    const size = sessionSizeNumber();
    const done = state.session.done;

    taskNEl.textContent = size === Infinity ? (done + 1) : Math.min(done + 1, size);
    taskTotalEl.textContent = size === Infinity ? "∞" : String(size);

    const pct = (size === Infinity) ? 0 : Math.round((done / size) * 100);
    barFill.style.width = (size === Infinity ? "0%" : (pct + "%"));
  }

  function applySettingsFromUI(){
    state.settings.place = placeSel.value;
    state.settings.mode = modeSel.value;
    state.settings.negatives = negSel.value;
    state.settings.sessionSize = sessionSel.value;
    save();
  }

  function chance(p){ return Math.random() < p; }
  function randomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function getPlaceLabel(exp){
    if(exp >= 0) return POS_LABEL[exp] || "разряда 10^" + exp;
    return NEG_LABEL[String(exp)] || "10^" + exp;
  }
  function getNextLabel(exp){
    const nextExp = exp - 1;
    return NEXT_LABEL[String(nextExp)] || "следующий разряд";
  }
  function expectedDecimalsForExp(exp){
    return exp < 0 ? -exp : 0;
  }

  function normalizeInput(raw){
    // разрешаем пробелы, запятую, точку
    const s = String(raw ?? "").trim().replace(/\s+/g, "").replace(",", ".");
    if(s === "") return { ok:false, reason:"Введите число." };

    // допустимы: -123, 123.45
    if(!/^-?\d+(\.\d+)?$/.test(s)){
      return { ok:false, reason:"Введите число (можно с запятой/точкой). Без букв и символов." };
    }

    const neg = s.startsWith("-");
    const t = neg ? s.slice(1) : s;
    const parts = t.split(".");
    let intPart = parts[0] || "0";
    let fracPart = parts[1] || "";

    intPart = intPart.replace(/^0+(?=\d)/, "");
    if(intPart === "") intPart = "0";

    let sign = neg ? "-" : "";
    if(intPart === "0" && /^0*$/.test(fracPart)) sign = ""; // -0 -> 0

    const num = Number(sign + intPart + (fracPart ? "." + fracPart : ""));
    if(!Number.isFinite(num)) return { ok:false, reason:"Не получилось распознать число." };

    return { ok:true, sign, intPart, fracPart, num };
  }

  function normalizeForCompare(parsed, exp){
    const dec = expectedDecimalsForExp(exp);

    // если нужно целое — дробная часть допустима только нулевая
    if(dec === 0){
      if(parsed.fracPart && !/^0*$/.test(parsed.fracPart)){
        return { ok:false, reason:"Ответ должен быть целым числом." };
      }
      // строгая проверка целого: строка целого (это и есть “строгое равенство” без допусков)
      return { ok:true, str: parsed.sign + parsed.intPart };
    }

    // если нужны десятичные: приводим к ровно dec знакам, лишние допускаем только нулевые
    let frac = parsed.fracPart || "";
    if(frac.length < dec) frac = frac + "0".repeat(dec - frac.length);
    if(frac.length > dec){
      const extra = frac.slice(dec);
      if(!/^0*$/.test(extra)){
        return { ok:false, reason:`Нужно не больше ${dec} знаков после запятой.` };
      }
      frac = frac.slice(0, dec);
    }

    let sign = parsed.sign;
    if(parsed.intPart === "0" && /^0*$/.test(frac)) sign = ""; // -0.00 -> 0.00

    return { ok:true, str: sign + parsed.intPart + "." + frac };
  }

  function correctToFixedString(value, exp){
    const dec = expectedDecimalsForExp(exp);
    if(dec === 0){
      const roundedInt = Math.round(value);
      return String(Object.is(roundedInt, -0) ? 0 : roundedInt);
    }
    const s = (Object.is(value, -0) ? 0 : value).toFixed(dec);
    if(/^-\s*0(\.0+)?$/.test(s)) return s.replace("-", "");
    return s;
  }

  function roundTo(value, exp){
    if(exp >= 0){
      const factor = 10 ** exp;
      const res = Math.round(value / factor) * factor;
      return Object.is(res, -0) ? 0 : res;
    }else{
      const factor = 10 ** (-exp);
      const res = Math.round(value * factor) / factor;
      return Object.is(res, -0) ? 0 : res;
    }
  }

  function nextDigit(value, exp){
    const e = exp - 1;
    const abs = Math.abs(value);
    if(e >= 0){
      const div = 10 ** e;
      return Math.floor(abs / div) % 10;
    }else{
      const mul = 10 ** (-e);
      return Math.floor(abs * mul + 1e-10) % 10;
    }
  }

  function chooseSign(){
    const m = state.settings.negatives;
    if(m === "no") return 1;
    if(m === "yes") return chance(0.5) ? -1 : 1;
    return chance(0.25) ? -1 : 1;
  }

  function chooseExp(){
    if(state.settings.place !== "auto") return Number(state.settings.place);

    const pos = [0,1,2,3,4,5,6];
    const neg = [-1,-2,-3];

    if(state.settings.mode === "ints") return pick(pos);
    if(state.settings.mode === "dec") return pick(neg);

    // авто: иногда десятичные, чаще целые
    return chance(0.35) ? pick(neg) : pick(pos);
  }

  function shouldGenerateDecimal(exp){
    if(state.settings.mode === "ints") return false;
    if(state.settings.mode === "dec") return true;
    if(exp < 0) return true;
    return chance(0.25);
  }

  function generateInteger(exp){
    const sign = chooseSign();
    const extraDigits = randomInt(1, 3);
    const digits = Math.max(2, exp + extraDigits + 1);

    const min = 10 ** (digits - 1);
    const max = (10 ** digits) - 1;
    let n = randomInt(min, max);

    if(exp >= 1){
      const factor = 10 ** exp;
      if(n % factor === 0) n += randomInt(1, 9) * (10 ** (exp-1));
    }
    return sign * n;
  }

  function generateDecimal(exp){
    const sign = chooseSign();
    const need = expectedDecimalsForExp(exp);
    const digitsAfter = Math.max(1, need + randomInt(1, 2));

    const intMax = exp >= 4 ? 999999 : 99999;
    const intPart = randomInt(0, intMax);

    const fracMax = (10 ** digitsAfter) - 1;
    let frac = randomInt(0, fracMax);
    if(frac === 0) frac = randomInt(1, fracMax);

    const fracStr = String(frac).padStart(digitsAfter, "0");
    const raw = intPart + "." + fracStr;
    const num = Number(raw);
    return { value: sign * num, digitsAfter };
  }

  function buildExplanation(task, showAnswer){
    const exp = task.exp;
    const nd = nextDigit(task.value, exp);
    const up = nd >= 5;

    const place = getPlaceLabel(exp);
    const next = getNextLabel(exp);

    const dec = expectedDecimalsForExp(exp);
    const correctFixed = task.correctFixed;
    const correctDisplay = fmtDisplay(Number(correctFixed), dec);

    const ruleLine = up
      ? `Так как <b>${nd} ≥ 5</b>, <b>увеличиваем</b> разряд «${place}» на 1.`
      : `Так как <b>${nd} < 5</b>, разряд «${place}» <b>не меняем</b>.`;

    const tailLine = exp >= 0
      ? `Все цифры правее заменяем нулями.`
      : `После запятой оставляем <b>${dec}</b> знак(а/ов).`;

    const ans = showAnswer ? `<div class="small"><b>Ответ:</b> <span class="mono">${correctDisplay}</span></div>` : "";

    return `
      <div>Округляем <span class="mono">${task.valueDisplay}</span> до <b>${place}</b>.</div>
      <div>Смотрим на следующий разряд: <b>${next}</b>. Там цифра <b>${nd}</b>.</div>
      <div>${ruleLine}</div>
      <div>${tailLine}</div>
      ${ans}
    `;
  }

  function lockAfterFinish(){
    checkBtn.disabled = true;
    answerEl.disabled = true;
    nextBtn.style.display = "inline-block";
  }
  function unlockForNew(){
    checkBtn.disabled = false;
    answerEl.disabled = false;
    nextBtn.style.display = "none";
  }

  function newTask(){
    applySettingsFromUI();

    // если сменили сессию — индикатор честный, но текущую сессию не трогаем
    const exp = chooseExp();

    let value, digitsAfter = 0, valueDisplay;

    if(shouldGenerateDecimal(exp)){
      const d = generateDecimal(exp);
      value = d.value;
      digitsAfter = d.digitsAfter;
      valueDisplay = fmtDisplay(value, digitsAfter);
    }else{
      value = generateInteger(Math.max(0, exp));
      valueDisplay = fmtDisplay(value, 0);
    }

    const correctValue = roundTo(value, exp);
    const correctFixed = correctToFixedString(correctValue, exp);

    state.task = {
      exp,
      value,
      valueDisplay,
      correctValue,
      correctFixed,
      attempts: 0,
      finished: false,
      decExpected: expectedDecimalsForExp(exp),
      placeLabel: getPlaceLabel(exp)
    };

    numSpan.textContent = valueDisplay;
    placeSpan.textContent = state.task.placeLabel;

    triesEl.textContent = "0";
    answerEl.value = "";
    answerEl.focus();

    unlockForNew();
    setFeedback(null, `Вводи число как удобно: <span class="mono">12 345,6</span> или <span class="mono">12345.6</span>.`);
    stepTextEl.textContent = "Нажми «Проверить», и здесь появится подсказка/разбор.";

    updateSessionUI();
    save();
  }

  function finishTask(){
    if(!state.task || state.task.finished) return;
    state.task.finished = true;
    state.session.done += 1;

    const size = sessionSizeNumber();
    if(size !== Infinity && state.session.done >= size){
      state.session.done = 0;
      setFeedback("warn", "Сессия завершена ✅ Нажми «Далее» или «Новый пример» — начнём заново (статистика сохранена).");
    }

    updateSessionUI();
    save();
  }

  function checkAnswer(){
    if(!state.task || state.task.finished) return;

    const parsed = normalizeInput(answerEl.value);

    // валидация нечислового ввода (критично)
    if(!parsed.ok){
      setFeedback("warn", `⚠️ ${parsed.reason}`);
      // сброс поля после проверки (по требованию аудита)
      answerEl.value = "";
      answerEl.focus();
      return;
    }

    const normUser = normalizeForCompare(parsed, state.task.exp);

    state.stats.total += 1;

    // сброс поля после проверки (по требованию аудита)
    const rawBeforeClear = answerEl.value;
    answerEl.value = "";
    answerEl.focus();

    if(!normUser.ok){
      state.stats.streak = 0;
      state.task.attempts += 1;
      triesEl.textContent = String(state.task.attempts);

      setFeedback("bad", `❌ ${normUser.reason}`);
      stepTextEl.innerHTML = buildExplanation(state.task, state.task.attempts >= 2);

      updateStatsUI();
      save();
      return;
    }

    const userStr = normUser.str;
    const correctStr = state.task.correctFixed;

    // строгое равенство (никаких допусков)
    if(userStr === correctStr){
      state.stats.correct += 1;
      state.stats.streak += 1;
      state.stats.best = Math.max(state.stats.best, state.stats.streak);

      stepTextEl.innerHTML = buildExplanation(state.task, true);

      const correctDisplay = fmtDisplay(Number(correctStr), state.task.decExpected);
      setFeedback("good", `✅ Верно! <span class="mono">${state.task.valueDisplay}</span> → <span class="mono">${correctDisplay}</span>.`);

      lockAfterFinish();
      finishTask();
    }else{
      state.stats.streak = 0;
      state.task.attempts += 1;
      triesEl.textContent = String(state.task.attempts);

      // после 2 ошибок показываем разбор уже с ответом (как в аудите)
      stepTextEl.innerHTML = buildExplanation(state.task, state.task.attempts >= 2);

      if(state.task.attempts >= 2){
        const correctDisplay = fmtDisplay(Number(correctStr), state.task.decExpected);
        setFeedback("bad", `❌ Неверно. Подсказка в разборе. Правильный ответ: <span class="mono">${correctDisplay}</span>.`);
      }else{
        setFeedback("bad", "❌ Неверно. Подсказка: смотри на следующий разряд справа.");
      }
    }

    updateStatsUI();
    save();
  }

  function showSolution(){
    if(!state.task || state.task.finished) return;

    state.stats.total += 1;
    state.stats.streak = 0;

    stepTextEl.innerHTML = buildExplanation(state.task, true);
    setFeedback("warn", "ℹ️ Показано решение. Нажми «Далее».");

    // блокируем, чтобы нельзя было “накликать”
    lockAfterFinish();
    finishTask();

    updateStatsUI();
    save();
  }

  function resetStats(){
    state.stats = { correct:0, total:0, streak:0, best:0 };
    state.session = { done:0 };
    updateStatsUI();
    updateSessionUI();
    setFeedback("warn", "Статистика сброшена.");
    save();
  }

  // events
  checkBtn.addEventListener("click", checkAnswer);
  solBtn.addEventListener("click", showSolution);
  newBtn.addEventListener("click", newTask);
  nextBtn.addEventListener("click", newTask);
  resetBtn.addEventListener("click", resetStats);

  [placeSel, modeSel, negSel, sessionSel].forEach(el => {
    el.addEventListener("change", () => {
      applySettingsFromUI();
      setFeedback("warn", "Настройки сохранены. Нажми «Новый пример», чтобы применить.");
    });
  });

  document.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      if(!checkBtn.disabled) checkAnswer();
      else newTask();
    }
  });

  // init
  load();
  placeSel.value = state.settings.place;
  modeSel.value = state.settings.mode;
  negSel.value = state.settings.negatives;
  sessionSel.value = state.settings.sessionSize;

  updateStatsUI();
  updateSessionUI();

  // first task
  newTask();
})();
</script>
</body>
</html>
