<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–î–µ–ª–µ–Ω–∏–µ —É–≥–æ–ª–∫–æ–º (–ø–æ-—Ä—É—Å—Å–∫–∏)</title>
  <style>
    :root {
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    body { margin: 20px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; line-height: 1.35; }
    .wrap { max-width: 1100px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 10px; }

    .bar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 12px 0 16px; }
    button { padding: 8px 12px; cursor:pointer; }
    input[type="number"] { width: 120px; padding:6px 8px; }
    .status { padding: 8px 10px; border-radius: 10px; background: #f3f4f6; }
    .ok { background:#ecfdf5; }
    .bad { background:#fef2f2; }

    .board { display:flex; gap:24px; flex-wrap:wrap; align-items:flex-start; }
    .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; }
    .problem { min-width: 430px; }
    .side { flex:1; min-width: 330px; }

    /* RU-—É–≥–æ–ª–æ–∫: –¥–µ–ª–∏–º–æ–µ —Å–ª–µ–≤–∞, –¥–µ–ª–∏—Ç–µ–ª—å —Å–ø—Ä–∞–≤–∞ —Å–≤–µ—Ä—Ö—É, —á–∞—Å—Ç–Ω–æ–µ —Å–ø—Ä–∞–≤–∞ —Å–Ω–∏–∑—É */
    .ru-corner {
      display: grid;
      grid-template-columns: auto 18px auto;
      grid-template-rows: auto 10px auto;
      column-gap: 10px;
      align-items: start;
      font-family: var(--mono);
      font-size: 34px;
      line-height: 1.1;
    }
    .ru-dividend { grid-column: 1; grid-row: 1; padding-left: 2px; position: relative; }
    .ru-vline {
      grid-column: 2; grid-row: 1 / 4;
      border-left: 4px solid #111827;
      border-radius: 2px;
    }
    .ru-divisor  { grid-column: 3; grid-row: 1; padding-left: 6px; }
    .ru-hline {
      grid-column: 2 / 4; grid-row: 2;
      border-top: 4px solid #111827;
      margin-top: 2px;
      height: 0;
    }
    .ru-quotient { grid-column: 3; grid-row: 3; padding-left: 6px; min-height: 38px; }

    /* –î–µ–ª–∏–º–æ–µ –ø–æ —Ü–∏—Ñ—Ä–∞–º + –¥—É–≥–∞ */
    .digits {
      font-family: var(--mono);
      display: inline-block;
      position: relative;
      letter-spacing: 0;
    }
    .digits .d { display:inline-block; width: 1ch; text-align:center; }
    .arc {
      position: absolute;
      left: calc(var(--arc-start, 0) * 1ch);
      width: calc(var(--arc-len, 0) * 1ch);
      top: -14px;
      height: 14px;
      border-top: 3px solid #111827;
      border-radius: 999px 999px 0 0;
      opacity: 0.9;
      pointer-events:none;
    }

    /* –°—Ç–æ–ª–±–∏–∫ –ø–æ–¥ –¥–µ–ª–∏–º—ã–º */
    .work {
      margin-top: 14px;
      font-family: var(--mono);
      font-size: 28px;
      white-space: pre;
    }

    .row { display:flex; gap: 10px; align-items:center; margin: 8px 0; flex-wrap:wrap; }
    .row label { font-weight: 600; }
    .small { font-size: 14px; opacity: .85; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f4f6; font-size: 13px; }
    .kbd { font-family: var(--mono); padding:2px 6px; border:1px solid #e5e7eb; border-bottom-width:2px; border-radius: 8px; }

    .split { display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start; }
    .boxTitle { font-weight: 700; margin-bottom: 8px; }

    /* –£–º–Ω–æ–∂–∞–ª–∫–∞ */
    .mul {
      font-family: var(--mono);
      font-size: 24px;
      white-space: pre;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
    }
    .log {
      font-family: var(--mono);
      font-size: 16px;
      white-space: pre-wrap;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
    }

    .mode {
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding: 10px 12px; border:1px solid #e5e7eb; border-radius: 12px;
      background:#fff;
    }
    .mode input { width:auto; }
    .fieldNote { font-size: 13px; opacity: .8; }

    .gridInputs {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 14px;
      align-items:end;
      margin-top: 10px;
    }
    .gridInputs .cell { display:flex; flex-direction:column; gap:6px; }
    .gridInputs input[type="number"] { width: 100%; }
    .actions { margin-top: 12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  </style>
</head>

<body>
<div class="wrap">
  <h1>–î–µ–ª–µ–Ω–∏–µ —É–≥–æ–ª–∫–æ–º ‚Äî —Ä–æ—Å—Å–∏–π—Å–∫–∏–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ)</h1>

  <div class="bar">
    <div class="row">
      <label>–î–µ–ª–∏–º–æ–µ:</label>
      <input id="dividendIn" type="number" min="0" step="1" value="41608">
    </div>
    <div class="row">
      <label>–î–µ–ª–∏—Ç–µ–ª—å:</label>
      <input id="divisorIn" type="number" min="1" step="1" value="56">
    </div>
    <button id="startBtn">–ù–∞—á–∞—Ç—å</button>
    <button id="randomBtn">–°–ª—É—á–∞–π–Ω—ã–π –ø—Ä–∏–º–µ—Ä</button>
    <button id="resetBtn">–°–±—Ä–æ—Å</button>
    <div id="status" class="status">–í–≤–µ–¥–∏ —á–∏—Å–ª–∞ –∏ –Ω–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª.</div>
  </div>

  <div class="board">
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
    <div class="card problem">
      <div class="ru-corner" aria-label="–¥–µ–ª–µ–Ω–∏–µ —É–≥–æ–ª–∫–æ–º (RU)">
        <div class="ru-dividend">
          <div id="dividendDigits" class="digits">
            <div class="arc" id="arc"></div>
          </div>
        </div>
        <div class="ru-vline"></div>
        <div class="ru-divisor"  id="divisorOut"></div>
        <div class="ru-hline"></div>
        <div class="ru-quotient" id="quotientOut"></div>
      </div>

      <div class="work" id="workOut"></div>

      <div class="mode" style="margin-top:12px;">
        <label style="display:flex; align-items:center; gap:8px;">
          <input id="detailedMode" type="checkbox" checked>
          <span><b>–ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–µ–∂–∏–º</b> (–ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫ –≤ —Ç–µ—Ç—Ä–∞–¥–∏: —Ü–∏—Ñ—Ä–∞ —á–∞—Å—Ç–Ω–æ–≥–æ ‚Üí –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ ‚Üí –æ—Å—Ç–∞—Ç–æ–∫ ‚Üí ‚Äú—Å–Ω–µ—Å—ë–Ω–Ω–æ–µ‚Äù —á–∏—Å–ª–æ)</span>
        </label>
        <span class="fieldNote">–ï—Å–ª–∏ —Å–Ω—è—Ç—å –≥–∞–ª–æ—á–∫—É ‚Äî –æ—Å—Ç–∞–Ω—É—Ç—Å—è —Ç–æ–ª—å–∫–æ ¬´—Ü–∏—Ñ—Ä–∞ —á–∞—Å—Ç–Ω–æ–≥–æ¬ª –∏ ¬´–æ—Å—Ç–∞—Ç–æ–∫¬ª.</span>
      </div>

      <div class="gridInputs" id="inputsBlock">
        <div class="cell">
          <label for="qDigit">–¶–∏—Ñ—Ä–∞ —á–∞—Å—Ç–Ω–æ–≥–æ (0‚Äì9)</label>
          <input id="qDigit" type="number" min="0" max="9" step="1">
          <div class="fieldNote" id="noteQ"></div>
        </div>
        <div class="cell">
          <label for="product">–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ (–¥–µ–ª–∏—Ç–µ–ª—å √ó —Ü–∏—Ñ—Ä–∞)</label>
          <input id="product" type="number" min="0" step="1">
          <div class="fieldNote" id="noteP"></div>
        </div>
        <div class="cell">
          <label for="remainder">–û—Å—Ç–∞—Ç–æ–∫ (–ø–æ—Å–ª–µ –≤—ã—á–∏—Ç–∞–Ω–∏—è)</label>
          <input id="remainder" type="number" min="0" step="1">
          <div class="fieldNote" id="noteR"></div>
        </div>
        <div class="cell">
          <label for="nextNum">–ß–∏—Å–ª–æ –ø–æ—Å–ª–µ ‚Äú—Å–Ω–æ—Å–∞‚Äù</label>
          <input id="nextNum" type="number" min="0" step="1">
          <div class="fieldNote" id="noteN"></div>
        </div>
      </div>

      <div class="actions">
        <button id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —à–∞–≥</button>
        <span class="small">Enter —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ª—é–±–æ–º –ø–æ–ª–µ: <span class="kbd">Enter</span></span>
      </div>

      <div class="small" style="margin-top:10px;">
        –ü–æ–¥—Å–∫–∞–∑–∫–∞: —Ç—Ä–µ–Ω–∞–∂—ë—Ä –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫, –∫–∞–∫ –≤ —à–∫–æ–ª–µ: –±–µ—Ä—ë–º —Å–ª–µ–≤–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫—É—Å–æ–∫ –¥–µ–ª–∏–º–æ–≥–æ ‚â• –¥–µ–ª–∏—Ç–µ–ª—è ‚Üí –¥–µ–ª–∏–º ‚Üí —É–º–Ω–æ–∂–∞–µ–º ‚Üí –≤—ã—á–∏—Ç–∞–µ–º ‚Üí —Å–Ω–æ—Å–∏–º —Å–ª–µ–¥—É—é—â—É—é —Ü–∏—Ñ—Ä—É.
      </div>
    </div>

    <!-- –ë–æ–∫–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
    <div class="card side">
      <div class="split">
        <div style="flex:1; min-width: 260px;">
          <div class="boxTitle">–£–º–Ω–æ–∂–∞–ª–∫–∞ (–∫–∞–∫ —Å–ø—Ä–∞–≤–∞ —É —Ç–µ–±—è)</div>
          <div class="mul" id="mulOut">‚Äî</div>
        </div>
        <div style="flex:1; min-width: 260px;">
          <div class="boxTitle">–õ–æ–≥ —à–∞–≥–æ–≤ (–¥–ª—è —É—á–∏—Ç–µ–ª—è)</div>
          <div class="log" id="logOut">‚Äî</div>
        </div>
      </div>

      <hr style="border:none; border-top:1px solid #e5e7eb; margin: 14px 0;">

      <div class="small">
        –ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å ‚Äî –¥–æ–±–∞–≤–ª—é –µ—â—ë –æ–¥–∏–Ω —É—Ä–æ–≤–µ–Ω—å ‚Äú–∂—ë—Å—Ç–∫–æ—Å—Ç–∏‚Äù: —á—Ç–æ–±—ã —É—á–µ–Ω–∏–∫ –≤–≤–æ–¥–∏–ª –Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ, –Ω–æ –∏ **—Å—Ç—Ä–æ–∫—É –≤—ã—á–∏—Ç–∞–Ω–∏—è —Å –º–∏–Ω—É—Å–æ–º** (–Ω–∞–ø—Ä–∏–º–µ—Ä, ‚Äú-392‚Äù) –∏ —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä—è–ª–∞—Å—å —Ñ–æ—Ä–º–∞ –∑–∞–ø–∏—Å–∏.
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const el = (id) => document.getElementById(id);

  const dividendIn = el('dividendIn');
  const divisorIn  = el('divisorIn');

  const startBtn   = el('startBtn');
  const randomBtn  = el('randomBtn');
  const resetBtn   = el('resetBtn');
  const checkBtn   = el('checkBtn');

  const status     = el('status');
  const divisorOut = el('divisorOut');
  const quotientOut= el('quotientOut');
  const workOut    = el('workOut');

  const digitsBox  = el('dividendDigits');
  const arcEl      = el('arc');

  const detailedMode = el('detailedMode');

  const qDigitIn   = el('qDigit');
  const productIn  = el('product');
  const remainderIn= el('remainder');
  const nextNumIn  = el('nextNum');

  const noteQ = el('noteQ');
  const noteP = el('noteP');
  const noteR = el('noteR');
  const noteN = el('noteN');

  const mulOut = el('mulOut');
  const logOut = el('logOut');

  let st = null;

  function setStatus(text, kind = 'neutral') {
    status.textContent = text;
    status.className = 'status' + (kind === 'ok' ? ' ok' : kind === 'bad' ? ' bad' : '');
  }

  function sanitizeInt(v, fallback = null) {
    if (v === '' || v === null || v === undefined) return fallback;
    const n = Number(v);
    if (!Number.isFinite(n)) return fallback;
    return Math.trunc(n);
  }

  function spaces(n) { return n > 0 ? ' '.repeat(n) : ''; }

  function resetUI() {
    divisorOut.textContent = '';
    quotientOut.textContent = '';
    workOut.textContent = '';
    mulOut.textContent = '‚Äî';
    logOut.textContent = '‚Äî';

    qDigitIn.value = '';
    productIn.value = '';
    remainderIn.value = '';
    nextNumIn.value = '';

    noteQ.textContent = '';
    noteP.textContent = '';
    noteR.textContent = '';
    noteN.textContent = '';

    digitsBox.innerHTML = '<div class="arc" id="arc"></div>';
  }

  function renderDividendDigits(numStr) {
    digitsBox.innerHTML = '';
    digitsBox.appendChild(arcEl); // arc —É–∂–µ —Å–æ–∑–¥–∞–Ω –≤ DOM, –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–Ω—É—Ç—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    for (const ch of numStr) {
      const s = document.createElement('span');
      s.className = 'd';
      s.textContent = ch;
      digitsBox.appendChild(s);
    }
  }

  function setArc(start, len) {
    // start, len –≤ "–∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ü–∏—Ñ—Ä"
    digitsBox.style.setProperty('--arc-start', String(start));
    digitsBox.style.setProperty('--arc-len', String(len));
    arcEl.style.display = (len > 0 ? 'block' : 'none');
  }

  function makeRandom() {
    const divisor = Math.floor(Math.random() * 90) + 10;        // 10..99
    const dividend = Math.floor(Math.random() * 90000) + 1000;  // 1000..99999
    dividendIn.value = dividend;
    divisorIn.value = divisor;
    start();
  }

  function start() {
    const dividend = sanitizeInt(dividendIn.value, null);
    const divisor  = sanitizeInt(divisorIn.value, null);

    if (dividend === null || divisor === null || divisor <= 0 || dividend < 0) {
      setStatus('–ü—Ä–æ–≤–µ—Ä—å —á–∏—Å–ª–∞: –¥–µ–ª–∏–º–æ–µ ‚â• 0, –¥–µ–ª–∏—Ç–µ–ª—å > 0.', 'bad');
      return;
    }

    const digits = String(dividend).split('').map(d => Number(d));

    st = {
      dividend,
      divisor,
      digits,
      totalLen: digits.length,
      i: 0,                 // —Å–∫–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä –¥–µ–ª–∏–º–æ–≥–æ —É–∂–µ –≤–æ–≤–ª–µ—á–µ–Ω–æ (–ø—Ä–∞–≤—ã–π –∫—Ä–∞–π —Ç–µ–∫—É—â–µ–≥–æ –∫—É—Å–æ—á–∫–∞)
      current: 0,
      quotientDigits: [],
      workLines: [],
      mulLines: [],
      logLines: [],
      finished: false,
      lastChunkStart: 0,     // –Ω–∞—á–∞–ª–æ —Ç–µ–∫—É—â–µ–≥–æ –∫—É—Å–æ—á–∫–∞ (–¥–ª—è –¥—É–≥–∏)
      lastChunkLen: 0        // –¥–ª–∏–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –∫—É—Å–æ—á–∫–∞ (–¥–ª—è –¥—É–≥–∏)
    };

    resetUI();
    divisorOut.textContent = String(divisor);
    renderDividendDigits(String(dividend));

    buildNextCurrentToAtLeastDivisor(/*isInitial=*/true);

    // —Å–ª—É—á–∞–π dividend < divisor
    if (st.i >= st.digits.length && st.current < st.divisor) {
      st.finished = true;
      quotientOut.textContent = '0';
      setArc(0, st.totalLen);
      setStatus(`–ì–æ—Ç–æ–≤–æ! –ß–∞—Å—Ç–Ω–æ–µ: 0, –æ—Å—Ç–∞—Ç–æ–∫: ${st.dividend}.`, 'ok');
      return;
    }

    render();
    setStatus('–®–∞–≥ 1: –≤–≤–µ–¥–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è (–∫–∞–∫ –≤ —Ç–µ—Ç—Ä–∞–¥–∏).', 'neutral');
    qDigitIn.focus();
  }

  function buildNextCurrentToAtLeastDivisor(isInitial = false) {
    // –°–æ–±–∏—Ä–∞–µ–º current, —Å–Ω–æ—Å—è —Ü–∏—Ñ—Ä—ã, –ø–æ–∫–∞ current >= divisor (–∏–ª–∏ —Ü–∏—Ñ—Ä—ã –Ω–µ –∫–æ–Ω—á–∞—Ç—Å—è).
    // –ï—Å–ª–∏ –º—ã —É–∂–µ –Ω–∞—á–∞–ª–∏ —á–∞—Å—Ç–Ω–æ–µ ‚Äî –∫–∞–∂–¥—ã–π "–¥–æ—Å–Ω–æ—Å" –¥–æ–±–∞–≤–ª—è–µ—Ç 0 –≤ —á–∞—Å—Ç–Ω–æ–µ (–∫–∞–∫ –≤ —Ç–µ—Ç—Ä–∞–¥–∏).
    let startIndex = st.i; // –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –Ω–∞—á–∞–ª–æ –∫—É—Å–∫–∞
    if (isInitial) startIndex = 0;

    while (st.i < st.digits.length && st.current < st.divisor) {
      st.current = st.current * 10 + st.digits[st.i];
      st.i++;
      if (!isInitial && st.quotientDigits.length > 0) st.quotientDigits.push(0);
    }

    // –≤—ã—á–∏—Å–ª–∏–º –¥—É–≥—É: –∫—É—Å–æ–∫ ‚Äî —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ len(current) —Ü–∏—Ñ—Ä, –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏–µ—Å—è –≤ –ø–æ–∑–∏—Ü–∏–∏ i
    const curStr = String(st.current);
    st.lastChunkLen = curStr.length;
    st.lastChunkStart = st.i - st.lastChunkLen;

    // –µ—Å–ª–∏ current –≤—Å—ë –µ—â—ë < divisor –∏ —Ü–∏—Ñ—Ä—ã –∫–æ–Ω—á–∏–ª–∏—Å—å ‚Äî –¥—É–≥–∞ –±—É–¥–µ—Ç –Ω–∞ –≤—Å—ë–º, –Ω–æ —ç—Ç–æ —Ñ–∏–Ω–∏—à –æ–±—Ä–∞–±–æ—Ç–∞–µ–º –≤—ã—à–µ
    setArc(st.lastChunkStart, st.lastChunkLen);
  }

  function expectedStep() {
    if (!st || st.finished) return null;

    if (st.i >= st.digits.length && st.current < st.divisor) {
      return {
        done: true,
        quotient: st.quotientDigits.length ? st.quotientDigits.join('') : '0',
        remainder: st.current
      };
    }

    const q = Math.floor(st.current / st.divisor);
    const prod = q * st.divisor;
    const rem = st.current - prod;

    let bringDownDigit = null;
    let nextCurrent = rem;
    let nextRightPos = st.i;

    if (st.i < st.digits.length) {
      bringDownDigit = st.digits[st.i];
      nextCurrent = rem * 10 + bringDownDigit;
      nextRightPos = st.i + 1;
    }

    // –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±–∏–∫–∞:
    const currentStr = String(st.current);
    const prodStr = String(prod);
    const barWidth = Math.max(currentStr.length, prodStr.length);

    const rightPos = st.i; // –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π —Ç–µ–∫—É—â–µ–≥–æ –∫—É—Å–∫–∞ –ø–æ –¥–µ–ª–∏–º–æ–º—É

    return {
      done: false,
      current: st.current,
      rightPos,
      qDigit: q,
      product: prod,
      remainder: rem,
      bringDownDigit,
      nextCurrent,
      nextRightPos,
      barWidth
    };
  }

  function setFieldNotes(exp) {
    if (!exp || exp.done) {
      noteQ.textContent = '';
      noteP.textContent = '';
      noteR.textContent = '';
      noteN.textContent = '';
      return;
    }
    // –ù–µ–Ω–∞–≤—è–∑—á–∏–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ ‚Äú—á—Ç–æ —Å–µ–π—á–∞—Å –¥–µ–ª–∞–µ–º‚Äù (–±–µ–∑ –æ—Ç–≤–µ—Ç–∞)
    noteQ.textContent = `–°–µ–π—á–∞—Å –¥–µ–ª–∏–º: ${exp.current} : ${st.divisor}`;
    noteP.textContent = `–î–æ–ª–∂–Ω–æ –±—ã—Ç—å: ${st.divisor} √ó (—Ü–∏—Ñ—Ä–∞ —á–∞—Å—Ç–Ω–æ–≥–æ)`;
    noteR.textContent = `–û—Å—Ç–∞—Ç–æ–∫ = ${exp.current} ‚àí –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ`;
    noteN.textContent = exp.bringDownDigit === null
      ? `–¶–∏—Ñ—Ä –±–æ–ª—å—à–µ –Ω–µ—Ç ‚Üí –∑–¥–µ—Å—å –æ–±—ã—á–Ω–æ –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Å—Ç–∞—Ç–æ–∫`
      : `–°–Ω–æ—Å–∏–º —Å–ª–µ–¥—É—é—â—É—é —Ü–∏—Ñ—Ä—É –¥–µ–ª–∏–º–æ–≥–æ: ${exp.bringDownDigit}`;
  }

  function render() {
    if (!st) return;

    quotientOut.textContent = st.quotientDigits.length ? st.quotientDigits.join('') : '';
    workOut.textContent = st.workLines.join('\n');

    mulOut.textContent = st.mulLines.length ? st.mulLines.slice(-6).join('\n') : '‚Äî';
    logOut.textContent = st.logLines.length ? st.logLines.join('\n') : '‚Äî';

    const exp = expectedStep();
    setFieldNotes(exp);

    // –¥—É–≥–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ buildNextCurrentToAtLeastDivisor, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π:
    if (st.lastChunkLen > 0) setArc(st.lastChunkStart, st.lastChunkLen);

    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    const on = detailedMode.checked;
    productIn.parentElement.style.display = on ? 'flex' : 'none';
    nextNumIn.parentElement.style.display = on ? 'flex' : 'none';
    noteP.parentElement.style.display = on ? 'flex' : 'none';
    noteN.parentElement.style.display = on ? 'flex' : 'none';
  }

  function addNotebookLines(exp) {
    // –°—Ç–æ–ª–±–∏–∫ "–ø–æ-—Ä—É—Å—Å–∫–∏" –ø–æ–¥ –¥–µ–ª–∏–º—ã–º:
    //  -XXX
    //  ----
    //  YYY (–ø–æ—Å–ª–µ —Å–Ω–æ—Å–∞)
    const currentStr = String(exp.current);
    const productStr = String(exp.product);
    const barWidth = exp.barWidth;

    const indentProd = exp.rightPos - productStr.length;
    const indentBar  = exp.rightPos - barWidth;

    st.workLines.push(spaces(indentProd) + '-' + productStr);
    st.workLines.push(spaces(indentBar)  + '-'.repeat(barWidth));

    const nextLineValue = (exp.bringDownDigit === null) ? exp.remainder : exp.nextCurrent;
    const nextStr = String(nextLineValue);
    const indentNext = exp.nextRightPos - nextStr.length;

    st.workLines.push(spaces(indentNext) + nextStr);
  }

  function addMul(exp) {
    // –£–º–Ω–æ–∂–∞–ª–∫–∞ ‚Äú–∫–∞–∫ –Ω–∞ –ø–æ–ª—è—Ö‚Äù: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –æ–ø–µ—Ä–∞—Ü–∏—é (–¥–µ–ª–∏—Ç–µ–ª—å √ó —Ü–∏—Ñ—Ä–∞ = –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ)
    // –§–æ—Ä–º–∞—Ç –±–ª–∏–∑–∫–∏–π –∫ —à–∫–æ–ª—å–Ω–æ–º—É:
    //   56
    // √ó  7
    // ----
    //  392
    const a = String(st.divisor);
    const b = String(exp.qDigit);
    const p = String(exp.product);

    const w = Math.max(a.length, b.length + 2, p.length); // +2 –ø–æ–¥ "√ó "
    const line1 = spaces(w - a.length) + a;
    const line2 = spaces(w - (b.length + 2)) + '√ó ' + b;
    const line3 = '-'.repeat(w);
    const line4 = spaces(w - p.length) + p;

    st.mulLines.push(line1);
    st.mulLines.push(line2);
    st.mulLines.push(line3);
    st.mulLines.push(line4);
    st.mulLines.push(''); // –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ–∂–¥—É –ø—Ä–∏–º–µ—Ä–∞–º–∏
  }

  function applyStep(user) {
    const exp = expectedStep();
    if (!exp) return;

    if (exp.done) {
      st.finished = true;
      render();
      setStatus(`–ì–æ—Ç–æ–≤–æ! –ß–∞—Å—Ç–Ω–æ–µ: ${exp.quotient}, –æ—Å—Ç–∞—Ç–æ–∫: ${exp.remainder}.`, 'ok');
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∏ (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞)
    const detailed = detailedMode.checked;

    if (user.qDigit !== exp.qDigit) {
      setStatus(`–ù–µ —Å—Ö–æ–¥–∏—Ç—Å—è —Ü–∏—Ñ—Ä–∞ —á–∞—Å—Ç–Ω–æ–≥–æ. –ü—Ä–æ–≤–µ—Ä—å: ${exp.current} : ${st.divisor}.`, 'bad');
      return;
    }

    if (detailed && user.product !== exp.product) {
      setStatus(`–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–µ–≤–µ—Ä–Ω–æ–µ. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: ${st.divisor} √ó ${exp.qDigit}.`, 'bad');
      return;
    }

    if (user.remainder !== exp.remainder) {
      setStatus(`–û—Å—Ç–∞—Ç–æ–∫ –Ω–µ–≤–µ—Ä–Ω—ã–π. –ü—Ä–æ–≤–µ—Ä—å –≤—ã—á–∏—Ç–∞–Ω–∏–µ: ${exp.current} ‚àí ${exp.product}.`, 'bad');
      return;
    }

    if (detailed) {
      // –í –ø–æ–¥—Ä–æ–±–Ω–æ–º —Ä–µ–∂–∏–º–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ ‚Äú—á–∏—Å–ª–æ –ø–æ—Å–ª–µ —Å–Ω–æ—Å–∞‚Äù
      const expectedNext = (exp.bringDownDigit === null) ? exp.remainder : exp.nextCurrent;
      if (user.nextNum !== expectedNext) {
        if (exp.bringDownDigit === null) {
          setStatus(`–¶–∏—Ñ—Ä –±–æ–ª—å—à–µ –Ω–µ—Ç ‚Äî –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–æ—Å—Ç–æ ${exp.remainder}.`, 'bad');
        } else {
          setStatus(`–ü–æ—Å–ª–µ ‚Äú—Å–Ω–æ—Å–∞‚Äù –¥–æ–ª–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å—Å—è ${exp.nextCurrent} (—Å–Ω–µ—Å–ª–∏ ${exp.bringDownDigit}).`, 'bad');
        }
        return;
      }
    }

    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ü–∏—Ñ—Ä—É —á–∞—Å—Ç–Ω–æ–≥–æ
    st.quotientDigits.push(exp.qDigit);

    // –†–∏—Å—É–µ–º —Å—Ç–æ–ª–±–∏–∫ –∏ —É–º–Ω–æ–∂–∞–ª–∫—É
    addNotebookLines(exp);
    addMul(exp);

    // –õ–æ–≥ ‚Äú–¥–ª—è —É—á–∏—Ç–µ–ª—è‚Äù
    st.logLines.push(`–ë–µ—Ä—ë–º ${exp.current}, –¥–µ–ª–∏–º –Ω–∞ ${st.divisor} ‚Üí —Ü–∏—Ñ—Ä–∞ ${exp.qDigit}`);
    st.logLines.push(`${st.divisor}√ó${exp.qDigit}=${exp.product}, –æ—Å—Ç–∞—Ç–æ–∫ ${exp.remainder}`);
    if (exp.bringDownDigit !== null) st.logLines.push(`–°–Ω–µ—Å–ª–∏ ${exp.bringDownDigit} ‚Üí ${exp.nextCurrent}`);
    else st.logLines.push(`–¶–∏—Ñ—Ä—ã –∫–æ–Ω—á–∏–ª–∏—Å—å, –æ—Å—Ç–∞—Ç–æ–∫: ${exp.remainder}`);
    st.logLines.push('');

    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
    st.current = exp.remainder;

    if (exp.bringDownDigit !== null) {
      st.current = exp.nextCurrent;
      st.i += 1;
    }

    // –ï—Å–ª–∏ current < divisor –∏ —Ü–∏—Ñ—Ä—ã –µ—â—ë –µ—Å—Ç—å ‚Äî ‚Äú–¥–æ—Å–Ω–æ—Å–∏–º‚Äù –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω—É–ª–∏ –≤ —á–∞—Å—Ç–Ω–æ–º
    if (st.i < st.digits.length && st.current < st.divisor) {
      buildNextCurrentToAtLeastDivisor(false);
    } else {
      // –æ–±–Ω–æ–≤–∏–º –¥—É–≥—É –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∫—É—Å–æ–∫
      const curStr = String(st.current);
      st.lastChunkLen = curStr.length;
      st.lastChunkStart = st.i - st.lastChunkLen;
      setArc(st.lastChunkStart, st.lastChunkLen);
    }

    // –æ—á–∏—Å—Ç–∏–º –≤–≤–æ–¥
    qDigitIn.value = '';
    productIn.value = '';
    remainderIn.value = '';
    nextNumIn.value = '';

    render();

    const exp2 = expectedStep();
    if (exp2 && exp2.done) {
      st.finished = true;
      render();
      setStatus(`–ì–æ—Ç–æ–≤–æ! –ß–∞—Å—Ç–Ω–æ–µ: ${exp2.quotient}, –æ—Å—Ç–∞—Ç–æ–∫: ${exp2.remainder}.`, 'ok');
      return;
    }

    setStatus('–í–µ—Ä–Ω–æ! –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥.', 'ok');
    qDigitIn.focus();
  }

  function onCheck() {
    if (!st) { setStatus('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª.', 'bad'); return; }
    if (st.finished) { setStatus('–£–∂–µ –≥–æ—Ç–æ–≤–æ üôÇ –ù–∞–∂–º–∏ ¬´–°–ª—É—á–∞–π–Ω—ã–π –ø—Ä–∏–º–µ—Ä¬ª –∏–ª–∏ ¬´–°–±—Ä–æ—Å¬ª.', 'neutral'); return; }

    const qd = sanitizeInt(qDigitIn.value, null);
    const pr = sanitizeInt(productIn.value, null);
    const rm = sanitizeInt(remainderIn.value, null);
    const nx = sanitizeInt(nextNumIn.value, null);

    if (qd === null || rm === null) {
      setStatus('–ú–∏–Ω–∏–º—É–º –Ω—É–∂–Ω–æ: ¬´—Ü–∏—Ñ—Ä–∞ —á–∞—Å—Ç–Ω–æ–≥–æ¬ª –∏ ¬´–æ—Å—Ç–∞—Ç–æ–∫¬ª.', 'bad');
      return;
    }
    if (qd < 0 || qd > 9) { setStatus('–¶–∏—Ñ—Ä–∞ —á–∞—Å—Ç–Ω–æ–≥–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 0‚Äì9.', 'bad'); return; }
    if (rm < 0) { setStatus('–û—Å—Ç–∞—Ç–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º.', 'bad'); return; }

    const detailed = detailedMode.checked;
    if (detailed && (pr === null || nx === null)) {
      setStatus('–í –ø–æ–¥—Ä–æ–±–Ω–æ–º —Ä–µ–∂–∏–º–µ –∑–∞–ø–æ–ª–Ω–∏ –µ—â—ë ¬´–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ¬ª –∏ ¬´—á–∏—Å–ª–æ –ø–æ—Å–ª–µ —Å–Ω–æ—Å–∞¬ª.', 'bad');
      return;
    }

    applyStep({ qDigit: qd, product: pr, remainder: rm, nextNum: nx });
  }

  // Events
  startBtn.addEventListener('click', start);
  randomBtn.addEventListener('click', makeRandom);
  resetBtn.addEventListener('click', () => {
    st = null;
    resetUI();
    setStatus('–°–±—Ä–æ—à–µ–Ω–æ. –í–≤–µ–¥–∏ —á–∏—Å–ª–∞ –∏ –Ω–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª.');
  });

  checkBtn.addEventListener('click', onCheck);

  [qDigitIn, productIn, remainderIn, nextNumIn].forEach(inp => {
    inp.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') onCheck();
    });
  });

  detailedMode.addEventListener('change', () => {
    render();
    setStatus(detailedMode.checked
      ? '–ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω: –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏ —á–∏—Å–ª–æ –ø–æ—Å–ª–µ —Å–Ω–æ—Å–∞.'
      : '–£–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ä–µ–∂–∏–º: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ü–∏—Ñ—Ä—É —á–∞—Å—Ç–Ω–æ–≥–æ –∏ –æ—Å—Ç–∞—Ç–æ–∫.', 'neutral');
  });

})();
</script>
</body>
</html>
