<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–¢—Ä–µ–Ω–∞–∂—ë—Ä –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è ‚Äî –û–ì–≠-—Å–∫–æ—Ä–æ–ø–æ–º–æ—â—å</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#101a2d;
      --text:#e8eefc;
      --muted:#a9b4d0;
      --line:#223153;
      --accent:#5aa7ff;
      --ok:#41d17c;
      --bad:#ff5a6f;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, #14244a 0%, var(--bg) 50%) fixed;
      color:var(--text);
      line-height:1.45;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:980px; margin:0 auto; padding:22px}
    .top{
      display:flex; flex-wrap:wrap; gap:12px;
      align-items:baseline; justify-content:space-between;
      margin-bottom:14px;
    }
    h1{
      font-size:22px; margin:0;
      letter-spacing:.2px;
    }
    .sub{color:var(--muted); font-size:13px}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin:10px 0 14px;
    }
    @media (max-width: 720px){
      .controls{grid-template-columns:1fr}
    }
    label{display:block; color:var(--muted); font-size:12px; margin-bottom:6px}
    select, input[type="text"]{
      width:100%;
      padding:12px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background:#0b1428;
      color:var(--text);
      outline:none;
    }
    select:focus, input[type="text"]:focus{border-color: rgba(90,167,255,.7); box-shadow: 0 0 0 3px rgba(90,167,255,.15)}
    .task{
      display:flex; flex-direction:column; gap:10px;
      margin-top:6px;
    }
    .taskline{
      font-size:18px;
      padding:14px;
      border-radius: 14px;
      border:1px dashed rgba(90,167,255,.35);
      background: rgba(90,167,255,.06);
    }
    .row{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }
    .row .grow{flex:1 1 260px}
    .btn{
      border:none;
      background: rgba(90,167,255,.16);
      color:var(--text);
      padding:11px 12px;
      border-radius: 12px;
      cursor:pointer;
      border:1px solid rgba(90,167,255,.35);
      transition: transform .04s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{background: rgba(90,167,255,.22)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: rgba(90,167,255,.28);
      border-color: rgba(90,167,255,.55);
    }
    .btn.ghost{
      background: transparent;
      border-color: rgba(169,180,208,.25);
      color: var(--muted);
    }
    .hint{
      margin-top:8px;
      padding:12px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      font-size: 13px;
    }
    .feedback{
      margin-top:10px;
      padding:12px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      font-size: 14px;
    }
    .feedback.ok{border-color: rgba(65,209,124,.35); background: rgba(65,209,124,.08)}
    .feedback.bad{border-color: rgba(255,90,111,.35); background: rgba(255,90,111,.08)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .stat{
      padding:12px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.02);
    }
    .stat .k{color:var(--muted); font-size:12px}
    .stat .v{font-size:20px; margin-top:4px}
    .progress{
      margin-top:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 999px;
      overflow:hidden;
      height: 12px;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(90,167,255,.25), rgba(65,209,124,.35));
      transition: width .2s ease;
    }
    .small{
      color:var(--muted);
      font-size:12px;
      margin-top:10px;
    }
    .kbd{
      display:inline-block;
      border:1px solid rgba(169,180,208,.35);
      border-bottom-color: rgba(169,180,208,.2);
      background: rgba(255,255,255,.03);
      padding:2px 7px;
      border-radius: 8px;
      font-size: 12px;
      color: var(--muted);
      margin:0 2px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>–¢—Ä–µ–Ω–∞–∂—ë—Ä –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è (–û–ì–≠-—Å–∫–æ—Ä–æ–ø–æ–º–æ—â—å)</h1>
      <div class="sub">–û–∫—Ä—É–≥–ª—è–µ–º –¥–æ –º–∏–ª–ª–∏–æ–Ω–æ–≤‚Ä¶ –µ–¥–∏–Ω–∏—Ü‚Ä¶ –¥–µ—Å—è—Ç—ã—Ö, —Å–æ—Ç—ã—Ö, —Ç—ã—Å—è—á–Ω—ã—Ö. –†–∞–∑–±–æ—Ä ‚Äî –∫–∞–∫ –≤ –≥–æ–ª–æ–≤–µ —É —Ö–æ—Ä–æ—à–µ–π ¬´—Ç—ë—Ç–∏ –≤ –æ—á–∫–∞—Ö¬ª üôÇ</div>
    </div>
    <div class="sub"><a href="index.html">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a></div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="controls">
        <div>
          <label for="place">–û–∫—Ä—É–≥–ª—è—Ç—å –¥–æ</label>
          <select id="place"></select>
        </div>
        <div>
          <label for="kind">–ö–∞–∫–∏–µ —á–∏—Å–ª–∞</label>
          <select id="kind">
            <option value="auto">–ê–≤—Ç–æ (–ø–æ–¥ —Ä–∞–∑—Ä—è–¥)</option>
            <option value="int">–¢–æ–ª—å–∫–æ —Ü–µ–ª—ã–µ</option>
            <option value="dec">–¢–æ–ª—å–∫–æ –¥–µ—Å—è—Ç–∏—á–Ω—ã–µ</option>
          </select>
        </div>
        <div>
          <label for="neg">–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ</label>
          <select id="neg">
            <option value="no">–ù–µ—Ç</option>
            <option value="sometimes">–ò–Ω–æ–≥–¥–∞</option>
          </select>
        </div>
      </div>

      <div class="task">
        <div class="taskline">
          <div class="sub">–ó–∞–¥–∞–Ω–∏–µ</div>
          <div style="margin-top:6px">
            –û–∫—Ä—É–≥–ª–∏ <span id="num" class="mono"></span> –¥–æ <span id="placeLabel"></span>.
          </div>
        </div>

        <div class="row">
          <div class="grow">
            <label for="answer">–¢–≤–æ–π –æ—Ç–≤–µ—Ç</label>
            <input id="answer" type="text" inputmode="decimal" autocomplete="off" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 12 300 –∏–ª–∏ 12 345,6" />
          </div>
          <button class="btn primary" id="btnCheck">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å <span class="sub">(Enter)</span></button>
          <button class="btn" id="btnNew">–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä <span class="sub">(Ctrl+Enter)</span></button>
          <button class="btn ghost" id="btnSolution">–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ</button>
          <button class="btn ghost" id="btnReset">–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        </div>

        <div id="feedback" class="feedback" style="display:none;"></div>
        <div id="solution" class="hint" style="display:none;"></div>

        <div class="hint">
          –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ –≤–≤–æ–¥—É: –º–æ–∂–Ω–æ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏, —Å –∑–∞–ø—è—Ç–æ–π –∏–ª–∏ —Ç–æ—á–∫–æ–π. –ü—Ä–∏–º–µ—Ä—ã: <span class="mono">12 345,6</span> / <span class="mono">12345.6</span><br/>
          –ü—Ä–∞–≤–∏–ª–æ: —Å–º–æ—Ç—Ä–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑—Ä—è–¥. –ï—Å–ª–∏ —Ç–∞–º <b>5‚Äì9</b> ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —Ä–∞–∑—Ä—è–¥ –Ω–∞ 1. –ï—Å–ª–∏ <b>0‚Äì4</b> ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="sub">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>

      <div class="stats">
        <div class="stat">
          <div class="k">–ü—Ä–∞–≤–∏–ª—å–Ω–æ</div>
          <div class="v" id="stOk">0</div>
        </div>
        <div class="stat">
          <div class="k">–í—Å–µ–≥–æ</div>
          <div class="v" id="stAll">0</div>
        </div>
        <div class="stat">
          <div class="k">–°–µ—Ä–∏—è</div>
          <div class="v" id="stStreak">0</div>
        </div>
        <div class="stat">
          <div class="k">–õ—É—á—à–∞—è —Å–µ—Ä–∏—è</div>
          <div class="v" id="stBest">0</div>
        </div>
      </div>

      <div class="small" style="margin-top:12px">
        –ë–ª–æ–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: <b><span id="blkDone">0</span>/10</b>
      </div>
      <div class="progress" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å –±–ª–æ–∫–∞">
        <div class="bar" id="bar"></div>
      </div>

      <div class="small" style="margin-top:12px">
        –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏: <span class="kbd">Enter</span> ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> ‚Äî –Ω–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // ---------- utils (BigInt rational) ----------
  const pow10 = (n) => 10n ** BigInt(n);

  const simplifyPow10 = (num, den) => {
    // den is power of 10
    let n = num, d = den;
    let sign = 1n;
    if (n < 0n) { sign = -1n; n = -n; }
    while (d > 1n && (d % 10n === 0n) && (n % 10n === 0n)) {
      n /= 10n;
      d /= 10n;
    }
    return { num: sign * n, den: d };
  };

  const parseToRational = (s) => {
    if (!s) return null;
    let t = String(s).trim();
    if (!t) return null;

    // allow spaces inside number (grouping), comma or dot
    t = t.replace(/\s+/g, '');
    t = t.replace(',', '.');

    if (!/^[-+]?\d+(\.\d+)?$/.test(t)) return null;

    let sign = 1n;
    if (t[0] === '-') { sign = -1n; t = t.slice(1); }
    if (t[0] === '+') { t = t.slice(1); }

    const parts = t.split('.');
    const intPart = parts[0] || '0';
    const fracPart = parts[1] || '';
    const fracLen = fracPart.length;

    const digits = (intPart + fracPart).replace(/^0+(?=\d)/, ''); // keep at least one digit
    const den = pow10(fracLen);
    let num = BigInt(digits || '0');
    num *= sign;

    return simplifyPow10(num, den);
  };

  const formatRational = (rat) => {
    const { num, den } = rat;
    if (den === 1n) return addSpaces(num.toString());
    // den is power of 10
    let sign = '';
    let n = num;
    if (n < 0n) { sign = '-'; n = -n; }
    const denPow = String(den).length - 1; // 10^k
    let s = n.toString();
    if (s.length <= denPow) s = '0'.repeat(denPow - s.length + 1) + s;
    const i = s.slice(0, s.length - denPow);
    const f = s.slice(s.length - denPow);
    // keep trailing zeros (school-style output), but we will ACCEPT any equivalent input anyway
    return sign + addSpaces(i) + '.' + f;
  };

  const addSpaces = (intStr) => {
    // keep leading '-' if present
    let s = intStr;
    let sign = '';
    if (s[0] === '-') { sign = '-'; s = s.slice(1); }
    // remove leading zeros (but keep single zero)
    s = s.replace(/^0+(?=\d)/, '');
    const out = s.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    return sign + out;
  };

  const roundHalfAwayFromZero = (N, D) => {
    // N can be negative, D > 0
    if (D <= 0n) throw new Error('Denominator must be positive');
    if (N === 0n) return 0n;
    const sign = (N < 0n) ? -1n : 1n;
    const a = (N < 0n) ? -N : N;
    let q = a / D;
    const r = a % D;
    if (2n * r >= D) q += 1n; // ties go away from zero
    return sign * q;
  };

  const toPlace = (valueRat, placeRat) => {
    // valueRat = num/den, placeRat = pNum/pDen
    const N = valueRat.num * placeRat.den;
    const D = valueRat.den * placeRat.num;
    const k = roundHalfAwayFromZero(N, D);
    const res = simplifyPow10(k * placeRat.num, placeRat.den);
    return res;
  };

  const floorDiv = (A, B) => {
    // A >=0, B>0
    return A / B;
  };

  const digitAt = (absValueRat, stepRat) => {
    // digit = floor(absValue / step) % 10
    // absValueRat: num>=0
    const N = absValueRat.num * stepRat.den;
    const D = absValueRat.den * stepRat.num;
    const q = floorDiv(N, D);
    return Number(q % 10n);
  };

  // ---------- places ----------
  const PLACE_ITEMS = [
    { id: 'p:6', label: '–º–∏–ª–ª–∏–æ–Ω–æ–≤', pretty: '1 000 000' },
    { id: 'p:5', label: '—Å–æ—Ç–µ–Ω —Ç—ã—Å—è—á', pretty: '100 000' },
    { id: 'p:4', label: '–¥–µ—Å—è—Ç–∫–æ–≤ —Ç—ã—Å—è—á', pretty: '10 000' },
    { id: 'p:3', label: '—Ç—ã—Å—è—á', pretty: '1 000' },
    { id: 'p:2', label: '—Å–æ—Ç–µ–Ω', pretty: '100' },
    { id: 'p:1', label: '–¥–µ—Å—è—Ç–∫–æ–≤', pretty: '10' },
    { id: 'p:0', label: '–µ–¥–∏–Ω–∏—Ü', pretty: '1' },
    { id: 'd:1', label: '–¥–µ—Å—è—Ç—ã—Ö', pretty: '0.1' },
    { id: 'd:2', label: '—Å–æ—Ç—ã—Ö', pretty: '0.01' },
    { id: 'd:3', label: '—Ç—ã—Å—è—á–Ω—ã—Ö', pretty: '0.001' },
  ];

  const placeToRat = (id) => {
    const [kind, nStr] = id.split(':');
    const n = Number(nStr);
    if (kind === 'p') return { num: pow10(n), den: 1n, kind, n };
    if (kind === 'd') return { num: 1n, den: pow10(n), kind, n };
    throw new Error('Bad place');
  };

  const nextStepRat = (place) => {
    // "—Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑—Ä—è–¥"
    if (place.kind === 'p') {
      if (place.n > 0) return { num: pow10(place.n - 1), den: 1n };
      // units -> look at tenths
      return { num: 1n, den: 10n };
    } else {
      // decimals: d:n -> look at d:(n+1)
      return { num: 1n, den: pow10(place.n + 1) };
    }
  };

  // ---------- random generation ----------
  const rndInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

  const makeRandomValue = (place, kindMode, negMode) => {
    // decide kind
    let kind = kindMode;
    if (kindMode === 'auto') kind = (place.kind === 'd') ? 'dec' : 'int';

    const sign = (negMode === 'sometimes' && Math.random() < 0.25) ? -1n : 1n;

    // magnitude heuristics
    const k = (place.kind === 'p') ? place.n : 0; // for int places
    const intMaxPow = Math.min(9, Math.max(4, k + 3)); // keep it reasonable
    const intMax = 10 ** intMaxPow;

    if (kind === 'int') {
      let x = rndInt(0, intMax - 1);
      if (x === 0) x = rndInt(1, intMax - 1);
      return simplifyPow10(sign * BigInt(x), 1n);
    }

    // decimals
    const targetDec = (place.kind === 'd') ? place.n : 0;
    const genDec = Math.min(6, Math.max(2, targetDec + rndInt(1, 3))); // ensure there is a "next digit"
    const den = pow10(genDec);

    const intPart = rndInt(0, 99999);
    const fracPart = rndInt(0, (10 ** genDec) - 1);
    const numAbs = BigInt(intPart) * den + BigInt(fracPart);
    return simplifyPow10(sign * numAbs, den);
  };

  // ---------- explanation ----------
  const explain = (original, place, rounded) => {
    const abs = { num: original.num < 0n ? -original.num : original.num, den: original.den };
    const step = nextStepRat(place);

    const nextDigit = digitAt(abs, step);
    const rule = (nextDigit >= 5)
      ? `–°–ª–µ–¥—É—é—â–∞—è —Ü–∏—Ñ—Ä–∞ = ${nextDigit} (—ç—Ç–æ 5‚Äì9), –∑–Ω–∞—á–∏—Ç —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —Ä–∞–∑—Ä—è–¥ –Ω–∞ 1.`
      : `–°–ª–µ–¥—É—é—â–∞—è —Ü–∏—Ñ—Ä–∞ = ${nextDigit} (—ç—Ç–æ 0‚Äì4), –∑–Ω–∞—á–∏—Ç –Ω—É–∂–Ω—ã–π —Ä–∞–∑—Ä—è–¥ –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.`;

    const origText = formatRational(original).replace(/\./g, ',');
    const roundText = formatRational(rounded).replace(/\./g, ',');

    const placeText = (place.kind === 'p')
      ? `–¥–æ ${PLACE_ITEMS.find(x => x.id === ('p:'+place.n))?.label || '—Ä–∞–∑—Ä—è–¥–∞'}`
      : `–¥–æ ${PLACE_ITEMS.find(x => x.id === ('d:'+place.n))?.label || '—Ä–∞–∑—Ä—è–¥–∞'}`;

    const noteNeg = (original.num < 0n)
      ? `–ß–∏—Å–ª–æ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ ‚Äî –ø—Ä–∞–≤–∏–ª–æ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–∞–∫ –∂–µ (–ø–æ —Ä–∞–∑—Ä—è–¥–∞–º), —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Å—Ç–∞—ë—Ç—Å—è —Å–æ –∑–Ω–∞–∫–æ–º ¬´‚àí¬ª.`
      : '';

    return `
<b>–†–∞–∑–±–æ—Ä —à–∞–≥–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è</b><br/>
–û–∫—Ä—É–≥–ª—è–µ–º ${origText} ${placeText}.<br/>
–°–º–æ—Ç—Ä–∏–º –Ω–∞ <b>—Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑—Ä—è–¥</b> (—Ü–∏—Ñ—Ä–∞ —Å–ø—Ä–∞–≤–∞ –æ—Ç —Ä–∞–∑—Ä—è–¥–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è).<br/>
${rule}<br/>
–í—Å–µ —Ü–∏—Ñ—Ä—ã –ø—Ä–∞–≤–µ–µ —Ä–∞–∑—Ä—è–¥–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –∑–∞–º–µ–Ω—è–µ–º –Ω—É–ª—è–º–∏ (–∏–ª–∏ –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π).<br/>
${noteNeg ? (noteNeg + '<br/>') : ''}
<b>–û—Ç–≤–µ—Ç:</b> ${roundText}
    `.trim();
  };

  // ---------- state ----------
  const LS_KEY = 'rounding_v2_stats';
  const loadStats = () => {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return { ok:0, all:0, streak:0, best:0, blkDone:0 };
      const s = JSON.parse(raw);
      return { ok:+s.ok||0, all:+s.all||0, streak:+s.streak||0, best:+s.best||0, blkDone:+s.blkDone||0 };
    } catch {
      return { ok:0, all:0, streak:0, best:0, blkDone:0 };
    }
  };
  const saveStats = () => localStorage.setItem(LS_KEY, JSON.stringify(stats));

  let stats = loadStats();
  let current = null; // { valueRat, place, correctRat }

  // ---------- UI ----------
  const elPlace = document.getElementById('place');
  const elKind = document.getElementById('kind');
  const elNeg = document.getElementById('neg');

  const elNum = document.getElementById('num');
  const elPlaceLabel = document.getElementById('placeLabel');
  const elAns = document.getElementById('answer');
  const elFb = document.getElementById('feedback');
  const elSol = document.getElementById('solution');

  const elOk = document.getElementById('stOk');
  const elAll = document.getElementById('stAll');
  const elStreak = document.getElementById('stStreak');
  const elBest = document.getElementById('stBest');
  const elBlkDone = document.getElementById('blkDone');
  const elBar = document.getElementById('bar');

  const renderStats = () => {
    elOk.textContent = stats.ok;
    elAll.textContent = stats.all;
    elStreak.textContent = stats.streak;
    elBest.textContent = stats.best;
    elBlkDone.textContent = stats.blkDone % 10;
    const done = (stats.blkDone % 10);
    elBar.style.width = (done/10*100) + '%';
  };

  const setFeedback = (type, html) => {
    elFb.style.display = 'block';
    elFb.classList.remove('ok', 'bad');
    if (type) elFb.classList.add(type);
    elFb.innerHTML = html;
  };

  const hideFeedback = () => {
    elFb.style.display = 'none';
    elFb.classList.remove('ok', 'bad');
    elFb.textContent = '';
  };

  const hideSolution = () => {
    elSol.style.display = 'none';
    elSol.textContent = '';
  };

  const newTask = () => {
    hideFeedback();
    hideSolution();

    const placeId = elPlace.value;
    const place = placeToRat(placeId);

    const valueRat = makeRandomValue(place, elKind.value, elNeg.value);
    const correct = toPlace(valueRat, place);

    current = { valueRat, place, correct };

    elNum.textContent = formatRational(valueRat).replace(/\./g, ',');
    const item = PLACE_ITEMS.find(x => x.id === placeId);
    elPlaceLabel.textContent = (item ? item.label : '–Ω—É–∂–Ω–æ–≥–æ —Ä–∞–∑—Ä—è–¥–∞');

    elAns.value = '';
    elAns.focus();
  };

  const check = () => {
    if (!current) return;
    hideSolution();

    const user = parseToRational(elAns.value);
    if (!user) {
      setFeedback('bad', '‚ùå –ù–µ –ø–æ–Ω—è–ª –≤–≤–æ–¥. –ü—Ä–∏–º–µ—Ä: <span class="mono">12 345,6</span> –∏–ª–∏ <span class="mono">12345.6</span>.');
      return;
    }

    const u = simplifyPow10(user.num, user.den);
    const c = simplifyPow10(current.correct.num, current.correct.den);

    const ok = (u.num === c.num && u.den === c.den);

    stats.all += 1;
    stats.blkDone += 1;

    if (ok) {
      stats.ok += 1;
      stats.streak += 1;
      stats.best = Math.max(stats.best, stats.streak);
      setFeedback('ok', `‚úÖ –í–µ—Ä–Ω–æ! –û—Ç–≤–µ—Ç: <b>${formatRational(c).replace(/\./g, ',')}</b>`);
    } else {
      stats.streak = 0;
      const exp = explain(current.valueRat, current.place, c);
      setFeedback('bad', `‚ùå –ü–æ–∫–∞ –Ω–µ—Ç. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: <b>${formatRational(c).replace(/\./g, ',')}</b><br/><span class="sub">–ù–∞–∂–º–∏ ¬´–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ¬ª ‚Äî —Ä–∞–∑–±–µ—Ä—ë–º —à–∞–≥.</span>`);
      elSol.innerHTML = exp;
    }

    saveStats();
    renderStats();

    // auto-next after each check (soft)
    // if you prefer manual next ‚Äî comment next line
    setTimeout(() => newTask(), 450);
  };

  const showSolution = () => {
    if (!current) return;
    const exp = explain(current.valueRat, current.place, current.correct);
    elSol.innerHTML = exp;
    elSol.style.display = 'block';
  };

  const resetStats = () => {
    stats = { ok:0, all:0, streak:0, best:0, blkDone:0 };
    saveStats();
    renderStats();
    hideFeedback();
    hideSolution();
    newTask();
  };

  // init place dropdown
  PLACE_ITEMS.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = `${p.label} (${p.pretty})`;
    elPlace.appendChild(opt);
  });
  // default: —Å–æ—Ç—ã—Ö (—á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è), –º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å
  elPlace.value = 'd:2';

  // bindings
  document.getElementById('btnNew').addEventListener('click', newTask);
  document.getElementById('btnCheck').addEventListener('click', check);
  document.getElementById('btnSolution').addEventListener('click', showSolution);
  document.getElementById('btnReset').addEventListener('click', resetStats);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); newTask(); return; }
    if (e.key === 'Enter') { e.preventDefault(); check(); return; }
  });

  renderStats();
  newTask();
})();
</script>
</body>
</html>

