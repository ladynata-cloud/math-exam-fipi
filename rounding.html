<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–¢—Ä–µ–Ω–∞–∂—ë—Ä –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è ‚Äî –û–ì–≠</title>
  <meta name="description" content="–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ —á–∏—Å–µ–ª (—Ü–µ–ª—ã–µ –∏ –¥–µ—Å—è—Ç–∏—á–Ω—ã–µ): –æ—Ç –º–∏–ª–ª–∏–æ–Ω–æ–≤ –¥–æ —Ç—ã—Å—è—á–Ω—ã—Ö –∏ –¥–∞–ª—å—à–µ. –° –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏, —Ä–µ—à–µ–Ω–∏—è–º–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π." />
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --card2:#0f172a;
      --text:#e6eaf2;
      --muted:#a9b3c7;
      --line:rgba(255,255,255,.12);
      --accent:#5aa2ff;
      --good:#2dd4bf;
      --bad:#fb7185;
      --warn:#fbbf24;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 30% -10%, rgba(90,162,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(45,212,191,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.45;
    }
    a{ color: var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 22px 16px 48px;
    }

    header{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-end;
      justify-content:space-between;
      gap: 14px;
      margin-bottom: 14px;
    }
    h1{
      font-size: 26px;
      margin: 0;
      letter-spacing: .2px;
    }
    .subtitle{
      color: var(--muted);
      margin-top: 6px;
      font-size: 14px;
    }
    .toplink{
      font-size:14px;
      opacity:.95;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 12px;
      background: rgba(255,255,255,.03);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 14px;
      margin-top: 14px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      overflow:hidden;
    }

    .card h2{
      margin:0 0 10px;
      font-size: 16px;
      color: var(--text);
      letter-spacing: .2px;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:flex-end;
    }

    label{
      display:flex;
      flex-direction:column;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    select, input[type="text"], input[type="number"]{
      appearance:none;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.12);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      min-width: 220px;
    }
    select:focus, input:focus{
      border-color: rgba(90,162,255,.7);
      box-shadow: 0 0 0 4px rgba(90,162,255,.16);
    }

    .taskBox{
      margin-top: 10px;
      padding: 14px;
      border-radius: 14px;
      background: rgba(0,0,0,.14);
      border: 1px solid rgba(255,255,255,.10);
    }
    .taskLine{
      font-size: 18px;
      margin: 0 0 6px;
      letter-spacing: .2px;
    }
    .taskHint{
      margin: 0;
      color: var(--muted);
      font-size: 13px;
    }

    .answerRow{
      margin-top: 12px;
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
    }

    .btn{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 12px;
      font-size: 15px;
      cursor:pointer;
      transition: transform .03s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.18);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: rgba(90,162,255,.18);
      border-color: rgba(90,162,255,.45);
    }
    .btn.primary:hover{
      background: rgba(90,162,255,.26);
      border-color: rgba(90,162,255,.65);
    }
    .btn.ghost{
      background: transparent;
    }
    .btn.danger{
      background: rgba(251,113,133,.12);
      border-color: rgba(251,113,133,.40);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .feedback{
      margin-top: 10px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      min-height: 46px;
    }
    .feedback.good{ border-color: rgba(45,212,191,.45); }
    .feedback.bad{ border-color: rgba(251,113,133,.45); }
    .feedback.warn{ border-color: rgba(251,191,36,.45); }
    .feedback .small{
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
    }

    .explain{
      margin-top: 12px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }
    .explainTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin: 0 0 8px;
      font-size: 14px;
      color: var(--text);
    }
    .explainText{
      margin:0;
      color: var(--muted);
      font-size: 14px;
      white-space: pre-wrap;
    }

    .statGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .stat{
      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.14);
      border: 1px solid rgba(255,255,255,.10);
    }
    .stat .k{
      font-size: 12px;
      color: var(--muted);
    }
    .stat .v{
      font-size: 20px;
      margin-top: 4px;
      letter-spacing: .2px;
    }

    .progressWrap{
      margin-top: 12px;
      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.14);
      border: 1px solid rgba(255,255,255,.10);
    }
    .progressTop{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:baseline;
      margin-bottom: 8px;
    }
    .progressTop .k{
      color: var(--muted);
      font-size: 12px;
    }
    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(90,162,255,.95), rgba(45,212,191,.85));
      border-radius: 999px;
      transition: width .25s ease;
    }

    details{
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(0,0,0,.14);
      padding: 10px 12px;
    }
    details summary{
      cursor:pointer;
      color: var(--text);
      font-size: 14px;
    }
    details .inside{
      margin-top: 8px;
      color: var(--muted);
      font-size: 14px;
    }
    .kbd{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color: var(--text);
      margin: 0 4px;
    }

    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }
    @media (max-width: 520px){
      select, input[type="text"]{ min-width: 100%; width:100%; }
      .btn{ width: 100%; }
      .answerRow{ align-items:stretch; }
      .toplink{ width: 100%; text-align:center; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>–¢—Ä–µ–Ω–∞–∂—ë—Ä –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è (–û–ì–≠-—Å–∫–æ—Ä–æ–ø–æ–º–æ—â—å)</h1>
        <div class="subtitle">–û–∫—Ä—É–≥–ª—è–µ–º –¥–æ –º–∏–ª–ª–∏–æ–Ω–æ–≤‚Ä¶ –µ–¥–∏–Ω–∏—Ü‚Ä¶ –¥–µ—Å—è—Ç—ã—Ö, —Å–æ—Ç—ã—Ö, —Ç—ã—Å—è—á–Ω—ã—Ö –∏ –¥–∞–ª—å—à–µ.</div>
      </div>
      <a class="toplink" href="index.html">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <section class="card" aria-label="–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞">
        <h2>–ó–∞–¥–∞–Ω–∏–µ</h2>

        <div class="row">
          <label>
            –û–∫—Ä—É–≥–ª—è—Ç—å –¥–æ
            <select id="placeSelect"></select>
          </label>

          <label>
            –ö–∞–∫–∏–µ —á–∏—Å–ª–∞
            <select id="kindSelect">
              <option value="auto">–ê–≤—Ç–æ (–ø–æ–¥ —Ä–∞–∑—Ä—è–¥)</option>
              <option value="int">–¢–æ–ª—å–∫–æ —Ü–µ–ª—ã–µ</option>
              <option value="dec">–¢–æ–ª—å–∫–æ –¥–µ—Å—è—Ç–∏—á–Ω—ã–µ</option>
            </select>
          </label>

          <label>
            –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ
            <select id="negSelect">
              <option value="no">–ù–µ—Ç</option>
              <option value="sometimes">–ò–Ω–æ–≥–¥–∞</option>
              <option value="yes">–î–∞</option>
            </select>
          </label>

          <label>
            –°–µ—Å—Å–∏—è
            <select id="sessionSelect">
              <option value="10">10 –∑–∞–¥–∞–Ω–∏–π</option>
              <option value="15">15 –∑–∞–¥–∞–Ω–∏–π</option>
              <option value="20">20 –∑–∞–¥–∞–Ω–∏–π</option>
            </select>
          </label>
        </div>

        <div class="taskBox" role="group" aria-label="–¢–µ–∫—É—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ">
          <p class="taskLine" id="taskLine">‚Äî</p>
          <p class="taskHint" id="taskHint">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –≤–≤–æ–¥–∏ –∫–∞–∫ —É–¥–æ–±–Ω–æ ‚Äî —Å –ø—Ä–æ–±–µ–ª–∞–º–∏, —Å –∑–∞–ø—è—Ç–æ–π –∏–ª–∏ —Ç–æ—á–∫–æ–π: <b>12 345,6</b> / <b>12345.6</b>.</p>
        </div>

        <div class="answerRow">
          <label style="flex:1; min-width: 260px;">
            –¢–≤–æ–π –æ—Ç–≤–µ—Ç
            <input
              id="answerInput"
              type="text"
              inputmode="decimal"
              autocomplete="off"
              placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 12 300"
              aria-label="–ü–æ–ª–µ –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞"
            />
          </label>

          <button class="btn primary" id="checkBtn" type="button">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å <span class="small">(Enter)</span></button>
          <button class="btn" id="newBtn" type="button">–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä <span class="small">(Ctrl+Enter)</span></button>
          <button class="btn ghost" id="solveBtn" type="button">–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ</button>
          <button class="btn danger" id="resetBtn" type="button">–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        </div>

        <div id="feedback" class="feedback" aria-live="polite"></div>

        <div class="explain" aria-label="–†–∞–∑–±–æ—Ä">
          <div class="explainTitle">
            <b>–†–∞–∑–±–æ—Ä —à–∞–≥–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è</b>
            <span style="color:var(--muted); font-size:12px;" id="attemptsInfo">–ü–æ–ø—ã—Ç–æ–∫: 0</span>
          </div>
          <p class="explainText" id="explainText">‚Äî</p>
        </div>

        <details>
          <summary>–ü—Ä–∞–≤–∏–ª–æ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è (–Ω–∞–ø–æ–º–Ω–∏—Ç—å)</summary>
          <div class="inside">
            <ol style="margin:8px 0 0 18px;">
              <li>–û–ø—Ä–µ–¥–µ–ª–∏ —Ä–∞–∑—Ä—è–¥, <b>–¥–æ –∫–æ—Ç–æ—Ä–æ–≥–æ</b> –æ–∫—Ä—É–≥–ª—è–µ—à—å (–¥–µ—Å—è—Ç–∫–∏, —Å–æ—Ç–Ω–∏, —Ç—ã—Å—è—á–Ω—ã–µ‚Ä¶).</li>
              <li>–ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —Ü–∏—Ñ—Ä—É <b>—Å–ø—Ä–∞–≤–∞</b> –æ—Ç –Ω—É–∂–Ω–æ–≥–æ —Ä–∞–∑—Ä—è–¥–∞:
                <ul style="margin:6px 0 0 18px;">
                  <li>–µ—Å–ª–∏ <b>0‚Äì4</b> ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Ä–∞–∑—Ä—è–¥ –∫–∞–∫ –µ—Å—Ç—å;</li>
                  <li>–µ—Å–ª–∏ <b>5‚Äì9</b> ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —Ä–∞–∑—Ä—è–¥ –Ω–∞ 1.</li>
                </ul>
              </li>
              <li>–í—Å–µ —Ü–∏—Ñ—Ä—ã –ø—Ä–∞–≤–µ–µ –∑–∞–º–µ–Ω—è–µ–º –Ω—É–ª—è–º–∏ (–∏–ª–∏ –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–∏—à–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π).</li>
            </ol>
            <div style="margin-top:10px; color:var(--muted);">
              –ë—ã—Å—Ç—Ä—ã–π —Å–º—ã—Å–ª: <b>—Å–º–æ—Ç—Ä–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑—Ä—è–¥</b>.
            </div>
          </div>
        </details>

        <details>
          <summary>–ö–∞–∫ —ç—Ç–æ –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –≤ –û–ì–≠ (–æ—Ü–µ–Ω–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞)</summary>
          <div class="inside">
            –ü—Ä–∏ –¥–µ–ª–µ–Ω–∏–∏ –∏ –ø—Ä–∏–∫–∏–¥–∫–µ —É–¥–æ–±–Ω–æ –æ–∫—Ä—É–≥–ª—è—Ç—å:
            <br><br>
            –ü—Ä–∏–º–µ—Ä: <b>473 : 8</b>. –û–∫—Ä—É–≥–ª–∏–º 473 –¥–æ <b>480</b> ‚Üí <b>480 : 8 = 60</b>.  
            –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –±—ã—Å—Ç—Ä–æ –ø–æ–¥–æ–±—Ä–∞—Ç—å –ø–µ—Ä–≤—É—é —Ü–∏—Ñ—Ä—É —á–∞—Å—Ç–Ω–æ–≥–æ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å ‚Äú–ø–æ—Ö–æ–∂–µ—Å—Ç—å‚Äù –æ—Ç–≤–µ—Ç–∞.
          </div>
        </details>
      </section>

      <!-- RIGHT -->
      <aside class="card" aria-label="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞">
        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>

        <div class="statGrid">
          <div class="stat">
            <div class="k">–ü—Ä–∞–≤–∏–ª—å–Ω–æ</div>
            <div class="v" id="statCorrect">0</div>
          </div>
          <div class="stat">
            <div class="k">–í—Å–µ–≥–æ</div>
            <div class="v" id="statTotal">0</div>
          </div>
          <div class="stat">
            <div class="k">–°–µ—Ä–∏—è</div>
            <div class="v" id="statStreak">0</div>
          </div>
          <div class="stat">
            <div class="k">–õ—É—á—à–∞—è —Å–µ—Ä–∏—è</div>
            <div class="v" id="statBest">0</div>
          </div>
        </div>

        <div class="progressWrap">
          <div class="progressTop">
            <div>
              <div class="k">–°–µ—Å—Å–∏—è</div>
              <div style="font-size:16px; margin-top:3px;" id="sessionLabel">–ó–∞–¥–∞–Ω–∏–µ 1 –∏–∑ 10</div>
            </div>
            <div style="text-align:right;">
              <div class="k">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
              <div style="font-size:16px; margin-top:3px;" id="sessionDoneLabel">0</div>
            </div>
          </div>
          <div class="bar" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–µ—Å—Å–∏–∏">
            <div id="sessionBar"></div>
          </div>

          <div style="margin-top:12px; color:var(--muted); font-size:13px;">
            –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:
            <span class="kbd">Enter</span> ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
            <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span> ‚Äî –Ω–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä
          </div>
        </div>

        <div style="margin-top:12px; color:var(--muted); font-size:13px;">
          –°–æ–≤–µ—Ç: –µ—Å–ª–∏ —É—á–µ–Ω–∏–∫ ‚Äú–ø–ª—ã–≤—ë—Ç‚Äù, –≤–∫–ª—é—á–∞–π—Ç–µ <b>–∞–≤—Ç–æ-–ø–æ–¥—Å–∫–∞–∑–∫—É</b>: –¥–≤–∞ –ø—Ä–æ–º–∞—Ö–∞ –ø–æ–¥—Ä—è–¥ ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–±–æ—Ä.
        </div>
      </aside>
    </div>
  </div>

  <script>
    // =========================
    //  –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    // =========================
    const LS_STATS_KEY = "rounding_stats_v2";
    const LS_SETTINGS_KEY = "rounding_settings_v2";

    const places = [
      { exp: 6,  label: "–º–∏–ª–ª–∏–æ–Ω–æ–≤ (1 000 000)" },
      { exp: 5,  label: "—Å–æ—Ç–µ–Ω —Ç—ã—Å—è—á (100 000)" },
      { exp: 4,  label: "–¥–µ—Å—è—Ç–∫–æ–≤ —Ç—ã—Å—è—á (10 000)" },
      { exp: 3,  label: "—Ç—ã—Å—è—á (1 000)" },
      { exp: 2,  label: "—Å–æ—Ç–µ–Ω (100)" },
      { exp: 1,  label: "–¥–µ—Å—è—Ç–∫–æ–≤ (10)" },
      { exp: 0,  label: "–µ–¥–∏–Ω–∏—Ü (1)" },
      { exp: -1, label: "–¥–µ—Å—è—Ç—ã—Ö (0,1)" },
      { exp: -2, label: "—Å–æ—Ç—ã—Ö (0,01)" },
      { exp: -3, label: "—Ç—ã—Å—è—á–Ω—ã—Ö (0,001)" },
      { exp: -4, label: "–¥–µ—Å—è—Ç–∏—Ç—ã—Å—è—á–Ω—ã—Ö (0,0001)" },
      { exp: -5, label: "—Å—Ç–æ—Ç—ã—Å—è—á–Ω—ã—Ö (0,00001)" },
      { exp: -6, label: "–º–∏–ª–ª–∏–æ–Ω–Ω—ã—Ö (0,000001)" }
    ];

    const el = (id) => document.getElementById(id);

    const placeSelect = el("placeSelect");
    const kindSelect = el("kindSelect");
    const negSelect = el("negSelect");
    const sessionSelect = el("sessionSelect");

    const taskLine = el("taskLine");
    const answerInput = el("answerInput");

    const checkBtn = el("checkBtn");
    const newBtn = el("newBtn");
    const solveBtn = el("solveBtn");
    const resetBtn = el("resetBtn");

    const feedback = el("feedback");
    const explainText = el("explainText");
    const attemptsInfo = el("attemptsInfo");

    const statCorrect = el("statCorrect");
    const statTotal = el("statTotal");
    const statStreak = el("statStreak");
    const statBest = el("statBest");

    const sessionLabel = el("sessionLabel");
    const sessionDoneLabel = el("sessionDoneLabel");
    const sessionBar = el("sessionBar");

    let stats = {
      correct: 0,
      total: 0,
      streak: 0,
      bestStreak: 0
    };

    let settings = {
      exp: 0,
      kind: "auto",
      neg: "no",
      sessionLen: 10
    };

    let current = null; // { displayNumber, normalized, exp, correctDisplay, explanation, nextDigit, targetLabel }
    let attempts = 0;
    let solvedThisTask = false;

    // –°–µ—Å—Å–∏—è: —Å—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –Ω–∞–∂–∞–ª–∏ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å" (–≤–∞–ª–∏–¥–Ω—ã—Ö) –∏ –∑–∞–∫—Ä—ã–ª–∏ –ø—Ä–∏–º–µ—Ä
    let sessionDone = 0;
    let sessionIndex = 1;

    // =========================
    //  BigInt-–æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –±–µ–∑ float
    // =========================
    function absBigInt(x){ return x < 0n ? -x : x; }

    function pow10BigInt(k){
      if (k <= 0) return 1n;
      return BigInt("1" + "0".repeat(k));
    }

    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤–≤–æ–¥: –ø—Ä–æ–±–µ–ª—ã —É–±–∏—Ä–∞–µ–º, –∑–∞–ø—è—Ç—É—é -> —Ç–æ—á–∫–∞
    // –†–∞–∑—Ä–µ—à–∞–µ–º: -123, 123, 123.45, -0.001, 12 345,6
    function normalizeNumberString(raw){
      const s = (raw ?? "").trim().replace(/\s+/g, "").replace(",", ".");
      return s;
    }

    function isValidNumberString(s){
      // —Ü–µ–ª–æ–µ –∏–ª–∏ –¥–µ—Å—è—Ç–∏—á–Ω–æ–µ, –º–∏–Ω—É—Å –¥–æ–ø—É—Å—Ç–∏–º
      return /^-?\d+(\.\d+)?$/.test(s);
    }

    function parseToBigIntAndScale(norm){
      // norm –≤–∏–¥–∞ -?\d+(\.\d+)?
      const neg = norm.startsWith("-");
      const t = neg ? norm.slice(1) : norm;

      const [ip, fp = ""] = t.split(".");
      const scale = fp.length;

      const digits = (ip === "" ? "0" : ip) + fp;
      // —É–±–∏—Ä–∞–µ–º –≤–µ–¥—É—â–∏–µ –Ω—É–ª–∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ (–Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω)
      const safeDigits = digits.replace(/^0+(?=\d)/, "");

      let n = BigInt(safeDigits === "" ? "0" : safeDigits);
      if (neg) n = -n;

      return { n, scale };
    }

    // –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ "–ø–æ–ª–æ–≤–∏–Ω–∞ –≤–≤–µ—Ä—Ö" –æ—Ç –Ω—É–ª—è (school-friendly)
    // exp >= 0: –¥–æ –¥–µ—Å—è—Ç–∫–æ–≤/—Å–æ—Ç–µ–Ω/...
    // exp < 0: –¥–æ –¥–µ—Å—è—Ç—ã—Ö/—Å–æ—Ç—ã—Ö/...
    function roundScaled(value, exp){
      const { n, scale } = value;

      if (exp >= 0){
        // –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 10^exp
        const unitScaled = pow10BigInt(exp + scale); // 10^(exp+scale) –≤ "—Ü–µ–ª—ã—Ö" –µ–¥–∏–Ω–∏—Ü–∞—Ö n
        if (unitScaled === 0n) return { n: n, scale: 0 };

        let q = n / unitScaled;
        let r = n % unitScaled;

        if (absBigInt(r) * 2n >= unitScaled){
          q += (n >= 0n ? 1n : -1n);
        }
        const roundedN = q * unitScaled;
        // —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–µ–∑ –¥–µ—Å—è—Ç–∏—á–Ω–æ–π —á–∞—Å—Ç–∏ (scaleOut = 0)
        const scaleFactor = pow10BigInt(scale);
        const outInt = roundedN / scaleFactor;
        return { n: outInt, scale: 0 };
      } else {
        const d = -exp; // —Å–∫–æ–ª—å–∫–æ –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π —Ö–æ—Ç–∏–º –æ—Å—Ç–∞–≤–∏—Ç—å
        if (scale <= d){
          // —É–∂–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ "–≥—Ä—É–±–æ": –ø—Ä–æ—Å—Ç–æ –¥–æ–ø–æ–ª–Ω–∏–º –Ω—É–ª—è–º–∏ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏
          return { n, scale };
        }
        const k = scale - d; // —Å–∫–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä "—Å—Ä–µ–∑–∞–µ–º"
        const factor = pow10BigInt(k);

        let q = n / factor;
        let r = n % factor;

        if (absBigInt(r) * 2n >= factor){
          q += (n >= 0n ? 1n : -1n);
        }
        // —Ç–µ–ø–µ—Ä—å q —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —á–∏—Å–ª—É, —É–º–Ω–æ–∂–µ–Ω–Ω–æ–º—É –Ω–∞ 10^d
        return { n: q, scale: d };
      }
    }

    function formatWithSpaces(intStr){
      // –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ 12 345 678
      return intStr.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }

    function toDisplayString(value, forceScale = null){
      // value: { n: BigInt, scale: int }
      // forceScale: –µ—Å–ª–∏ –Ω–µ null, —Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–æ–≤–Ω–æ —Å—Ç–æ–ª—å–∫–æ –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
      let n = value.n;
      const neg = n < 0n;
      if (neg) n = -n;

      const s = n.toString();
      const scale = (forceScale !== null) ? forceScale : value.scale;

      if (scale === 0){
        const i = formatWithSpaces(s);
        return (neg ? "-" : "") + i;
      }

      // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –¥–ª–∏–Ω—É
      const pad = Math.max(0, scale - s.length + 1);
      const full = "0".repeat(pad) + s;

      const cut = full.length - scale;
      const intPart = full.slice(0, cut);
      const fracPart = full.slice(cut);

      const intNice = formatWithSpaces(intPart === "" ? "0" : intPart);
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–ø—è—Ç—É—é –∫–∞–∫ –≤ –†–§
      return (neg ? "-" : "") + intNice + "," + fracPart;
    }

    // –î–ª—è –ø–æ—è—Å–Ω–µ–Ω–∏—è –Ω–∞–π–¥—ë–º "—Å–ª–µ–¥—É—é—â—É—é —Ü–∏—Ñ—Ä—É" (–Ω–∞ –∫–æ—Ç–æ—Ä—É—é —Å–º–æ—Ç—Ä–∏–º)
    function getNextDigitInfo(value, exp){
      // value: {n, scale} –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∞ (–¥–æ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è)
      // –í–æ–∑—å–º—ë–º –∞–±—Å–æ–ª—é—Ç, —Ä–∞–±–æ—Ç–∞–µ–º —Å–æ —Å—Ç—Ä–æ–∫–æ–π —Ü–∏—Ñ—Ä.
      let n = value.n;
      const neg = n < 0n;
      if (neg) n = -n;

      const digits = n.toString();
      const scale = value.scale;

      // –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ: digits ‚Äî —ç—Ç–æ —á–∏—Å–ª–æ –±–µ–∑ —Ç–æ—á–∫–∏, scale ‚Äî —Å–∫–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏
      // –ü–æ–∑–∏—Ü–∏—è "–Ω—É–∂–Ω–æ–≥–æ —Ä–∞–∑—Ä—è–¥–∞" –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ü–∞ —Å—Ç—Ä–æ–∫–∏:
      // exp>=0: –æ–∫—Ä—É–≥–ª—è–µ–º –ø–æ —Ü–µ–ª—ã–º, —Å–º–æ—Ç—Ä–∏–º –Ω–∞ —Ä–∞–∑—Ä—è–¥ 10^(exp-1) ? –ø—Ä–æ—â–µ –≤—ã—á–∏—Å–ª–∏—Ç—å –∏–Ω–¥–µ–∫—Å "—Å–ª–µ–¥—É—é—â–µ–π —Ü–∏—Ñ—Ä—ã"
      //
      // –î–µ–ª–∞—Ç—å –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Ç–∞–∫:
      // –°–æ–∑–¥–∞–¥–∏–º "–ø–æ–ª–Ω—É—é" —Å—Ç—Ä–æ–∫—É —Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π –¥–ª–∏–Ω–æ–π, –≥–¥–µ –¥–µ—Å—è—Ç–∏—á–Ω–∞—è —Ç–æ—á–∫–∞ —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ–¥ –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ scale —Ü–∏—Ñ—Ä–∞–º–∏.
      // –ù—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å: –∫–∞–∫—É—é —Ü–∏—Ñ—Ä—É —Å–º–æ—Ç—Ä–∏–º (—Å–ø—Ä–∞–≤–∞ –æ—Ç –æ–∫—Ä—É–≥–ª—è–µ–º–æ–≥–æ —Ä–∞–∑—Ä—è–¥–∞).
      //
      // exp = 0 (–µ–¥–∏–Ω–∏—Ü—ã) -> —Å–º–æ—Ç—Ä–∏–º –Ω–∞ –¥–µ—Å—è—Ç—ã–µ => —ç—Ç–æ –ø–µ—Ä–≤–∞—è —Ü–∏—Ñ—Ä–∞ –¥—Ä–æ–±–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å), –∏–Ω–∞—á–µ 0
      // exp = 1 (–¥–µ—Å—è—Ç–∫–∏) -> —Å–º–æ—Ç—Ä–∏–º –Ω–∞ –µ–¥–∏–Ω–∏—Ü—ã
      // exp = -2 (—Å–æ—Ç—ã–µ) -> —Å–º–æ—Ç—Ä–∏–º –Ω–∞ —Ç—ã—Å—è—á–Ω—ã–µ
      //
      // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ: "—Å–º–æ—Ç—Ä–∏–º –Ω–∞ —Ä–∞–∑—Ä—è–¥ 10^(exp-1)"? –Ω–µ—Ç, –ø—É—Ç–∞–µ—Ç —Å –¥–µ—Å—è—Ç–∏—á–Ω—ã–º–∏.
      // –ü—Ä–æ—â–µ: –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 10^exp => —Å–º–æ—Ç—Ä–∏–º –Ω–∞ 10^(exp-1) –µ—Å–ª–∏ exp>0,
      // –∞ –µ—Å–ª–∏ exp<=0, —Å–º–æ—Ç—Ä–∏–º –Ω–∞ 10^(exp-1) –≤ –¥—Ä–æ–±–Ω–æ–π —á–∞—Å—Ç–∏.
      //
      // –°–≤–µ–¥—ë–º –∫ "–ø–æ–∑–∏—Ü–∏–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–µ—Å—è—Ç–∏—á–Ω–æ–π —Ç–æ—á–∫–∏":
      // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ exp => —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Ä–∞–∑—Ä—è–¥—ã >= exp, –∞ "—Å–ª–µ–¥—É—é—â–∏–π" ‚Äî exp-1.
      // –ó–Ω–∞—á–∏—Ç, –∏—â–µ–º —Ü–∏—Ñ—Ä—É —Ä–∞–∑—Ä—è–¥–∞ (exp-1).
      //
      // –ü–æ—Å—Ç—Ä–æ–∏–º –∏–Ω–¥–µ–∫—Å –≤ —Å—Ç—Ä–æ–∫–µ digitsWithPoint.
      // –ü—É—Å—Ç—å decimalIndex ‚Äî –∏–Ω–¥–µ–∫—Å —Ç–æ—á–∫–∏ (–º–µ–∂–¥—É int –∏ frac) –≤ —Ç–µ—Ä–º–∏–Ω–∞—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ü–∏—Ñ—Ä —Å–ª–µ–≤–∞.
      const decimalDigitsLeft = digits.length - scale; // –º–æ–∂–µ—Ç –±—ã—Ç—å <=0

      // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º —Å—Ç—Ä–æ–∫—É —Ç–∞–∫, —á—Ç–æ–±—ã —Å–ª–µ–≤–∞ –±—ã–ª–æ —Ö–æ—Ç—è –±—ã 1 —Ü–∏—Ñ—Ä–∞
      let left = decimalDigitsLeft;
      let work = digits;
      if (left <= 0){
        // —á–∏—Å–ª–æ –º–µ–Ω—å—à–µ 1: –¥–æ–±–∞–≤–∏–º –≤–µ–¥—É—â–∏–µ –Ω—É–ª–∏
        const need = 1 - left;
        work = "0".repeat(need) + work;
        left = 1;
      }

      // –¢–µ–ø–µ—Ä—å —Ç–æ—á–∫–∞ –ø–æ—Å–ª–µ left —Ü–∏—Ñ—Ä (work[0..left-1] —Ü–µ–ª–∞—è —á–∞—Å—Ç—å)
      // –†–∞–∑—Ä—è–¥ 10^k –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏: –µ—Å–ª–∏ k>=0 ‚Äî —ç—Ç–æ k-–π —Å–ø—Ä–∞–≤–∞ –æ—Ç —Ç–æ—á–∫–∏ –≤ —Ü–µ–ª–æ–π —á–∞—Å—Ç–∏.
      // –ê —Ä–∞–∑—Ä—è–¥ 10^(-m) ‚Äî —ç—Ç–æ m-–π —Å–ø—Ä–∞–≤–∞ –æ—Ç —Ç–æ—á–∫–∏ –≤ –¥—Ä–æ–±–Ω–æ–π —á–∞—Å—Ç–∏.
      //
      // –ù–∞–º –Ω—É–∂–µ–Ω —Ä–∞–∑—Ä—è–¥ (exp-1).
      const lookExp = exp - 1;

      let digit = "0";
      if (lookExp >= 0){
        // —Ü–µ–ª–∞—è —á–∞—Å—Ç—å: –ø–æ–∑–∏—Ü–∏—è —Å–ø—Ä–∞–≤–∞: –µ–¥–∏–Ω–∏—Ü—ã k=0, –¥–µ—Å—è—Ç–∫–∏ k=1...
        // –∏–Ω–¥–µ–∫—Å –≤ work —Ü–µ–ª–æ–π —á–∞—Å—Ç–∏: left-1-k
        const idx = left - 1 - lookExp;
        digit = (idx >= 0 && idx < work.length) ? work[idx] : "0";
      } else {
        // –¥—Ä–æ–±–Ω–∞—è —á–∞—Å—Ç—å: lookExp = -m, m>=1 => m-—è —Ü–∏—Ñ—Ä–∞ –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏
        const m = -lookExp;
        const idx = left + (m - 1);
        digit = (idx >= 0 && idx < work.length) ? work[idx] : "0";
      }

      return { digit };
    }

    function placeLabel(exp){
      const p = places.find(x => x.exp === exp);
      return p ? p.label : ("10^" + exp);
    }

    // =========================
    //  –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–¥–∞–Ω–∏–π
    // =========================
    function randInt(min, max){
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function shouldBeNegative(mode){
      if (mode === "no") return false;
      if (mode === "yes") return true;
      // sometimes
      return Math.random() < 0.35;
    }

    function buildRandomNumber(exp, kind, negMode){
      // kind: auto/int/dec
      // exp: —Ü–µ–ª–µ–≤–æ–π —Ä–∞–∑—Ä—è–¥ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –±—ã–ª–æ "–Ω–µ —Ç—Ä–∏–≤–∏–∞–ª—å–Ω—ã–º" (–Ω–µ –≤—Å–µ–≥–¥–∞ —É–∂–µ –∫—Ä—É–≥–ª–æ–µ)
      let wantDec;
      if (kind === "auto") wantDec = (exp < 0);
      else if (kind === "int") wantDec = false;
      else wantDec = true;

      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª "—Ç–æ–ª—å–∫–æ —Ü–µ–ª—ã–µ", –Ω–æ –æ–∫—Ä—É–≥–ª—è–µ—Ç –¥–æ –¥–µ—Å—è—Ç—ã—Ö/—Å–æ—Ç—ã—Ö ‚Äî —ç—Ç–æ —Å—Ç—Ä–∞–Ω–Ω–æ.
      // –°–¥–µ–ª–∞–µ–º –º—è–≥–∫–æ: –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–∞–¥–∏–º –¥–µ—Å—è—Ç–∏—á–Ω–æ–µ, –∏–Ω–∞—á–µ —Ç—Ä–µ–Ω–∞–∂—ë—Ä —Ç–µ—Ä—è–µ—Ç —Å–º—ã—Å–ª.
      if (kind === "int" && exp < 0) wantDec = true;

      const neg = shouldBeNegative(negMode);

      // –ü–æ–¥–±–µ—Ä—ë–º –º–∞—Å—à—Ç–∞–±
      // –¶–µ–ª—ã–µ: –æ—Ç 2‚Äì7 –∑–Ω–∞–∫–æ–≤, –ø–æ–¥ —Ä–∞–∑—Ä—è–¥
      // –î–µ—Å—è—Ç–∏—á–Ω—ã–µ: —Ü–µ–ª–∞—è —á–∞—Å—Ç—å 1‚Äì5 –∑–Ω–∞–∫–æ–≤ + –¥—Ä–æ–±—å
      let intDigits;
      if (exp >= 0){
        // –µ—Å–ª–∏ –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ —Ç—ã—Å—è—á/–º–∏–ª–ª–∏–æ–Ω–æ–≤, —á–∏—Å–ª–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–ª—å—à–∏–º
        intDigits = Math.max(exp + 1, randInt(exp + 1, Math.min(exp + 4, 8)));
      } else {
        intDigits = randInt(1, 5);
      }

      // –¥—Ä–æ–±–Ω—ã–µ –∑–Ω–∞–∫–∏
      let fracDigits = 0;
      if (wantDec){
        const need = Math.max(1, Math.max(0, -exp) + 1); // —á—Ç–æ–±—ã –±—ã–ª "—Å–ª–µ–¥—É—é—â–∏–π" –∑–Ω–∞–∫ –¥–ª—è –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è
        fracDigits = randInt(need, Math.min(need + 3, 10));
      }

      // –≥–µ–Ω–µ—Ä–∏–º —Ü–∏—Ñ—Ä—ã
      let intPart = "";
      for (let i = 0; i < intDigits; i++){
        const d = (i === 0) ? randInt(1, 9) : randInt(0, 9);
        intPart += String(d);
      }

      let fracPart = "";
      for (let i = 0; i < fracDigits; i++){
        fracPart += String(randInt(0, 9));
      }

      // —Å–¥–µ–ª–∞–µ–º —á–∏—Å–ª–æ "–Ω–µ –∫—Ä—É–≥–ª—è–∫–æ–º": —á—Ç–æ–±—ã —Å–ø—Ä–∞–≤–∞ –æ—Ç –Ω—É–∂–Ω–æ–≥–æ —Ä–∞–∑—Ä—è–¥–∞ –±—ã–ª–∞ –Ω–µ —Ç–æ–ª—å–∫–æ 0
      // –î–ª—è exp>=0: —Å–ø—Ä–∞–≤–∞ –æ—Ç 10^exp –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ö–æ—Ç—å –æ–¥–∏–Ω –Ω–µ-–Ω–æ–ª—å –≤ –º–ª–∞–¥—à–∏—Ö —Ä–∞–∑—Ä—è–¥–∞—Ö
      if (exp >= 0){
        const tailLen = exp; // —Å–∫–æ–ª—å–∫–æ –º–ª–∞–¥—à–∏—Ö —Ä–∞–∑—Ä—è–¥–æ–≤ "–∑–∞–Ω—É–ª–∏–º" –ø—Ä–∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–∏
        if (tailLen > 0){
          const tail = intPart.slice(-tailLen);
          if (/^0+$/.test(tail)){
            // –∑–∞–º–µ–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ü–∏—Ñ—Ä—É —Ö–≤–æ—Å—Ç–∞ –Ω–∞ –Ω–µ-–Ω–æ–ª—å
            const pos = intPart.length - 1;
            const newDigit = randInt(1, 9);
            intPart = intPart.slice(0, pos) + String(newDigit);
          }
        }
      } else {
        // exp<0: –Ω–∞–¥–æ, —á—Ç–æ–±—ã –∑–∞ –Ω—É–∂–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥—Ä–æ–±–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ –±—ã–ª "—Å–º–æ—Ç—Ä—è—â–∏–π" –∑–Ω–∞–∫
        // –º—ã —É–∂–µ –¥–µ–ª–∞–ª–∏ fracDigits >= (-exp)+1, –Ω–æ –ø—É—Å—Ç—å —Ö–æ—Ç—è –±—ã –∏–Ω–æ–≥–¥–∞ digit >=5
        // –±–µ–∑ –Ω–∞–≤—è–∑—á–∏–≤–æ—Å—Ç–∏.
      }

      const num = (neg ? "-" : "") + intPart + (fracDigits ? "." + fracPart : "");
      return num;
    }

    function buildTask(){
      const exp = settings.exp;
      const kind = settings.kind;
      const negMode = settings.neg;

      const raw = buildRandomNumber(exp, kind, negMode);
      const norm = normalizeNumberString(raw);
      const parsed = parseToBigIntAndScale(norm);

      const rounded = roundScaled(parsed, exp);
      const outScale = (exp < 0) ? (-exp) : 0;
      const correct = toDisplayString(rounded, outScale);

      const nextDigit = getNextDigitInfo(parsed, exp).digit;
      const target = placeLabel(exp);

      // —á–∏—Å–ª–æ –¥–ª—è –ø–æ–∫–∞–∑–∞: —Ö–æ—Ç–∏–º –ø—Ä–æ–±–µ–ª—ã –∏ –∑–∞–ø—è—Ç—É—é
      const displayNumber = toDisplayString(parsed, parsed.scale);

      const explanation = makeExplanation({
        displayNumber,
        exp,
        targetLabel: target,
        nextDigit
      }, correct);

      return {
        exp,
        targetLabel: target,
        displayNumber,
        normalized: norm,
        parsed,
        correctDisplay: correct,
        nextDigit,
        explanation
      };
    }

    function makeExplanation(info, correct){
      const { displayNumber, exp, targetLabel, nextDigit } = info;
      const look = Number(nextDigit);

      const line1 = `–ß–∏—Å–ª–æ: ${displayNumber}`;
      const line2 = `–û–∫—Ä—É–≥–ª—è–µ–º –¥–æ: ${targetLabel}.`;
      const line3 = `–°–º–æ—Ç—Ä–∏–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑—Ä—è–¥: ${nextDigit}.`;
      const line4 = (look >= 5)
        ? `–¢–∞–∫ –∫–∞–∫ ${nextDigit} ‚â• 5 ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —Ä–∞–∑—Ä—è–¥ –Ω–∞ 1.`
        : `–¢–∞–∫ –∫–∞–∫ ${nextDigit} < 5 ‚Äî –Ω—É–∂–Ω—ã–π —Ä–∞–∑—Ä—è–¥ –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.`;
      const line5 = (exp >= 0)
        ? `–í—Å–µ –º–ª–∞–¥—à–∏–µ —Ä–∞–∑—Ä—è–¥—ã –∑–∞–º–µ–Ω—è–µ–º –Ω—É–ª—è–º–∏.`
        : `–õ–∏—à–Ω–∏–µ –∑–Ω–∞–∫–∏ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º (–∏–ª–∏ –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ –Ω—É–ª–∏ –¥–æ –Ω—É–∂–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏).`;
      const line6 = `–û—Ç–≤–µ—Ç: ${correct}`;

      return [line1, line2, line3, line4, line5, line6].join("\n");
    }

    // =========================
    //  UI / –õ–æ–≥–∏–∫–∞ —Ç—Ä–µ–Ω–∞–∂—ë—Ä–∞
    // =========================
    function setFeedback(type, mainText, smallText = ""){
      feedback.className = "feedback" + (type ? (" " + type) : "");
      feedback.innerHTML = "";
      const main = document.createElement("div");
      main.textContent = mainText;
      feedback.appendChild(main);

      if (smallText){
        const small = document.createElement("div");
        small.className = "small";
        small.textContent = smallText;
        feedback.appendChild(small);
      }
    }

    function renderStats(){
      statCorrect.textContent = stats.correct;
      statTotal.textContent = stats.total;
      statStreak.textContent = stats.streak;
      statBest.textContent = stats.bestStreak;
    }

    function renderSession(){
      const len = settings.sessionLen;
      sessionLabel.textContent = `–ó–∞–¥–∞–Ω–∏–µ ${sessionIndex} –∏–∑ ${len}`;
      sessionDoneLabel.textContent = `${sessionDone}/${len}`;

      const pct = len > 0 ? Math.min(100, Math.round((sessionDone / len) * 100)) : 0;
      sessionBar.style.width = pct + "%";
    }

    function saveStats(){
      localStorage.setItem(LS_STATS_KEY, JSON.stringify(stats));
    }

    function loadStats(){
      try{
        const raw = localStorage.getItem(LS_STATS_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (typeof data?.correct === "number") stats = data;
      } catch(_){}
    }

    function saveSettings(){
      localStorage.setItem(LS_SETTINGS_KEY, JSON.stringify(settings));
    }

    function loadSettings(){
      try{
        const raw = localStorage.getItem(LS_SETTINGS_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);

        if (typeof data?.exp === "number") settings.exp = data.exp;
        if (typeof data?.kind === "string") settings.kind = data.kind;
        if (typeof data?.neg === "string") settings.neg = data.neg;
        if (typeof data?.sessionLen === "number") settings.sessionLen = data.sessionLen;
      } catch(_){}
    }

    function resetTaskState(){
      attempts = 0;
      solvedThisTask = false;
      attemptsInfo.textContent = "–ü–æ–ø—ã—Ç–æ–∫: 0";
      answerInput.value = "";
      setFeedback("", "", "");
      solveBtn.disabled = false;
      checkBtn.disabled = false;
      answerInput.focus();
    }

    function loadNewTask(isNewSessionStep = false){
      current = buildTask();
      taskLine.textContent = `–û–∫—Ä—É–≥–ª–∏ —á–∏—Å–ª–æ ${current.displayNumber} –¥–æ ${current.targetLabel}.`;
      explainText.textContent = "‚Äî";
      resetTaskState();

      if (isNewSessionStep){
        sessionIndex = Math.min(settings.sessionLen, sessionIndex + 1);
      }
      renderSession();
    }

    function normalizeAnswerInputForCompare(raw){
      const norm = normalizeNumberString(raw);
      if (!isValidNumberString(norm)) return null;
      // –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∞—à–µ–º—É "—á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–º—É" —Ñ–æ—Ä–º–∞—Ç—É –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:
      // —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —á–∏—Å–ª–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ BigInt/scale, —á—Ç–æ–±—ã "12 300" –∏ "12300" –±—ã–ª–∏ —Ä–∞–≤–Ω—ã.
      // –î–ª—è —ç—Ç–æ–≥–æ –ø–∞—Ä—Å–∏–º –∏ –ø–æ—Ç–æ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ –Ω—É–∂–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ (exp<0 => —Ñ–∏–∫—Å–∏—Ä—É–µ–º scale).
      const parsed = parseToBigIntAndScale(norm);
      const outScale = (current.exp < 0) ? (-current.exp) : 0;
      const rounded = roundScaled(parsed, current.exp); // –µ—Å–ª–∏ —É—á–µ–Ω–∏–∫ –≤–≤—ë–ª "—É–∂–µ –æ–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–π" ‚Äî –ª–∏—à–Ω—è—è —Ç–æ—á–Ω–æ—Å—Ç—å –Ω–µ –º–µ—à–∞–µ—Ç
      // –ù–æ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –Ω–∞–¥–æ "–∫–∞–∫ —á–∏—Å–ª–æ", –∞ –Ω–µ "–∫–∞–∫ —Å—Ç—Ä–æ–∫—É"
      // -> –ø—Ä–∏–≤–µ–¥—ë–º –∫ —Å—Ç—Ä–æ–∫–µ —Å –Ω—É–∂–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é:
      return toDisplayString(rounded, outScale);
    }

    function check(){
      if (!current) return;

      const raw = answerInput.value;
      const norm = normalizeNumberString(raw);

      if (!norm){
        setFeedback("warn", "–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ.", "–ù–∞–ø—Ä–∏–º–µ—Ä: 12 300 –∏–ª–∏ 12 345,6");
        return;
      }
      if (!isValidNumberString(norm)){
        setFeedback("warn", "–û—à–∏–±–∫–∞: –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ.", "–ú–æ–∂–Ω–æ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –∏ —Å –∑–∞–ø—è—Ç–æ–π/—Ç–æ—á–∫–æ–π. –ü—Ä–∏–º–µ—Ä: 12 345,6");
        return;
      }

      // –í–∞–ª–∏–¥–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
      attempts++;
      attemptsInfo.textContent = "–ü–æ–ø—ã—Ç–æ–∫: " + attempts;

      const userDisplay = normalizeAnswerInputForCompare(raw);
      const correct = current.correctDisplay;

      if (userDisplay === correct){
        if (!solvedThisTask){
          stats.correct++;
          stats.total++;
          stats.streak++;
          stats.bestStreak = Math.max(stats.bestStreak, stats.streak);

          sessionDone++;
          solvedThisTask = true;

          // –µ—Å–ª–∏ —Å–µ—Å—Å–∏—è –∑–∞–∫–æ–Ω—á–µ–Ω–∞ ‚Äî –Ω–∞—á–Ω—ë–º –∑–∞–Ω–æ–≤–æ, –Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
          if (sessionDone >= settings.sessionLen){
            setFeedback("good", "‚úÖ –í–µ—Ä–Ω–æ! –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.", "–ù–∞–∂–º–∏—Ç–µ ¬´–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–ª–µ–¥—É—é—â—É—é —Å–µ—Å—Å–∏—é.");
          } else {
            setFeedback("good", "‚úÖ –í–µ—Ä–Ω–æ!", "–ú–æ–∂–Ω–æ –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ: ¬´–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä¬ª.");
          }

          explainText.textContent = current.explanation;

          saveStats();
          renderStats();
          renderSession();
        } else {
          setFeedback("good", "‚úÖ –£–∂–µ –±—ã–ª–æ –≤–µ—Ä–Ω–æ.", "–ù–∞–∂–º–∏—Ç–µ ¬´–ù–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä¬ª, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.");
        }

        // —á—Ç–æ–±—ã ‚Äú–Ω–∞–∫–ª–∏–∫–∏–≤–∞–Ω–∏–µ–º‚Äù –Ω–µ –Ω–∞–∫—Ä—É—á–∏–≤–∞–ª–∏ ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ –Ω–æ–≤–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞
        checkBtn.disabled = true;
        return;
      }

      // –ù–µ–≤–µ—Ä–Ω–æ
      stats.total++;
      stats.streak = 0;
      saveStats();
      renderStats();

      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ—Å–ª–µ 2 –æ—à–∏–±–æ–∫ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–±–æ—Ä
      if (attempts >= 2){
        setFeedback("bad", "‚ùå –ù–µ–≤–µ—Ä–Ω–æ.", "–î–≤–∞ –ø—Ä–æ–º–∞—Ö–∞ ‚Äî –≤–∫–ª—é—á–∞—é —Ä–∞–∑–±–æ—Ä –Ω–∏–∂–µ. –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –Ω–∞–∂–∞—Ç—å ¬´–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ¬ª.");
        explainText.textContent = current.explanation;
      } else {
        setFeedback("bad", "‚ùå –ù–µ–≤–µ—Ä–Ω–æ.", "–ü–æ–¥—Å–∫–∞–∑–∫–∞: —Å–º–æ—Ç—Ä–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑—Ä—è–¥. –ï—Å–ª–∏ 5‚Äì9 ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º, –µ—Å–ª–∏ 0‚Äì4 ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º.");
      }
    }

    function showSolution(){
      if (!current) return;
      explainText.textContent = current.explanation;
      setFeedback("warn", "–†–µ—à–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–æ.", "–°–Ω–∞—á–∞–ª–∞ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ ‚Äî –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º —Å–º–æ—Ç—Ä–∏ —Ä–∞–∑–±–æ—Ä üòâ");
    }

    function newExample(){
      // –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å ‚Äî –Ω–∞—á–Ω—ë–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
      const finished = sessionDone >= settings.sessionLen;

      if (finished){
        sessionDone = 0;
        sessionIndex = 1;
      } else {
        // –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø—Ä–∏–º–µ—Ä –±—ã–ª —Ä–µ—à—ë–Ω, –¥–≤–∏–≥–∞–µ–º "–Ω–æ–º–µ—Ä –∑–∞–¥–∞–Ω–∏—è" –≤–ø–µ—Ä—ë–¥
        if (solvedThisTask){
          sessionIndex = Math.min(settings.sessionLen, sessionIndex + 1);
        }
      }

      loadNewTask(false);
    }

    function resetAllStats(){
      const ok = confirm("–¢–æ—á–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É? (–ü—Ä–∞–≤–∏–ª—å–Ω–æ/–í—Å–µ–≥–æ/–°–µ—Ä–∏–∏)");
      if (!ok) return;
      stats = { correct: 0, total: 0, streak: 0, bestStreak: 0 };
      saveStats();
      renderStats();

      sessionDone = 0;
      sessionIndex = 1;
      renderSession();

      setFeedback("", "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞.", "");
    }

    function fillPlaces(){
      placeSelect.innerHTML = "";
      for (const p of places){
        const opt = document.createElement("option");
        opt.value = String(p.exp);
        opt.textContent = p.label;
        placeSelect.appendChild(opt);
      }
    }

    function applySettingsToUI(){
      placeSelect.value = String(settings.exp);
      kindSelect.value = settings.kind;
      negSelect.value = settings.neg;
      sessionSelect.value = String(settings.sessionLen);
    }

    function readSettingsFromUI(){
      settings.exp = parseInt(placeSelect.value, 10);
      settings.kind = kindSelect.value;
      settings.neg = negSelect.value;
      settings.sessionLen = parseInt(sessionSelect.value, 10);

      saveSettings();

      // –ü—Ä–∏ —Å–º–µ–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é
      sessionDone = 0;
      sessionIndex = 1;
      renderSession();
      loadNewTask(false);
    }

    // =========================
    //  –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    // =========================
    function init(){
      fillPlaces();
      loadStats();
      loadSettings();
      applySettingsToUI();
      renderStats();

      sessionDone = 0;
      sessionIndex = 1;
      renderSession();

      loadNewTask(false);

      // –°–æ–±—ã—Ç–∏—è
      placeSelect.addEventListener("change", readSettingsFromUI);
      kindSelect.addEventListener("change", readSettingsFromUI);
      negSelect.addEventListener("change", readSettingsFromUI);
      sessionSelect.addEventListener("change", readSettingsFromUI);

      checkBtn.addEventListener("click", check);
      newBtn.addEventListener("click", newExample);
      solveBtn.addEventListener("click", showSolution);
      resetBtn.addEventListener("click", resetAllStats);

      // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
      document.addEventListener("keydown", (e) => {
        // Enter
        if (e.key === "Enter" && !e.ctrlKey){
          e.preventDefault();
          if (!checkBtn.disabled) check();
          return;
        }
        // Ctrl+Enter
        if (e.key === "Enter" && e.ctrlKey){
          e.preventDefault();
          newExample();
          return;
        }
      });
    }

    init();
  </script>
</body>
</html>
