<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–£–º–Ω–æ–∂–µ–Ω–∏–µ —Å—Ç–æ–ª–±–∏–∫–æ–º ‚Äî –û–ì–≠ —Ç—Ä–µ–Ω–∞–∂—ë—Ä</title>
  <style>
    :root { --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    body { margin: 20px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; line-height: 1.35; }
    .wrap { max-width: 1120px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 10px; }

    .bar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 12px 0 16px; }
    button { padding: 8px 12px; cursor:pointer; }
    input[type="number"] { width: 140px; padding:6px 8px; }
    .status { padding: 8px 10px; border-radius: 10px; background: #f3f4f6; }
    .ok { background:#ecfdf5; }
    .bad { background:#fef2f2; }

    .board { display:flex; gap:24px; flex-wrap:wrap; align-items:flex-start; }
    .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; }
    .problem { min-width: 440px; }
    .side { flex:1; min-width: 340px; }

    .col {
      font-family: var(--mono);
      font-size: 34px;
      line-height: 1.1;
      white-space: pre;
    }

    .mode {
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding: 10px 12px; border:1px solid #e5e7eb; border-radius: 12px;
      background:#fff; margin-top: 10px;
    }

    .grid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 14px;
      align-items:end;
      margin-top: 10px;
    }
    .cell { display:flex; flex-direction:column; gap:6px; }
    .cell input[type="number"] { width: 100%; }

    .actions { margin-top: 12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .small { font-size: 14px; opacity: .85; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f4f6; font-size: 13px; }
    .kbd { font-family: var(--mono); padding:2px 6px; border:1px solid #e5e7eb; border-bottom-width:2px; border-radius: 8px; }

    .boxTitle { font-weight: 700; margin-bottom: 8px; }
    .log {
      font-family: var(--mono);
      font-size: 16px;
      white-space: pre-wrap;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>–£–º–Ω–æ–∂–µ–Ω–∏–µ —Å—Ç–æ–ª–±–∏–∫–æ–º ‚Äî ‚Äú–∂—ë—Å—Ç–∫–∏–π‚Äù –û–ì–≠-—Ä–µ–∂–∏–º (–ø–µ—Ä–µ–Ω–æ—Å—ã –ø–æ —à–∞–≥–∞–º)</h1>

  <div class="bar">
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <label><b>–í–µ—Ä—Ö–Ω–µ–µ —á–∏—Å–ª–æ:</b></label>
      <input id="aIn" type="number" min="0" step="1" value="347">
      <label><b>–ù–∏–∂–Ω–µ–µ —á–∏—Å–ª–æ:</b></label>
      <input id="bIn" type="number" min="0" step="1" value="56">
    </div>

    <button id="startBtn">–ù–∞—á–∞—Ç—å</button>
    <button id="randomBtn">–°–ª—É—á–∞–π–Ω—ã–π –ø—Ä–∏–º–µ—Ä</button>
    <button id="resetBtn">–°–±—Ä–æ—Å</button>

    <div id="status" class="status">–í–≤–µ–¥–∏ —á–∏—Å–ª–∞ –∏ –Ω–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª.</div>
  </div>

  <div class="board">
    <div class="card problem">
      <div class="col" id="colOut">‚Äî</div>

      <div class="mode">
        <label style="display:flex; align-items:center; gap:8px;">
          <input id="strictMode" type="checkbox" checked>
          <span><b>–û–ì–≠-–∫–æ–Ω—Ç—Ä–æ–ª—å –ø–µ—Ä–µ–Ω–æ—Å–æ–≤</b> (–ø–æ—Ä–∞–∑—Ä—è–¥–Ω–æ –≤–≤–æ–¥–∏–º —Ü–∏—Ñ—Ä—É –∏ –ø–µ—Ä–µ–Ω–æ—Å)</span>
        </label>
        <label style="display:flex; align-items:center; gap:8px;">
          <input id="needFinal" type="checkbox" checked>
          <span><b>–¢—Ä–µ–±–æ–≤–∞—Ç—å –∏—Ç–æ–≥</b> (—É—á–µ–Ω–∏–∫ –≤–≤–æ–¥–∏—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç)</span>
        </label>
        <span class="small">–ï—Å–ª–∏ —Å–Ω—è—Ç—å –û–ì–≠-–∫–æ–Ω—Ç—Ä–æ–ª—å ‚Äî –º–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å —á–∞—Å—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Ü–µ–ª–∏–∫–æ–º.</span>
      </div>

      <div class="grid" id="inputsStrict">
        <div class="cell">
          <label for="digitAns">–¶–∏—Ñ—Ä–∞ –≤ —ç—Ç–æ–º —Ä–∞–∑—Ä—è–¥–µ</label>
          <input id="digitAns" type="number" min="0" max="9" step="1">
          <div class="small" id="noteDigit">‚Äî</div>
        </div>
        <div class="cell">
          <label for="carryAns">–ü–µ—Ä–µ–Ω–æ—Å –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑—Ä—è–¥</label>
          <input id="carryAns" type="number" min="0" step="1">
          <div class="small" id="noteCarry">‚Äî</div>
        </div>
      </div>

      <div class="grid" id="inputsLite" style="display:none;">
        <div class="cell">
          <label for="partAns">–ß–∞—Å—Ç–∏—á–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ (–≤–µ—Ä—Ö–Ω–µ–µ √ó —Ç–µ–∫—É—â–∞—è —Ü–∏—Ñ—Ä–∞ —Å–Ω–∏–∑—É)</label>
          <input id="partAns" type="number" min="0" step="1">
          <div class="small" id="notePart">‚Äî</div>
        </div>
        <div class="cell">
          <label for="digitControl">–¢–µ–∫—É—â–∞—è —Ü–∏—Ñ—Ä–∞ —Å–Ω–∏–∑—É (–∫–æ–Ω—Ç—Ä–æ–ª—å)</label>
          <input id="digitControl" type="number" min="0" max="9" step="1">
          <div class="small" id="noteCtrl">‚Äî</div>
        </div>
      </div>

      <div class="grid" id="inputsFinal">
        <div class="cell">
          <label for="finalAns">–ò—Ç–æ–≥–æ–≤–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ</label>
          <input id="finalAns" type="number" min="0" step="1">
          <div class="small" id="noteFinal">‚Äî</div>
        </div>
        <div class="cell">
          <div class="small">
            <span class="pill">–ü–æ—Ä—è–¥–æ–∫</span>
            –∏–¥—ë–º –ø–æ –Ω–∏–∂–Ω–µ–º—É —á–∏—Å–ª—É —Å–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ: —É–º–Ω–æ–∂–∏–ª–∏ –Ω–∞ —Ü–∏—Ñ—Ä—É ‚Üí –∑–∞–ø–∏—Å–∞–ª–∏ —Å—Ç—Ä–æ–∫—É ‚Üí —Å–¥–≤–∏–≥ ‚Üí –≤ –∫–æ–Ω—Ü–µ –∏—Ç–æ–≥.
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —à–∞–≥</button>
        <span class="small">Enter: <span class="kbd">Enter</span></span>
      </div>
    </div>

    <div class="card side">
      <div class="boxTitle">–õ–æ–≥ (–¥–ª—è —Ç–µ–±—è / –¥–ª—è —É—á–µ–Ω–∏–∫–∞)</div>
      <div class="log" id="logOut">‚Äî</div>

      <hr style="border:none; border-top:1px solid #e5e7eb; margin: 14px 0;">
      <div class="small">
        –í –û–ì–≠-—Ä–µ–∂–∏–º–µ —Ç—Ä–µ–Ω–∞–∂—ë—Ä –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç ‚Äú–ø–æ–º–Ω–∏—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º‚Äù: –∫–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ ‚Äî —ç—Ç–æ ‚Äú—Ü–∏—Ñ—Ä–∞ –æ—Ç–≤–µ—Ç–∞‚Äù –∏ ‚Äú–ø–µ—Ä–µ–Ω–æ—Å‚Äù.
        –≠—Ç–æ —Ç–æ, —á—Ç–æ —á–∞—â–µ –≤—Å–µ–≥–æ –∏ —Ä–∞–∑–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è —É –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤.
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const el = (id) => document.getElementById(id);

  const aIn = el('aIn');
  const bIn = el('bIn');

  const startBtn = el('startBtn');
  const randomBtn = el('randomBtn');
  const resetBtn = el('resetBtn');
  const checkBtn = el('checkBtn');

  const status = el('status');
  const colOut = el('colOut');
  const logOut = el('logOut');

  const strictMode = el('strictMode');
  const needFinal = el('needFinal');

  const inputsStrict = el('inputsStrict');
  const inputsLite = el('inputsLite');

  const digitAns = el('digitAns');
  const carryAns = el('carryAns');

  const partAns = el('partAns');
  const digitControl = el('digitControl');

  const finalAns = el('finalAns');

  const noteDigit = el('noteDigit');
  const noteCarry = el('noteCarry');
  const notePart = el('notePart');
  const noteCtrl = el('noteCtrl');
  const noteFinal = el('noteFinal');

  let st = null;

  function setStatus(text, kind = 'neutral') {
    status.textContent = text;
    status.className = 'status' + (kind === 'ok' ? ' ok' : kind === 'bad' ? ' bad' : '');
  }

  function sanitizeInt(v, fallback = null) {
    if (v === '' || v === null || v === undefined) return fallback;
    const n = Number(v);
    if (!Number.isFinite(n)) return fallback;
    return Math.trunc(n);
  }

  function spaces(n){ return n > 0 ? ' '.repeat(n) : ''; }

  function resetUI() {
    colOut.textContent = '‚Äî';
    logOut.textContent = '‚Äî';

    digitAns.value = '';
    carryAns.value = '';
    partAns.value = '';
    digitControl.value = '';
    finalAns.value = '';

    noteDigit.textContent = '‚Äî';
    noteCarry.textContent = '‚Äî';
    notePart.textContent = '‚Äî';
    noteCtrl.textContent = '‚Äî';
    noteFinal.textContent = '‚Äî';
  }

  function formatColumn(a, b, partialsShifted, showFinal, finalValue) {
    // –†—É—Å—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç:
    //    a
    // √ó  b
    // ----
    //   p0
    //  p1
    // ----
    //  ab
    const aStr = String(a);
    const bStr = String(b);
    const finalStr = String(finalValue ?? (a * b));

    const width = Math.max(
      aStr.length,
      bStr.length + 2,
      finalStr.length,
      ...partialsShifted.map(s => s.length)
    );

    const lineA = spaces(width - aStr.length) + aStr;
    const lineB = spaces(width - (bStr.length + 2)) + '√ó ' + bStr;
    const bar = '-'.repeat(width);

    let out = [lineA, lineB, bar];

    for (const p of partialsShifted) out.push(spaces(width - p.length) + p);

    if (showFinal) {
      out.push(bar);
      out.push(spaces(width - finalStr.length) + finalStr);
    }

    return out.join('\n');
  }

  function start() {
    const a = sanitizeInt(aIn.value, null);
    const b = sanitizeInt(bIn.value, null);

    if (a === null || b === null || a < 0 || b < 0) {
      setStatus('–ü—Ä–æ–≤–µ—Ä—å —á–∏—Å–ª–∞: –æ–±–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ü–µ–ª—ã–µ –∏ ‚â• 0.', 'bad');
      return;
    }

    const aDigits = String(a).split('').map(Number).reverse(); // —Å–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ
    const bDigits = String(b).split('').map(Number).reverse(); // —Å–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ

    st = {
      a, b,
      aDigits,
      bDigits,
      row: 0,          // –ø–æ –∫–∞–∫–æ–π —Ü–∏—Ñ—Ä–µ b –∏–¥—ë–º (0=–µ–¥–∏–Ω–∏—Ü—ã)
      col: 0,          // –ø–æ –∫–∞–∫–æ–π —Ü–∏—Ñ—Ä–µ a –∏–¥—ë–º (0=–µ–¥–∏–Ω–∏—Ü—ã)
      carry: 0,        // —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–µ–Ω–æ—Å –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏
      rowDigits: [],   // —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ü–∏—Ñ—Ä—ã —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (–≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ)
      partialsShifted: [],
      log: [],
      finished: false
    };

    resetUI();
    render();
    setStatus('–ù–∞—á–∏–Ω–∞–µ–º —Å –ø—Ä–∞–≤–æ–π —Ü–∏—Ñ—Ä—ã –Ω–∏–∂–Ω–µ–≥–æ —á–∏—Å–ª–∞ (–µ–¥–∏–Ω–∏—Ü—ã).', 'neutral');
    focusSmart();
  }

  function makeRandom() {
    // –ø–æ–¥ –û–ì–≠ —É–¥–æ–±–Ω–æ: 3-4 —Ü–∏—Ñ—Ä—ã —Å–≤–µ—Ä—Ö—É, 2-3 —Ü–∏—Ñ—Ä—ã —Å–Ω–∏–∑—É
    const a = Math.floor(Math.random() * 9000) + 100; // 100..9099
    const b = Math.floor(Math.random() * 900) + 10;   // 10..909
    aIn.value = a;
    bIn.value = b;
    start();
  }

  function currentContext() {
    const dB = st.bDigits[st.row]; // —Ç–µ–∫—É—â–∞—è —Ü–∏—Ñ—Ä–∞ —Å–Ω–∏–∑—É
    const dA = st.aDigits[st.col]; // —Ç–µ–∫—É—â–∞—è —Ü–∏—Ñ—Ä–∞ —Å–≤–µ—Ä—Ö—É
    const placeRow = st.row;       // —Å–¥–≤–∏–≥ —Å—Ç—Ä–æ–∫–∏ (0=–µ–¥–∏–Ω–∏—Ü—ã,1=–¥–µ—Å—è—Ç–∫–∏)
    const placeCol = st.col;       // —Ä–∞–∑—Ä—è–¥ –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏
    return { dB, dA, placeRow, placeCol };
  }

  function expectedStrictStep() {
    // –ï—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞ —Ü–∏—Ñ—Ä —Å–≤–µ—Ä—Ö—É ‚Äî –Ω—É–∂–Ω–æ "—Å–±—Ä–æ—Å–∏—Ç—å –ø–µ—Ä–µ–Ω–æ—Å" (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å) –∏ –∑–∞–∫–æ–Ω—á–∏—Ç—å —Å—Ç—Ä–æ–∫—É
    const { dB, dA } = currentContext();
    const t = dA * dB + st.carry;
    const digit = t % 10;
    const carry = Math.floor(t / 10);
    return { digit, carry, t };
  }

  function finishRowIfNeeded() {
    // –ï—Å–ª–∏ –º—ã –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ –≤—Å–µ —Ü–∏—Ñ—Ä—ã a (col == aDigits.length), –¥–æ–±–∞–≤–∏–º –ø–µ—Ä–µ–Ω–æ—Å –µ—Å–ª–∏ –µ—Å—Ç—å, —Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É
    if (st.col < st.aDigits.length) return false;

    if (st.carry > 0) {
      // –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å—Ç–∞—Ä—à–µ–π —Ü–∏—Ñ—Ä–æ–π —Å—Ç—Ä–æ–∫–∏
      st.rowDigits.push(st.carry);
      st.log.push(`–í –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫–∏ –¥–æ–ø–∏—Å—ã–≤–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å ${st.carry}.`);
      st.carry = 0;
    }

    // rowDigits —Å–æ–±—Ä–∞–Ω—ã —Å–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ ‚Üí –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
    const part = Number(st.rowDigits.slice().reverse().join('') || '0');
    const shifted = String(part) + '0'.repeat(st.row);

    st.partialsShifted.push(shifted);
    st.log.push(`–°—Ç—Ä–æ–∫–∞ –≥–æ—Ç–æ–≤–∞: ${part} (—Å–¥–≤–∏–≥ –Ω–∞ ${st.row} –Ω—É–ª–µ–π ‚Üí ${shifted})`);
    st.log.push('');

    // –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ
    st.row += 1;
    st.col = 0;
    st.carry = 0;
    st.rowDigits = [];

    // –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫ –±–æ–ª—å—à–µ –Ω–µ—Ç ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ñ–∏–Ω–∞–ª—É
    if (st.row >= st.bDigits.length) {
      // –≤—Å—ë, –∂–¥—ë–º –∏—Ç–æ–≥ (–∏–ª–∏ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º)
      return true;
    }
    return false;
  }

  function renderNotes() {
    if (!st) return;

    if (st.finished) {
      noteFinal.textContent = `–ì–æ—Ç–æ–≤–æ: ${st.a}√ó${st.b}=${st.a * st.b}`;
      noteDigit.textContent = '‚Äî';
      noteCarry.textContent = '‚Äî';
      notePart.textContent = '‚Äî';
      noteCtrl.textContent = '‚Äî';
      return;
    }

    const strict = strictMode.checked;

    // –ï—Å–ª–∏ —É–∂–µ –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –≥–æ—Ç–æ–≤—ã ‚Äî —Ä–µ–∂–∏–º —Ñ–∏–Ω–∞–ª–∞
    if (st.row >= st.bDigits.length) {
      noteFinal.textContent = `–í–≤–µ–¥–∏ –∏—Ç–æ–≥: ${st.a} √ó ${st.b}`;
      noteDigit.textContent = '‚Äî';
      noteCarry.textContent = '‚Äî';
      notePart.textContent = '‚Äî';
      noteCtrl.textContent = '‚Äî';
      return;
    }

    const { dB, dA, placeRow, placeCol } = currentContext();

    if (strict) {
      noteDigit.textContent = `–°—Ç—Ä–æ–∫–∞: —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ —Ü–∏—Ñ—Ä—É —Å–Ω–∏–∑—É ${dB} (—Ä–∞–∑—Ä—è–¥: ${placeRow === 0 ? '–µ–¥–∏–Ω–∏—Ü—ã' : placeRow === 1 ? '–¥–µ—Å—è—Ç–∫–∏' : placeRow + '-–π'}). –°–µ–π—á–∞—Å: ${dA}√ó${dB} + –ø–µ—Ä–µ–Ω–æ—Å ${st.carry}`;
      noteCarry.textContent = `–ü–µ—Ä–µ–Ω–æ—Å ‚Äî —ç—Ç–æ ‚åä( ${dA}√ó${dB}+${st.carry} ) / 10‚åã`;
      noteFinal.textContent = `–ò—Ç–æ–≥ –±—É–¥–µ—Ç –ø–æ—Å–ª–µ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫.`;
      notePart.textContent = '‚Äî';
      noteCtrl.textContent = '‚Äî';
    } else {
      noteCtrl.textContent = `–°–µ–π—á–∞—Å —Ü–∏—Ñ—Ä–∞ —Å–Ω–∏–∑—É: ${dB} (—Å–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ).`;
      notePart.textContent = `–ù—É–∂–Ω–æ: ${st.a} √ó ${dB} (–±–µ–∑ —Å–¥–≤–∏–≥–∞).`;
      noteFinal.textContent = `–ò—Ç–æ–≥ –ø–æ—Å–ª–µ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫.`;
      noteDigit.textContent = '‚Äî';
      noteCarry.textContent = '‚Äî';
    }
  }

  function render() {
    if (!st) return;

    inputsStrict.style.display = strictMode.checked ? 'grid' : 'none';
    inputsLite.style.display = strictMode.checked ? 'none' : 'grid';

    const showFinal = st.finished || (!needFinal.checked && st.row >= st.bDigits.length);
    const finalValue = st.a * st.b;

    colOut.textContent = formatColumn(st.a, st.b, st.partialsShifted, showFinal, finalValue);
    logOut.textContent = st.log.length ? st.log.join('\n') : '‚Äî';

    renderNotes();
  }

  function focusSmart() {
    if (!st) return;
    if (st.finished) return;
    if (st.row >= st.bDigits.length) { finalAns.focus(); return; }
    if (strictMode.checked) digitAns.focus();
    else digitControl.focus();
  }

  function onCheck() {
    if (!st) { setStatus('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª.', 'bad'); return; }
    if (st.finished) { setStatus('–£–∂–µ –≥–æ—Ç–æ–≤–æ üôÇ', 'neutral'); return; }

    // –§–∏–Ω–∞–ª?
    if (st.row >= st.bDigits.length) {
      if (!needFinal.checked) {
        st.finished = true;
        render();
        setStatus(`–ì–æ—Ç–æ–≤–æ! –û—Ç–≤–µ—Ç: ${st.a * st.b}.`, 'ok');
        return;
      }

      const fin = sanitizeInt(finalAns.value, null);
      if (fin === null) { setStatus('–í–≤–µ–¥–∏ –∏—Ç–æ–≥–æ–≤–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.', 'bad'); return; }
      if (fin !== st.a * st.b) {
        setStatus(`–ò—Ç–æ–≥ –Ω–µ–≤–µ—Ä–Ω—ã–π. –ü—Ä–æ–≤–µ—Ä—å —Å—É–º–º—É —Å—Ç—Ä–æ–∫/–ø–µ—Ä–µ–º–Ω–æ–∂–µ–Ω–∏–µ: ${st.a}√ó${st.b}.`, 'bad');
        return;
      }
      st.finished = true;
      st.log.push(`–ò—Ç–æ–≥: ${st.a}√ó${st.b} = ${fin}`);
      render();
      setStatus(`–ì–æ—Ç–æ–≤–æ! –û—Ç–≤–µ—Ç: ${fin}.`, 'ok');
      return;
    }

    // –ï—â—ë —Å—Ç—Ä–æ–∏–º —Å—Ç—Ä–æ–∫–∏
    if (strictMode.checked) {
      const da = sanitizeInt(digitAns.value, null);
      const ca = sanitizeInt(carryAns.value, null);
      if (da === null || ca === null) {
        setStatus('–í –û–ì–≠-—Ä–µ–∂–∏–º–µ –≤–≤–µ–¥–∏ –∏ —Ü–∏—Ñ—Ä—É, –∏ –ø–µ—Ä–µ–Ω–æ—Å.', 'bad');
        return;
      }
      if (da < 0 || da > 9) { setStatus('–¶–∏—Ñ—Ä–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 0‚Äì9.', 'bad'); return; }
      if (ca < 0) { setStatus('–ü–µ—Ä–µ–Ω–æ—Å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º.', 'bad'); return; }

      const { dB, dA } = currentContext();
      const exp = expectedStrictStep();

      if (da !== exp.digit) {
        setStatus(`–¶–∏—Ñ—Ä–∞ –≤ —ç—Ç–æ–º —Ä–∞–∑—Ä—è–¥–µ –Ω–µ–≤–µ—Ä–Ω–∞—è. –ü—Ä–æ–≤–µ—Ä—å: ${dA}√ó${dB}+–ø–µ—Ä–µ–Ω–æ—Å ${st.carry} = ${exp.t}.`, 'bad');
        return;
      }
      if (ca !== exp.carry) {
        setStatus(`–ü–µ—Ä–µ–Ω–æ—Å –Ω–µ–≤–µ—Ä–Ω—ã–π. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: ${exp.carry}. (–ø–æ—Ç–æ–º—É —á—Ç–æ ${exp.t} = ${exp.carry} –¥–µ—Å—è—Ç–∫–æ–≤ –∏ ${exp.digit} –µ–¥–∏–Ω–∏—Ü)`, 'bad');
        return;
      }

      // –ø—Ä–∏–º–µ–Ω—è–µ–º —à–∞–≥
      st.rowDigits.push(exp.digit);
      st.carry = exp.carry;
      st.log.push(`${dA}√ó${dB}+–ø–µ—Ä–µ–Ω–æ—Å ‚Üí ${exp.t}: –ø–∏—à–µ–º ${exp.digit}, –ø–µ—Ä–µ–Ω–æ—Å ${exp.carry}`);

      // –¥–≤–∏–≥–∞–µ–º—Å—è –ø–æ –≤–µ—Ä—Ö–Ω–µ–º—É —á–∏—Å–ª—É
      st.col += 1;

      // –µ—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ ‚Äî –∑–∞–≤–µ—Ä—à–∞–µ–º —Å—Ç—Ä–æ–∫—É
      if (st.col >= st.aDigits.length) {
        st.log.push(`–ö–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏ –ø–æ —Ü–∏—Ñ—Ä–µ —Å–Ω–∏–∑—É ${dB}.`);
        const rowDone = finishRowIfNeeded();
        if (rowDone && st.row >= st.bDigits.length) {
          setStatus('–í—Å–µ —Å—Ç—Ä–æ–∫–∏ –≥–æ—Ç–æ–≤—ã. –í–≤–µ–¥–∏ –∏—Ç–æ–≥.', 'ok');
          render();
          finalAns.focus();
          digitAns.value = '';
          carryAns.value = '';
          return;
        }
      }

      digitAns.value = '';
      carryAns.value = '';
      render();
      setStatus('–í–µ—Ä–Ω–æ! –°–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑—Ä—è–¥.', 'ok');
      focusSmart();
      return;
    }

    // Lite-—Ä–µ–∂–∏–º (—á–∞—Å—Ç–∏—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Ü–µ–ª–∏–∫–æ–º)
    const part = sanitizeInt(partAns.value, null);
    const d = sanitizeInt(digitControl.value, null);
    if (part === null || d === null) { setStatus('–í–≤–µ–¥–∏ —Ü–∏—Ñ—Ä—É —Å–Ω–∏–∑—É –∏ —á–∞—Å—Ç–∏—á–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.', 'bad'); return; }
    if (d < 0 || d > 9) { setStatus('–¶–∏—Ñ—Ä–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 0‚Äì9.', 'bad'); return; }

    const curDigit = st.bDigits[st.row];
    if (d !== curDigit) {
      setStatus(`–°–µ–π—á–∞—Å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ü–∏—Ñ—Ä–∞ —Å–Ω–∏–∑—É ${curDigit} (–∏–¥—ë–º —Å–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ).`, 'bad');
      return;
    }

    const expPart = st.a * curDigit;
    if (part !== expPart) {
      setStatus(`–ß–∞—Å—Ç–∏—á–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–µ–≤–µ—Ä–Ω–æ: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ${st.a}√ó${curDigit} = ${expPart}.`, 'bad');
      return;
    }

    const shifted = String(expPart) + '0'.repeat(st.row);
    st.partialsShifted.push(shifted);
    st.log.push(`–°—Ç—Ä–æ–∫–∞: ${st.a}√ó${curDigit}=${expPart}, —Å–æ —Å–¥–≤–∏–≥–æ–º (${st.row} –Ω—É–ª–µ–π) ‚Üí ${shifted}`);
    st.log.push('');

    st.row += 1;

    partAns.value = '';
    digitControl.value = '';

    render();
    if (st.row >= st.bDigits.length) {
      setStatus('–í—Å–µ —Å—Ç—Ä–æ–∫–∏ –≥–æ—Ç–æ–≤—ã. –í–≤–µ–¥–∏ –∏—Ç–æ–≥.', 'ok');
      finalAns.focus();
    } else {
      setStatus('–í–µ—Ä–Ω–æ! –°–ª–µ–¥—É—é—â–∞—è —Ü–∏—Ñ—Ä–∞ —Å–Ω–∏–∑—É.', 'ok');
      focusSmart();
    }
  }

  // events
  startBtn.addEventListener('click', start);
  randomBtn.addEventListener('click', makeRandom);
  resetBtn.addEventListener('click', () => { st = null; resetUI(); setStatus('–°–±—Ä–æ—à–µ–Ω–æ. –í–≤–µ–¥–∏ —á–∏—Å–ª–∞ –∏ –Ω–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª.'); });

  checkBtn.addEventListener('click', onCheck);

  [digitAns, carryAns, partAns, digitControl, finalAns].forEach(inp => {
    inp.addEventListener('keydown', (e) => { if (e.key === 'Enter') onCheck(); });
  });

  strictMode.addEventListener('change', () => {
    if (!st) { render(); return; }
    setStatus(strictMode.checked
      ? '–û–ì–≠-–∫–æ–Ω—Ç—Ä–æ–ª—å –≤–∫–ª—é—á—ë–Ω: –≤–≤–æ–¥–∏–º —Ü–∏—Ñ—Ä—É –∏ –ø–µ—Ä–µ–Ω–æ—Å –ø–æ –∫–∞–∂–¥–æ–º—É —Ä–∞–∑—Ä—è–¥—É.'
      : '–£–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ä–µ–∂–∏–º: –≤–≤–æ–¥–∏–º —á–∞—Å—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Ü–µ–ª–∏–∫–æ–º.', 'neutral');
    render();
    focusSmart();
  });

  needFinal.addEventListener('change', () => {
    if (!st) return;
    setStatus(needFinal.checked ? '–ò—Ç–æ–≥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω.' : '–ò—Ç–æ–≥ –º–æ–∂–Ω–æ –Ω–µ –≤–≤–æ–¥–∏—Ç—å (–ø–æ–∫–∞–∂–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏).', 'neutral');
  });
})();
</script>
</body>
</html>
