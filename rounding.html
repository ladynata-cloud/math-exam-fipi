<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Тренажёр: округление (ОГЭ-режим)</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#121824;
      --text:#e9f0f7;
      --muted:#9fb0c3;
      --line:rgba(255,255,255,.12);
      --accent:#5aa7ff;
      --ok:#39d98a;
      --bad:#ff5a6b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 900px at 10% -10%, rgba(90,167,255,.18), transparent 60%),
                  radial-gradient(900px 700px at 110% 0%, rgba(255,90,107,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.45;
    }
    .wrap{max-width:860px;margin:0 auto;padding:18px 14px 40px;}
    .card{
      background: rgba(18,24,36,.92);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
    }
    h1{margin:0;font-size:20px}
    .sub{margin:6px 0 0;color:var(--muted);font-size:13px}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}

    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px}
    select, input{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(7,10,16,.55);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    select:focus,input:focus{
      border-color: rgba(90,167,255,.55);
      box-shadow: 0 0 0 3px rgba(90,167,255,.15);
    }
    .col{flex:1 1 180px;min-width:180px}

    .task{
      margin-top:12px;
      padding: 14px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(7,10,16,.32);
    }
    .taskline{
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      color:var(--muted);font-size:12px;margin-bottom:8px
    }
    .tasktext{font-size:18px;margin:0}
    .mono{font-variant-numeric: tabular-nums}
    .pill{
      display:inline-block;padding:2px 8px;border-radius:999px;
      border:1px solid rgba(90,167,255,.30);
      background: rgba(90,167,255,.10);
    }

    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-size: 14px;
      user-select:none;
    }
    button:hover{background: rgba(255,255,255,.09)}
    button.primary{border-color: rgba(90,167,255,.38);background: rgba(90,167,255,.18)}
    button.primary:hover{background: rgba(90,167,255,.24)}
    button[disabled]{opacity:.55;cursor:not-allowed}

    /* аудит Алисы */
    .correct { color: var(--ok); font-weight: 700; }
    .incorrect { color: var(--bad); font-weight: 700; }
    .hint { color: var(--muted); font-size: 0.95em; }

    #feedback{
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(7,10,16,.32);
      min-height: 44px;
    }

    #rule{
      display:none;
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(7,10,16,.32);
      color: var(--muted);
      font-size: 13px;
    }
    #rule ol{margin:8px 0 0 18px}
    #rule li{margin:6px 0}

    .footer{
      margin-top:12px;
      color:var(--muted);
      font-size:13px;
    }

    .toggle{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,10,16,.32);
      color: var(--muted);
    }
    .toggle input{width:auto}

    @media (max-width: 768px) {
      #answer, #checkBtn {
        width: 100%;
        margin: 10px 0;
        padding: 15px;
        font-size: 18px;
      }
      #progress { font-size: 16px; }
      button{width:100%;}
      .toggle{width:100%}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start">
        <div>
          <h1>Тренажёр округления</h1>
          <div class="sub">ОГЭ-режим по умолчанию • строгая проверка • подсказки • сохранение прогресса</div>
        </div>
        <div class="sub"><a href="./index.html">← На главную</a></div>
      </div>

      <div class="row">
        <div class="col">
          <label>Режим</label>
          <div class="toggle">
            <input type="checkbox" id="ogeMode" checked />
            <div>
              <b>ОГЭ-режим</b> (только целые, разряды: десятки → миллионы)
              <div class="sub" style="margin:4px 0 0">Выключите — появятся десятые/сотые/тысячные.</div>
            </div>
          </div>
        </div>

        <div class="col">
          <label for="placeSel">Округлять до</label>
          <select id="placeSel"></select>
        </div>

        <div class="col">
          <label for="countSel">Сколько заданий в сессии</label>
          <select id="countSel">
            <option value="10" selected>10</option>
            <option value="20">20</option>
          </select>
        </div>
      </div>

      <!-- СЧЁТЧИК ЗАДАНИЙ -->
      <div id="progress" class="sub" style="margin-top:10px">
        Задание <span id="current">1</span> из <span id="total">10</span>
      </div>
      <div id="savedLine" class="sub" style="margin-top:6px; display:none;"></div>

      <div class="task">
        <div class="taskline">
          <div>Попыток в этом задании: <span class="mono" id="attempts">0</span></div>
          <div>Прогресс: <span class="mono" id="done">0</span>/<span class="mono" id="tot2">10</span></div>
        </div>

        <p class="tasktext" id="taskText">
          Округли число <span class="pill mono" id="numSpan">—</span> до <b id="placeSpan">—</b>.
        </p>

        <div style="margin-top:10px">
          <input id="answer" type="text" inputmode="numeric" autocomplete="off" placeholder="Введи ответ" />
        </div>

        <div class="btns">
          <button class="primary" id="checkBtn">Проверить</button>
          <button id="nextBtn" style="display:none;">Далее</button>
          <button id="ruleBtn">Напомнить правило</button>
          <button id="resetBtn">Сбросить прогресс</button>
        </div>

        <div id="feedback" class="hint">Введите ответ и нажмите «Проверить».</div>

        <div id="rule"></div>

        <div class="footer" id="usefulness">
          <b>Как это пригодится?</b><br/>
          При делении <span class="mono">473 : 8</span> можно округлить <span class="mono">473 → 480</span> → <span class="mono">480 : 8 = 60</span>.
          Это помогает быстро подобрать первую цифру частного.
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const LS_KEY = "roundingProgress_v2";

  const ogeModeEl = document.getElementById("ogeMode");
  const placeSel  = document.getElementById("placeSel");
  const countSel  = document.getElementById("countSel");

  const currentEl = document.getElementById("current");
  const totalEl   = document.getElementById("total");
  const doneEl    = document.getElementById("done");
  const tot2El    = document.getElementById("tot2");

  const savedLine = document.getElementById("savedLine");

  const attemptsEl = document.getElementById("attempts");
  const numSpan    = document.getElementById("numSpan");
  const placeSpan  = document.getElementById("placeSpan");

  const answerEl = document.getElementById("answer");
  const checkBtn = document.getElementById("checkBtn");
  const nextBtn  = document.getElementById("nextBtn");
  const feedback = document.getElementById("feedback");

  const ruleBtn = document.getElementById("ruleBtn");
  const ruleBox = document.getElementById("rule");
  const resetBtn= document.getElementById("resetBtn");

  const PLACE_LABEL = {
    6:"миллионов",5:"сотен тысяч",4:"десятков тысяч",3:"тысяч",2:"сотен",1:"десятков",
    0:"единиц",-1:"десятых",-2:"сотых",-3:"тысячных"
  };

  const OGE_PLACES = [1,2,3,4,5,6];
  const FULL_PLACES = [1,2,3,4,5,6,-1,-2,-3];

  let totalTasks = Number(countSel.value) || 10;
  let currentTask = 0;
  let completedTasks = 0;
  let score = 0;
  let attempts = 0;

  let task = null; // { exp, num, numDisplay, correct, correctDisplay, correctStr }

  function saveProgress(){
    localStorage.setItem(LS_KEY, JSON.stringify({
      completed: completedTasks,
      total: totalTasks,
      score: score,
      currentTask: currentTask,
      place: placeSel.value,
      count: countSel.value,
      oge: ogeModeEl.checked
    }));
  }

  function loadProgress(){
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    try{
      const data = JSON.parse(raw);
      if(typeof data.completed === "number") completedTasks = data.completed;
      if(typeof data.total === "number") totalTasks = data.total;
      if(typeof data.score === "number") score = data.score;
      if(typeof data.currentTask === "number") currentTask = data.currentTask;

      if(typeof data.oge === "boolean") ogeModeEl.checked = data.oge;
      if(data.count != null) countSel.value = String(data.count);

      totalTasks = Number(countSel.value) || totalTasks;

      // placeSel заполним после rebuild, потом выставим
      return data.place;
    }catch(e){}
  }

  function rebuildPlaceOptions(){
    const oge = ogeModeEl.checked;
    const places = oge ? OGE_PLACES : FULL_PLACES;

    placeSel.innerHTML = "";
    for(const p of places){
      const opt = document.createElement("option");
      opt.value = String(p);
      opt.textContent = PLACE_LABEL[p] || ("10^" + p);
      placeSel.appendChild(opt);
    }

    // В ОГЭ-режиме хотим стартовать с "сотен" (часто полезно для оценки),
    // но если раньше было сохранено — восстановим позже.
    if(oge){
      placeSel.value = "2";
      answerEl.setAttribute("inputmode", "numeric");
      answerEl.placeholder = "Введи целое число";
    }else{
      placeSel.value = "1";
      answerEl.setAttribute("inputmode", "decimal");
      answerEl.placeholder = "Введи число";
    }

    renderRuleText();
  }

  function renderRuleText(){
    const oge = ogeModeEl.checked;
    // блок "правило" делаем внутренним HTML
    ruleBox.style.display = "none";
    ruleBox.innerHTML = oge
      ? `
        <ol>
          <li>Определи разряд, до которого округляешь (десятки, сотни, тысячи...).</li>
          <li>Посмотри на цифру справа:
            <ul>
              <li>0–4 → разряд не меняем;</li>
              <li>5–9 → увеличиваем разряд на 1.</li>
            </ul>
          </li>
          <li>Все цифры справа заменяем на нули.</li>
        </ol>
      `
      : `
        <ol>
          <li>Определи разряд, до которого округляешь (десятки/сотни/… или десятые/сотые/тысячные).</li>
          <li>Посмотри на цифру справа:
            <ul>
              <li>0–4 → разряд не меняем;</li>
              <li>5–9 → увеличиваем разряд на 1.</li>
            </ul>
          </li>
          <li>Цифры справа заменяем на нули (или оставляем нужное число знаков после запятой).</li>
        </ol>
      `;
  }

  function updateProgressUI(){
    totalEl.textContent = String(totalTasks);
    tot2El.textContent  = String(totalTasks);
    currentEl.textContent = String(currentTask + 1);
    doneEl.textContent = String(completedTasks);
  }

  function roundTo(value, exp){
    if(exp >= 0){
      const factor = Math.pow(10, exp);
      return Math.round(value / factor) * factor;
    }else{
      const factor = Math.pow(10, -exp);
      return Math.round(value * factor) / factor;
    }
  }

  function nextDigit(value, exp){
    // цифра справа от разряда exp
    const e = exp - 1;
    const abs = Math.abs(value);
    if(e >= 0){
      const div = Math.pow(10, e);
      return Math.floor(abs / div) % 10;
    }else{
      const mul = Math.pow(10, -e);
      return Math.floor(abs * mul + 1e-10) % 10;
    }
  }

  function formatNumberRu(n, fixed=null){
    const opt = { useGrouping:true };
    if(fixed !== null){
      opt.minimumFractionDigits = fixed;
      opt.maximumFractionDigits = fixed;
    }else{
      opt.maximumFractionDigits = 12;
    }
    return new Intl.NumberFormat("ru-RU", opt).format(n);
  }

  function buildHint(num, exp, correctDisplay){
    const nd = nextDigit(num, exp);
    const place = PLACE_LABEL[exp] || ("10^" + exp);
    const nextLabel = PLACE_LABEL[exp-1] || "следующий разряд";
    const up = nd >= 5;

    return `
      <div class="hint">
        Подсказка: округляем до <b>${place}</b>. Смотрим на <b>${nextLabel}</b>: там цифра <b>${nd}</b>.<br/>
        ${up ? `Так как <b>${nd} ≥ 5</b>, увеличиваем разряд «${place}» на 1.` : `Так как <b>${nd} < 5</b>, разряд «${place}» не меняем.`}<br/>
        <b>Ответ:</b> <span class="mono">${correctDisplay}</span>
      </div>
    `;
  }

  function generateTask(){
    attempts = 0;
    attemptsEl.textContent = "0";
    nextBtn.style.display = "none";
    answerEl.value = "";
    answerEl.disabled = false;
    checkBtn.disabled = false;

    const exp = Number(placeSel.value);
    const oge = ogeModeEl.checked;

    let num;
    if(oge){
      // ТОЛЬКО целые
      const minDigits = Math.max(2, exp + 2);
      const min = Math.pow(10, minDigits - 1);
      const max = Math.pow(10, minDigits) - 1;
      num = Math.floor(Math.random() * (max - min + 1)) + min;
    }else{
      // Полный режим: целые + десятичные
      if(exp >= 0){
        const minDigits = Math.max(2, exp + 2);
        const min = Math.pow(10, minDigits - 1);
        const max = Math.pow(10, minDigits) - 1;
        num = Math.floor(Math.random() * (max - min + 1)) + min;
      }else{
        const intPart = Math.floor(Math.random() * 9000) + 100;
        const extraDigits = Math.max(1, (-exp) + 1);
        const fracMax = Math.pow(10, extraDigits) - 1;
        const frac = Math.floor(Math.random() * fracMax) + 1;
        num = Number(intPart + "." + String(frac).padStart(extraDigits, "0"));
      }
    }

    const correct = roundTo(num, exp);
    const fixed = exp < 0 ? (-exp) : 0;

    const numDisplay = oge
      ? formatNumberRu(num, 0)
      : formatNumberRu(num, exp < 0 ? Math.max(1, (-exp) + 1) : 0);

    const correctDisplay = formatNumberRu(correct, fixed);
    const correctStr = exp < 0 ? correct.toFixed(-exp) : String(correct);

    task = { exp, num, numDisplay, correct, correctDisplay, correctStr };

    numSpan.textContent = numDisplay;
    placeSpan.textContent = PLACE_LABEL[exp] || ("10^" + exp);

    feedback.className = "hint";
    feedback.innerHTML = "Введите ответ и нажмите «Проверить».";
    updateProgressUI();
    saveProgress();
    answerEl.focus();
  }

  // ====== ВАЛИДАЦИЯ ======
  function validateInput(raw, exp){
    const s = String(raw || "").trim();
    if(s === "") return { ok:false, msg:"Введите число!" };

    // ОГЭ-режим: строго целое
    if(ogeModeEl.checked){
      if(!/^\d+$/.test(s)) return { ok:false, msg:"Введите целое число!" };
      return { ok:true, norm:s };
    }

    // Полный режим
    if(exp >= 0){
      if(!/^\d+$/.test(s)) return { ok:false, msg:"Введите целое число!" };
      return { ok:true, norm:s };
    }else{
      const dec = -exp;
      const cleaned = s.replace(",", ".");
      if(!/^\d+(\.\d+)?$/.test(cleaned)) return { ok:false, msg:"Введите число (можно с запятой)!" };
      const parts = cleaned.split(".");
      const fracLen = parts[1] ? parts[1].length : 0;
      if(fracLen > dec) return { ok:false, msg:`Введите число не точнее, чем до ${PLACE_LABEL[exp]}!` };
      return { ok:true, norm:cleaned };
    }
  }

  function strictEqualCheck(userNorm, exp){
    // ОГЭ-режим: всё целое, строго
    if(ogeModeEl.checked){
      return parseInt(userNorm, 10) === Number(task.correctStr);
    }

    // Полный режим
    if(exp >= 0){
      return parseInt(userNorm, 10) === Number(task.correctStr);
    }else{
      const dec = -exp;
      const userFixed = Number(userNorm).toFixed(dec);
      return userFixed === task.correctStr;
    }
  }

  function checkAnswer(){
    if(!task) return;

    const userInput = answerEl.value.trim();
    const v = validateInput(userInput, task.exp);
    if(!v.ok){
      feedback.className = "incorrect";
      feedback.textContent = v.msg;
      return;
    }

    // сброс поля + блокировка кнопки (по аудиту)
    answerEl.value = "";
    checkBtn.disabled = true;
    setTimeout(() => {
      // если за это время задание уже “закрыто” (верный ответ) — не включаем обратно
      if(answerEl.disabled) return;
      checkBtn.disabled = false;
    }, 2000);

    nextBtn.style.display = "inline-block";

    const ok = strictEqualCheck(v.norm, task.exp);

    if(ok){
      feedback.className = "correct";
      feedback.innerHTML = `Верно! ✅<br/><span class="hint">${task.numDisplay} → <span class="mono">${task.correctDisplay}</span></span>`;
      score += 1;

      answerEl.disabled = true;
      checkBtn.disabled = true;
      completedTasks += 1;
    }else{
      attempts += 1;
      attemptsEl.textContent = String(attempts);

      feedback.className = "incorrect";
      feedback.textContent = "Неверно. Попробуй ещё.";

      if(attempts >= 2){
        feedback.innerHTML = `Неверно. Попробуй ещё.<br/>` + buildHint(task.num, task.exp, task.correctDisplay);
      }
    }

    saveProgress();
    updateProgressUI();
  }

  function loadNextTask(){
    // если ученик нажал “Далее”, но не решил — считаем как пройденное (пропуск),
    // чтобы прогресс шёл и ребёнок не “залипал”
    if(task && completedTasks < (currentTask + 1)){
      completedTasks += 1;
    }

    currentTask += 1;
    if(currentTask >= totalTasks){
      currentTask = 0;
      completedTasks = 0;
    }
    generateTask();
  }

  function toggleRule(){
    ruleBox.style.display = (ruleBox.style.display === "none" || ruleBox.style.display === "") ? "block" : "none";
  }

  function resetAll(){
    localStorage.removeItem(LS_KEY);
    currentTask = 0;
    completedTasks = 0;
    score = 0;
    attempts = 0;
    savedLine.style.display = "none";
    rebuildPlaceOptions();
    generateTask();
    feedback.className = "hint";
    feedback.textContent = "Прогресс сброшен. Начнём заново.";
  }

  // ====== INIT ======
  const savedPlace = loadProgress(); // вернёт сохранённый place, если был
  rebuildPlaceOptions();
  if(savedPlace != null){
    // если сохранённый разряд не доступен в ОГЭ-режиме — оставим текущий
    const exists = Array.from(placeSel.options).some(o => o.value === String(savedPlace));
    if(exists) placeSel.value = String(savedPlace);
  }

  totalTasks = Number(countSel.value) || totalTasks;
  updateProgressUI();

  // показываем строку сохранённого прогресса (чтобы не ломать счётчик 1/10)
  const raw = localStorage.getItem(LS_KEY);
  if(raw){
    try{
      const data = JSON.parse(raw);
      savedLine.style.display = "block";
      savedLine.textContent = `Сохранено: выполнено ${data.completed} из ${data.total}.`;
    }catch(e){}
  }

  checkBtn.addEventListener("click", checkAnswer);
  nextBtn.addEventListener("click", loadNextTask);
  ruleBtn.addEventListener("click", toggleRule);
  resetBtn.addEventListener("click", resetAll);

  ogeModeEl.addEventListener("change", () => {
    // при смене режима перестраиваем разряды и начинаем сессию заново
    currentTask = 0;
    completedTasks = 0;
    attempts = 0;
    rebuildPlaceOptions();
    generateTask();
    saveProgress();
  });

  placeSel.addEventListener("change", () => {
    currentTask = 0;
    completedTasks = 0;
    generateTask();
  });

  countSel.addEventListener("change", () => {
    totalTasks = Number(countSel.value) || 10;
    currentTask = 0;
    completedTasks = 0;
    generateTask();
  });

  document.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      if(!checkBtn.disabled) checkAnswer();
    }
  });

  generateTask();
})();
</script>
</body>
</html>
